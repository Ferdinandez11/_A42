This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.env.example
.gitattributes
.gitignore
eslint.config.js
index.html
package.json
postcss.config.js
public/banco.glb
public/columpio.glb
public/muelle.glb
public/tobogan.glb
public/vite.svg
README.md
src/App.tsx
src/components/layout/DashboardLayout.tsx
src/components/layout/ViewerLayout.tsx
src/components/ui/ConfirmModal.tsx
src/features/crm/index.ts
src/features/crm/pages/AdminCalendarPage.tsx
src/features/crm/pages/AdminClientDetailPage.tsx
src/features/crm/pages/AdminOrderDetailPage.tsx
src/features/crm/pages/BudgetDetailPage.tsx
src/features/crm/pages/ClientDashboard.tsx
src/features/crm/pages/ClientsPage.tsx
src/features/crm/pages/CrmDashboard.tsx
src/features/crm/pages/ProfilePage.tsx
src/features/editor/context/EngineContext.tsx
src/features/editor/data/fence_presets.ts
src/features/editor/Editor3D.tsx
src/features/editor/engine/A42Engine.ts
src/features/editor/engine/managers/ExportManager.ts
src/features/editor/engine/managers/InteractionManager.ts
src/features/editor/engine/managers/ObjectManager.ts
src/features/editor/engine/managers/PDFManager.ts
src/features/editor/engine/managers/RecorderManager.ts
src/features/editor/engine/managers/SceneManager.ts
src/features/editor/engine/managers/tools/CADTool.ts
src/features/editor/engine/managers/tools/FenceTool.ts
src/features/editor/engine/managers/tools/FloorTool.ts
src/features/editor/engine/managers/tools/MeasurementTool.ts
src/features/editor/engine/managers/tools/PlacingTool.ts
src/features/editor/engine/managers/ToolsManager.ts
src/features/editor/engine/managers/WalkManager.ts
src/features/editor/hooks/useEditorMedia.ts
src/features/editor/hooks/useProjectActions.ts
src/features/editor/hooks/useSceneTools.ts
src/features/editor/ui/BudgetPanel.tsx
src/features/editor/ui/CadControl.tsx
src/features/editor/ui/Catalog.tsx
src/features/editor/ui/Editor.css
src/features/editor/ui/EnvironmentPanel.tsx
src/features/editor/ui/FenceProperties.tsx
src/features/editor/ui/FloorProperties.tsx
src/features/editor/ui/InputModal.tsx
src/features/editor/ui/QRModal.tsx
src/features/editor/ui/Toolbar.tsx
src/index.css
src/lib/supabase.ts
src/main.tsx
src/services/catalogService.ts
src/stores/auth/useAuthStore.ts
src/stores/budget/useBudgetStore.ts
src/stores/cad/useCADStore.ts
src/stores/catalog/useCatalogStore.ts
src/stores/crm/useCRMStore.ts
src/stores/editor/useEditorStore.ts
src/stores/fence/useFenceStore.ts
src/stores/project/useProjectStore.ts
src/stores/scene/useSceneStore.ts
src/stores/selection/useSelectionStore.ts
src/stores/ui/useUIStore.ts
src/stores/user/useUserStore.ts
src/types/catalog.ts
src/types/editor.ts
src/types/types.ts
src/utils/budgetUtils.ts
src/utils/pdfGenerator.ts
src/utils/PriceCalculator.ts
tailwind.config.js
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vercel.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".env.example">
VITE_SUPABASE_URL=https://ikcjeiyidbrbkbletpxh.supabase.co
VITE_SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrY2plaXlpZGJyYmtibGV0cHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDM2NTQsImV4cCI6MjA3OTgxOTY1NH0.6x6bLTzHIqqInO2_9N83weQ3SVR0mrQV07pItqpisMs
</file>

<file path=".gitattributes">
# Auto detect text files and perform LF normalization
* text=auto
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
.env
.env.*
.env.local
.env.*.local
!/.env.example

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>a42-app</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="package.json">
{
  "name": "a42-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.86.0",
    "@types/three": "^0.158.0",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "lucide-react": "^0.555.0",
    "pdfjs-dist": "^5.4.449",
    "qrcode.react": "^4.2.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.9.6",
    "three": "^0.158.0",
    "zustand": "^5.0.8"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.22",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```
</file>

<file path="src/App.tsx">
import React from "react";
import {
  BrowserRouter,
  Routes,
  Route,
  Link,
  Outlet,
  useNavigate,
} from "react-router-dom";
import { supabase } from "./lib/supabase";

// --- IMPORTS ---
import { Editor3D } from "./features/editor/Editor3D";
import { useAuthStore } from "@/stores/auth/useAuthStore";
import { useProjectStore } from "@/stores/project/useProjectStore";
import { CrmDashboard } from "./features/crm/pages/CrmDashboard";
import { ClientDashboard } from "./features/crm/pages/ClientDashboard";
import { ProfilePage } from "./features/crm/pages/ProfilePage";
import { BudgetDetailPage } from "./features/crm/pages/BudgetDetailPage";
import { AdminOrderDetailPage } from "./features/crm/pages/AdminOrderDetailPage";
import { AdminClientDetailPage } from "./features/crm/pages/AdminClientDetailPage";
import { AdminCalendarPage } from "./features/crm/pages/AdminCalendarPage";

// --- ESTILOS ---
const badgeStyle: React.CSSProperties = {
  backgroundColor: "#333",
  color: "white",
  padding: "8px 16px",
  borderRadius: "20px",
  textDecoration: "none",
  fontSize: "14px",
  fontWeight: "bold",
  display: "flex",
  alignItems: "center",
  gap: "8px",
  boxShadow: "0 4px 6px rgba(0,0,0,0.3)",
  border: "1px solid #444",
  cursor: "pointer",
  transition: "all 0.2s ease",
};

const navLinkStyle: React.CSSProperties = {
  color: "#aaa",
  textDecoration: "none",
  padding: "8px 12px",
  borderRadius: "6px",
  transition: "color 0.2s",
  fontSize: "14px",
  display: "block",
};

// --- LOGOUT ---
const performLogout = async () => {
  await supabase.auth.signOut();
  useAuthStore.getState().setUser(null);
  useAuthStore.getState().setSession(null);
  localStorage.clear();
  window.location.href = "/";
};

// ------------------------------------------------------------------------------------
// EMPLOYEE LAYOUT
const EmployeeLayout = () => (
  <div
    style={{
      display: "flex",
      height: "100vh",
      fontFamily: "sans-serif",
      background: "#121212",
      color: "#e0e0e0",
    }}
  >
    <aside
      style={{
        width: "240px",
        background: "#1e1e1e",
        borderRight: "1px solid #333",
        display: "flex",
        flexDirection: "column",
      }}
    >
      <div style={{ padding: "20px", borderBottom: "1px solid #333" }}>
        <h3 style={{ margin: 0, color: "#fff" }}>Intranet üè¢</h3>
        <small style={{ color: "#666" }}>Modo Empleado</small>
      </div>

      <nav
        style={{
          display: "flex",
          flexDirection: "column",
          padding: "15px",
          gap: "5px",
        }}
      >
        <Link
          to="/admin/crm"
          style={{ ...navLinkStyle, color: "#fff", background: "#2a2a2a" }}
        >
          üë• CRM (Listado)
        </Link>
        <Link to="/admin/calendar" style={navLinkStyle}>
          üìÖ Calendario Entregas
        </Link>
        <Link to="/admin/erp" style={navLinkStyle}>
          üè≠ ERP (F√°brica)
        </Link>
        <Link to="/admin/purchases" style={navLinkStyle}>
          üõí Compras
        </Link>
      </nav>

      <div
        style={{
          marginTop: "auto",
          padding: "20px",
          borderTop: "1px solid #333",
          display: "flex",
          flexDirection: "column",
          gap: "10px",
        }}
      >
        <button
          onClick={performLogout}
          style={{
            background: "transparent",
            border: "none",
            color: "#e74c3c",
            cursor: "pointer",
            textAlign: "left",
            padding: 0,
          }}
        >
          Cerrar Sesi√≥n
        </button>

        <Link
          to="/"
          style={{ color: "#666", textDecoration: "none", fontSize: "13px" }}
        >
          ‚Üê Volver al Visor 3D
        </Link>
      </div>
    </aside>

    <main style={{ flex: 1, overflow: "auto" }}>
      <Outlet />
    </main>
  </div>
);

// ------------------------------------------------------------------------------------
// CLIENT PORTAL LAYOUT
const ClientPortalLayout = () => (
  <div
    style={{
      height: "100vh",
      display: "flex",
      flexDirection: "column",
      background: "#121212",
      color: "#e0e0e0",
      fontFamily: "sans-serif",
      overflow: "hidden",
    }}
  >
    <header
      style={{
        background: "#1e1e1e",
        borderBottom: "1px solid #333",
        padding: "15px 40px",
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        flexShrink: 0,
      }}
    >
      <h3 style={{ margin: 0, color: "#fff" }}>Portal del Cliente üëã</h3>

      <nav style={{ display: "flex", gap: "20px", alignItems: "center" }}>
        <Link to="/portal?tab=projects" style={{ color: "#fff" }}>
          Mis Proyectos
        </Link>
        <Link to="/portal?tab=budgets" style={{ color: "#bbb" }}>
          Mis Presupuestos
        </Link>
        <Link to="/portal?tab=orders" style={{ color: "#bbb" }}>
          Mis Pedidos
        </Link>
        <Link to="/portal/profile" style={{ color: "#bbb" }}>
          Mi Perfil üë§
        </Link>

        <Link
          to="/"
          style={{ ...badgeStyle, fontSize: "12px", padding: "6px 12px" }}
        >
          + Nuevo Proyecto 3D
        </Link>

        <button
          onClick={performLogout}
          style={{ background: "none", border: "none", color: "#666" }}
        >
          Salir
        </button>
      </nav>
    </header>

    <main style={{ flex: 1, overflowY: "auto", padding: "40px" }}>
      <div style={{ maxWidth: "1200px", margin: "0 auto" }}>
        <div
          style={{
            background: "#1e1e1e",
            padding: "30px",
            borderRadius: "12px",
            border: "1px solid #333",
          }}
        >
          <Outlet />
        </div>
      </div>
    </main>
  </div>
);

// ------------------------------------------------------------------------------------
// LOGIN PAGE (como la ten√≠as)
const LoginPage = () => {
  const navigate = useNavigate();
  const { setUser, setSession } = useAuthStore();

  const [step, setStep] = React.useState<"selection" | "form">("selection");
  const [targetRole, setTargetRole] = React.useState<"client" | "employee">(
    "client"
  );
  const [isRegistering, setIsRegistering] = React.useState(false);

  const [email, setEmail] = React.useState("");
  const [password, setPassword] = React.useState("");
  const [loading, setLoading] = React.useState(false);
  const [errorMsg, setErrorMsg] = React.useState("");

  const selectRole = (role: "client" | "employee") => {
    setTargetRole(role);
    setStep("form");
    setErrorMsg("");
  };

  const checkUserStatus = async (userId: string) => {
    const { data: profile } = await supabase
      .from("profiles")
      .select("role, is_approved")
      .eq("id", userId)
      .single();

    if (profile) {
      if (profile.role === "admin" || profile.role === "employee") {
        navigate("/admin/crm");
        return;
      }

      if (profile.is_approved) {
        navigate("/portal");
      } else {
        await supabase.auth.signOut();
        throw new Error("üîí Cuenta creada. Pendiente de validaci√≥n.");
      }
    }
  };

  const handleAuth = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setErrorMsg("");

    try {
      let result;

      if (isRegistering) {
        result = await supabase.auth.signUp({
          email,
          password,
          options: { data: { role: "client" } },
        });
      } else {
        result = await supabase.auth.signInWithPassword({ email, password });
      }

      if (result.error) throw result.error;

      if (!result.data.user) throw new Error("Error desconocido.");

      setUser(result.data.user);
      const session = (await supabase.auth.getSession()).data.session;
      setSession(session);

      await checkUserStatus(result.data.user.id);
    } catch (error: any) {
      setErrorMsg(error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      {step === "selection" ? (
        // pantalla selecci√≥n
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            justifyContent: "center",
            alignItems: "center",
            height: "100vh",
            background: "#000",
            color: "#fff",
          }}
        >
          <div
            style={{
              padding: "3rem",
              background: "#1e1e1e",
              borderRadius: "16px",
              border: "1px solid #333",
              textAlign: "center",
              minWidth: "350px",
            }}
          >
            <h2 style={{ marginBottom: "10px" }}>Bienvenido</h2>

            <div
              style={{
                display: "flex",
                gap: "15px",
                justifyContent: "center",
                margin: "30px 0",
              }}
            >
              <button
                onClick={() => selectRole("client")}
                style={{
                  ...badgeStyle,
                  flexDirection: "column",
                  padding: "20px",
                  width: "140px",
                  background: "#333",
                }}
              >
                <span style={{ fontSize: "30px" }}>üëã</span>
                <span>Soy Cliente</span>
              </button>

              <button
                onClick={() => selectRole("employee")}
                style={{
                  ...badgeStyle,
                  flexDirection: "column",
                  padding: "20px",
                  width: "140px",
                  background: "#222",
                  border: "1px solid #555",
                }}
              >
                <span style={{ fontSize: "30px" }}>üè¢</span>
                <span>Soy Empleado</span>
              </button>
            </div>

            <button
              onClick={() => navigate("/")}
              style={{
                background: "transparent",
                border: "none",
                color: "#666",
                cursor: "pointer",
                textDecoration: "underline",
              }}
            >
              Volver al Visor 3D
            </button>
          </div>
        </div>
      ) : (
        // --- FORMULARIO ORIGINAL ----
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            justifyContent: "center",
            alignItems: "center",
            height: "100vh",
            background: "#000",
            color: "#fff",
            fontFamily: "sans-serif",
          }}
        >
          <div
            style={{
              padding: "3rem",
              background: "#1e1e1e",
              borderRadius: "16px",
              border: "1px solid #333",
              textAlign: "center",
              minWidth: "350px",
            }}
          >
            <h2 style={{ marginBottom: "5px" }}>
              {targetRole === "employee"
                ? "Acceso Empleados"
                : isRegistering
                ? "Nuevo Registro"
                : "Acceso Clientes"}
            </h2>

            {errorMsg && (
              <div
                style={{
                  background: errorMsg.includes("validaci√≥n")
                    ? "rgba(39, 174, 96, 0.2)"
                    : "rgba(231, 76, 60, 0.2)",
                  color: errorMsg.includes("validaci√≥n")
                    ? "#2ecc71"
                    : "#e74c3c",
                  padding: "10px",
                  borderRadius: "6px",
                  marginBottom: "15px",
                  fontSize: "13px",
                }}
              >
                {errorMsg}
              </div>
            )}

            <form
              onSubmit={handleAuth}
              style={{ display: "flex", flexDirection: "column", gap: "15px" }}
            >
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={{
                  padding: "12px",
                  borderRadius: "6px",
                  border: "1px solid #444",
                  background: "#2a2a2a",
                  color: "white",
                }}
                required
              />
              <input
                type="password"
                placeholder="Contrase√±a"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={{
                  padding: "12px",
                  borderRadius: "6px",
                  border: "1px solid #444",
                  background: "#2a2a2a",
                  color: "white",
                }}
                required
              />

              <button
                type="submit"
                disabled={loading}
                style={{
                  ...badgeStyle,
                  justifyContent: "center",
                  backgroundColor:
                    targetRole === "employee" ? "#e67e22" : "#3b82f6",
                  border: "none",
                  padding: "12px",
                  marginTop: "10px",
                }}
              >
                {loading
                  ? "Procesando..."
                  : isRegistering
                  ? "Crear Cuenta"
                  : "Entrar"}
              </button>
            </form>

            {targetRole === "client" && (
              <div
                style={{
                  marginTop: "15px",
                  fontSize: "13px",
                  color: "#888",
                }}
              >
                {isRegistering ? "¬øYa tienes cuenta?" : "¬øNo tienes cuenta?"}{" "}
                <button
                  onClick={() => {
                    setIsRegistering(!isRegistering);
                    setErrorMsg("");
                  }}
                  style={{
                    background: "none",
                    border: "none",
                    color: "#3b82f6",
                    cursor: "pointer",
                    fontWeight: "bold",
                    textDecoration: "underline",
                  }}
                >
                  {isRegistering ? "Inicia Sesi√≥n" : "Reg√≠strate aqu√≠"}
                </button>
              </div>
            )}

            <button
              onClick={() => setStep("selection")}
              style={{
                marginTop: "20px",
                background: "transparent",
                border: "none",
                color: "#666",
                cursor: "pointer",
                textDecoration: "underline",
              }}
            >
              ‚Üê Volver
            </button>
          </div>
        </div>
      )}
    </>
  );
};


// VISOR 3D PAGE
const ViewerPage = () => {
  // Stores correctos (SIN useAppStore)
  const isReadOnlyMode = useProjectStore((s) => s.isReadOnlyMode);

  const loadProjectFromURL = useProjectStore((s) => s.loadProjectFromURL);
  const resetProject = useProjectStore((s) => s.resetProject);




  const { user, setUser } = useAuthStore();
  const navigate = useNavigate();

  // cargar usuario
  React.useEffect(() => {
    const loadUser = async () => {
      const { data } = await supabase.auth.getUser();
      const authUser = data.user;

      if (authUser) {
        const { data: profile } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", authUser.id)
          .single();

        setUser(profile ? { ...authUser, role: profile.role } : authUser);
      }
    };
    loadUser();
  }, [setUser]);

  React.useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const projectId = params.get("project_id");
    const isClone = params.get("mode") === "clone";

    if (projectId) {
      loadProjectFromURL(projectId).then(() => {
        if (isClone) resetProject();
      });
    }
  }, [loadProjectFromURL, resetProject]);

  const isAdminOrEmployee =
    user?.role === "admin" || user?.role === "employee";

  return (
    <div
      style={{
        width: "100vw",
        height: "100vh",
        position: "relative",
        overflow: "hidden",
        background: "#000",
      }}
    >
      <div
        style={{
          position: "absolute",
          top: 20,
          left: 20,
          zIndex: 2000,
          display: "flex",
          flexDirection: "column",
          gap: "10px",
        }}
      >
        {isAdminOrEmployee && (
          <button
            onClick={() => navigate("/admin/crm")}
            style={{
              background: "#e67e22",
              color: "white",
              padding: "10px 20px",
              borderRadius: "8px",
              border: "none",
              cursor: "pointer",
              fontWeight: "bold",
            }}
          >
            ‚¨ÖÔ∏è Volver al Panel
          </button>
        )}

        {!user && !isReadOnlyMode && (
          <Link to="/login" style={badgeStyle}>
            üë§ Acceso / Login
          </Link>
        )}
      </div>

      <Editor3D />

    </div>
  );
};

// ------------------------------------------------------------------------------------
// APP ROOT
function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<ViewerPage />} />
        <Route path="/login" element={<LoginPage />} />

        <Route path="/admin" element={<EmployeeLayout />}>
          <Route index element={<CrmDashboard />} />
          <Route path="crm" element={<CrmDashboard />} />
          <Route path="order/:id" element={<AdminOrderDetailPage />} />
          <Route path="client/:id" element={<AdminClientDetailPage />} />
          <Route path="calendar" element={<AdminCalendarPage />} />
        </Route>

        <Route path="/portal" element={<ClientPortalLayout />}>
          <Route index element={<ClientDashboard />} />
          <Route path="profile" element={<ProfilePage />} />
          <Route path="order/:id" element={<BudgetDetailPage />} />
        </Route>
      </Routes>
    </BrowserRouter>
  );
}

export default App;
</file>

<file path="src/components/ui/ConfirmModal.tsx">
import React from 'react';

interface ConfirmModalProps {
  isOpen: boolean;
  title: string;
  message: string;
  onConfirm: () => void;
  onCancel: () => void;
  isDestructive?: boolean; // Para poner el bot√≥n rojo
}

export const ConfirmModal: React.FC<ConfirmModalProps> = ({ 
  isOpen, title, message, onConfirm, onCancel, isDestructive = false 
}) => {
  if (!isOpen) return null;

  return (
    <div style={{
      position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
      background: 'rgba(0,0,0,0.8)', zIndex: 9999,
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      backdropFilter: 'blur(2px)'
    }}>
      <div style={{
        background: '#1e1e1e', border: '1px solid #333', borderRadius: '12px',
        padding: '25px', width: '400px', maxWidth: '90%',
        boxShadow: '0 10px 25px rgba(0,0,0,0.5)'
      }}>
        <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>{title}</h3>
        <p style={{ color: '#aaa', fontSize: '14px', marginBottom: '25px', lineHeight: '1.5' }}>
          {message}
        </p>
        
        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
          <button 
            onClick={onCancel}
            style={{
              padding: '10px 20px', borderRadius: '6px', border: '1px solid #444',
              background: 'transparent', color: '#ccc', cursor: 'pointer'
            }}
          >
            Cancelar
          </button>
          <button 
            onClick={onConfirm}
            style={{
              padding: '10px 20px', borderRadius: '6px', border: 'none',
              background: isDestructive ? '#c0392b' : '#3b82f6', 
              color: 'white', fontWeight: 'bold', cursor: 'pointer'
            }}
          >
            {isDestructive ? 'Borrar / Ejecutar' : 'Confirmar'}
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/features/crm/pages/AdminCalendarPage.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';

// --- ESTILOS ---
const containerStyle = { padding: '20px', color: '#e0e0e0', height: '100vh', display: 'flex', flexDirection: 'column' as const };
const headerStyle = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', background: '#1e1e1e', padding: '15px', borderRadius: '12px', border: '1px solid #333' };
const controlsStyle = { display: 'flex', gap: '15px', alignItems: 'center' };
const inputStyle = { background: '#252525', border: '1px solid #444', color: 'white', padding: '8px 12px', borderRadius: '6px', outline: 'none' };
const btnStyle = { background: '#333', color: 'white', border: '1px solid #555', padding: '8px 12px', borderRadius: '6px', cursor: 'pointer' };

// Estilos Grilla Calendario
const calendarGridStyle = { 
    display: 'grid', 
    gridTemplateColumns: 'repeat(7, 1fr)', 
    gap: '1px', 
    background: '#333', // Color de las l√≠neas
    border: '1px solid #333',
    borderRadius: '8px',
    overflow: 'hidden',
    flex: 1
};
const dayHeaderStyle = { background: '#2a2a2a', padding: '10px', textAlign: 'center' as const, fontWeight: 'bold', color: '#888', textTransform: 'uppercase' as const, fontSize: '12px' };
const dayCellStyle = { background: '#121212', minHeight: '100px', padding: '5px', position: 'relative' as const };
const dayNumberStyle = { position: 'absolute' as const, top: '5px', right: '8px', color: '#444', fontWeight: 'bold' };
const eventStyle = (status: string) => {
    let bg = '#3498db'; // Azul por defecto (pedido)
    if (status === 'presupuestado') bg = '#8e44ad';
    if (status === 'fabricacion') bg = '#e67e22';
    if (status === 'entregado') bg = '#27ae60';
    if (status === 'retrasado') bg = '#c0392b';

    return {
        background: bg, color: 'white', padding: '4px 6px', borderRadius: '4px', marginBottom: '4px', 
        fontSize: '11px', cursor: 'pointer', whiteSpace: 'nowrap' as const, overflow: 'hidden', textOverflow: 'ellipsis',
        borderLeft: '3px solid rgba(0,0,0,0.2)'
    };
};

const WEEKDAYS = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];

export const AdminCalendarPage = () => {
  const navigate = useNavigate();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [orders, setOrders] = useState<any[]>([]);
  const [, setLoading] = useState(true);
  
  // Filtros
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<'all' | 'client' | 'ref'>('all');

  useEffect(() => { loadOrders(); }, []);

  const loadOrders = async () => {
    setLoading(true);
    // Traemos pedidos que no est√©n cancelados ni rechazados y que tengan fecha
    const { data } = await supabase
        .from('orders')
        .select('id, order_ref, custom_name, estimated_delivery_date, status, profiles(company_name, email, full_name)')
        .not('estimated_delivery_date', 'is', null)
        .neq('status', 'rechazado')
        .neq('status', 'cancelado');
    
    setOrders(data || []);
    setLoading(false);
  };

  // --- L√ìGICA DE CALENDARIO ---
  const getDaysInMonth = (date: Date) => {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      // Ajustar para que la semana empiece en Lunes (0 = Domingo en JS, lo convertimos)
      let startDay = firstDay.getDay() - 1; 
      if (startDay === -1) startDay = 6; // Si es domingo, ponerlo al final

      const days = [];
      // Rellenar huecos previos
      for (let i = 0; i < startDay; i++) { days.push(null); }
      // Rellenar d√≠as del mes
      for (let i = 1; i <= lastDay.getDate(); i++) { days.push(new Date(year, month, i)); }
      
      return days;
  };

  const changeMonth = (offset: number) => {
      const newDate = new Date(currentDate.setMonth(currentDate.getMonth() + offset));
      setCurrentDate(new Date(newDate));
  };

  // --- FILTRADO ---
  const filteredOrders = orders.filter(o => {
      const searchLower = searchTerm.toLowerCase();
      const matchesRef = o.order_ref.toLowerCase().includes(searchLower) || (o.custom_name && o.custom_name.toLowerCase().includes(searchLower));
      const clientName = o.profiles?.company_name || o.profiles?.full_name || o.profiles?.email || '';
      const matchesClient = clientName.toLowerCase().includes(searchLower);

      if (filterType === 'all') return matchesRef || matchesClient;
      if (filterType === 'client') return matchesClient;
      if (filterType === 'ref') return matchesRef;
      return true;
  });

  const getEventsForDay = (day: Date) => {
      return filteredOrders.filter(o => {
          const d = new Date(o.estimated_delivery_date);
          return d.getDate() === day.getDate() && d.getMonth() === day.getMonth() && d.getFullYear() === day.getFullYear();
      });
  };

  const calendarDays = getDaysInMonth(currentDate);

  return (
    <div style={containerStyle}>
        
        {/* CABECERA Y CONTROLES */}
        <div style={headerStyle}>
            <div style={{display:'flex', alignItems:'center', gap:'15px'}}>
                <button onClick={() => changeMonth(-1)} style={btnStyle}>‚óÄ</button>
                <h2 style={{margin:0, color:'white', width:'200px', textAlign:'center'}}>
                    {currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase()}
                </h2>
                <button onClick={() => changeMonth(1)} style={btnStyle}>‚ñ∂</button>
            </div>

            <div style={controlsStyle}>
                <select 
                    value={filterType} 
                    onChange={e => setFilterType(e.target.value as any)}
                    style={{...inputStyle, width:'120px', cursor:'pointer'}}
                >
                    <option value="all">üîç Todo</option>
                    <option value="client">üë§ Cliente</option>
                    <option value="ref">üì¶ Pedido/Ref</option>
                </select>
                <input 
                    type="text" 
                    placeholder="Buscar..." 
                    value={searchTerm}
                    onChange={e => setSearchTerm(e.target.value)}
                    style={{...inputStyle, width:'200px'}}
                />
                <button onClick={loadOrders} style={{...btnStyle, background:'#27ae60', border:'none'}}>üîÑ</button>
            </div>
        </div>

        {/* LEYENDA */}
        <div style={{display:'flex', gap:'15px', marginBottom:'10px', fontSize:'12px', color:'#888'}}>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#8e44ad', borderRadius:'2px'}}></span> Presupuestado (Fin Validez)</div>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#e67e22', borderRadius:'2px'}}></span> Fabricaci√≥n</div>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#3498db', borderRadius:'2px'}}></span> Pedido Confirmado</div>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#27ae60', borderRadius:'2px'}}></span> Entregado</div>
        </div>

        {/* CALENDARIO */}
        <div style={calendarGridStyle}>
            {/* Cabeceras D√≠as */}
            {WEEKDAYS.map(d => <div key={d} style={dayHeaderStyle}>{d}</div>)}
            
            {/* Celdas */}
            {calendarDays.map((day, idx) => {
                if (!day) return <div key={`empty-${idx}`} style={{...dayCellStyle, background:'#1a1a1a'}}></div>;
                
                const events = getEventsForDay(day);
                const isToday = new Date().toDateString() === day.toDateString();

                return (
                    <div key={day.toISOString()} style={{...dayCellStyle, background: isToday ? '#1e251e' : '#121212', border: isToday ? '1px solid #27ae60' : 'none'}}>
                        <span style={{...dayNumberStyle, color: isToday ? '#27ae60' : '#444'}}>{day.getDate()}</span>
                        
                        <div style={{marginTop:'25px', display:'flex', flexDirection:'column', gap:'2px'}}>
                            {events.map(ev => (
                                <div 
                                    key={ev.id} 
                                    onClick={() => navigate(`/admin/order/${ev.id}`)}
                                    title={`Cliente: ${ev.profiles?.company_name || ev.profiles?.email}\nRef: ${ev.order_ref}`}
                                    style={eventStyle(ev.status)}
                                >
                                    <strong>{ev.order_ref}</strong>
                                    <div style={{fontSize:'9px', opacity:0.9}}>
                                        {ev.custom_name || ev.profiles?.company_name || 'Sin nombre'}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
  );
};
</file>

<file path="src/features/crm/pages/AdminClientDetailPage.tsx">
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';

const containerStyle = { padding: '20px', color: '#e0e0e0', fontFamily: 'sans-serif' };
const cardStyle = { background: '#1e1e1e', borderRadius: '12px', border: '1px solid #333', padding: '25px', marginBottom: '20px' };
const labelStyle = { display: 'block', color: '#aaa', marginBottom: '5px', fontSize: '13px' };
const inputStyle = { background: '#252525', border: '1px solid #444', color: 'white', padding: '10px', borderRadius: '6px', width: '100%', marginBottom: '15px' };
const sectionTitleStyle = { borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', color: 'white' };

export const AdminClientDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [profile, setProfile] = useState<any>(null);
  const [clientOrders, setClientOrders] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => { loadClientData(); }, [id]);

  const loadClientData = async () => {
    if (!id) return;
    setLoading(true);

    // 1. Cargar Perfil
    const { data: p } = await supabase.from('profiles').select('*').eq('id', id).single();
    if (p) setProfile(p);

    // 2. Cargar Historial de Pedidos
    const { data: o } = await supabase.from('orders')
        .select('*, projects(name)')
        .eq('user_id', id)
        .order('created_at', { ascending: false });
    setClientOrders(o || []);
    
    setLoading(false);
  };

  const handleSave = async () => {
    // IMPORTANTE: Convertimos descuento a n√∫mero para evitar error al guardar
    const discountValue = parseFloat(profile.discount_rate) || 0;

    const { error } = await supabase.from('profiles').update({
        company_name: profile.company_name,
        full_name: profile.full_name,
        email: profile.email, // A√±adido campo email al guardado
        phone: profile.phone,
        cif: profile.cif,
        shipping_address: profile.shipping_address,
        billing_address: profile.billing_address,
        discount_rate: discountValue
    }).eq('id', id);

    if (error) alert("Error al guardar: " + error.message);
    else alert("‚úÖ Cliente actualizado correctamente");
  };

  if (loading) return <p>Cargando ficha...</p>;
  if (!profile) return <p>Cliente no encontrado.</p>;

  return (
    <div style={containerStyle}>
      <div style={{display:'flex', justifyContent:'space-between', marginBottom:'20px'}}>
        <button onClick={() => navigate('/admin/crm')} style={{ background: 'none', border: 'none', color: '#888', cursor: 'pointer' }}>‚Üê Volver al Listado</button>
        <h2 style={{margin:0, color:'white'}}>Ficha Cliente: <span style={{color:'#3b82f6'}}>{profile.email}</span></h2>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px' }}>
        
        {/* COLUMNA IZQUIERDA: DATOS EDITABLES */}
        <div>
            <div style={cardStyle}>
                <h3 style={sectionTitleStyle}>üè¢ Datos de Empresa & Facturaci√≥n</h3>
                
                {/* ZONA DESCUENTO - DESTACADA */}
                <div style={{background: 'rgba(230, 126, 34, 0.1)', padding:'15px', borderRadius:'8px', border:'1px solid #e67e22', marginBottom:'20px'}}>
                    <label style={{...labelStyle, color:'#e67e22', fontWeight:'bold'}}>Descuento Comercial Fijo (%)</label>
                    <input 
                        type="number" 
                        value={profile.discount_rate || 0} 
                        onChange={e => setProfile({...profile, discount_rate: e.target.value})}
                        style={{...inputStyle, border:'1px solid #e67e22', fontSize:'18px', fontWeight:'bold', width:'100px', marginBottom:0}}
                    />
                    <small style={{color:'#888', display:'block', marginTop:'5px'}}>Este descuento se aplicar√° autom√°ticamente al calcular presupuestos.</small>
                </div>

                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px'}}>
                    <div>
                        <label style={labelStyle}>Nombre Empresa</label>
                        <input type="text" value={profile.company_name || ''} onChange={e => setProfile({...profile, company_name: e.target.value})} style={inputStyle} />
                    </div>
                    <div>
                        <label style={labelStyle}>CIF / NIF</label>
                        <input type="text" value={profile.cif || ''} onChange={e => setProfile({...profile, cif: e.target.value})} style={inputStyle} />
                    </div>
                </div>

                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px'}}>
                    <div>
                        <label style={labelStyle}>Persona de Contacto</label>
                        <input type="text" value={profile.full_name || ''} onChange={e => setProfile({...profile, full_name: e.target.value})} style={inputStyle} />
                    </div>
                    <div>
                        <label style={labelStyle}>Tel√©fono</label>
                        <input type="text" value={profile.phone || ''} onChange={e => setProfile({...profile, phone: e.target.value})} style={inputStyle} />
                    </div>
                </div>

                {/* NUEVO CAMPO EMAIL */}
                <label style={labelStyle}>Email Principal (CRM)</label>
                <input 
                    type="email" 
                    value={profile.email || ''} 
                    onChange={e => setProfile({...profile, email: e.target.value})} 
                    style={inputStyle} 
                />

                <label style={labelStyle}>Direcci√≥n de Facturaci√≥n</label>
                <textarea rows={3} value={profile.billing_address || ''} onChange={e => setProfile({...profile, billing_address: e.target.value})} style={{...inputStyle, resize:'none'}} />

                <label style={labelStyle}>Direcci√≥n de Env√≠o</label>
                <textarea rows={3} value={profile.shipping_address || ''} onChange={e => setProfile({...profile, shipping_address: e.target.value})} style={{...inputStyle, resize:'none'}} />

                <div style={{textAlign:'right', marginTop:'10px'}}>
                    <button onClick={handleSave} style={{background:'#27ae60', color:'white', border:'none', padding:'12px 30px', borderRadius:'6px', cursor:'pointer', fontWeight:'bold', fontSize:'16px'}}>
                        üíæ Guardar Cambios
                    </button>
                </div>
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL */}
        <div>
            <div style={cardStyle}>
                <h3 style={sectionTitleStyle}>üì¶ Historial de Pedidos ({clientOrders.length})</h3>
                <div style={{display:'flex', flexDirection:'column', gap:'10px', maxHeight:'600px', overflowY:'auto'}}>
                    {clientOrders.length === 0 && <p style={{color:'#666'}}>Sin pedidos.</p>}
                    {clientOrders.map(order => (
                        <div key={order.id} style={{background:'#252525', padding:'10px', borderRadius:'6px', border:'1px solid #333'}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                                <span style={{color:'white', fontWeight:'bold'}}>{order.order_ref}</span>
                                <span style={{fontSize:'12px', color:'#aaa'}}>{new Date(order.created_at).toLocaleDateString()}</span>
                            </div>
                            <div style={{fontSize:'13px', color:'#888', marginBottom:'5px'}}>{order.projects?.name}</div>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span style={{
                                    fontSize:'10px', padding:'2px 6px', borderRadius:'4px',
                                    background: order.status === 'pedido' ? '#3498db' : '#444', color:'white'
                                }}>
                                    {order.status.toUpperCase()}
                                </span>
                                <button onClick={() => navigate(`/admin/order/${order.id}`)} style={{background:'none', border:'none', color:'#3b82f6', cursor:'pointer', fontSize:'12px'}}>Ver ‚Üó</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

      </div>
    </div>
  );
};
</file>

<file path="src/features/crm/pages/AdminOrderDetailPage.tsx">
import { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';
import { PriceCalculator, PRICES } from '../../../utils/PriceCalculator';
import { generateBillOfMaterials } from '../../../utils/budgetUtils';
import { generateBudgetPDF } from '../../../utils/pdfGenerator'; // <--- IMPORTANTE

const CATALOG_ITEMS = [
    { id: 'bench_01', name: 'Banco Cl√°sico', type: 'model', price: 150 },
    { id: 'swing_01', name: 'Columpio Doble', type: 'model', price: 1200 },
    { id: 'slide_01', name: 'Tobog√°n Espiral', type: 'model', price: 2500 },
    { id: 'fence_wood', name: 'Valla de Madera', type: 'fence', price: PRICES.FENCE_M },
    { id: 'floor_rubber', name: 'Suelo de Caucho', type: 'floor', price: PRICES.FLOOR_M2 },
];

const containerStyle = { display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', height: '100%', color: '#e0e0e0', fontFamily: 'sans-serif' };
const cardStyle = { background: '#1e1e1e', borderRadius: '12px', border: '1px solid #333', padding: '20px', display: 'flex', flexDirection: 'column' as const, marginBottom: '20px' };
const inputStyle = { background: '#252525', border: '1px solid #444', color: 'white', padding: '10px', borderRadius: '6px', width: '100%', marginBottom: '15px' };
const labelStyle = { display: 'block', color: '#aaa', marginBottom: '5px', fontSize: '13px' };

const formatMoney = (amount: number) => {
    return amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
};

export const AdminOrderDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [order, setOrder] = useState<any>(null);
  
  // Items
  const [items3D, setItems3D] = useState<any[]>([]); 
  const [manualItems, setManualItems] = useState<any[]>([]); 
  const [calculatedBasePrice, setCalculatedBasePrice] = useState(0); 

  // Chat y Datos
  const [messages, setMessages] = useState<any[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [newDate, setNewDate] = useState(''); 
  
  // OBSERVACIONES
  const [observations, setObservations] = useState<any[]>([]);
  const [newObservation, setNewObservation] = useState('');

  // Archivos
  const [attachments, setAttachments] = useState<any[]>([]);
  const [uploading, setUploading] = useState(false);
  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false); // Estado visual para el PDF

  // UI
  const [isCatalogOpen, setIsCatalogOpen] = useState(false);
  const [parametricModal, setParametricModal] = useState<{isOpen: boolean, item: any | null, value: string}>({ isOpen: false, item: null, value: '' });

  const chatEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => { loadData(); }, [id]);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const loadData = async () => {
    if (!id) return;
    
    // 1. Cargar Pedido
    const { data: o } = await supabase
        .from('orders')
        .select('*, projects(*), profiles(*)') 
        .eq('id', id)
        .single();
    
    if (o) {
        setOrder(o);
        if (o.estimated_delivery_date) {
            setNewDate(new Date(o.estimated_delivery_date).toISOString().slice(0, 16));
        } else {
            setNewDate('');
        }
        
        // 1.1 Procesar Items 3D
        let total3D = 0;
        let processed3DItems: any[] = [];
        const raw3DItems = o.projects?.data?.items || o.projects?.items || [];

        if (raw3DItems.length > 0) {
            const itemsWithRealPrices = raw3DItems.map((item: any) => ({
                ...item,
                price: PriceCalculator.getItemPrice(item) 
            }));
            processed3DItems = generateBillOfMaterials(itemsWithRealPrices);
            total3D = processed3DItems.reduce((acc, line) => acc + line.totalPrice, 0);
        }
        setItems3D(processed3DItems);

        // 1.2 Cargar Items Manuales
        const { data: mItems } = await supabase.from('order_items').select('*').eq('order_id', id);
        const manual = mItems || [];
        setManualItems(manual);

        // 1.3 Calcular Total Base Real
        const totalManual = manual.reduce((acc: number, item: any) => acc + item.total_price, 0);
        setCalculatedBasePrice(total3D + totalManual);
    }

    // 2. Chat
    const { data: m } = await supabase.from('order_messages').select('*, profiles(full_name, role)').eq('order_id', id).order('created_at', { ascending: true });
    setMessages(m || []);

    // 3. Adjuntos
    const { data: att } = await supabase.from('order_attachments').select('*').eq('order_id', id);
    setAttachments(att || []);

    // 4. Observaciones
    const { data: obs } = await supabase
        .from('order_observations')
        .select('*, profiles(full_name, role)')
        .eq('order_id', id)
        .order('created_at', { ascending: false });
    setObservations(obs || []);
  };

  // --- ACTUALIZAR PEDIDO Y GENERAR PDF ---
  const handleUpdateOrder = async () => {
    if (!order) return;
    setIsGeneratingPDF(true); // Bloquear bot√≥n visualmente

    try {
        const dateToSave = newDate ? new Date(newDate).toISOString() : null;

        // 1. Guardar cambios en la Base de Datos
        const { error } = await supabase.from('orders').update({
            status: order.status,
            custom_name: order.custom_name, 
            estimated_delivery_date: dateToSave,
            total_price: order.total_price 
        }).eq('id', id);

        if (error) throw error;

        // 2. Si el estado es "presupuestado", generar PDF autom√°tico
        if (order.status === 'presupuestado') {
            // Generar Blob del PDF
            const pdfBlob = await generateBudgetPDF(order, items3D, manualItems);
            
            // Nombre del archivo: Presupuesto_REF_FECHA.pdf
            const fileName = `Presupuesto_${order.order_ref}_${Date.now()}.pdf`;
            const filePath = `${id}/${fileName}`;

            // Subir a Supabase Storage
            const { error: uploadError } = await supabase.storage.from('attachments').upload(filePath, pdfBlob);
            if (uploadError) throw uploadError;

            // Obtener URL P√∫blica
            const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filePath);

            // Guardar registro en la tabla de adjuntos
            const { data: { user } } = await supabase.auth.getUser();
            const { error: dbError } = await supabase.from('order_attachments').insert([{
                order_id: id,
                file_name: `üìÑ ${fileName}`, // Icono para distinguir
                file_url: publicUrl,
                uploader_id: user?.id
            }]);

            if (dbError) throw dbError;
            
            alert("‚úÖ Cambios guardados y PDF de Presupuesto generado y enviado al cliente.");
        } else {
            alert("‚úÖ Pedido actualizado correctamente.");
        }

        loadData(); // Recargar para ver el PDF en la lista
    } catch (error: any) {
        alert("Error: " + error.message);
    } finally {
        setIsGeneratingPDF(false);
    }
  };

  const handleStatusChangeRaw = (e: React.ChangeEvent<HTMLSelectElement>) => {
      const status = e.target.value;
      const now = new Date();
      let calculatedDateStr = newDate;

      if (status === 'presupuestado') {
          const d = new Date(now.getTime() + (48 * 60 * 60 * 1000));
          d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
          calculatedDateStr = d.toISOString().slice(0, 16);
      } 
      else if (status === 'pedido') {
          const d = new Date(now.getTime() + (42 * 24 * 60 * 60 * 1000));
          d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
          calculatedDateStr = d.toISOString().slice(0, 16);
      }

      setNewDate(calculatedDateStr);
      setOrder({...order, status: status});
  };

  const applyClientDiscount = () => {
      const discount = order.profiles?.discount_rate || 0;
      const discountAmount = calculatedBasePrice * (discount / 100);
      const finalPrice = calculatedBasePrice - discountAmount;
      if(confirm(`Base: ${formatMoney(calculatedBasePrice)}\nDto (${discount}%): -${formatMoney(discountAmount)}\n\nTotal: ${formatMoney(finalPrice)}`)) {
          setOrder({ ...order, total_price: finalPrice }); 
      }
  };

  const copyBasePrice = () => {
      setOrder({ ...order, total_price: calculatedBasePrice });
  };

  // --- OBSERVACIONES ---
  const handleAddObservation = async () => {
    if(!newObservation.trim()) return;
    const { data: { user } } = await supabase.auth.getUser();
    const { error } = await supabase.from('order_observations').insert([{
        order_id: id, user_id: user?.id, content: newObservation
    }]);
    if(error) alert("Error: " + error.message);
    else { setNewObservation(''); loadData(); }
  };

  // --- ITEMS MANUALES ---
  const handleAddItem = (item: any) => {
      if (item.type === 'fence' || item.type === 'floor') setParametricModal({ isOpen: true, item: item, value: '' });
      else saveManualItem(item.id, item.name, 1, item.price, '1 ud');
  };

  const confirmParametricItem = () => {
      const val = parseFloat(parametricModal.value);
      if (!val || val <= 0) return alert("Valor inv√°lido");
      const item = parametricModal.item;
      let price = 0;
      let dimensions = '';
      if (item.type === 'fence') { price = val * PRICES.FENCE_M; dimensions = `${val} ml`; } 
      else { price = val * PRICES.FLOOR_M2; dimensions = `${val} m¬≤`; }
      saveManualItem(item.id, item.name, 1, price, dimensions);
      setParametricModal({ isOpen: false, item: null, value: '' });
  };

  const saveManualItem = async (prodId: string, name: string, qty: number, total: number, dims: string) => {
      await supabase.from('order_items').insert([{
          order_id: id, product_id: prodId, name: name, quantity: qty, total_price: total, dimensions: dims
      }]);
      setIsCatalogOpen(false);
      loadData(); 
  };

  const handleDeleteManualItem = async (itemId: string) => {
      if(!confirm("¬øBorrar l√≠nea?")) return;
      await supabase.from('order_items').delete().eq('id', itemId);
      loadData();
  };

  // --- CHAT & FILES ---
  const handleSendMessage = async () => {
    if (!newMessage.trim()) return;
    const { data: { user } } = await supabase.auth.getUser();
    await supabase.from('order_messages').insert([{ order_id: id, user_id: user?.id, content: newMessage }]);
    setNewMessage(''); loadData();
  };

  const handleFileUpload = async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;
      setUploading(true);
      try {
          const fileExt = file.name.split('.').pop();
          const fileName = `${Math.random()}.${fileExt}`;
          const filePath = `${id}/${fileName}`;
          await supabase.storage.from('attachments').upload(filePath, file);
          const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filePath);
          await supabase.from('order_attachments').insert([{
              order_id: id, file_name: file.name, file_url: publicUrl, uploader_id: (await supabase.auth.getUser()).data.user?.id
          }]);
          loadData();
      } catch (error: any) { alert('Error: ' + error.message); } 
      finally { setUploading(false); }
  };

  const handleDeleteAttachment = async (attId: string) => {
      if(!confirm("¬øBorrar archivo?")) return;
      await supabase.from('order_attachments').delete().eq('id', attId);
      loadData();
  };

  if (!order) return <p>Cargando...</p>;
  const isMyMessage = (role: string) => role === 'admin' || role === 'employee';

  return (
    <div style={{ padding: '20px', height: '100vh', display:'flex', flexDirection:'column' }}>
      <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px'}}>
        <button onClick={() => navigate('/admin/crm')} style={{ background: 'none', border: 'none', color: '#888', cursor: 'pointer' }}>‚Üê Volver al Panel</button>
        <h2 style={{margin:0, color:'white'}}>Pedido Ref: <span style={{color:'#3b82f6'}}>{order.order_ref}</span></h2>
      </div>
      
      <div style={containerStyle}>
        
        {/* COLUMNA IZQUIERDA */}
        <div style={{ display:'flex', flexDirection:'column', gap:'10px', overflowY:'auto' }}>
            
            {/* ESTADO Y DATOS PRINCIPALES */}
            <div style={cardStyle}>
                <h3 style={{margin:'0 0 15px 0', borderBottom:'1px solid #333', paddingBottom:'10px', color:'white'}}>‚öôÔ∏è Control y Datos</h3>
                
                <div style={{marginBottom:'15px'}}>
                     <label style={labelStyle}>Nombre del Proyecto (Editable)</label>
                     <input 
                        type="text" 
                        value={order.custom_name || ''} 
                        onChange={e => setOrder({...order, custom_name: e.target.value})}
                        placeholder="Ej: Parque Ayuntamiento Norte"
                        style={{...inputStyle, border:'1px solid #3b82f6'}}
                     />
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={labelStyle}>Estado</label>
                        <select value={order.status} onChange={handleStatusChangeRaw} style={inputStyle}>
                            <option value="pendiente">üü† Pendiente</option>
                            <option value="presupuestado">üü£ Presupuestado (Auto: +48h)</option>
                            <option value="pedido">üîµ Pedido Aceptado (Auto: +6sem)</option>
                            <option value="fabricacion">üü† En Fabricaci√≥n</option>
                            <option value="entregado">üü¢ Entregado</option>
                            <option value="rechazado">üî¥ Rechazado</option>
                            <option value="cancelado">‚ö´ Cancelado</option>
                        </select>
                    </div>
                    <div>
                        <label style={labelStyle}>Fecha Entrega Estimada</label>
                        <input type="datetime-local" value={newDate} onChange={(e) => setNewDate(e.target.value)} style={inputStyle} />
                    </div>
                </div>

                {/* --- SECCI√ìN PRECIOS --- */}
                <div style={{background:'rgba(59, 130, 246, 0.1)', padding:'15px', borderRadius:'8px', border:'1px solid rgba(59, 130, 246, 0.3)'}}>
                    
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px', borderBottom:'1px solid rgba(255,255,255,0.1)', paddingBottom:'10px'}}>
                        <span style={{color:'#aaa', fontSize:'13px'}}>Total Tarifa (Suma Items):</span>
                        <span style={{fontSize:'16px', fontWeight:'bold', color:'white'}}>{formatMoney(calculatedBasePrice)}</span>
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'1fr auto auto', gap:'10px', alignItems:'end'}}>
                        <div>
                            <label style={{...labelStyle, color:'#3b82f6', fontWeight:'bold'}}>Precio Final Oferta (‚Ç¨)</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                value={order.total_price} 
                                onChange={(e) => setOrder({...order, total_price: parseFloat(e.target.value)})} 
                                style={{...inputStyle, marginBottom:0, fontSize:'16px', fontWeight:'bold'}} 
                            />
                        </div>
                        <button 
                            onClick={applyClientDiscount} 
                            title={`Aplicar Descuento Cliente (${order.profiles?.discount_rate || 0}%)`}
                            style={{background:'#e67e22', color:'white', border:'none', borderRadius:'6px', padding:'0 15px', height:'42px', cursor:'pointer', fontWeight:'bold'}}
                        >
                            % Dto
                        </button>
                        <button 
                            onClick={copyBasePrice} 
                            title="Copiar precio base a precio oferta"
                            style={{background:'#333', color:'white', border:'1px solid #555', borderRadius:'6px', padding:'0 15px', height:'42px', cursor:'pointer'}}
                        >
                            Igualar ‚¨á
                        </button>
                    </div>
                </div>
                
                <div style={{marginTop:'20px', display:'flex', justifyContent:'flex-end'}}>
                     <button 
                        onClick={handleUpdateOrder} 
                        disabled={isGeneratingPDF}
                        style={{background:'#27ae60', color:'white', padding:'12px 30px', border:'none', borderRadius:'6px', cursor: isGeneratingPDF ? 'wait' : 'pointer', fontWeight:'bold', fontSize:'14px', opacity: isGeneratingPDF ? 0.7 : 1}}
                    >
                        {isGeneratingPDF ? 'Guardando y Generando PDF...' : 'üíæ Guardar Cambios'}
                    </button>
                </div>
            </div>

            {/* OBSERVACIONES */}
            <div style={{...cardStyle, borderLeft:'4px solid #e67e22'}}>
                <h4 style={{margin:'0 0 15px 0', color:'#e67e22'}}>üìù Historial de Observaciones</h4>
                <div style={{maxHeight:'200px', overflowY:'auto', marginBottom:'15px', display:'flex', flexDirection:'column', gap:'10px'}}>
                    {observations.length === 0 && <p style={{color:'#666', fontStyle:'italic', fontSize:'13px'}}>No hay observaciones registradas.</p>}
                    {observations.map(obs => (
                        <div key={obs.id} style={{background:'#252525', padding:'10px', borderRadius:'6px', borderLeft:`3px solid ${obs.profiles?.role === 'admin' ? '#e67e22' : '#3b82f6'}`}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'4px'}}>
                                <span style={{fontWeight:'bold', fontSize:'12px', color:'white'}}>
                                    {obs.profiles?.role === 'admin' ? 'üè¢ T√∫ (Admin)' : 'üë§ Cliente'}
                                </span>
                                <span style={{fontSize:'11px', color:'#888'}}>{new Date(obs.created_at).toLocaleString()}</span>
                            </div>
                            <p style={{margin:0, fontSize:'13px', color:'#ddd', whiteSpace:'pre-wrap'}}>{obs.content}</p>
                        </div>
                    ))}
                </div>
                <div style={{display:'flex', gap:'10px'}}>
                    <input type="text" value={newObservation} onChange={e => setNewObservation(e.target.value)} placeholder="A√±adir nota interna o mensaje..." style={{flex:1, padding:'8px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} />
                    <button onClick={handleAddObservation} style={{background:'#e67e22', color:'white', border:'none', padding:'0 15px', borderRadius:'6px', cursor:'pointer'}}>A√±adir</button>
                </div>
            </div>

            {/* DESGLOSE DE MATERIALES */}
            <div style={cardStyle}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'15px'}}>
                    <h3 style={{margin:0, color:'white'}}>üìã Desglose Materiales</h3>
                    <div style={{display:'flex', gap:'10px'}}>
                        <button onClick={() => setIsCatalogOpen(true)} style={{padding:'5px 15px', background:'#27ae60', color:'white', border:'none', borderRadius:'4px', cursor:'pointer', fontWeight:'bold'}}>+ A√±adir Item</button>
                        <button onClick={() => {if(order.project_id) window.location.href=`/?project_id=${order.project_id}&mode=readonly`}} style={{padding:'5px 10px', background:'#333', color:'white', border:'1px solid #555', borderRadius:'4px', cursor:'pointer'}}>Ver 3D ‚Üó</button>
                    </div>
                </div>

                <div style={{background:'#252525', borderRadius:'8px', overflow:'hidden'}}>
                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'13px'}}>
                        <thead style={{background:'#333', color:'#aaa'}}>
                            <tr>
                                <th style={{padding:'8px', textAlign:'left'}}>√çtem</th>
                                <th style={{padding:'8px', textAlign:'center'}}>Origen</th>
                                <th style={{padding:'8px', textAlign:'right'}}>Precio</th>
                                <th style={{padding:'8px'}}></th>
                            </tr>
                        </thead>
                        <tbody>
                            {items3D.map((line, idx) => (
                                <tr key={`3d-${idx}`} style={{borderBottom:'1px solid #333'}}>
                                    <td style={{padding:'8px', color:'white'}}>
                                        {line.name} <span style={{color:'#666', fontSize:'10px'}}>x{line.quantity}</span>
                                    </td>
                                    <td style={{padding:'8px', textAlign:'center', color:'#888', fontSize:'11px'}}>DISE√ëO 3D</td>
                                    <td style={{padding:'8px', textAlign:'right', color:'#ccc'}}>{formatMoney(line.totalPrice)}</td>
                                    <td style={{textAlign:'right', padding:'8px'}}><small style={{color:'#666'}}>Auto</small></td>
                                </tr>
                            ))}
                            {manualItems.map((item) => (
                                <tr key={item.id} style={{borderBottom:'1px solid #333', background:'rgba(59, 130, 246, 0.1)'}}>
                                    <td style={{padding:'8px', color:'white'}}>
                                        {item.name} <span style={{color:'#888', fontSize:'11px'}}>({item.dimensions})</span>
                                    </td>
                                    <td style={{padding:'8px', textAlign:'center', color:'#3b82f6', fontSize:'11px'}}>EXTRA MANUAL</td>
                                    <td style={{padding:'8px', textAlign:'right', color:'white', fontWeight:'bold'}}>{formatMoney(item.total_price)}</td>
                                    <td style={{textAlign:'right', padding:'8px'}}>
                                        <button onClick={() => handleDeleteManualItem(item.id)} style={{color:'#e74c3c', background:'none', border:'none', cursor:'pointer'}}>üóëÔ∏è</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot style={{background:'#2a2a2a', fontWeight:'bold'}}>
                             <tr>
                                <td colSpan={2} style={{padding:'10px', textAlign:'right', color:'#aaa'}}>SUMA TOTAL</td>
                                <td style={{padding:'10px', textAlign:'right', color:'white'}}>{formatMoney(calculatedBasePrice)}</td>
                                <td></td>
                             </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            {/* ARCHIVOS */}
            <div style={cardStyle}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
                    <h3 style={{margin:0, color:'white'}}>üìé Archivos Adjuntos</h3>
                    <label style={{background:'#3b82f6', color:'white', padding:'5px 10px', borderRadius:'4px', cursor:'pointer', fontSize:'12px'}}>
                        {uploading ? 'Subiendo...' : '+ Subir Archivo'}
                        <input type="file" onChange={handleFileUpload} style={{display:'none'}} disabled={uploading} />
                    </label>
                </div>
                {attachments.length === 0 ? <p style={{color:'#666', fontSize:'13px'}}>No hay archivos.</p> : (
                    <ul style={{listStyle:'none', padding:0, margin:0}}>
                        {attachments.map(att => (
                            <li key={att.id} style={{display:'flex', justifyContent:'space-between', background:'#252525', padding:'8px', marginBottom:'5px', borderRadius:'4px'}}>
                                <a href={att.file_url} target="_blank" rel="noreferrer" style={{color:'#3b82f6', textDecoration:'none', fontSize:'13px'}}>{att.file_name}</a>
                                <button onClick={() => handleDeleteAttachment(att.id)} style={{border:'none', background:'none', color:'#e74c3c', cursor:'pointer'}}>üóëÔ∏è</button>
                            </li>
                        ))}
                    </ul>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: CHAT */}
        <div style={{...cardStyle, maxHeight:'90vh', marginBottom:0}}>
            <h3 style={{color:'white', borderBottom:'1px solid #333', paddingBottom:'10px'}}>üí¨ Chat</h3>
            <div style={{flex:1, overflowY:'auto', display:'flex', flexDirection:'column', gap:'15px'}}>
                {messages.map(msg => {
                    const amITheSender = isMyMessage(msg.profiles?.role);
                    return (
                        <div key={msg.id} style={{alignSelf: amITheSender ? 'flex-end' : 'flex-start', maxWidth: '85%', background: amITheSender ? '#3b82f6' : '#444', color: 'white', padding: '10px', borderRadius: '8px'}}>
                            {msg.content}
                        </div>
                    );
                })}
                <div ref={chatEndRef} />
            </div>
            <div style={{marginTop:'15px', display:'flex', gap:'10px'}}>
                <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value)} onKeyDown={e => e.key==='Enter' && handleSendMessage()} style={{flex:1, padding:'10px', borderRadius:'6px', border:'none'}} placeholder="Responder..." />
                <button onClick={handleSendMessage} style={{background:'#3b82f6', color:'white', border:'none', padding:'0 15px', borderRadius:'6px'}}>‚û§</button>
            </div>
        </div>

      </div>
      {/* ... MODALES ... */}
       {isCatalogOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:999}}>
              <div style={{background:'#1e1e1e', width:'600px', maxHeight:'80vh', borderRadius:'12px', border:'1px solid #444', display:'flex', flexDirection:'column'}}>
                  <div style={{padding:'20px', borderBottom:'1px solid #333', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                      <h3 style={{margin:0, color:'white'}}>A√±adir Extra</h3>
                      <button onClick={() => setIsCatalogOpen(false)} style={{background:'none', border:'none', color:'#888', fontSize:'20px'}}>‚úï</button>
                  </div>
                  <div style={{padding:'20px', overflowY:'auto', display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                      {CATALOG_ITEMS.map(item => (
                          <div key={item.id} onClick={() => handleAddItem(item)} style={{background:'#252525', padding:'15px', borderRadius:'8px', cursor:'pointer', border:'1px solid #333'}}>
                              <div style={{fontWeight:'bold', color:'white'}}>{item.name}</div>
                              <div style={{color:'#888', fontSize:'12px'}}>{item.type === 'model' ? `${item.price} ‚Ç¨` : 'Param√©trico'}</div>
                          </div>
                      ))}
                  </div>
              </div>
          </div>
      )}
      {parametricModal.isOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:1000}}>
              <div style={{background:'#1e1e1e', padding:'30px', borderRadius:'12px', width:'350px', border:'1px solid #444'}}>
                  <h3 style={{margin:'0 0 15px 0', color:'white'}}>{parametricModal.item?.name}</h3>
                  <input type="number" autoFocus value={parametricModal.value} onChange={e => setParametricModal({...parametricModal, value: e.target.value})} placeholder="Cantidad" style={{width:'100%', padding:'10px', marginBottom:'20px'}}/>
                  <div style={{display:'flex', gap:'10px', justifyContent:'flex-end'}}>
                      <button onClick={() => setParametricModal({isOpen:false, item:null, value:''})}>Cancelar</button>
                      <button onClick={confirmParametricItem}>A√±adir</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/BudgetDetailPage.tsx">
import { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';
import { ConfirmModal } from '../../../components/ui/ConfirmModal';
import { PriceCalculator, PRICES } from '../../../utils/PriceCalculator';
import type { Order } from '../../../types/types';

const CATALOG_ITEMS = [
    { id: 'bench_01', name: 'Banco Cl√°sico', type: 'model', price: 150 },
    { id: 'swing_01', name: 'Columpio Doble', type: 'model', price: 1200 },
    { id: 'slide_01', name: 'Tobog√°n Espiral', type: 'model', price: 2500 },
    { id: 'fence_wood', name: 'Valla de Madera', type: 'fence', price: PRICES.FENCE_M },
    { id: 'floor_rubber', name: 'Suelo de Caucho', type: 'floor', price: PRICES.FLOOR_M2 },
];

const containerStyle = { display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', height: '100%' };
const cardStyle = { background: '#1e1e1e', borderRadius: '12px', border: '1px solid #333', padding: '20px', display: 'flex', flexDirection: 'column' as const, marginBottom: '20px' };
const sectionHeaderStyle = { color: 'white', marginTop: 0, borderBottom: '1px solid #333', paddingBottom: '10px', display:'flex', justifyContent:'space-between', alignItems:'center' };

const formatMoney = (amount: number) => amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';

const getStatusBadge = (status: string) => {
    switch(status) {
        case 'pendiente': return { label: 'PENDIENTE DE REVISI√ìN', color: '#e67e22' }; 
        case 'presupuestado': return { label: 'PRESUPUESTADO', color: '#8e44ad' }; 
        case 'pedido': return { label: 'PEDIDO CONFIRMADO', color: '#27ae60' }; 
        case 'fabricacion': return { label: 'EN FABRICACI√ìN', color: '#d35400' }; 
        case 'rechazado': return { label: 'RECHAZADO', color: '#c0392b' }; 
        case 'cancelado': return { label: 'CANCELADO', color: '#7f8c8d' };
        default: return { label: status.toUpperCase(), color: '#95a5a6' };
    }
};

export const BudgetDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  
  const [order, setOrder] = useState<Order | null>(null);
  const [items3D, setItems3D] = useState<any[]>([]);
  const [manualItems, setManualItems] = useState<any[]>([]);
  const [messages, setMessages] = useState<any[]>([]);
  
  // Nombres y Notas
  const [customName, setCustomName] = useState('');
  
  // OBSERVACIONES (Historial)
  const [observations, setObservations] = useState<any[]>([]);
  const [newObservation, setNewObservation] = useState('');
  
  // Archivos
  const [attachments, setAttachments] = useState<any[]>([]);
  const [uploading, setUploading] = useState(false);

  // UI
  const [loading, setLoading] = useState(true);
  const [isCatalogOpen, setIsCatalogOpen] = useState(false);
  const [newMessage, setNewMessage] = useState('');
  const chatEndRef = useRef<HTMLDivElement>(null);
  
  // Modals
  const [parametricModal, setParametricModal] = useState<{isOpen: boolean, item: any | null, value: string}>({ isOpen: false, item: null, value: '' });
  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDestructive: false });
  const closeModal = () => setModal({ ...modal, isOpen: false });

  useEffect(() => { loadOrderData(); }, [id]);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const loadOrderData = async () => {
    if (!id) return;
    setLoading(true);

    const { data: orderData } = await supabase.from('orders').select('*, projects(*), profiles(discount_rate)').eq('id', id).single();
    if (!orderData) { navigate('/portal'); return; }
    
    // Items 3D (Carga segura)
    let calculated3DItems: any[] = [];
    const raw3DItems = orderData.projects?.data?.items || orderData.projects?.items || [];
    
    if (raw3DItems.length > 0) {
        calculated3DItems = raw3DItems.map((item: any) => ({
            uuid: item.uuid,
            name: item.name || 'Elemento 3D',
            quantity: 1,
            info: PriceCalculator.getItemDimensions(item),
            price: PriceCalculator.getItemPrice(item),
            is3D: true
        }));
    }
    setItems3D(calculated3DItems);
    setOrder(orderData as any);
    
    // Cargar Nombre si existe
    if(orderData.custom_name) setCustomName(orderData.custom_name);

    // Items Manuales
    const { data: mItems } = await supabase.from('order_items').select('*').eq('order_id', id);
    setManualItems(mItems || []);

    // Chat
    const { data: chatData } = await supabase.from('order_messages').select('*, profiles(full_name, role)').eq('order_id', id).order('created_at', { ascending: true });
    setMessages(chatData || []);

    // Adjuntos
    const { data: att } = await supabase.from('order_attachments').select('*').eq('order_id', id);
    setAttachments(att || []);

    // Cargar Historial Observaciones
    const { data: obs } = await supabase
        .from('order_observations')
        .select('*, profiles(full_name, role)')
        .eq('order_id', id)
        .order('created_at', { ascending: false }); 
    setObservations(obs || []);

    setLoading(false);
  };

  const calculateTotal = () => {
      const total3D = items3D.reduce((acc, item) => acc + item.price, 0);
      const totalManual = manualItems.reduce((acc, item) => acc + item.total_price, 0);
      const subtotal = total3D + totalManual;
      const discountRate = (order as any)?.profiles?.discount_rate || 0;
      const discountAmount = subtotal * (discountRate / 100);
      return { subtotal, discountRate, discountAmount, final: subtotal - discountAmount };
  };
  const totals = calculateTotal();

  // --- ACCIONES DATOS ---
  const handleSaveName = async () => {
      // Guardado directo del nombre
      const { error } = await supabase.from('orders').update({ custom_name: customName }).eq('id', id);
      if(error) alert("Error: " + error.message);
      else alert("‚úÖ Nombre guardado");
  };

  const handleAddObservation = async () => {
      if(!newObservation.trim()) return;
      const { data: { user } } = await supabase.auth.getUser();
      
      const { error } = await supabase.from('order_observations').insert([{
          order_id: id,
          user_id: user?.id,
          content: newObservation
      }]);
      
      if(error) alert("Error: " + error.message);
      else {
          setNewObservation('');
          loadOrderData();
      }
  };

  // --- ACCIONES ITEMS ---
  const handleAddItem = (item: any) => {
      if (order?.status !== 'pendiente') return alert("Solo puedes a√±adir elementos si el presupuesto est√° pendiente.");
      
      if (item.type === 'fence' || item.type === 'floor') {
          setParametricModal({ isOpen: true, item: item, value: '' });
      } else {
          saveManualItem(item.id, item.name, 1, item.price, '1 ud');
      }
  };

  const confirmParametricItem = () => {
      const val = parseFloat(parametricModal.value);
      if (!val || val <= 0) return alert("Valor inv√°lido");
      const item = parametricModal.item;
      let price = 0;
      let dimensions = '';
      if (item.type === 'fence') { price = val * PRICES.FENCE_M; dimensions = `${val} ml`; } 
      else { price = val * PRICES.FLOOR_M2; dimensions = `${val} m¬≤`; }
      saveManualItem(item.id, item.name, 1, price, dimensions);
      setParametricModal({ isOpen: false, item: null, value: '' });
  };

  const saveManualItem = async (prodId: string, name: string, qty: number, total: number, dims: string) => {
      await supabase.from('order_items').insert([{
          order_id: id, product_id: prodId, name: name, quantity: qty, total_price: total, dimensions: dims
      }]);
      setIsCatalogOpen(false);
      loadOrderData(); 
  };

  const handleDeleteManualItem = async (itemId: string) => {
      if (order?.status !== 'pendiente') return alert("Solo editable en fase pendiente.");
      if(!confirm("¬øBorrar l√≠nea?")) return;
      await supabase.from('order_items').delete().eq('id', itemId);
      loadOrderData();
  };

  // --- ARCHIVOS ---
  const handleFileUpload = async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;
      setUploading(true);
      try {
          const fileExt = file.name.split('.').pop();
          const fileName = `${Math.random()}.${fileExt}`;
          const filePath = `${id}/${fileName}`;
          await supabase.storage.from('attachments').upload(filePath, file);
          const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filePath);
          await supabase.from('order_attachments').insert([{
              order_id: id, file_name: file.name, file_url: publicUrl, uploader_id: (await supabase.auth.getUser()).data.user?.id
          }]);
          loadOrderData();
      } catch (error: any) { alert('Error al subir: ' + error.message); } 
      finally { setUploading(false); }
  };

  const handleDeleteAttachment = async (attId: string) => {
      if(!confirm("¬øBorrar archivo?")) return;
      await supabase.from('order_attachments').delete().eq('id', attId);
      loadOrderData();
  };

  // --- ESTADOS Y BOTONES ---
  const handleStatusChange = (status: string) => {
      setModal({
          isOpen: true,
          title: status === 'pedido' ? 'Confirmar Pedido' : 'Rechazar Presupuesto',
          message: status === 'pedido' ? 'Al aceptar, el pedido pasar√° a fabricaci√≥n.' : 'El presupuesto pasar√° a archivados.',
          isDestructive: status === 'rechazado',
          onConfirm: async () => {
              const update: any = { status: status, total_price: totals.final };
              if (status === 'pedido') {
                  const d = new Date(); d.setDate(d.getDate() + 42); 
                  update.estimated_delivery_date = d.toISOString();
              }
              await supabase.from('orders').update(update).eq('id', id);
              if (status==='pedido') navigate('/portal?tab=orders');
              else navigate('/portal?tab=archived');
              closeModal();
          }
      });
  };

  const handleDelete = () => {
      setModal({
          isOpen: true, title: 'Borrar Solicitud', message: 'Se borrar√° la solicitud y el dise√±o. ¬øContinuar?', isDestructive: true,
          onConfirm: async () => {
              await supabase.from('orders').delete().eq('id', id);
              navigate('/portal?tab=orders');
              closeModal();
          }
      });
  };
  
  const handleCancelOrder = () => {
      setModal({
          isOpen: true, title: 'Cancelar Pedido', message: 'El pedido pasar√° a cancelado.', isDestructive: true,
          onConfirm: async () => {
              await supabase.from('orders').update({ status: 'cancelado', is_archived: true }).eq('id', id);
              navigate('/portal?tab=archived');
              closeModal();
          }
      });
  };

  const handleSendMessage = async () => {
    if (!newMessage.trim() || !id) return;
    const { data: { user } } = await supabase.auth.getUser();
    await supabase.from('order_messages').insert([{ order_id: id, user_id: user?.id, content: newMessage }]);
    setNewMessage(''); loadOrderData();
  };

  if (loading) return <p style={{color:'#888', padding:'20px'}}>Cargando...</p>;
  if (!order) return <p>Error.</p>;

  const badge = getStatusBadge(order.status);
  const isPending = order.status === 'pendiente'; 
  const isDecisionTime = order.status === 'presupuestado';
  const isOrderConfirmed = order.status === 'pedido'; 
  const isLocked = !isPending && !isOrderConfirmed && order.status !== 'presupuestado';

  return (
    <div className="budget-detail-container">
      <ConfirmModal {...modal} onCancel={closeModal} />

      <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px', flexWrap:'wrap', gap:'10px'}}>
        <button onClick={() => navigate(-1)} style={{background:'none', border:'none', color:'#888', cursor:'pointer'}}>‚Üê Volver</button>
        <div style={{display:'flex', gap:'10px', alignItems:'center'}}>
             {isLocked && <span style={{color:'#888', fontSize:'12px', marginRight:'10px'}}>‚ö†Ô∏è Cambios solo v√≠a chat</span>}
             {isDecisionTime && (
                <>
                    <button onClick={() => handleStatusChange('pedido')} style={{background:'#27ae60', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer', fontWeight:'bold'}}>‚úÖ Aceptar Presupuesto</button>
                    <button onClick={() => handleStatusChange('rechazado')} style={{background:'#c0392b', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer', fontWeight:'bold'}}>‚ùå Rechazar</button>
                </>
             )}
             {isOrderConfirmed && <button onClick={handleCancelOrder} style={{background:'#c0392b', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer'}}>üö´ Cancelar Pedido</button>}
             {isPending && <button onClick={handleDelete} style={{background:'#c0392b', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer'}}>üóëÔ∏è Borrar Solicitud</button>}
        </div>
      </div>
      
      <div style={containerStyle}>
        
        {/* COLUMNA IZQUIERDA */}
        <div style={{ display:'flex', flexDirection:'column', gap:'10px' }}>
            
            {/* INFO Y NOMBRE */}
            <div style={cardStyle}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                    <h2 style={{margin:0, color:'white'}}>Ref: {order.order_ref}</h2>
                    <span style={{padding:'5px 10px', borderRadius:'4px', background: badge.color, color: 'white', fontWeight:'bold'}}>{badge.label}</span>
                </div>
                
                {/* CAMPO NOMBRE PERSONALIZADO */}
                <div style={{marginTop:'15px'}}>
                    <label style={{color:'#aaa', fontSize:'12px', display:'block', marginBottom:'5px'}}>Nombre del Proyecto / Referencia Personal:</label>
                    <div style={{display:'flex', gap:'10px'}}>
                        <input 
                            type="text" 
                            value={customName}
                            onChange={e => setCustomName(e.target.value)}
                            placeholder="Ej: Reforma Parque Infantil Comunidad..."
                            disabled={!isPending && !isDecisionTime}
                            style={{flex:1, padding:'10px', background:'#252525', border:'1px solid #444', borderRadius:'6px', color:'white'}}
                        />
                        {(isPending || isDecisionTime) && (
                            <button onClick={handleSaveName} style={{background:'#333', border:'1px solid #555', color:'white', borderRadius:'6px', padding:'0 15px', cursor:'pointer'}} title="Guardar Nombre">üíæ</button>
                        )}
                    </div>
                </div>
                
                <p style={{color:'#888', marginTop:'10px', fontSize:'13px'}}>Solicitado el: {new Date(order.created_at).toLocaleString()}</p>
                {order.estimated_delivery_date && (
                    <p style={{color:'#3498db', marginTop:'0', fontWeight:'bold'}}>üìÖ Fecha Entrega Estimada: {new Date(order.estimated_delivery_date).toLocaleDateString()}</p>
                )}
            </div>

            {/* OBSERVACIONES CRONOL√ìGICAS (NUEVO) */}
            <div style={cardStyle}>
                <h3 style={sectionHeaderStyle}>üìù Historial de Observaciones</h3>
                
                {/* Lista de observaciones anteriores */}
                <div style={{maxHeight:'200px', overflowY:'auto', marginBottom:'15px', display:'flex', flexDirection:'column', gap:'10px'}}>
                    {observations.length === 0 && <p style={{color:'#666', fontStyle:'italic', fontSize:'13px'}}>No hay observaciones registradas.</p>}
                    {observations.map(obs => (
                        <div key={obs.id} style={{background:'#252525', padding:'10px', borderRadius:'6px', borderLeft:`3px solid ${obs.profiles?.role === 'admin' ? '#e67e22' : '#3b82f6'}`}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'4px'}}>
                                <span style={{fontWeight:'bold', fontSize:'12px', color:'white'}}>
                                    {obs.profiles?.role === 'admin' ? 'üè¢ Administrador' : 'üë§ T√∫'}
                                </span>
                                <span style={{fontSize:'11px', color:'#888'}}>{new Date(obs.created_at).toLocaleString()}</span>
                            </div>
                            <p style={{margin:0, fontSize:'13px', color:'#ddd', whiteSpace:'pre-wrap'}}>{obs.content}</p>
                        </div>
                    ))}
                </div>

                {/* Input nueva observaci√≥n */}
                {(isPending || isDecisionTime) ? (
                    <div style={{display:'flex', gap:'10px'}}>
                        <input 
                            type="text" 
                            value={newObservation}
                            onChange={e => setNewObservation(e.target.value)}
                            placeholder="A√±adir nueva observaci√≥n o nota..."
                            style={{flex:1, padding:'10px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}}
                        />
                        <button onClick={handleAddObservation} style={{background:'#3b82f6', color:'white', border:'none', padding:'0 20px', borderRadius:'6px', cursor:'pointer'}}>A√±adir</button>
                    </div>
                ) : (
                    <p style={{fontSize:'12px', color:'#666'}}>* No se pueden a√±adir m√°s observaciones en este estado.</p>
                )}
            </div>

            {/* ARCHIVOS */}
            <div style={cardStyle}>
                <div style={sectionHeaderStyle}>
                    <h3 style={{margin:0}}>üìé Archivos y Planos</h3>
                    <label style={{background:'#333', color:'white', padding:'5px 10px', borderRadius:'4px', cursor:'pointer', fontSize:'12px', border:'1px solid #555'}}>
                        {uploading ? '...' : '+ Adjuntar'}
                        <input type="file" onChange={handleFileUpload} style={{display:'none'}} disabled={uploading} />
                    </label>
                </div>
                {attachments.length === 0 ? <p style={{color:'#666', fontSize:'13px'}}>Sin archivos.</p> : (
                    <ul style={{listStyle:'none', padding:0, margin:0}}>
                        {attachments.map(att => (
                            <li key={att.id} style={{display:'flex', justifyContent:'space-between', background:'#252525', padding:'8px', marginBottom:'5px', borderRadius:'4px'}}>
                                <a href={att.file_url} target="_blank" rel="noreferrer" style={{color:'#3b82f6', textDecoration:'none', fontSize:'13px'}}>{att.file_name}</a>
                                <button onClick={() => handleDeleteAttachment(att.id)} style={{border:'none', background:'none', color:'#e74c3c', cursor:'pointer'}}>üóëÔ∏è</button>
                            </li>
                        ))}
                    </ul>
                )}
            </div>

            {/* MATERIALES */}
            <div style={cardStyle}>
                <div style={sectionHeaderStyle}>
                    <h3 style={{margin:0}}>üìã Desglose</h3>
                    {isPending && <button onClick={() => setIsCatalogOpen(true)} style={{background:'#3b82f6', color:'white', border:'none', padding:'5px 15px', borderRadius:'4px', cursor:'pointer'}}>+ A√±adir Extra</button>}
                </div>

                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'14px', marginTop:'10px'}}>
                    <tbody>
                        {items3D.map((item, idx) => (
                            <tr key={`3d-${idx}`} style={{borderBottom:'1px solid #2a2a2a'}}>
                                <td style={{padding:'12px', color:'white'}}>{item.name}</td>
                                <td style={{padding:'12px', color:'#aaa', fontSize:'12px'}}>üïã 3D</td>
                                <td style={{padding:'12px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(item.price)}</td>
                            </tr>
                        ))}
                        {manualItems.map((item) => (
                            <tr key={item.id} style={{borderBottom:'1px solid #2a2a2a', background:'rgba(59, 130, 246, 0.05)'}}>
                                <td style={{padding:'12px', color:'white'}}>{item.name} <small>({item.dimensions})</small></td>
                                <td style={{padding:'12px', color:'#3b82f6', fontSize:'12px'}}>‚úèÔ∏è Manual</td>
                                <td style={{padding:'12px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(item.total_price)}</td>
                                <td style={{textAlign:'right'}}>
                                    {isPending && <button onClick={() => handleDeleteManualItem(item.id)} style={{color:'#e74c3c', background:'none', border:'none', cursor:'pointer'}}>üóëÔ∏è</button>}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                <div style={{marginTop:'20px', borderTop:'1px solid #333', textAlign:'right', paddingTop:'10px'}}>
                    {isPending ? (
                        <div style={{fontSize:'18px', color:'white'}}>Estimado: {formatMoney(totals.subtotal)}</div>
                    ) : (
                        <>
                            <div style={{color:'#aaa'}}>Subtotal: {formatMoney(totals.subtotal)}</div>
                            {totals.discountRate > 0 && <div style={{color:'#2ecc71'}}>Dto {totals.discountRate}%: -{formatMoney(totals.discountAmount)}</div>}
                            <div style={{fontSize:'22px', fontWeight:'bold', color:'#3b82f6', marginTop:'5px'}}>Total: {formatMoney(totals.final)}</div>
                        </>
                    )}
                </div>
            </div>

            {/* PROYECTO 3D */}
            {order.projects && (
                <div style={cardStyle}>
                     <h3 style={sectionHeaderStyle}>Dise√±o 3D</h3>
                     <div style={{height:'150px', background:'#000', borderRadius:'8px', display:'flex', alignItems:'center', justifyContent:'center', overflow:'hidden', border:'1px solid #333'}}>
                         {order.projects.thumbnail_url ? <img src={order.projects.thumbnail_url} style={{width:'100%', objectFit:'cover'}} alt="Vista"/> : 'üèûÔ∏è'}
                     </div>
                     <button onClick={() => window.location.href=`/?project_id=${order.project_id}&mode=readonly`} style={{marginTop:'15px', background:'#333', color:'white', border:'1px solid #555', padding:'10px', width:'100%', borderRadius:'6px', cursor:'pointer'}}>Abrir Visor 3D üëÅÔ∏è</button>
                </div>
            )}
        </div>

        {/* CHAT */}
        <div style={{...cardStyle, maxHeight:'80vh', marginBottom:0}}>
            <h3 style={sectionHeaderStyle}>üí¨ Chat</h3>
            <div style={{flex:1, overflowY:'auto', display:'flex', flexDirection:'column', gap:'10px', paddingRight:'5px'}}>
                {messages.map(msg => {
                    const isMe = msg.profiles?.role === 'client';
                    return (
                        <div key={msg.id} style={{alignSelf: isMe ? 'flex-end' : 'flex-start', maxWidth:'85%', background: isMe ? '#3b82f6' : '#444', color:'white', padding:'10px 15px', borderRadius:'12px'}}>
                            {msg.content}
                        </div>
                    );
                })}
                <div ref={chatEndRef} />
            </div>
            <div style={{marginTop:'15px', display:'flex', gap:'10px'}}>
                <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} onKeyDown={(e) => e.key==='Enter' && handleSendMessage()} placeholder="Mensaje..." style={{flex:1, padding:'10px', borderRadius:'6px', background:'#252525', border:'none', color:'white'}}/>
                <button onClick={handleSendMessage} style={{padding:'0 15px', background:'#3b82f6', border:'none', borderRadius:'6px', color:'white'}}>‚û§</button>
            </div>
        </div>
      </div>

      {/* MODALES CATALOGO (IGUAL QUE ADMIN) */}
      {isCatalogOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:999}}>
              <div style={{background:'#1e1e1e', width:'600px', maxHeight:'80vh', borderRadius:'12px', border:'1px solid #444', display:'flex', flexDirection:'column'}}>
                  <div style={{padding:'20px', borderBottom:'1px solid #333', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                      <h3 style={{margin:0, color:'white'}}>A√±adir Extra</h3>
                      <button onClick={() => setIsCatalogOpen(false)} style={{background:'none', border:'none', color:'#888', fontSize:'20px'}}>‚úï</button>
                  </div>
                  <div style={{padding:'20px', overflowY:'auto', display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                      {CATALOG_ITEMS.map(item => (
                          <div key={item.id} onClick={() => handleAddItem(item)} style={{background:'#252525', padding:'15px', borderRadius:'8px', cursor:'pointer', border:'1px solid #333'}}>
                              <div style={{fontWeight:'bold', color:'white'}}>{item.name}</div>
                              <div style={{color:'#888', fontSize:'12px'}}>{item.type === 'model' ? `${item.price} ‚Ç¨` : 'Param√©trico'}</div>
                          </div>
                      ))}
                  </div>
              </div>
          </div>
      )}
      {parametricModal.isOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:1000}}>
              <div style={{background:'#1e1e1e', padding:'30px', borderRadius:'12px', width:'350px', border:'1px solid #444'}}>
                  <h3 style={{margin:'0 0 15px 0', color:'white'}}>{parametricModal.item?.name}</h3>
                  <input type="number" autoFocus value={parametricModal.value} onChange={e => setParametricModal({...parametricModal, value: e.target.value})} placeholder="Cantidad" style={{width:'100%', padding:'10px', marginBottom:'20px'}}/>
                  <div style={{display:'flex', gap:'10px', justifyContent:'flex-end'}}>
                      <button onClick={() => setParametricModal({isOpen:false, item:null, value:''})}>Cancelar</button>
                      <button onClick={confirmParametricItem}>A√±adir</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/ClientDashboard.tsx">
import { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';
import { ConfirmModal } from '../../../components/ui/ConfirmModal';

// --- ESTILOS ---
const containerStyle = { color: '#e0e0e0', padding: '20px', fontFamily: 'sans-serif', minHeight: '100vh', display:'flex', flexDirection:'column' as const };
const headerStyle = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px', borderBottom: '1px solid #333', paddingBottom: '15px' };
const tabContainerStyle = { display: 'flex', gap: '20px', marginBottom: '20px', borderBottom: '1px solid #333' };
const tabStyle = (isActive: boolean) => ({
  cursor: 'pointer', padding: '10px 15px', borderBottom: isActive ? '3px solid #3b82f6' : '3px solid transparent',
  color: isActive ? '#fff' : '#888', fontWeight: isActive ? 'bold' : 'normal', transition: 'all 0.2s', marginBottom: '-2px'
});
const gridStyle = { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '20px' };
const cardStyle = { background: '#1e1e1e', border: '1px solid #333', borderRadius: '12px', overflow: 'hidden', display: 'flex', flexDirection: 'column' as const };
const cardImgStyle = { height: '160px', background: '#2a2a2a', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '40px', color: '#555', backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' };
const cardBodyStyle = { padding: '15px' };
const btnActionStyle = { flex: 1, padding: '8px', borderRadius: '6px', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: 'bold' };
const tableStyle = { width: '100%', borderCollapse: 'collapse' as const, background: '#1e1e1e', borderRadius: '8px', overflow: 'hidden' };
const thStyle = { textAlign: 'left' as const, padding: '15px', background: '#252525', color: '#aaa', borderBottom: '1px solid #333' };
const tdStyle = { padding: '15px', borderBottom: '1px solid #333' };

type TabType = 'projects' | 'budgets' | 'orders' | 'archived';

const getStatusColor = (status: string) => {
    switch(status) {
        case 'pedido': return '#3498db'; 
        case 'fabricacion': return '#e67e22'; 
        case 'entregado_parcial': return '#f1c40f'; 
        case 'entregado': return '#27ae60'; 
        case 'pendiente': return 'orange';
        case 'rechazado': return '#c0392b';
        case 'cancelado': return '#7f8c8d';
        default: return '#27ae60';
    }
};

export const ClientDashboard = () => {
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();
  const initialTab = (searchParams.get('tab') as TabType) || 'projects';
  const [activeTab, setActiveTab] = useState<TabType>(initialTab);
  
  const [projects, setProjects] = useState<any[]>([]);
  const [dataList, setDataList] = useState<any[]>([]); 
  const [loading, setLoading] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);

  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDestructive: false });
  const closeModal = () => setModal({ ...modal, isOpen: false });

  useEffect(() => { setSearchParams({ tab: activeTab }); }, [activeTab, setSearchParams]);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { navigate('/login'); return; }
      setUserId(user.id);

      try {
        if (activeTab === 'projects') {
          const { data } = await supabase.from('projects').select('*, orders(id)').eq('user_id', user.id).order('updated_at', { ascending: false });
          const cleanProjects = (data || []).filter((p: any) => !p.orders || p.orders.length === 0);
          setProjects(cleanProjects);
        }
        else {
            let query = supabase.from('orders').select('*, projects(name)').order('created_at', { ascending: false });
            
            if (activeTab === 'budgets') query = query.eq('is_archived', false).in('status', ['pendiente', 'presupuestado', 'rechazado']);
            else if (activeTab === 'orders') query = query.eq('is_archived', false).in('status', ['pedido', 'fabricacion', 'entregado_parcial', 'entregado', 'completado']);
            else if (activeTab === 'archived') query = query.eq('is_archived', true);

            const { data } = await query;
            setDataList(data || []);
        }
      } catch (error) { console.error(error); } finally { setLoading(false); }
    };
    fetchData();
  }, [activeTab, navigate]);

  const handleCreateManualBudget = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    const ref = 'MAN-' + Math.floor(10000 + Math.random() * 90000);
    
    const { data, error } = await supabase.from('orders').insert([{
        user_id: user?.id,
        order_ref: ref,
        status: 'pendiente',
        total_price: 0,
        is_archived: false,
        created_at: new Date().toISOString()
    }]).select();

    if (error) { alert("Error al crear: " + error.message); return; }
    if (data) navigate(`/portal/order/${data[0].id}`);
  };

  const handleRequestQuote = (project: any) => {
    setModal({
      isOpen: true, title: 'Solicitar Presupuesto', message: `¬øQuieres enviar "${project.name}" a revisi√≥n?`, isDestructive: false,
      onConfirm: async () => {
        const estimatedDate = new Date(); estimatedDate.setHours(estimatedDate.getHours() + 48);
        const ref = 'SOL-' + Math.floor(10000 + Math.random() * 90000);
        const { data } = await supabase.from('orders').insert([{ 
            user_id: userId, project_id: project.id, order_ref: ref, total_price: 0, 
            status: 'pendiente', estimated_delivery_date: estimatedDate.toISOString() 
        }]).select();
        
        if(data) { navigate(`/portal/order/${data[0].id}`); }
        closeModal();
      }
    });
  };

  const handleDeleteProject = (id: string) => {
    setModal({
      isOpen: true, title: 'Borrar Proyecto', message: '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.', isDestructive: true,
      onConfirm: async () => {
        await supabase.from('projects').delete().eq('id', id);
        setProjects(p => p.filter(x => x.id !== id));
        closeModal();
      }
    });
  };

  const handleReactivate = (order: any) => {
    setModal({
      isOpen: true, title: 'Reactivar Presupuesto', message: 'El presupuesto volver√° a la lista de "Mis Presupuestos".', isDestructive: false,
      onConfirm: async () => {
        await supabase.from('orders').update({ is_archived: false, status: 'pendiente', created_at: new Date().toISOString() }).eq('id', order.id);
        setActiveTab('budgets');
        closeModal();
      }
    });
  };

  return (
    <div style={containerStyle}>
      <ConfirmModal {...modal} onCancel={closeModal} />

      <div style={headerStyle}>
        <h2 style={{ margin: 0, color: '#fff' }}>Mi Espacio Personal</h2>
        <div style={{display:'flex', gap:'15px'}}>
             {/* --- BOTONES DE ACCI√ìN PRINCIPAL --- */}
            <button onClick={handleCreateManualBudget} style={{ background: '#3b82f6', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '6px', fontWeight: 'bold', cursor: 'pointer', display:'flex', alignItems:'center', gap:'8px' }}>
                üìù Crear Presupuesto Manual
            </button>
            <a href="/" style={{ background: '#27ae60', color: 'white', textDecoration: 'none', padding: '10px 20px', borderRadius: '6px', fontWeight: 'bold', display:'flex', alignItems:'center', gap:'8px' }}>
                + Nuevo Proyecto 3D
            </a>
        </div>
      </div>

      <div style={tabContainerStyle}>
        <div onClick={() => setActiveTab('projects')} style={tabStyle(activeTab === 'projects')}>üìÇ Mis Proyectos</div>
        <div onClick={() => setActiveTab('budgets')} style={tabStyle(activeTab === 'budgets')}>üìë Mis Presupuestos</div>
        <div onClick={() => setActiveTab('orders')} style={tabStyle(activeTab === 'orders')}>üì¶ Mis Pedidos</div>
        <div onClick={() => setActiveTab('archived')} style={tabStyle(activeTab === 'archived')}>üóÑÔ∏è Archivados</div>
      </div>

      {loading ? ( <p style={{color:'#666'}}>Cargando datos...</p> ) : (
        <>
            {activeTab === 'projects' && (
                <div style={gridStyle}>
                    {projects.map(p => (
                        <div key={p.id} style={cardStyle}>
                            <div style={{...cardImgStyle, backgroundImage: p.thumbnail_url ? `url(${p.thumbnail_url})` : 'none'}}>{!p.thumbnail_url && 'üèûÔ∏è'}</div>
                            <div style={cardBodyStyle}>
                                <h4 style={{margin:'0 0 5px 0', color:'white'}}>{p.name || 'Sin Nombre'}</h4>
                                <div style={{display:'flex', gap:'8px', marginTop:'10px'}}>
                                    <button onClick={() => navigate(`/?project_id=${p.id}`)} style={{...btnActionStyle, background:'#3b82f6', color:'white'}}>‚úèÔ∏è Editar</button>
                                    <button onClick={() => handleRequestQuote(p)} style={{...btnActionStyle, background:'#e67e22', color:'white'}}>üõí Pedir</button>
                                    <button onClick={() => handleDeleteProject(p.id)} style={{...btnActionStyle, background:'#e74c3c', color:'white', flex:0}}>üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    ))}
                    {projects.length === 0 && <p style={{color:'#666'}}>No tienes proyectos pendientes.</p>}
                </div>
            )}

            {activeTab !== 'projects' && (
                <table style={tableStyle}>
                    <thead>
                        <tr>
                            <th style={thStyle}>Ref</th>
                            <th style={thStyle}>Proyecto</th>
                            <th style={thStyle}>{activeTab === 'orders' ? 'F. Inicio Pedido' : 'F. Solicitud'}</th>
                            <th style={thStyle}>F. Entrega Est.</th>
                            <th style={thStyle}>Estado</th>
                            <th style={thStyle}>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {dataList.map(o => (
                            <tr key={o.id} style={{borderBottom:'1px solid #333'}}>
                                <td style={tdStyle}><strong style={{color:'#fff'}}>{o.order_ref}</strong></td>
                                <td style={tdStyle}>{o.projects?.name || '---'}</td>
                                <td style={tdStyle}>{new Date(o.created_at).toLocaleDateString()}</td>
                                <td style={{...tdStyle, color: o.estimated_delivery_date ? '#ccc' : '#666'}}>
                                    {o.estimated_delivery_date ? new Date(o.estimated_delivery_date).toLocaleDateString() : '--'}
                                </td>
                                <td style={tdStyle}>
                                    <span style={{ color: getStatusColor(o.status), fontWeight:'bold', textTransform:'uppercase', fontSize:'12px'}}>
                                        {o.status.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style={tdStyle}>
                                    {activeTab === 'archived' ? (
                                        <button onClick={() => handleReactivate(o)} style={{background:'#3b82f6', color:'white', border:'none', padding:'5px 10px', borderRadius:'4px', cursor:'pointer'}}>Reactivar üîÑ</button>
                                    ) : (
                                        <button onClick={() => navigate(`/portal/order/${o.id}`)} style={{background:'#333', color:'white', border:'1px solid #555', padding:'5px 10px', borderRadius:'4px', cursor:'pointer'}}>Ver Ficha üëÅÔ∏è</button>
                                    )}
                                </td>
                            </tr>
                        ))}
                        {dataList.length === 0 && (
                            <tr><td colSpan={6} style={{padding:'20px', textAlign:'center', color:'#666'}}>No hay datos en esta secci√≥n.</td></tr>
                        )}
                    </tbody>
                </table>
            )}
        </>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/CrmDashboard.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';

// ESTILOS
const containerStyle = { color: '#e0e0e0', padding: '20px', fontFamily: 'sans-serif' };
const headerStyle = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px', borderBottom: '1px solid #333', paddingBottom: '15px' };
const tabBtnStyle = (active: boolean) => ({
  background: active ? '#e67e22' : '#333', color: active ? '#fff' : '#aaa',
  border: 'none', padding: '10px 20px', marginRight: '10px', borderRadius: '6px', cursor: 'pointer', fontWeight: 'bold' as const
});
const tableStyle = { width: '100%', borderCollapse: 'collapse' as const, fontSize: '13px', background: '#1e1e1e', borderRadius: '8px', overflow: 'hidden' };
const thStyle = { textAlign: 'left' as const, padding: '12px', background: '#2a2a2a', color: '#888', borderBottom: '1px solid #333', whiteSpace: 'nowrap' as const };
const tdStyle = { padding: '12px', borderBottom: '1px solid #333', verticalAlign: 'middle' };
const selectStyle = {
    background: '#252525', color: 'white', border: '1px solid #444', padding: '4px', borderRadius: '4px', cursor: 'pointer', maxWidth: '130px'
};

const formatMoney = (amount: number) => amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';

const BUDGET_STATUSES = ['pendiente', 'presupuestado', 'rechazado'];
const ORDER_STATUSES = ['pedido', 'fabricacion', 'entregado_parcial', 'entregado', 'completado', 'cancelado'];

export const CrmDashboard = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<'clients' | 'budgets' | 'orders'>('budgets');
  const [loading, setLoading] = useState(false);
  const [dataList, setDataList] = useState<any[]>([]);
  const [clients, setClients] = useState<any[]>([]);
  
  // Modal Cliente
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [newClientData, setNewClientData] = useState({ email: '', company_name: '', full_name: '', phone: '', discount_rate: 0 });

  useEffect(() => { loadData(); }, [activeTab]);

  const loadData = async () => {
    setLoading(true);
    try {
      if (activeTab === 'clients') {
        const { data } = await supabase.from('profiles').select('*, is_approved').order('created_at', { ascending: false });
        setClients(data || []);
      } else {
        // CORRECCI√ìN: A√±adido 'discount_rate' en el select de profiles
        let query = supabase.from('orders')
            .select(`*, profiles(company_name, email, discount_rate), projects(name), order_messages(created_at, profiles(role))`)
            .order('created_at', { ascending: false });
        
        if (activeTab === 'budgets') query = query.in('status', BUDGET_STATUSES);
        else if (activeTab === 'orders') query = query.in('status', ORDER_STATUSES);

        const { data } = await query;
        setDataList(data || []);
      }
    } catch (err: any) { console.error(err); } finally { setLoading(false); }
  };

  const handleApproveClient = async (clientId: string) => {
    const { error } = await supabase.from('profiles').update({ is_approved: true }).eq('id', clientId);
    if (!error) { alert("Usuario aprobado."); loadData(); }
  };

  const handleCreateClient = async () => {
    if (!newClientData.email) return alert("Email obligatorio");
    const { error } = await supabase.from('pre_clients').insert([newClientData]);
    if (error) alert("Error: " + error.message);
    else {
        alert(`‚úÖ Ficha creada para ${newClientData.email}.`);
        setShowCreateModal(false);
        setNewClientData({ email: '', company_name: '', full_name: '', phone: '', discount_rate: 0 });
    }
  };

  const handleDeleteClient = async (id: string) => {
    if(!confirm("¬øBorrar cliente?")) return;
    await supabase.from('profiles').delete().eq('id', id);
    loadData();
  };
  const handleDeleteOrder = async (id: string) => {
    if(!confirm("¬øBorrar registro?")) return;
    await supabase.from('orders').delete().eq('id', id);
    loadData();
  };
  
  const handleStatusUpdate = async (id: string, newStatus: string) => {
      const confirmMsg = `¬øCambiar estado a "${newStatus.toUpperCase()}"?`;
      if(!confirm(confirmMsg)) return; 
      
      const updateData: any = { status: newStatus };
      const now = new Date();
      
      if (newStatus === 'pedido') updateData.estimated_delivery_date = new Date(now.getTime() + (6 * 7 * 24 * 60 * 60 * 1000)).toISOString();
      else if (newStatus === 'presupuestado') updateData.estimated_delivery_date = new Date(now.getTime() + (48 * 60 * 60 * 1000)).toISOString();

      await supabase.from('orders').update(updateData).eq('id', id);
      loadData();
  };

  const getAlertStatus = (order: any) => {
    const messages = order.order_messages || [];
    messages.sort((a: any, b: any) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
    if (!messages[0]) return null;
    if (messages[0].profiles?.role === 'client') return { icon: 'üî¥', text: 'Cliente escribi√≥' };
    return { icon: 'üü¢', text: 'Respondido' };
  };

  return (
    <div style={containerStyle}>
      <div style={headerStyle}>
        <div><h2 style={{ margin: 0, color: 'white' }}>Panel de Control üè¢</h2><small>Vista Administrador</small></div>
        <div style={{display:'flex', gap:'10px'}}>
          <button onClick={() => setActiveTab('clients')} style={tabBtnStyle(activeTab === 'clients')}>üë• Clientes</button>
          <button onClick={() => setActiveTab('budgets')} style={tabBtnStyle(activeTab === 'budgets')}>üìë Presupuestos</button>
          <button onClick={() => setActiveTab('orders')} style={tabBtnStyle(activeTab === 'orders')}>üì¶ Pedidos</button>
          <button onClick={() => loadData()} style={{...tabBtnStyle(false), background: '#27ae60', color: 'white'}}>üîÑ</button>
        </div>
      </div>

      {loading ? <p>Cargando...</p> : (
        <>
          {(activeTab === 'budgets' || activeTab === 'orders') && (
             <div style={{overflowX: 'auto'}}>
                <table style={tableStyle}>
                  <thead>
                    <tr>
                      <th style={thStyle}>Aviso</th>
                      <th style={thStyle}>REF</th>
                      <th style={thStyle}>Cliente</th>
                      <th style={thStyle}>Estado</th>
                      <th style={thStyle}>F. Solicitud</th>
                      <th style={thStyle}>F. Entrega Est.</th>
                      <th style={{...thStyle, borderLeft:'1px solid #444'}}>Total / Oferta</th>
                      <th style={thStyle}>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {dataList.map(o => {
                        const alert = getAlertStatus(o);
                        // --- C√ÅLCULO VISUAL DE DESCUENTOS ---
                        const finalPrice = o.total_price || 0;
                        const discount = o.profiles?.discount_rate || 0;
                        let basePrice = finalPrice;
                        
                        // Si hay descuento, calculamos el precio base original inverso
                        // Precio Final = Base * (1 - Dto/100)  =>  Base = Precio Final / (1 - Dto/100)
                        if (discount > 0 && finalPrice > 0) {
                            basePrice = finalPrice / (1 - (discount / 100));
                        }

                        return (
                        <tr key={o.id}>
                            <td style={{...tdStyle, textAlign:'center'}} title={alert?.text}>{alert ? alert.icon : '‚ö™'}</td>
                            <td style={tdStyle}>
                                <strong>{o.order_ref}</strong>
                                {o.custom_name && <div style={{fontSize:'11px', color:'#aaa'}}>{o.custom_name}</div>}
                            </td>
                            <td style={{...tdStyle, color: o.profiles ? '#4a90e2' : '#999'}}>{o.profiles ? (o.profiles.company_name || o.profiles.email) : 'Eliminado'}</td>
                            <td style={tdStyle}>
                                <select value={o.status} onChange={(e) => handleStatusUpdate(o.id, e.target.value)} style={selectStyle}>
                                    {activeTab==='budgets' ? (
                                        <>
                                            <option value="pendiente">üü† Pendiente</option>
                                            <option value="presupuestado">üü£ Presupuestado</option>
                                            <option value="rechazado">üî¥ Rechazado</option>
                                            <option value="pedido">‚û°Ô∏è A PEDIDO</option>
                                        </>
                                    ) : (
                                        <>
                                            <option value="pedido">üîµ Pedido</option>
                                            <option value="fabricacion">üü† Fabricaci√≥n</option>
                                            <option value="entregado">üü¢ Entregado</option>
                                            <option value="completado">üèÅ Completado</option>
                                        </>
                                    )}
                                </select>
                            </td>
                            <td style={tdStyle}>{new Date(o.created_at).toLocaleDateString()}</td>
                            <td style={tdStyle}>
                                {o.estimated_delivery_date ? (
                                    <span style={{color: activeTab === 'orders' ? '#e67e22' : '#ccc'}}>
                                        {new Date(o.estimated_delivery_date).toLocaleDateString()}
                                    </span>
                                ) : '--'}
                            </td>
                            
                            {/* COLUMNA TOTAL MODIFICADA */}
                            <td style={tdStyle}>
                                {discount > 0 ? (
                                    <div style={{display:'flex', flexDirection:'column', alignItems:'flex-start'}}>
                                        <span style={{textDecoration:'line-through', color:'#666', fontSize:'11px'}}>
                                            Base: {formatMoney(basePrice)}
                                        </span>
                                        <span style={{color:'white', fontWeight:'bold'}}>
                                            {formatMoney(finalPrice)} 
                                            <span style={{color:'#e67e22', fontSize:'11px', marginLeft:'5px'}}>({discount}%)</span>
                                        </span>
                                    </div>
                                ) : (
                                    <span style={{fontWeight:'bold'}}>{formatMoney(finalPrice)}</span>
                                )}
                            </td>

                            <td style={tdStyle}>
                                <button onClick={() => navigate(`/admin/order/${o.id}`)} style={{background:'#333', color:'white', border:'1px solid #555', padding:'5px 10px', borderRadius:'4px', marginRight:'5px'}}>üëÅÔ∏è</button>
                                <button onClick={() => handleDeleteOrder(o.id)} style={{background:'none', border:'none', color:'#666'}}>üóëÔ∏è</button>
                            </td>
                        </tr>
                    )})}
                    {dataList.length === 0 && <tr><td colSpan={8} style={{padding:'20px', textAlign:'center', color:'#666'}}>Sin datos.</td></tr>}
                  </tbody>
                </table>
             </div>
          )}

          {activeTab === 'clients' && (
            <div>
                <div style={{marginBottom:'15px', textAlign:'right'}}>
                    <button onClick={() => setShowCreateModal(true)} style={{background:'#3b82f6', color:'white', border:'none', padding:'10px 20px', borderRadius:'6px', fontWeight:'bold', cursor:'pointer'}}>+ Nuevo Cliente</button>
                </div>
                <table style={tableStyle}>
                <thead>
                    <tr>
                        <th style={thStyle}>Estado</th>
                        <th style={thStyle}>Empresa</th>
                        <th style={thStyle}>Email</th>
                        <th style={thStyle}>Dto.</th>
                        <th style={thStyle}>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {clients.map(c => (
                    <tr key={c.id}>
                        <td style={tdStyle}>{c.is_approved ? <span title="Activo">‚úÖ</span> : <button onClick={() => handleApproveClient(c.id)} style={{background:'#e67e22', color:'white', border:'none', padding:'4px 8px', borderRadius:'4px', cursor:'pointer'}}>Aprobar</button>}</td>
                        <td style={{...tdStyle, fontWeight:'bold'}}>{c.company_name || '---'}</td>
                        <td style={tdStyle}>{c.email}</td>
                        <td style={{...tdStyle, color:'#2ecc71', fontWeight:'bold'}}>{c.discount_rate}%</td>
                        <td style={tdStyle}>
                            <button onClick={() => navigate(`/admin/client/${c.id}`)} style={{background:'#333', color:'white', border:'1px solid #555', padding:'5px 10px', borderRadius:'4px', marginRight:'5px'}}>Ficha</button>
                            <button onClick={() => handleDeleteClient(c.id)} style={{background:'none', border:'none', color:'#e74c3c'}}>üóëÔ∏è</button>
                        </td>
                    </tr>
                    ))}
                </tbody>
                </table>
            </div>
          )}
        </>
      )}

      {showCreateModal && (
        <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.7)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:9999}}>
            <div style={{background:'#1e1e1e', padding:'30px', borderRadius:'12px', width:'400px', border:'1px solid #444'}}>
                <h3 style={{marginTop:0, color:'white'}}>Dar de Alta Cliente</h3>
                <input type="email" placeholder="Email (Obligatorio)" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.email} onChange={e => setNewClientData({...newClientData, email: e.target.value})} />
                <input type="text" placeholder="Nombre Empresa" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.company_name} onChange={e => setNewClientData({...newClientData, company_name: e.target.value})} />
                <input type="text" placeholder="Contacto" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.full_name} onChange={e => setNewClientData({...newClientData, full_name: e.target.value})} />
                <input type="text" placeholder="Tel√©fono" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.phone} onChange={e => setNewClientData({...newClientData, phone: e.target.value})} />
                <input type="number" placeholder="Descuento %" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.discount_rate} onChange={e => setNewClientData({...newClientData, discount_rate: parseFloat(e.target.value)})} />
                
                <div style={{display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                    <button onClick={() => setShowCreateModal(false)} style={{background:'transparent', color:'#888', border:'none', cursor:'pointer'}}>Cancelar</button>
                    <button onClick={handleCreateClient} style={{background:'#3b82f6', color:'white', border:'none', padding:'10px 20px', borderRadius:'6px', fontWeight:'bold', cursor:'pointer'}}>Crear</button>
                </div>
            </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/ProfilePage.tsx">
import { useEffect, useState } from 'react';
import { supabase } from '../../../lib/supabase';
import type { Profile } from '../../../types/types';

const inputStyle = {
  width: '100%',
  padding: '10px',
  background: '#2a2a2a',
  border: '1px solid #444',
  borderRadius: '6px',
  color: 'white',
  marginTop: '5px'
};

const labelStyle = { display: 'block', marginBottom: '15px', color: '#aaa', fontSize: '14px' };
const sectionTitleStyle = { color: '#e67e22', borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', marginTop: '30px' };

export const ProfilePage = () => {
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
  
  const [formData, setFormData] = useState<Partial<Profile>>({
    company_name: '',
    full_name: '',
    email: '', // A√±adido campo email
    cif: '',
    phone: '',
    shipping_address: '',
    billing_address: '',
    billing_email: '',
    observations: ''
  });

  useEffect(() => {
    loadProfile();
  }, []);

  const loadProfile = async () => {
    setLoading(true);
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (data) setFormData(data);
    }
    setLoading(false);
  };

  const handleSave = async () => {
    setLoading(true);
    setMessage(null);
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) return;

    try {
      const { error } = await supabase
        .from('profiles')
        .update(formData)
        .eq('id', user.id);

      if (error) throw error;
      setMessage({ text: '‚úÖ Perfil actualizado correctamente', type: 'success' });
    } catch (error: any) {
      setMessage({ text: '‚ùå Error al guardar: ' + error.message, type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: '800px', margin: '0 auto', color: '#e0e0e0' }}>
      <h2 style={{ color: 'white' }}>Mi Zona Personal</h2>
      <p style={{ color: '#888' }}>Gestiona tus datos de facturaci√≥n y env√≠o.</p>

      {message && (
        <div style={{ 
          padding: '10px', 
          borderRadius: '6px', 
          background: message.type === 'success' ? 'rgba(39, 174, 96, 0.2)' : 'rgba(231, 76, 60, 0.2)',
          color: message.type === 'success' ? '#2ecc71' : '#e74c3c',
          marginBottom: '20px'
        }}>
          {message.text}
        </div>
      )}

      <div style={{ background: '#1e1e1e', padding: '30px', borderRadius: '12px', border: '1px solid #333' }}>
        
        {/* DATOS EMPRESA */}
        <h4 style={{ ...sectionTitleStyle, marginTop: 0 }}>üè¢ Datos Fiscales</h4>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
          <label style={labelStyle}>
            Nombre Empresa
            <input 
              type="text" 
              style={inputStyle} 
              value={formData.company_name || ''} 
              onChange={e => setFormData({...formData, company_name: e.target.value})} 
            />
          </label>
          <label style={labelStyle}>
            CIF / NIF
            <input 
              type="text" 
              style={inputStyle} 
              value={formData.cif || ''} 
              onChange={e => setFormData({...formData, cif: e.target.value})} 
            />
          </label>
        </div>

        {/* CONTACTO */}
        <h4 style={sectionTitleStyle}>üë§ Contacto Principal</h4>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
          <label style={labelStyle}>
            Nombre Completo
            <input 
              type="text" 
              style={inputStyle} 
              value={formData.full_name || ''} 
              onChange={e => setFormData({...formData, full_name: e.target.value})} 
            />
          </label>
          <label style={labelStyle}>
            Tel√©fono
            <input 
              type="tel" 
              style={inputStyle} 
              value={formData.phone || ''} 
              onChange={e => setFormData({...formData, phone: e.target.value})} 
            />
          </label>
        </div>
        
        {/* NUEVO: EMAIL DE CONTACTO */}
        <label style={labelStyle}>
            Email de Contacto (CRM)
            <input 
              type="email" 
              style={inputStyle} 
              value={formData.email || ''} 
              onChange={e => setFormData({...formData, email: e.target.value})} 
              placeholder="ejemplo@empresa.com"
            />
        </label>

        <label style={labelStyle}>
            Email para Facturaci√≥n (si es distinto)
            <input 
              type="email" 
              style={inputStyle} 
              value={formData.billing_email || ''} 
              onChange={e => setFormData({...formData, billing_email: e.target.value})} 
              placeholder="contabilidad@empresa.com..."
            />
        </label>

        {/* DIRECCIONES */}
        <h4 style={sectionTitleStyle}>üìç Direcciones</h4>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
            <label style={labelStyle}>
                Direcci√≥n de Env√≠o
                <textarea 
                rows={3}
                style={{...inputStyle, resize: 'none'}} 
                value={formData.shipping_address || ''} 
                onChange={e => setFormData({...formData, shipping_address: e.target.value})} 
                />
            </label>
            <label style={labelStyle}>
                Direcci√≥n de Facturaci√≥n
                <textarea 
                rows={3}
                style={{...inputStyle, resize: 'none'}} 
                value={formData.billing_address || ''} 
                onChange={e => setFormData({...formData, billing_address: e.target.value})} 
                />
            </label>
        </div>

        {/* OBSERVACIONES */}
        <h4 style={sectionTitleStyle}>üìù Otros</h4>
        <label style={labelStyle}>
            Observaciones Generales
            <textarea 
              rows={2}
              style={{...inputStyle, resize: 'none'}} 
              value={formData.observations || ''} 
              onChange={e => setFormData({...formData, observations: e.target.value})} 
            />
        </label>

        <div style={{ marginTop: '30px', display: 'flex', justifyContent: 'flex-end' }}>
          <button 
            onClick={handleSave} 
            disabled={loading}
            style={{ 
              background: '#3b82f6', 
              color: 'white', 
              border: 'none', 
              padding: '12px 30px', 
              borderRadius: '6px', 
              fontWeight: 'bold', 
              cursor: loading ? 'wait' : 'pointer',
              opacity: loading ? 0.7 : 1
            }}
          >
            {loading ? 'Guardando...' : 'Guardar Cambios'}
          </button>
        </div>

      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/context/EngineContext.tsx">
import { createContext, useContext } from 'react';
import type { A42Engine } from '../engine/A42Engine';

// Definimos el tipo del contexto
interface EngineContextType {
  engine: A42Engine | null;
}

// Creamos el contexto
export const EngineContext = createContext<EngineContextType>({
  engine: null,
});

// Hook personalizado para usar el motor f√°cilmente
export const useEngine = () => {
  const context = useContext(EngineContext);
  if (context === undefined) {
    throw new Error('useEngine must be used within an EngineProvider');
  }
  return context.engine;
};
</file>

<file path="src/features/editor/data/fence_presets.ts">
// --- START OF FILE src/features/editor/data/fence_presets.ts ---
export interface FencePreset {
    name: string;
    ref: string;
    price: number;
    postType: 'square' | 'round';
    postWidth?: number;
    postRadius?: number;
    postHeight: number;
    railType: 'frame' | 'none';
    railShape?: 'square' | 'round';
    railThickness?: number;
    railRadius?: number;
    slatWidth: number;
    slatThickness: number;
    slatGap?: number;
    fixedCount?: number;
    multiColor?: boolean;
    isSolidPanel?: boolean;
    defaultColors: {
        post: number;
        slatA: number;
        slatB?: number;
        slatC?: number;
    };
}

export const FENCE_PRESETS: Record<string, FencePreset> = {
    "wood": {
        name: "Valla Madera Cl√°sica",
        ref: "VALMAD-01",
        price: 36,
        postType: "square",
        postWidth: 0.1,
        postHeight: 1.0,
        railType: "frame",
        railShape: "square",
        railThickness: 0.08, 
        slatWidth: 0.1,
        slatThickness: 0.02,
        slatGap: 0.05,
        defaultColors: { 
            post: 0x8b5a2b, 
            slatA: 0xd2b48c 
        }
    },
    "metal_slats": {
        name: "Valla Met√°lica Fina",
        ref: "VALFN-01",
        price: 42,
        postType: "round",
        postRadius: 0.04,
        postHeight: 1.0,
        railType: "frame",
        railShape: "round",
        railRadius: 0.03,
        slatWidth: 0.08,
        slatThickness: 0.01,
        fixedCount: 9,
        multiColor: true,
        defaultColors: { 
            post: 0x1a1a1a, 
            slatA: 0xcccccc, 
            slatB: 0x888888, 
            slatC: 0x444444 
        }
    },
    "wide_panel": {
        name: "Valla Met√°lica Ancha",
        ref: "VALAN-01",
        price: 45,
        postType: "round",
        postRadius: 0.04,
        postHeight: 1.0,
        railType: "frame",
        railShape: "round",
        railRadius: 0.04,
        slatWidth: 0.20,
        slatThickness: 0.02,
        fixedCount: 6,
        multiColor: true,
        defaultColors: { 
            post: 0x222222, 
            slatA: 0x22c55e, 
            slatB: 0x3b82f6, 
            slatC: 0xeab308 
        }
    },
    "game_panel": {
        name: "Valla Lisa / Panel",
        ref: "VALLI-01",
        price: 61,
        postType: "round",
        postRadius: 0.04,
        postHeight: 1.0,
        railType: "frame",
        railShape: "round",
        railRadius: 0.03,
        isSolidPanel: true,
        slatWidth: 1.0,
        slatThickness: 0.02,
        defaultColors: { 
            post: 0x111111, 
            slatA: 0xffffff 
        }
    }
};
// --- END OF FILE src/features/editor/data/fence_presets.ts ---
</file>

<file path="src/features/editor/Editor3D.tsx">
import React, { useEffect, useRef, useState, useCallback } from "react";
import { A42Engine } from "./engine/A42Engine";
import { EngineContext } from "./context/EngineContext";

import { Toolbar } from "./ui/Toolbar";
import { BudgetPanel } from "./ui/BudgetPanel";
import { EnvironmentPanel } from "./ui/EnvironmentPanel";
import { FloorProperties } from "./ui/FloorProperties";
import { FenceProperties } from "./ui/FenceProperties";
import { InputModal } from "./ui/InputModal";
import { QRModal } from "./ui/QRModal";
import { Catalog } from "./ui/Catalog";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { useProjectStore } from "@/stores/project/useProjectStore";

import {
  Euro,
  Move,
  RotateCw,
  Scaling,
  Trash2,
  Copy,
  QrCode,
} from "lucide-react";

export const Editor3D = () => {
  const containerRef = useRef<HTMLDivElement>(null);
  const [engineInstance, setEngineInstance] = useState<A42Engine | null>(null);

  // --- Editor store (usamos 'any' para evitar choques de tipos) ---
  const mode = useEditorStore((s: any) => s.mode as string);
  const gridVisible = useEditorStore((s) => s.gridVisible);
  const cameraType = useEditorStore((s: any) => s.cameraType as string);
  const pendingView = useEditorStore(
    (s: any) => s.pendingView as any | null
  );
  const clearPendingView = useEditorStore(
    (s: any) => s.clearPendingView as () => void
  );
  const sunPosition = useEditorStore(
    (s: any) =>
      (s.sunPosition as { azimuth: number; elevation: number }) ?? {
        azimuth: 0,
        elevation: 45,
      }
  );
  const backgroundColor = useEditorStore((s) => s.backgroundColor);
  const safetyZonesVisible = useEditorStore(
    (s: any) => (s.safetyZonesVisible as boolean) ?? true
  );
  const measurementResult = useEditorStore(
    (s: any) => (s.measurementResult as number | null) ?? null
  );

  // --- Scene store ---
  const items = useSceneStore((s) => s.items);
  const totalPrice = useSceneStore(
    (s: any) => (s.totalPrice as number) ?? 0
  );

  // --- Selection store: usamos selectedUUID, que sabemos que existe ---
  const selectedUUID = useSelectionStore(
    (s: any) => s.selectedUUID as string | null
  );

  // --- Project store ---
  const isReadOnlyMode = useProjectStore(
    (s: any) => (s.isReadOnlyMode as boolean) ?? false
  );

  const [qrVisible, setQRVisible] = React.useState(false);

  // ============================================================
  // 1. INICIALIZACI√ìN DEL MOTOR
  // ============================================================
  useEffect(() => {
    if (!containerRef.current) return;

    const engine = new A42Engine(containerRef.current);
    engine.init();

    setEngineInstance(engine);

    const handlePointerDown = (e: PointerEvent) => {
      // solo clicks sobre el canvas, no sobre la UI
      if ((e.target as HTMLElement).tagName === "CANVAS") {
        // Transformamos a MouseEvent para que encaje con la firma
        engine.interactionManager.onPointerDown(e as unknown as MouseEvent);
      }
    };

    const container = containerRef.current;
    container.addEventListener("pointerdown", handlePointerDown);

    // Config inicial
    engine.setGrid(gridVisible);
    engine.updateSunPosition?.(sunPosition.azimuth, sunPosition.elevation);
    if (backgroundColor === "#111111") engine.setSky(true);
    else engine.setBackground(backgroundColor);

    return () => {
      container.removeEventListener("pointerdown", handlePointerDown);
      engine.dispose();
      setEngineInstance(null);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ============================================================
  // 2. LIMPIEZA DE HERRAMIENTAS AL CAMBIAR MODO
  // ============================================================
  useEffect(() => {
    if (engineInstance) {
      engineInstance.clearTools();
    }
  }, [mode, engineInstance]);

  // ============================================================
  // 3. SINCRONIZACI√ìN SELECCI√ìN UI ‚Üí ENGINE
  // ============================================================
  useEffect(() => {
    if (!engineInstance) return;
    engineInstance.interactionManager.selectItemByUUID(selectedUUID);
  }, [selectedUUID, engineInstance]);

  // ============================================================
  // 4. SINCRONIZACI√ìN ESCENA STORE ‚Üí ENGINE
  // ============================================================
  useEffect(() => {
    if (!engineInstance) return;
    // syncScene es el m√©todo p√∫blico del motor; si el tipo no encaja, usamos any
    (engineInstance as any).syncScene(items as any);
  }, [items, engineInstance]);

  // ============================================================
  // 5. REACTIVIDAD SOBRE PROPIEDADES DEL EDITOR
  // ============================================================
  useEffect(() => {
    engineInstance?.setGrid(gridVisible);
  }, [gridVisible, engineInstance]);

  useEffect(() => {
    if (!engineInstance) return;
    engineInstance.switchCamera(cameraType as any);
    engineInstance.interactionManager.updateCamera(engineInstance.activeCamera);
  }, [cameraType, engineInstance]);

  useEffect(() => {
    if (!engineInstance) return;

    // Mostrado/ocultado de zonas de seguridad directamente sobre la escena
    engineInstance.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone) {
        obj.visible = safetyZonesVisible;
      }
    });
  }, [safetyZonesVisible, engineInstance]);

  useEffect(() => {
    if (!engineInstance) return;
    engineInstance.updateSunPosition?.(
      sunPosition.azimuth,
      sunPosition.elevation
    );
  }, [sunPosition, engineInstance]);

  useEffect(() => {
    if (!pendingView || !engineInstance) return;
    engineInstance.setView(pendingView as any);
    clearPendingView();
  }, [pendingView, clearPendingView, engineInstance]);

  useEffect(() => {
    if (!engineInstance) return;
    if (backgroundColor === "#111111") engineInstance.setSky(true);
    else engineInstance.setBackground(backgroundColor);
  }, [backgroundColor, engineInstance]);

  // ============================================================
  // 6. ACCIONES SOBRE LA SELECCI√ìN (duplicar / eliminar)
  // ============================================================
  const handleDuplicateSelection = useCallback(() => {
    if (!selectedUUID) return;

    const sceneState = useSceneStore.getState() as any;
    const currentItems = sceneState.items as any[];
    const original = currentItems.find((i) => i.uuid === selectedUUID);
    if (!original) return;

    const newUuid = crypto.randomUUID();
    const newItem = {
      ...original,
      uuid: newUuid,
      position: [
        original.position[0] + 1,
        original.position[1],
        original.position[2],
      ] as [number, number, number],
    };

    sceneState.addItem(newItem);
  }, [selectedUUID]);

  const handleRemoveSelection = useCallback(() => {
    if (!selectedUUID || !engineInstance) return;

    const sceneState = useSceneStore.getState() as any;
    sceneState.removeItem(selectedUUID);

    engineInstance.objectManager.removeByUUID(selectedUUID);

    const selState = useSelectionStore.getState() as any;
    selState.select(null);
  }, [selectedUUID, engineInstance]);

  // ============================================================
  // RENDER
  // ============================================================
  return (
    <EngineContext.Provider value={{ engine: engineInstance }}>
      <div className="w-screen h-screen relative bg-neutral-900 overflow-hidden">
        {/* Contenedor del Motor 3D */}
        <div
          ref={containerRef}
          className="absolute inset-0 z-0"
          onContextMenu={(e) => e.preventDefault()}
        />

        {/* UI LAYERS */}
        <BudgetPanel />
        <EnvironmentPanel />
        <FloorProperties />
        <FenceProperties />

        {/* Cat√°logo por encima de todo */}
        {mode === "catalog" && (
          <div className="absolute inset-0 z-40">
            <Catalog />
          </div>
        )}

        {/* Bot√≥n QR */}
        <button
          onClick={() => setQRVisible(true)}
          className="absolute top-6 right-6 z-20 bg-neutral-800/90 hover:bg-neutral-700 text-white p-3 rounded-full border border-neutral-600 shadow-lg"
        >
          <QrCode size={20} />
        </button>

        {/* Total presupuesto */}
        {!isReadOnlyMode && (
          <div className="absolute bottom-6 left-6 z-20">
            <button className="bg-neutral-800/90 px-4 py-3 rounded-full border border-neutral-600 text-white flex gap-3 items-center">
              <Euro size={18} />
              <span className="text-lg">{totalPrice.toLocaleString()} ‚Ç¨</span>
            </button>
          </div>
        )}

        {/* Mini toolbar de gizmo + acciones sobre selecci√≥n */}
        {selectedUUID && mode === "editing" && (
          <div className="absolute bottom-20 left-1/2 -translate-x-1/2 flex gap-2 glass-panel p-2 rounded-xl z-30">
            <button onClick={() => engineInstance?.setGizmoMode("translate")}>
              <Move size={16} />
            </button>
            <button onClick={() => engineInstance?.setGizmoMode("rotate")}>
              <RotateCw size={16} />
            </button>
            <button onClick={() => engineInstance?.setGizmoMode("scale")}>
              <Scaling size={16} />
            </button>
            <button onClick={handleDuplicateSelection}>
              <Copy size={16} />
            </button>
            <button onClick={handleRemoveSelection}>
              <Trash2 size={16} />
            </button>
          </div>
        )}

        {/* HUD de medici√≥n */}
        {mode === "measuring" && (
          <div className="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black/80 px-6 py-3 text-white rounded-full border border-white/20 backdrop-blur-md font-mono pointer-events-none">
            {measurementResult !== null
              ? `Distancia: ${measurementResult.toFixed(2)} m`
              : "Selecciona punto A y B"}
          </div>
        )}

        <Toolbar />
        <QRModal isOpen={qrVisible} onClose={() => setQRVisible(false)} />
        <InputModal />

        <div className="absolute bottom-6 right-6 text-white/5 font-black text-4xl pointer-events-none select-none">
          A42
        </div>
      </div>
    </EngineContext.Provider>
  );
};
</file>

<file path="src/features/editor/engine/A42Engine.ts">
// --- FILE: src/features/editor/engine/A42Engine.ts ---
import * as THREE from "three";
import { ARButton } from "three/examples/jsm/webxr/ARButton.js";

import type { SceneItem, CameraView, CameraType } from "@/types/editor";

import { SceneManager } from "./managers/SceneManager";
import { ObjectManager } from "./managers/ObjectManager";
import { ToolsManager } from "./managers/ToolsManager";
import { InteractionManager } from "./managers/InteractionManager";
import { WalkManager } from "./managers/WalkManager";
import { RecorderManager } from "./managers/RecorderManager";
import { ExportManager } from "./managers/ExportManager";
import { PDFManager } from "./managers/PDFManager";

import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export class A42Engine {
  public sceneManager: SceneManager;
  public objectManager: ObjectManager;
  public toolsManager: ToolsManager;
  public interactionManager: InteractionManager;
  public walkManager: WalkManager;
  public recorderManager: RecorderManager;
  public exportManager: ExportManager;
  public pdfManager: PDFManager;

  private clock = new THREE.Clock();

  constructor(container: HTMLElement) {
    // --- CORE MODULES ---
    this.sceneManager = new SceneManager(container);
    this.objectManager = new ObjectManager(this.sceneManager.scene);

    this.toolsManager = new ToolsManager(this.sceneManager.scene, this.objectManager);
    this.interactionManager = new InteractionManager(this);
    this.walkManager = new WalkManager(this);
    this.recorderManager = new RecorderManager(this);
    this.exportManager = new ExportManager(this);
    this.pdfManager = new PDFManager(this);

    this.sceneManager.renderer.xr.enabled = true;

    // --- EVENTS ---
    window.addEventListener("resize", this.onWindowResize);
    window.addEventListener("keydown", this.onKeyDown);
  }

  // === GETTERS ===
  public get scene() {
    return this.sceneManager.scene;
  }
  public get activeCamera() {
    return this.sceneManager.activeCamera;
  }
  public get renderer() {
    return this.sceneManager.renderer;
  }

  // --- PUBLIC API -----------------------------------------------------

  public onPointerDown = (event: MouseEvent) => {
    this.interactionManager.onPointerDown(event);
  };

  public switchCamera(type: CameraType) {
    this.sceneManager.switchCamera(type);
    this.interactionManager.updateCamera(this.activeCamera);
  }

  public setView(view: CameraView) {
    this.sceneManager.setView(view);
  }

  public setBackground(color: string) {
    this.sceneManager.setBackgroundColor(color);
  }

  public setGrid(visible: boolean) {
    this.sceneManager.setGridVisible(visible);
  }

  public setSky(visible: boolean) {
    this.sceneManager.setSkyVisible(visible);
  }

  /** ‚úîÔ∏è NECESARIO PARA EDITOR3D */
  public updateSunPosition(azimuth: number, elevation: number) {
    this.sceneManager.updateSunPosition(azimuth, elevation);
  }

  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    this.interactionManager.setGizmoMode(mode);
  }

  public clearTools() {
    this.toolsManager.clearTools();
    this.interactionManager.selectObject(null);
  }

  // === KEYBOARD HANDLING ---------------------------------------------

  private onKeyDown = (e: KeyboardEvent) => {
    if (this.walkManager.isEnabled) return;

    const selection = useSelectionStore.getState();
    const sceneStore = useSceneStore.getState();

    // DELETE ITEM
    if (e.key === "Delete" || e.key === "Backspace") {
      const uuid = selection.selectedUUID;
      if (!uuid) return;

      this.interactionManager.selectObject(null);
      sceneStore.removeItem(uuid);
      this.objectManager.removeByUUID(uuid);
      selection.select(null);
      return;
    }

    const tc = this.interactionManager.transformControl;
    if (!tc?.visible) return;

    if (e.key === "t") tc.setMode("translate");
    else if (e.key === "r") tc.setMode("rotate");
    else if (e.key === "e") tc.setMode("scale");
  };

  // === RESIZE ---------------------------------------------------------

  private onWindowResize = () => {
    this.sceneManager.onWindowResize();
  };

  // === AR INIT --------------------------------------------------------

  private async initAR() {
    if (!("xr" in navigator)) return;

    let supported = false;
    try {
      // @ts-ignore
      supported = await navigator.xr.isSessionSupported("immersive-ar");
    } catch {
      supported = false;
    }
    if (!supported) return;

    const button = ARButton.createButton(this.renderer, {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body },
    });

    button.style.position = "fixed";
    button.style.bottom = "20px";
    button.style.right = "20px";
    button.style.width = "160px";
    button.style.background = "rgba(0,0,0,0.85)";
    button.style.border = "1px solid rgba(255,255,255,0.3)";
    button.style.borderRadius = "30px";
    button.style.color = "#fff";
    button.style.fontSize = "12px";
    button.style.fontWeight = "bold";
    button.style.padding = "10px 0";
    button.style.cursor = "pointer";
  }

  // === SCENE SYNC -----------------------------------------------------

  public async syncScene(items: SceneItem[]) {
    await this.syncSceneFromStore(items);
  }

  private async syncSceneFromStore(items: SceneItem[]) {
    const scene = this.scene;
    const existing = new Map<string, THREE.Object3D>();

    scene.traverse((child) => {
      if (child.userData?.isItem && child.uuid) {
        existing.set(child.uuid, child);
      }
    });

    for (const item of items) {
      const obj = existing.get(item.uuid);

      if (!obj) {
        await this.objectManager.createFromItem(item);
        continue;
      }

      obj.position.fromArray(item.position);
      obj.rotation.fromArray(item.rotation);
      obj.scale.fromArray(item.scale);

      existing.delete(item.uuid);
    }

    for (const [uuid] of existing) {
      this.objectManager.removeByUUID(uuid);
    }
  }

  // === ENGINE INIT ----------------------------------------------------

  public init() {
    this.initAR();
    this.renderer.setAnimationLoop(this.render);
  }

  // === RENDER LOOP ----------------------------------------------------

  private render = () => {
    const delta = this.clock.getDelta();

    this.walkManager.update(delta);
    this.recorderManager.update(delta);

    if (!this.walkManager.isEnabled) {
      this.sceneManager.controls.update();
    }

    this.renderer.render(this.scene, this.activeCamera);
  };

  // === DISPOSE --------------------------------------------------------

  public dispose() {
    this.renderer.setAnimationLoop(null);
    window.removeEventListener("resize", this.onWindowResize);
    window.removeEventListener("keydown", this.onKeyDown);

    this.sceneManager.dispose();
  }
}
// --- END FILE ---
</file>

<file path="src/features/editor/engine/managers/ExportManager.ts">
// --- FILE: src/features/editor/engine/managers/ExportManager.ts ---
import * as THREE from "three";
import { GLTFExporter } from "three/examples/jsm/exporters/GLTFExporter.js";
import type { A42Engine } from "../A42Engine";
import { useEditorStore } from "@/stores/editor/useEditorStore";

export class ExportManager {
  private engine: A42Engine;

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  // ======================================================
  // GLB EXPORT
  // ======================================================
  public async exportGLB() {
    const name = await useEditorStore
      .getState()
      .requestInput("Nombre del archivo (.glb):", "proyecto-3d");

    if (!name) return;

    const exporter = new GLTFExporter();
    const exportGroup = this.buildExportGroup();

    if (!exportGroup) {
      alert("No hay objetos para exportar.");
      return;
    }

    exporter.parse(
      exportGroup,
      (gltf) => {
        const blob = new Blob([gltf as ArrayBuffer], {
          type: "application/octet-stream",
        });
        this.download(blob, `${name}.glb`);
      },
      (error) => {
        console.error("Error exportando GLB:", error);
        alert("Error al exportar GLB.");
      },
      { binary: true }
    );
  }

  private buildExportGroup(): THREE.Group | null {
    const group = new THREE.Group();
    let found = false;

    this.engine.scene.traverse((child) => {
      if (child.userData?.isItem) {
        group.add(child.clone());
        found = true;
      }
    });

    return found ? group : null;
  }

  // ======================================================
  // DXF EXPORT
  // ======================================================
  public async exportDXF() {
    const name = await useEditorStore
      .getState()
      .requestInput("Nombre del archivo (.dxf):", "plano-cad");

    if (!name) return;

    let dxf = this.headerDXF();
    this.engine.scene.updateMatrixWorld(true);

    this.engine.scene.traverse((obj) => {
      if (!obj.userData?.isItem) return;

      // --- EXPORTAR SUELOS ---
      if (obj.userData.type === "floor" && obj.userData.points) {
        dxf += this.exportFloor(obj);
        return;
      }

      // --- EXPORTAR MODELOS Y VALLAS ---
      dxf += this.exportMeshOrInstanced(obj);
    });

    dxf += this.footerDXF();

    const blob = new Blob([dxf], { type: "application/dxf" });
    this.download(blob, `${name}.dxf`);
  }

  // ======================================================
  // DXF ‚Äî EXPORT FLOOR
  // ======================================================
  private exportFloor(obj: THREE.Object3D): string {
    let out = "";

    const layer = "SUELOS";
    const color = 4;

    const pts = obj.userData.points;
    const world = pts.map((p: any) => {
      const v = new THREE.Vector3(p.x, 0, p.z);
      v.applyMatrix4(obj.matrixWorld);
      return v;
    });

    for (let i = 0; i < world.length; i++) {
      const p1 = world[i];
      const p2 = world[(i + 1) % world.length];
      out += this.lineDXF(p1.x, -p1.z, p2.x, -p2.z, layer, color);
    }

    return out;
  }

  // ======================================================
  // DXF ‚Äî MESH / INSTANCED
  // ======================================================
  private exportMeshOrInstanced(root: THREE.Object3D): string {
    let out = "";

    const layer =
      root.userData.type === "fence" ? "VALLAS" : "MOBILIARIO";
    const color = root.userData.type === "fence" ? 1 : 3;

    root.traverse((child) => {
      if (!(child as THREE.Mesh).isMesh) return;

      const mesh = child as THREE.Mesh;

      // Edges
      const edges = new THREE.EdgesGeometry(mesh.geometry, 10);
      const pos = edges.attributes.position.array;

      // Instanced meshes
      if ((mesh as THREE.InstancedMesh).isInstancedMesh) {
        const inst = mesh as THREE.InstancedMesh;
        const mat = new THREE.Matrix4();

        for (let i = 0; i < inst.count; i++) {
          inst.getMatrixAt(i, mat);
          const worldMat = new THREE.Matrix4().multiplyMatrices(
            inst.matrixWorld,
            mat
          );
          out += this.exportEdgesDXF(pos, worldMat, layer, color);
        }
        return;
      }

      // Normal meshes
      out += this.exportEdgesDXF(pos, mesh.matrixWorld, layer, color);
    });

    return out;
  }

  private exportEdgesDXF(
    pos: ArrayLike<number>,
    matrix: THREE.Matrix4,
    layer: string,
    color: number
  ): string {
    let out = "";

    for (let i = 0; i < pos.length; i += 6) {
      const v1 = new THREE.Vector3(pos[i], pos[i + 1], pos[i + 2]).applyMatrix4(matrix);
      const v2 = new THREE.Vector3(pos[i + 3], pos[i + 4], pos[i + 5]).applyMatrix4(matrix);

      out += this.lineDXF(v1.x, -v1.z, v2.x, -v2.z, layer, color);
    }

    return out;
  }

  // ======================================================
  // DXF FORMAT HELPERS
  // ======================================================
  private headerDXF() {
    return `0
SECTION
2
HEADER
9
$ACADVER
1
AC1009
0
ENDSEC
0
SECTION
2
ENTITIES
`;
  }

  private footerDXF() {
    return `0
ENDSEC
0
EOF`;
  }

  private lineDXF(
    x1: number,
    y1: number,
    x2: number,
    y2: number,
    layer: string,
    color: number
  ) {
    return `0
LINE
8
${layer}
62
${color}
10
${x1.toFixed(4)}
20
${y1.toFixed(4)}
11
${x2.toFixed(4)}
21
${y2.toFixed(4)}
`;
  }

  // ======================================================
  // FILE DOWNLOAD
  // ======================================================
  private download(blob: Blob, filename: string) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 120);
  }
}
</file>

<file path="src/features/editor/engine/managers/InteractionManager.ts">
// --- FILE: src/features/editor/engine/managers/InteractionManager.ts ---
import * as THREE from "three";
import { TransformControls } from "three/examples/jsm/controls/TransformControls.js";

import type { A42Engine } from "../A42Engine";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { useEditorStore } from "@/stores/editor/useEditorStore";

export class InteractionManager {
  private engine: A42Engine;
  private raycaster = new THREE.Raycaster();
  private pointer = new THREE.Vector2();

  public transformControl: TransformControls;
  private isDragging = false;

  constructor(engine: A42Engine) {
    this.engine = engine;

    this.transformControl = new TransformControls(
      this.engine.activeCamera,
      this.engine.renderer.domElement
    );

    this.transformControl.visible = false;
    this.engine.scene.add(this.transformControl);

    this.attachListeners();
  }

  private attachListeners() {
    this.transformControl.addEventListener("dragging-changed", (e: any) => {
      this.isDragging = e.value;
      this.engine.sceneManager.controls.enabled = !e.value;

      const obj = this.transformControl.object;
      if (!obj || e.value) return;

      if (obj.userData?.uuid) {
        this.syncTransformToStore(obj);
      }
    });

    this.transformControl.addEventListener("objectChange", () => {
      if (!this.isDragging) return;
      const obj = this.transformControl.object;
      if (obj) this.syncTransformToStore(obj);
    });
  }

  public updateCamera(camera: THREE.Camera) {
    this.transformControl.camera = camera;
  }

  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    this.transformControl.setMode(mode);
  }

  // ======================================================
  // POINTER DOWN
  // ======================================================
  public onPointerDown = (evt: MouseEvent) => {
    if (evt.button === 2) return this.handleRightClick();
    if (this.isDragging) return;

    const rect = this.engine.renderer.domElement.getBoundingClientRect();
    this.pointer.x = ((evt.clientX - rect.left) / rect.width) * 2 - 1;
    this.pointer.y = -((evt.clientY - rect.top) / rect.height) * 2 + 1;

    this.raycaster.setFromCamera(this.pointer, this.engine.activeCamera);

    this.handleSceneClick();
  };

  private handleSceneClick() {
    const mode = useEditorStore.getState().mode;

    // ------------------------------------
    // TRY SELECT OBJECT
    // ------------------------------------
    const objects: THREE.Object3D[] = [];
    this.engine.scene.traverse((obj) => {
      if (obj.userData?.isItem) objects.push(obj);
    });

    const hits = this.raycaster.intersectObjects(objects, true);
    if (hits.length > 0) {
      let obj: THREE.Object3D | null = hits[0].object;
      while (obj && !obj.userData?.isItem && obj.parent) obj = obj.parent;
      if (obj) return this.selectObject(obj);
    }

    // ------------------------------------
    // WORLD POINT ON FLOOR
    // ------------------------------------
    const world = this.engine.sceneManager.raycastWorldPoint(this.raycaster);
    if (world) {
      if (mode === "placing_item") {
        this.engine.objectManager.placePreviewAt(world);
        return;
      }
      if (mode === "drawing_floor") {
        this.engine.toolsManager.floorTool.addPoint(world);
        return;
      }
      if (mode === "drawing_fence") {
        this.engine.toolsManager.fenceTool.addPoint(world);
        return;
      }
    }

    this.clearSelection();
  }

  // ======================================================
  // RIGHT CLICK (CONFIRM ACTION)
  // ======================================================
  private handleRightClick() {
    const mode = useEditorStore.getState().mode;

    if (mode === "placing_item") {
      this.engine.objectManager.confirmPreviewPlacement();
      useEditorStore.getState().setMode("idle");
      return;
    }

    if (mode === "drawing_floor") {
      this.engine.toolsManager.floorTool.finalize();
      return;
    }

    if (mode === "drawing_fence") {
      this.engine.toolsManager.fenceTool.finalize();
      return;
    }
  }

  // ======================================================
  // SELECTION
  // ======================================================
  public selectObject(obj: THREE.Object3D | null) {
    const store = useSelectionStore.getState();

    if (!obj) return this.clearSelection();

    const uuid = obj.userData?.uuid;
    if (!uuid) return this.clearSelection();

    store.select(uuid);
    this.transformControl.attach(obj);
    this.transformControl.visible = true;
    this.engine.sceneManager.controls.enabled = false;
  }

  private clearSelection() {
    const store = useSelectionStore.getState();
    store.select(null);

    this.transformControl.detach();
    this.transformControl.visible = false;
    this.engine.sceneManager.controls.enabled = true;
  }

  // ======================================================
  // STORE SYNC
  // ======================================================
  private syncTransformToStore(obj: THREE.Object3D) {
    if (!obj.userData?.uuid) return;

    useSceneStore.getState().updateItem(obj.userData.uuid, {
      position: [obj.position.x, obj.position.y, obj.position.z],
      rotation: [obj.rotation.x, obj.rotation.y, obj.rotation.z],
      scale: [obj.scale.x, obj.scale.y, obj.scale.z],
    });
  }

  public selectItemByUUID(uuid: string | null) {
    if (!uuid) return this.clearSelection();
    const obj = this.engine.scene.getObjectByProperty("uuid", uuid);
    this.selectObject(obj ?? null);
  }
}
// --- END FILE ---
</file>

<file path="src/features/editor/engine/managers/ObjectManager.ts">
// --- FILE: src/features/editor/engine/managers/ObjectManager.ts ---
import * as THREE from "three";
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";

import type {
  SceneItem,
  ModelItem,
  FloorItem,
  FenceItem,
  Vector3Array,
} from "@/types/editor";

import { useSceneStore } from "@/stores/scene/useSceneStore";

export class ObjectManager {
  private scene: THREE.Scene;
  private gltf = new GLTFLoader();

  private cache: Record<string, THREE.Group> = {};

  // === PREVIEW ===
  private previewObject: THREE.Object3D | null = null;
  private previewItem: SceneItem | null = null;

  constructor(scene: THREE.Scene) {
    this.scene = scene;
  }

  // ============================================================
  // MODEL LOADING + CACHE
  // ============================================================
  public async loadModel(url: string): Promise<THREE.Group> {
    if (this.cache[url]) return this.cache[url].clone();

    const gltf = await this.gltf.loadAsync(url);
    this.cache[url] = gltf.scene;

    return gltf.scene.clone();
  }

  // ============================================================
  // SCENE ITEM ‚Üí OBJECT
  // ============================================================
  public async createFromItem(item: SceneItem): Promise<THREE.Object3D | null> {
    switch (item.type) {
      case "model":
        return this.createModel(item as ModelItem);
      case "floor":
        return this.createFloor(item as FloorItem);
      case "fence":
        return this.createFence(item as FenceItem);
      default:
        return null;
    }
  }

  // ============================================================
  // MODEL
  // ============================================================
  private async createModel(item: ModelItem): Promise<THREE.Object3D | null> {
    if (!item.modelUrl) return null;

    const model = await this.loadModel(item.modelUrl);

    model.uuid = item.uuid;
    model.position.fromArray(item.position as Vector3Array);
    model.rotation.fromArray(item.rotation as Vector3Array);
    model.scale.fromArray(item.scale as Vector3Array);

    model.userData = {
      isItem: true,
      type: "model",
      uuid: item.uuid,
      productId: item.productId,
    };

    this.prepareSafetyZones(model);
    this.scene.add(model);

    return model;
  }

  private prepareSafetyZones(root: THREE.Object3D) {
    const safetyMat = new THREE.MeshBasicMaterial({
      color: 0xff0000,
      transparent: true,
      opacity: 0.25,
      depthWrite: false,
      side: THREE.DoubleSide,
    });

    root.traverse((child: any) => {
      if (!child.isMesh) return;

      const name = child.name.toLowerCase();
      const matName = child.material?.name?.toLowerCase?.() ?? "";

      const isSafety =
        name.includes("seguridad") ||
        name.includes("safety") ||
        matName.includes("seguridad") ||
        matName.includes("safety");

      if (isSafety) {
        child.material = safetyMat.clone();
        child.userData.isSafetyZone = true;
      }
    });
  }

  // ============================================================
  // FLOOR
  // ============================================================
  private createFloor(item: FloorItem): THREE.Object3D | null {
    const pts = item.points;
    if (!pts || pts.length < 3) return null;

    const shape = new THREE.Shape();
    shape.moveTo(pts[0].x, -pts[0].z);
    pts.forEach((p, i) => i && shape.lineTo(p.x, -p.z));
    shape.lineTo(pts[0].x, -pts[0].z);

    const geometry = new THREE.ExtrudeGeometry(shape, {
      depth: 0.05,
      bevelEnabled: false,
    });

    geometry.rotateX(-Math.PI / 2);

    const material = new THREE.MeshStandardMaterial({
      color: 0x999999,
    });

    const mesh = new THREE.Mesh(geometry, material);
    mesh.uuid = item.uuid;

    mesh.position.fromArray(item.position as Vector3Array);
    mesh.rotation.fromArray(item.rotation as Vector3Array);
    mesh.scale.fromArray(item.scale as Vector3Array);

    mesh.userData = {
      isItem: true,
      type: "floor",
      uuid: item.uuid,
    };

    this.scene.add(mesh);
    return mesh;
  }

  // ============================================================
  // FENCE
  // ============================================================
  private createFence(item: FenceItem): THREE.Object3D | null {
    const group = new THREE.Group();

    group.uuid = item.uuid;
    group.position.fromArray(item.position as Vector3Array);
    group.rotation.fromArray(item.rotation as Vector3Array);
    group.scale.fromArray(item.scale as Vector3Array);

    group.userData = {
      isItem: true,
      type: "fence",
      uuid: item.uuid,
      points: item.points,
      fenceConfig: item.fenceConfig,
      productId: item.productId,
    };

    this.scene.add(group);
    return group;
  }

  // ============================================================
  // PREVIEW HANDLING
  // ============================================================
  public async setPreviewItem(item: SceneItem) {
    if (this.previewObject) {
      this.scene.remove(this.previewObject);
      this.previewObject = null;
    }

    this.previewItem = item;

    const obj = await this.createFromItem({ ...item, uuid: "preview" });
    if (!obj) return;

    obj.traverse((child: any) => {
      if (child.material) {
        child.material = child.material.clone();
        child.material.transparent = true;
        child.material.opacity = 0.35;
      }
    });

    this.previewObject = obj;
    this.scene.add(obj);
  }

  public placePreviewAt(point: THREE.Vector3) {
    if (!this.previewObject) return;
    this.previewObject.position.copy(point);
  }

  public confirmPreviewPlacement() {
    if (!this.previewObject || !this.previewItem) return;

    const uuid = THREE.MathUtils.generateUUID();

    const finalItem: SceneItem = {
      ...this.previewItem,
      uuid,
      position: [
        this.previewObject.position.x,
        this.previewObject.position.y,
        this.previewObject.position.z,
      ] as Vector3Array,
    };

    useSceneStore.getState().addItem(finalItem);

    this.scene.remove(this.previewObject);
    this.previewObject = null;
    this.previewItem = null;
  }

  // ============================================================
  // REMOVE ITEM
  // ============================================================
  public removeByUUID(uuid: string) {
    const obj = this.scene.getObjectByProperty("uuid", uuid);
    if (!obj) return;

    this.scene.remove(obj);

    obj.traverse((child: any) => {
      if (child.geometry) child.geometry.dispose();
      if (Array.isArray(child.material))
        child.material.forEach((mat: THREE.Material) => mat.dispose());
      else child.material?.dispose?.();
    });
  }
}
// --- END FILE ---
</file>

<file path="src/features/editor/engine/managers/PDFManager.ts">
// --- FILE: src/features/editor/engine/managers/PDFManager.ts ---
import * as THREE from "three";
import { jsPDF } from "jspdf";
import autoTable from "jspdf-autotable";

import type { A42Engine } from "../A42Engine";
type StoreSceneItem = import("@/stores/scene/useSceneStore").SceneItem;

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useUserStore } from "@/stores/user/useUserStore";
import { PriceCalculator } from "@/utils/PriceCalculator";

// ======================================================================================
// 1) HELPER ‚Äî Scene State Saver
// ======================================================================================
class PDFSceneState {
  private engine: A42Engine;

  private rendererSize = new THREE.Vector2();
  private pixelRatio = 1;
  private camPos = new THREE.Vector3();
  private camRot = new THREE.Euler();
  private controlsTarget = new THREE.Vector3();

  private bg: THREE.Color | THREE.Texture | null = null;
  private fog: THREE.Fog | THREE.FogExp2 | null = null;
  private skyVisible = false;

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  save() {
    const r = this.engine.renderer;

    r.getSize(this.rendererSize);
    this.pixelRatio = r.getPixelRatio();

    this.camPos.copy(this.engine.activeCamera.position);
    this.camRot.copy(this.engine.activeCamera.rotation);
    this.controlsTarget.copy(this.engine.sceneManager.controls.target);

    this.bg = this.engine.scene.background;
    this.fog = this.engine.scene.fog as any;

    this.skyVisible = this.engine.sceneManager.sky?.visible ?? false;
  }

  restore() {
    const r = this.engine.renderer;

    r.setSize(this.rendererSize.x, this.rendererSize.y);
    r.setPixelRatio(this.pixelRatio);

    this.engine.switchCamera("perspective");
    this.engine.sceneManager.onWindowResize();

    this.engine.activeCamera.position.copy(this.camPos);
    this.engine.activeCamera.rotation.copy(this.camRot);
    this.engine.sceneManager.controls.target.copy(this.controlsTarget);

    this.engine.scene.background = this.bg;
    this.engine.scene.fog = this.fog as any;

    this.engine.sceneManager.controls.enabled = true;
    this.engine.sceneManager.controls.update();

    this.engine.setSky(this.skyVisible);

    const shouldGrid = useEditorStore.getState().gridVisible;
    this.engine.setGrid(shouldGrid);

    this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
  }
}

// ======================================================================================
// 2) HELPER ‚Äî PDF Renderer
// ======================================================================================
class PDFRenderer {
  private engine: A42Engine;

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  setRendererSize(w: number, h: number) {
    const cam = this.engine.activeCamera;

    this.engine.renderer.setSize(w, h);

    if (cam instanceof THREE.PerspectiveCamera) {
      cam.aspect = w / h;
      cam.updateProjectionMatrix();
    }
  }

  capture(format: "image/jpeg" | "image/png" = "image/jpeg"): string {
    return this.engine.renderer.domElement.toDataURL(format, 0.92);
  }

  centerCameraOnBox(box: THREE.Box3, margin = 1.35) {
    const cam = this.engine.activeCamera as THREE.PerspectiveCamera;

    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    const fov = (cam.fov * Math.PI) / 180;
    let camZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * margin;

    const aspect = cam.aspect;
    if (aspect < 1) camZ = camZ / aspect;

    const dir = new THREE.Vector3(1, 0.6, 1).normalize();
    const newPos = dir.multiplyScalar(camZ).add(center);

    cam.position.copy(newPos);
    cam.lookAt(center);
  }

  centerCameraOnObject(obj: THREE.Object3D) {
    const box = new THREE.Box3().setFromObject(obj);
    if (!box.isEmpty()) this.centerCameraOnBox(box, 1.4);
  }

  getSceneBox(): THREE.Box3 {
    const box = new THREE.Box3();
    this.engine.scene.traverse((o) => {
      if (o.userData?.isItem && o.visible) box.expandByObject(o);
    });
    if (box.isEmpty()) {
      box.setFromCenterAndSize(new THREE.Vector3(), new THREE.Vector3(2, 2, 2));
    }
    return box;
  }
}

// ======================================================================================
// 3) HELPER ‚Äî PDF Layout
// ======================================================================================
class PDFLayout {
  private doc: jsPDF;

  constructor(doc: jsPDF) {
    this.doc = doc;
  }

  header(title: string, subtitle = "") {
    const w = this.doc.internal.pageSize.getWidth();

    this.doc.setFont("helvetica", "bold");
    this.doc.setFontSize(22);
    this.doc.setTextColor(40);
    this.doc.text(title, 20, 20);

    if (subtitle) {
      this.doc.setFontSize(10);
      this.doc.setTextColor(140);
      this.doc.text(subtitle, w - 20, 20, { align: "right" });
    }

    this.doc.setDrawColor(200);
    this.doc.line(20, 25, w - 20, 25);
  }

  footer() {
    const h = this.doc.internal.pageSize.getHeight();
    this.doc.setFontSize(9);
    this.doc.setTextColor(120);
    this.doc.text("Levipark21 ¬∑ www.levipark21.es", 20, h - 10);
  }

  imageCentered(img: string, x: number, y: number, w: number, h: number) {
    const p = this.doc.getImageProperties(img);

    const ratioImg = p.width / p.height;
    const ratioBox = w / h;

    let drawW = w;
    let drawH = h;

    if (ratioImg > ratioBox) {
      drawH = w / ratioImg;
    } else {
      drawW = h * ratioImg;
    }

    const offX = x + (w - drawW) / 2;
    const offY = y + (h - drawH) / 2;

    this.doc.addImage(img, "JPEG", offX, offY, drawW, drawH);
  }
}

// ======================================================================================
// 4) MAIN ‚Äî PDFManager
// ======================================================================================
export class PDFManager {
  private engine: A42Engine;
  private sceneState: PDFSceneState;
  private renderer: PDFRenderer;

  constructor(engine: A42Engine) {
    this.engine = engine;
    this.sceneState = new PDFSceneState(engine);
    this.renderer = new PDFRenderer(engine);
  }

  // ============================================
  // PUBLIC API
  // ============================================
  public async generatePDF() {
    const project = await useEditorStore
      .getState()
      .requestInput("Nombre del Proyecto:", "Proyecto sin t√≠tulo");

    if (!project) return;

    const doc = new jsPDF();
    const layout = new PDFLayout(doc);

    const items = useSceneStore.getState().items;
    const user = useUserStore.getState().user;

    this.sceneState.save();

    try {
      this.prepareScene();

      const cover = this.captureCover();
      this.pageCover(doc, layout, project, cover);

      const views = this.captureTechnicalViews();
      this.pageTechnicalViews(doc, layout, views);

      if (user) this.pageBudget(doc, layout, items);

      const unique = this.getUniqueItems(items);
      const fichas = this.captureItemImages(unique);
      this.pageItemSheets(doc, layout, unique, fichas);

      doc.save(`${project}_Levipark.pdf`);
    } finally {
      this.sceneState.restore();
    }
  }

  // ============================================
  // PREPARAR ESCENA
  // ============================================
  private prepareScene() {
    const eng = this.engine;

    eng.sceneManager.controls.enabled = false;

    eng.scene.background = new THREE.Color(0xffffff);
    eng.scene.fog = null;

    eng.setGrid(false);
    eng.setSky(false);

    this.hideHelpers(true);
  }

  private hideHelpers(hide: boolean) {
    this.engine.scene.traverse((o) => {
      const isHelper =
        o instanceof THREE.GridHelper ||
        o.type.includes("Helper") ||
        o.userData?.isSafetyZone ||
        o.name === "ShadowPlane";

      if (isHelper) o.visible = !hide;
    });
  }

  // ============================================
  // PORTADA
  // ============================================
  private captureCover() {
    const eng = this.engine;

    this.renderer.setRendererSize(1600, 1200);
    eng.switchCamera("perspective");

    this.setAllObjectsVisibility(true);
    this.renderer.centerCameraOnBox(this.renderer.getSceneBox());

    eng.renderer.render(eng.scene, eng.activeCamera);
    return this.renderer.capture("image/jpeg");
  }

  private pageCover(
    _doc: jsPDF,
    layout: PDFLayout,
    project: string,
    img: string
  ) {
    layout.header(project, "Dossier del Proyecto");
    layout.imageCentered(img, 15, 40, 180, 120);
    layout.footer();
  }

  // ============================================
  // VISTAS T√âCNICAS
  // ============================================
  private captureTechnicalViews() {
    const eng = this.engine;
    eng.switchCamera("orthographic");

    const cam = eng.sceneManager.orthoCamera;
    const box = this.renderer.getSceneBox();
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    cam.left = -maxDim;
    cam.right = maxDim;
    cam.top = maxDim;
    cam.bottom = -maxDim;
    cam.updateProjectionMatrix();

    const views: Record<string, string> = {};

    const cfg: Array<{
      name: string;
      pos: [number, number, number];
      up: [number, number, number];
    }> = [
      { name: "front", pos: [0, 0, maxDim * 3], up: [0, 1, 0] },
      { name: "side", pos: [maxDim * 3, 0, 0], up: [0, 1, 0] },
      { name: "top", pos: [0, maxDim * 3, 0], up: [0, 0, -1] },
      {
        name: "iso",
        pos: [maxDim * 2.5, maxDim * 1.6, maxDim * 2.5],
        up: [0, 1, 0],
      },
    ];

    this.renderer.setRendererSize(1200, 1200);

    for (let i = 0; i < cfg.length; i++) {
      const v = cfg[i];

      cam.position.set(center.x + v.pos[0], center.y + v.pos[1], center.z + v.pos[2]);
      cam.up.set(v.up[0], v.up[1], v.up[2]);
      cam.lookAt(center);
      cam.updateProjectionMatrix();

      eng.renderer.render(eng.scene, cam);
      views[v.name] = this.renderer.capture("image/jpeg");
    }

    return views;
  }

  private pageTechnicalViews(
    doc: jsPDF,
    layout: PDFLayout,
    views: Record<string, string>
  ) {
    doc.addPage();
    layout.header("Vistas T√©cnicas");

    const w = doc.internal.pageSize.getWidth();
    const m = 15;
    const gw = (w - 3 * m) / 2;
    const gh = 80;
    const y1 = 45;
    const y2 = y1 + gh + 12;

    doc.setFontSize(10);

    doc.text("Frontal", m, y1 - 3);
    layout.imageCentered(views.front, m, y1, gw, gh);

    doc.text("Lateral", m + gw + m, y1 - 3);
    layout.imageCentered(views.side, m + gw + m, y1, gw, gh);

    doc.text("Superior", m, y2 - 3);
    layout.imageCentered(views.top, m, y2, gw, gh);

    doc.text("Isom√©trica", m + gw + m, y2 - 3);
    layout.imageCentered(views.iso, m + gw + m, y2, gw, gh);

    layout.footer();
  }

  // ============================================
  // PRESUPUESTO
  // ============================================
  private pageBudget(
    doc: jsPDF,
    layout: PDFLayout,
    items: StoreSceneItem[]
  ) {
    doc.addPage();
    layout.header("Estimaci√≥n Presupuestaria");

    let total = 0;

    const rows = items.map((i) => {
      const price = PriceCalculator.getItemPrice(i as any);
      total += price;
      return [
        i.name || "",
        i.productId,
        PriceCalculator.getItemDimensions(i as any),
        price.toLocaleString("es-ES", { style: "currency", currency: "EUR" }),
      ];
    });

    const iva = total * 0.21;

    autoTable(doc, {
      head: [["Elemento", "Ref", "Dim", "Precio"]],
      body: rows,
      startY: 40,
      headStyles: { fillColor: [30, 80, 160] },
      foot: [
        ["", "", "Base", total.toLocaleString("es-ES", { style: "currency", currency: "EUR" })],
        ["", "", "IVA 21%", iva.toLocaleString("es-ES", { style: "currency", currency: "EUR" })],
        ["", "", "TOTAL", (total + iva).toLocaleString("es-ES", { style: "currency", currency: "EUR" })],
      ],
      columnStyles: { 3: { halign: "right" } },
    });

    layout.footer();
  }

  // ============================================
  // FICHAS DE PRODUCTO
  // ============================================
  private getUniqueItems(items: StoreSceneItem[]) {
    const map = new Map<string, StoreSceneItem>();

    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      const key = item.productId === "custom_upload" ? item.uuid : item.productId;
      if (!map.has(key)) map.set(key, item);
    }

    return map;
  }

  private captureItemImages(unique: Map<string, StoreSceneItem>) {
    const out: Record<string, string> = {};

    this.engine.switchCamera("perspective");
    this.renderer.setRendererSize(1024, 768);

    const iterator = unique.entries();
    let entry = iterator.next();

    while (!entry.done) {
      const key = entry.value[0];
      const item = entry.value[1];

      this.setAllObjectsVisibility(false);
      this.setObjectVisibility(item.uuid, true);

      const obj = this.engine.scene.getObjectByProperty("uuid", item.uuid);
      if (obj) {
        this.renderer.centerCameraOnObject(obj);
        this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
        out[key] = this.renderer.capture("image/png");
      }

      entry = iterator.next();
    }

    return out;
  }

  private pageItemSheets(
    doc: jsPDF,
    layout: PDFLayout,
    unique: Map<string, StoreSceneItem>,
    images: Record<string, string>
  ) {
    const iterator = unique.entries();
    let entry = iterator.next();

    while (!entry.done) {
      const key = entry.value[0];
      const item = entry.value[1];

      doc.addPage();
      layout.header(item.name || "Ficha T√©cnica", item.productId.toUpperCase());

      if (images[key]) {
        layout.imageCentered(images[key], 15, 40, 180, 110);
      }

      const y = 160;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Descripci√≥n:", 15, y);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.setTextColor(60);

      const anyItem = item as any;
      const desc =
        anyItem.data?.descripcion ||
        anyItem.data?.DESCRIPCION ||
        anyItem.description ||
        "Elemento certificado seg√∫n normativa vigente.";

      const lines = doc.splitTextToSize(desc, 180);
      doc.text(lines, 15, y + 7);

      layout.footer();

      entry = iterator.next();
    }
  }

  // ============================================
  // VISIBILIDAD
  // ============================================
  private setAllObjectsVisibility(v: boolean) {
    this.engine.scene.traverse((o) => {
      if (o.userData?.isItem) o.visible = v;
    });
  }

  private setObjectVisibility(uuid: string, v: boolean) {
    const obj = this.engine.scene.getObjectByProperty("uuid", uuid);
    if (!obj) return;

    obj.visible = v;
    obj.traverse((c) => (c.visible = v));
  }
}
// --- END FILE ---
</file>

<file path="src/features/editor/engine/managers/RecorderManager.ts">
// --- FILE: src/features/editor/engine/managers/RecorderManager.ts ---
import * as THREE from "three";
import type { A42Engine } from "../A42Engine";
import { useEditorStore } from "@/stores/editor/useEditorStore";

//
// ================================================================
// 1) HELPER: Recorder UI Indicator
// ================================================================
class RecorderIndicator {
  private el: HTMLElement;

  constructor() {
    this.el = document.createElement("div");
    this.el.innerText = "‚óè REC";
    Object.assign(this.el.style, {
      position: "absolute",
      top: "20px",
      right: "20px",
      padding: "6px 14px",
      fontSize: "18px",
      fontFamily: "monospace",
      fontWeight: "bold",
      color: "white",
      background: "rgba(200,0,0,0.85)",
      borderRadius: "6px",
      zIndex: "99999",
      pointerEvents: "none",
      display: "none",
      boxShadow: "0 0 8px rgba(0,0,0,0.4)",
      animation: "blinkREC 1s infinite"
    });

    const style = document.createElement("style");
    style.innerHTML = `
      @keyframes blinkREC {
        0% { opacity: 1; }
        50% { opacity: 0.35; }
        100% { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    document.body.appendChild(this.el);
  }

  show() { this.el.style.display = "block"; }
  hide() { this.el.style.display = "none"; }
}

//
// ================================================================
// 2) HELPER: RecorderState
// ================================================================
class RecorderState {
  private engine: A42Engine;
  private savedPos = new THREE.Vector3();
  private savedRot = new THREE.Euler();
  private savedTarget = new THREE.Vector3();

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  save() {
    const cam = this.engine.activeCamera;
    this.savedPos.copy(cam.position);
    this.savedRot.copy(cam.rotation);
    this.savedTarget.copy(this.engine.sceneManager.controls.target);
  }

  restore() {
    const cam = this.engine.activeCamera;
    cam.position.copy(this.savedPos);
    cam.rotation.copy(this.savedRot);
    this.engine.sceneManager.controls.target.copy(this.savedTarget);
    this.engine.sceneManager.controls.update();
    this.engine.sceneManager.controls.enabled = true;
  }
}

//
// ================================================================
// 3) HELPER: VideoRecorder
// ================================================================
class VideoRecorder {
  private recorder: MediaRecorder | null = null;
  private chunks: Blob[] = [];
  private onFinish: ((blob: Blob) => void) | null = null;

  start(canvas: HTMLCanvasElement, onFinish: (blob: Blob) => void) {
    this.onFinish = onFinish;

    const stream = canvas.captureStream(30);
    let mime = "video/webm;codecs=vp9";
    if (!MediaRecorder.isTypeSupported(mime)) mime = "video/webm";

    this.recorder = new MediaRecorder(stream, { mimeType: mime });
    this.chunks = [];

    this.recorder.ondataavailable = (e) => {
      if (e.data.size > 0) this.chunks.push(e.data);
    };

    this.recorder.onstop = () => {
      const blob = new Blob(this.chunks, { type: "video/webm" });
      if (this.onFinish) this.onFinish(blob);
    };

    this.recorder.start();
  }

  stop() {
    if (this.recorder && this.recorder.state === "recording") {
      this.recorder.stop();
    }
  }
}

//
// ================================================================
// 4) HELPER: CameraAnimator
// ================================================================
class CameraAnimator {
  public active = false;

  private t = 0;
  private center = new THREE.Vector3();
  private radius = 10;
  private height = 5;
  private duration = 8;
  private engine: A42Engine;

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  configureFromScene() {
    const box = new THREE.Box3();
    let hasItems = false;

    this.engine.scene.traverse((o) => {
      if (o.userData?.isItem) {
        box.expandByObject(o);
        hasItems = true;
      }
    });

    if (!hasItems) return false;

    box.getCenter(this.center);

    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.z);

    this.radius = maxDim * 0.9 + 2;
    this.height = maxDim * 0.35 + 1;
    this.duration = 8;
    this.t = 0;

    return true;
  }

  start() {
    this.active = true;
    this.engine.sceneManager.controls.enabled = false;
    this.engine.switchCamera("perspective");
  }

  update(delta: number) {
    if (!this.active) return;

    this.t += delta;
    const progress = this.t / this.duration;
    const angle = progress * Math.PI * 2;

    const camX = this.center.x + Math.cos(angle) * this.radius;
    const camZ = this.center.z + Math.sin(angle) * this.radius;

    this.engine.activeCamera.position.set(
      camX,
      this.center.y + this.height,
      camZ
    );

    this.engine.activeCamera.lookAt(this.center);

    if (progress >= 1) {
      this.active = false;
    }
  }
}

//
// ================================================================
// 5) MAIN: RecorderManager
// ================================================================
export class RecorderManager {
  private engine: A42Engine;

  private indicator: RecorderIndicator;
  private state: RecorderState;
  private video: VideoRecorder;
  private animator: CameraAnimator;

  public isRecording = false;
  private pendingName = "";

  constructor(engine: A42Engine) {
    this.engine = engine;

    // üîß YA SE PUEDE USAR engine (ya est√° asignado)
    this.indicator = new RecorderIndicator();
    this.state = new RecorderState(engine);
    this.video = new VideoRecorder();
    this.animator = new CameraAnimator(engine);
  }

  // -------------------------------------------------------------
  // Screenshot
  // -------------------------------------------------------------
  public async takeScreenshot() {
    const name = await useEditorStore
      .getState()
      .requestInput("Nombre de la captura:", "captura");

    if (!name) return;

    this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
    const data = this.engine.renderer.domElement.toDataURL("image/png");

    const a = document.createElement("a");
    a.href = data;
    a.download = `${name}.png`;
    a.click();
  }

  // -------------------------------------------------------------
  // Orbit 360
  // -------------------------------------------------------------
  public async startOrbitAnimation() {
    if (this.isRecording || this.animator.active) return;

    const name = await useEditorStore
      .getState()
      .requestInput("Nombre del video 360:", "video-360");

    if (!name) return;

    this.pendingName = name;

    if (!this.animator.configureFromScene()) {
      alert("No hay objetos para grabar.");
      return;
    }

    this.state.save();
    this.animator.start();
    this.startRecording();
  }

  public update(delta: number) {
    if (!this.animator.active) return;

    this.animator.update(delta);

    if (!this.animator.active) {
      this.stopRecording(true);
      this.state.restore();
    }
  }

  // -------------------------------------------------------------
  // Recording
  // -------------------------------------------------------------
  public startRecording() {
    if (this.isRecording) return;

    this.isRecording = true;
    this.indicator.show();

    const canvas = this.engine.renderer.domElement;

    this.video.start(canvas, (blob) => this.saveVideo(blob));
  }

  public stopRecording(manual = false) {
    if (!this.isRecording) return;

    this.isRecording = false;
    this.indicator.hide();

    this.video.stop();

    if (manual) {
      this.engine.sceneManager.controls.enabled = true;
    }
  }

  // -------------------------------------------------------------
  // Save file
  // -------------------------------------------------------------
  private async saveVideo(blob: Blob) {
    let fileName = this.pendingName;

    if (!fileName) {
      const input = await useEditorStore
        .getState()
        .requestInput("Nombre del video:", "grabacion");

      if (!input) return;

      fileName = input; // lo validamos
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${fileName}.webm`;
    a.click();

    setTimeout(() => URL.revokeObjectURL(url), 300);
  }
}
</file>

<file path="src/features/editor/engine/managers/SceneManager.ts">
// --- FILE: src/features/editor/engine/managers/SceneManager.ts ---
import * as THREE from "three";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
import { Sky } from "three/examples/jsm/objects/Sky.js";
import { useEditorStore } from "@/stores/editor/useEditorStore";

export type CameraView = "top" | "front" | "side" | "iso";

export class SceneManager {
  public scene: THREE.Scene;
  public perspectiveCamera: THREE.PerspectiveCamera;
  public orthoCamera: THREE.OrthographicCamera;
  public activeCamera: THREE.Camera;
  public renderer: THREE.WebGLRenderer;
  public controls: OrbitControls;

  public grid: THREE.GridHelper;
  public dirLight: THREE.DirectionalLight | null = null;
  public sky: Sky | null = null;
  public sun: THREE.DirectionalLight;

  public interactionPlane: THREE.Mesh; // ‚≠êÔ∏è Plano invisible para raycast al suelo

  private container: HTMLElement;
  private frameOverlay: HTMLElement | null = null;

  constructor(container: HTMLElement) {
    this.container = container;

    // === SCENE ===
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color("#222222");

    // === RENDERER ===
    this.renderer = this.createRenderer(container);

    // === CAMERAS ===
    this.perspectiveCamera = this.createPerspectiveCamera();
    this.orthoCamera = this.createOrthoCamera();
    this.activeCamera = this.perspectiveCamera;

    // === CONTROLS ===
    this.controls = this.createControls();

    // === ENVIRONMENT ===
    this.sun = this.createSun();
    this.dirLight = this.sun;
    this.sky = this.createSky();
    this.grid = this.createGrid();
    this.createShadowReceiver();

    // === INTERACTION PLANE ===
    this.interactionPlane = this.createInteractionPlane();

    // === FRAME OVERLAY (PDF) ===
    this.initFrameOverlay();

    // === SYNC CON ZUSTAND EDITOR STORE ===
    this.setupEditorStoreSync();
  }

  // ------------------------------------------------------
  // SYNC CON useEditorStore
  // ------------------------------------------------------
  private setupEditorStoreSync() {
    // Fondo
    useEditorStore.subscribe((state) => {
      const color: string = state.backgroundColor;
      this.setBackgroundColor(color);
    });

    // Cielo
    useEditorStore.subscribe((state) => {
      const visible: boolean = state.skyVisible;
      this.setSkyVisible(visible);
    });

    // Sol
    useEditorStore.subscribe((state) => {
      const sun = state.sunPosition as { azimuth: number; elevation: number };
      this.updateSunPosition(sun.azimuth, sun.elevation);
    });

    // Grid
    useEditorStore.subscribe((state) => {
      const visible: boolean = state.gridVisible;
      this.setGridVisible(visible);
    });
  }

  // ------------------------------------------------------
  // RENDERER
  // ------------------------------------------------------
  private createRenderer(container: HTMLElement) {
    const renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: false,
      preserveDrawingBuffer: true,
      powerPreference: "high-performance",
    });

    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;

    container.appendChild(renderer.domElement);
    return renderer;
  }

  // ------------------------------------------------------
  // CAMERAS
  // ------------------------------------------------------
  private createPerspectiveCamera() {
    const aspect = this.container.clientWidth / this.container.clientHeight;
    const cam = new THREE.PerspectiveCamera(45, aspect, 0.1, 5000);
    cam.position.set(12, 10, 12);
    return cam;
  }

  private createOrthoCamera() {
    const aspect = this.container.clientWidth / this.container.clientHeight;
    const s = 20;

    const cam = new THREE.OrthographicCamera(
      -(s * aspect) / 2,
      (s * aspect) / 2,
      s / 2,
      -s / 2,
      -500,
      500
    );

    cam.position.set(20, 20, 20);
    cam.lookAt(0, 0, 0);

    return cam;
  }

  public switchCamera(type: "perspective" | "orthographic") {
    const oldPos = this.activeCamera.position.clone();
    const target = this.controls.target.clone();

    this.activeCamera =
      type === "perspective" ? this.perspectiveCamera : this.orthoCamera;

    this.activeCamera.position.copy(oldPos);
    this.activeCamera.lookAt(target);

    this.controls.object = this.activeCamera;
    this.controls.update();
  }

  public setView(view: CameraView) {
    const d = 22;
    const target = new THREE.Vector3(0, 0, 0);

    const pos =
      view === "top"
        ? new THREE.Vector3(0, d, 0)
        : view === "front"
        ? new THREE.Vector3(0, 0, d)
        : view === "side"
        ? new THREE.Vector3(d, 0, 0)
        : new THREE.Vector3(d, d, d);

    this.activeCamera.position.copy(pos);
    this.activeCamera.lookAt(target);

    this.controls.target.copy(target);
    this.controls.update();
  }

  // ------------------------------------------------------
  // CONTROLS
  // ------------------------------------------------------
  private createControls() {
    const c = new OrbitControls(this.activeCamera, this.renderer.domElement);

    c.enableDamping = true;
    c.dampingFactor = 0.04;

    c.minDistance = 1;
    c.maxDistance = 500;

    c.screenSpacePanning = true;

    c.mouseButtons = {
      LEFT: THREE.MOUSE.ROTATE,
      MIDDLE: THREE.MOUSE.DOLLY,
      RIGHT: THREE.MOUSE.PAN,
    };

    return c;
  }

  // ------------------------------------------------------
  // ENVIRONMENT
  // ------------------------------------------------------
  private createSun() {
    const sun = new THREE.DirectionalLight(0xffffff, 2.5);
    sun.position.set(60, 80, 60);
    sun.castShadow = true;

    sun.shadow.mapSize.set(2048, 2048);

    const d = 60;
    sun.shadow.camera.left = -d;
    sun.shadow.camera.right = d;
    sun.shadow.camera.top = d;
    sun.shadow.camera.bottom = -d;
    sun.shadow.bias = -0.0001;

    this.scene.add(sun);
    return sun;
  }

  private createSky() {
    const sky = new Sky();
    sky.scale.setScalar(450000);

    const u = sky.material.uniforms;
    u["turbidity"].value = 10;
    u["rayleigh"].value = 3;
    u["mieCoefficient"].value = 0.004;
    u["mieDirectionalG"].value = 0.7;

    this.updateSunPosition(180, 45);

    this.scene.add(sky);
    return sky;
  }

  // ------------------------------------------------------
  // SUN POSITION
  // ------------------------------------------------------
  public updateSunPosition(azimuth: number, elevation: number) {
    if (!this.dirLight) return;

    const phi = THREE.MathUtils.degToRad(90 - elevation);
    const theta = THREE.MathUtils.degToRad(azimuth);

    const x = Math.sin(phi) * Math.cos(theta);
    const y = Math.cos(phi);
    const z = Math.sin(phi) * Math.sin(theta);

    this.dirLight.position.set(x * 50, y * 50, z * 50);
    this.dirLight.target.position.set(0, 0, 0);
    this.dirLight.target.updateMatrixWorld();
  }

  // ------------------------------------------------------
  // GRID & BACKGROUND
  // ------------------------------------------------------
  private createGrid() {
    const grid = new THREE.GridHelper(200, 200, 0x888888, 0x444444);
    grid.position.y = 0.005;
    this.scene.add(grid);
    return grid;
  }

  public setGridVisible(v: boolean) {
    this.grid.visible = v;
  }

  public setSkyVisible(v: boolean) {
    if (!this.sky) return;
    this.sky.visible = v;
    this.scene.background = v ? null : new THREE.Color("#222222");
  }

  public setBackgroundColor(color: string) {
    this.scene.background = new THREE.Color(color);
    if (this.sky) this.sky.visible = false;
  }

  // ------------------------------------------------------
  // INTERACTION PLANE (para clicks sobre el suelo)
  // ------------------------------------------------------
  private createInteractionPlane() {
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(5000, 5000),
      new THREE.MeshBasicMaterial({ visible: false })
    );
    plane.rotation.x = -Math.PI / 2;
    plane.position.y = 0;
    plane.userData.isInteractionPlane = true;
    this.scene.add(plane);
    return plane;
  }

  public raycastWorldPoint(raycaster: THREE.Raycaster): THREE.Vector3 | null {
    const hit = raycaster.intersectObject(this.interactionPlane, false);
    if (!hit.length) return null;
    return hit[0].point;
  }

  // ------------------------------------------------------
  // SHADOW RECEIVER
  // ------------------------------------------------------
  private createShadowReceiver() {
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(2000, 2000),
      new THREE.ShadowMaterial({ opacity: 0.3 })
    );
    plane.rotation.x = -Math.PI / 2;
    plane.receiveShadow = true;
    plane.position.y = 0.001;
    this.scene.add(plane);
  }

  // ------------------------------------------------------
  // FRAME OVERLAY (PDF)
  // ------------------------------------------------------
  private initFrameOverlay() {
    const el = document.createElement("div");
    el.style.position = "absolute";
    el.style.display = "none";
    el.style.border = "2px dashed rgba(255,255,255,0.9)";
    el.style.pointerEvents = "none";
    el.style.zIndex = "200";
    el.style.left = "50%";
    el.style.top = "50%";
    el.style.transform = "translate(-50%, -50%)";

    const label = document.createElement("div");
    label.innerText = "√ÅREA PDF PORTADA";
    label.style.position = "absolute";
    label.style.bottom = "-22px";
    label.style.left = "50%";
    label.style.transform = "translateX(-50%)";
    label.style.fontSize = "11px";
    label.style.fontWeight = "bold";
    label.style.color = "#fff";

    el.appendChild(label);

    if (getComputedStyle(this.container).position === "static") {
      this.container.style.position = "relative";
    }

    this.container.appendChild(el);
    this.frameOverlay = el;
  }

  public setFrameVisible(v: boolean) {
    if (!this.frameOverlay) return;
    this.frameOverlay.style.display = v ? "block" : "none";
    if (v) this.updateFrameDimensions();
  }

  public updateFrameDimensions() {
    if (!this.frameOverlay) return;
    if (this.frameOverlay.style.display === "none") return;

    const w = this.container.clientWidth;
    const h = this.container.clientHeight;

    const aspectTarget = 170 / 120;
    const aspectScreen = w / h;

    let fw: number;
    let fh: number;

    if (aspectScreen > aspectTarget) {
      fh = h * 0.85;
      fw = fh * aspectTarget;
    } else {
      fw = w * 0.85;
      fh = fw / aspectTarget;
    }

    this.frameOverlay.style.width = `${fw}px`;
    this.frameOverlay.style.height = `${fh}px`;
  }

  // ------------------------------------------------------
  // RESIZE & DISPOSE
  // ------------------------------------------------------
  public onWindowResize = () => {
    const w = this.container.clientWidth;
    const h = this.container.clientHeight;

    this.perspectiveCamera.aspect = w / h;
    this.perspectiveCamera.updateProjectionMatrix();

    const s = 20;
    const a = w / h;
    this.orthoCamera.left = -(s * a) / 2;
    this.orthoCamera.right = (s * a) / 2;
    this.orthoCamera.top = s / 2;
    this.orthoCamera.bottom = -s / 2;
    this.orthoCamera.updateProjectionMatrix();

    this.renderer.setSize(w, h);
    this.updateFrameDimensions();
  };

  public dispose() {
    try {
      if (this.renderer.domElement.parentElement) {
        this.container.removeChild(this.renderer.domElement);
      }

      if (this.frameOverlay) {
        this.container.removeChild(this.frameOverlay);
      }
    } catch {}

    this.controls.dispose();
    this.renderer.dispose();
  }
}
// --- END FILE ---
</file>

<file path="src/features/editor/engine/managers/tools/CADTool.ts">
// --- FILE: src/features/editor/engine/managers/tools/CADTool.ts ---
import * as THREE from "three";
import { useCADStore } from "@/stores/cad/useCADStore";

export class CADTool {
  private scene: THREE.Scene;
  private markers: THREE.Mesh[] = [];

  constructor(scene: THREE.Scene) {
    this.scene = scene;
  }

  public reset() {
    this.markers.forEach((m) => this.scene.remove(m));
    this.markers = [];

    useCADStore.getState().setSelectedVertices([], null, null);
  }

  public setMarkers(itemUuid: string, worldPositions: THREE.Vector3[]) {
    void itemUuid; // <- evita warning con erasableSyntaxOnly

    this.reset();

    worldPositions.forEach((pos, index) => {
      const m = new THREE.Mesh(
        new THREE.BoxGeometry(0.4, 0.4, 0.4),
        new THREE.MeshBasicMaterial({ color: 0x00ff00 })
      );
      m.position.copy(pos);
      m.userData.pointIndex = index;
      this.scene.add(m);
      this.markers.push(m);
    });
  }


  public updateDistances() {
    const store = useCADStore.getState();
    const indices = store.selectedVertices;

    let distance: number | null = null;
    let angle: number | null = null;

    if (indices.length >= 2) {
      const a = this.getMarker(indices[0]);
      const b = this.getMarker(indices[1]);
      if (a && b) {
        distance = a.position.distanceTo(b.position);
      }
    }

    if (indices.length === 3) {
      const p0 = this.getMarker(indices[0])?.position;
      const p1 = this.getMarker(indices[1])?.position;
      const p2 = this.getMarker(indices[2])?.position;

      if (p0 && p1 && p2) {
        const v1 = new THREE.Vector3().subVectors(p0, p1).normalize();
        const v2 = new THREE.Vector3().subVectors(p2, p1).normalize();
        angle = THREE.MathUtils.radToDeg(v1.angleTo(v2));
      }
    }

    store.setSelectedVertices([...indices], distance, angle);
  }

  private getMarker(idx: number) {
    return this.markers.find((m) => m.userData.pointIndex === idx);
  }
}
</file>

<file path="src/features/editor/engine/managers/tools/FenceTool.ts">
// --- FILE: src/features/editor/engine/managers/tools/FenceTool.ts ---
import * as THREE from "three";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useFenceStore } from "@/stores/fence/useFenceStore";
import type { FenceItem, FenceConfig as BaseFenceConfig } from "@/types/editor";

// Tipo interno extendido con todos los campos que este tool necesita
type FenceConfig = BaseFenceConfig & {
  moduleLength?: number;

  postHeight: number;
  postType?: string;
  postRadius?: number;
  postWidth?: number;

  fixedCount?: number;
  slatWidth: number;
  slatGap?: number;
  slatThickness: number;

  railType?: string;
  railShape?: string;
  railRadius?: number;
  railThickness?: number;
};

/**
 * FenceTool PRO ‚Äî versi√≥n profesional
 */
export class FenceTool {
  private scene: THREE.Scene;

  private points: THREE.Vector3[] = [];
  private markers: THREE.Mesh[] = [];
  private previewLine: THREE.Line | null = null;

  constructor(scene: THREE.Scene) {
    this.scene = scene;
  }

  // ====================================================================
  // RESET
  // ====================================================================
  public reset() {
    this.markers.forEach((m) => this.scene.remove(m));
    this.markers = [];

    if (this.previewLine) this.scene.remove(this.previewLine);
    this.previewLine = null;

    this.points = [];
  }

  // ====================================================================
  // ADD POINT
  // ====================================================================
  public addPoint(world: THREE.Vector3) {
    const p = world.clone();
    p.y = 0;

    if (this.points.length > 0 && p.distanceTo(this.points.at(-1)!) < 0.1) {
      return;
    }

    this.points.push(p);

    const marker = new THREE.Mesh(
      new THREE.SphereGeometry(0.15),
      new THREE.MeshBasicMaterial({ color: 0x3b82f6 })
    );
    marker.position.copy(p);
    this.scene.add(marker);
    this.markers.push(marker);

    this.updatePreview();
  }

  private updatePreview() {
    if (this.previewLine) this.scene.remove(this.previewLine);

    if (this.points.length > 1) {
      const geo = new THREE.BufferGeometry().setFromPoints(this.points);
      this.previewLine = new THREE.Line(
        geo,
        new THREE.LineBasicMaterial({ color: 0x3b82f6 })
      );
      this.scene.add(this.previewLine);
    }
  }

  // ====================================================================
  // FINALIZE (llamado desde InteractionManager bot√≥n derecho)
  // ====================================================================
  public finalize() {
    this.createFence();
  }

  // ====================================================================
  // CREATE FENCE (SceneItem)
  // ====================================================================
  private createFence() {
    if (this.points.length < 2) return;

    const config = useFenceStore.getState().config as FenceConfig;

    const uuid = THREE.MathUtils.generateUUID();
    const box = new THREE.Box3().setFromPoints(this.points);
    const center = box.getCenter(new THREE.Vector3());

    const localPoints = this.points.map((p) => ({
      x: p.x - center.x,
      z: p.z - center.z,
    }));

    const item: FenceItem = {
      uuid,
      type: "fence",
      productId: "fence_" + (config as any).presetId,
      name: "Valla",
      price: 100,
      points: localPoints,
      // clonamos para no mutar el store
      fenceConfig: structuredClone(config),
      position: [center.x, 0, center.z],
      rotation: [0, 0, 0],
      scale: [1, 1, 1],
    };

    useSceneStore.getState().addItem(item);

    this.reset();
  }

  // ====================================================================
  // RUNTIME GEOMETRY BUILDER
  // ====================================================================
  public static buildFenceMesh(item: FenceItem): THREE.Group {
    const group = new THREE.Group();
    const config = item.fenceConfig as FenceConfig;

    const pts = item.points.map((p) => new THREE.Vector3(p.x, 0, p.z));
    if (pts.length < 2) return group;

    const postMatrices: THREE.Matrix4[] = [];
    const railMatrices: THREE.Matrix4[] = [];
    const slatMatrices: THREE.Matrix4[] = [];

    const temp = new THREE.Object3D();

    const postGeo = FenceTool.getPostGeometry(config);
    const railGeo = FenceTool.getRailGeometry(config);
    const slatGeo = FenceTool.getSlatGeometry(config);

    const moduleLength = config.moduleLength ?? 2.0;
    const postHeight = config.postHeight;

    const topRailY = postHeight - 0.12;
    const bottomRailY = 0.12;

    // --- Recorremos tramos P_i -> P_{i+1} ---
    for (let i = 0; i < pts.length - 1; i++) {
      const A = pts[i];
      const B = pts[i + 1];
      const dist = A.distanceTo(B);
      const dir = new THREE.Vector3().subVectors(B, A).normalize();
      const angle = Math.atan2(dir.x, dir.z);

      // POSTE en el inicio de cada tramo (A)
      FenceTool.pushMatrix(postMatrices, temp, A, angle, 1);

      const segmentCount = Math.max(1, Math.ceil(dist / moduleLength));
      const moduleLen = dist / segmentCount;

      for (let m = 0; m < segmentCount; m++) {
        const t0 = m / segmentCount;
        const t1 = (m + 1) / segmentCount;
        const mid = new THREE.Vector3().lerpVectors(A, B, (t0 + t1) / 2);

        // --- RAILS ---
        if (railGeo) {
          FenceTool.pushMatrix(
            railMatrices,
            temp,
            new THREE.Vector3(mid.x, topRailY, mid.z),
            angle,
            moduleLen
          );
          FenceTool.pushMatrix(
            railMatrices,
            temp,
            new THREE.Vector3(mid.x, bottomRailY, mid.z),
            angle,
            moduleLen
          );
        }

        // --- SLATS ---
        const slatWidth = config.slatWidth;
        const slatGap = config.slatGap ?? 0.04;

        const maxSlats = Math.max(
          1,
          Math.floor(moduleLen / (slatWidth + slatGap))
        );
        const slatCount = config.fixedCount ?? maxSlats;

        for (let s = 0; s < slatCount; s++) {
          const tSlat = (s + 0.5) / slatCount;
          const pSlat = new THREE.Vector3().lerpVectors(A, B, tSlat);
          FenceTool.pushMatrix(
            slatMatrices,
            temp,
            new THREE.Vector3(pSlat.x, postHeight * 0.5, pSlat.z),
            angle,
            1
          );
        }
      }
    }

    // --- √öltimo poste en el punto final P_{n} ---
    FenceTool.pushMatrix(postMatrices, temp, pts.at(-1)!, 0, 1);

    // Instanced meshes
    FenceTool.addInstanced(group, postGeo, postMatrices, config.colors.post);
    if (railGeo)
      FenceTool.addInstanced(group, railGeo, railMatrices, config.colors.post);
    FenceTool.addInstanced(group, slatGeo, slatMatrices, config.colors.slatA);

    return group;
  }

  // ====================================================================
  // HELPERS GEOMETR√çA
  // ====================================================================
  private static getPostGeometry(config: FenceConfig) {
    const h = config.postHeight;

    if (config.postType === "round") {
      const r = config.postRadius ?? 0.06;
      const geo = new THREE.CylinderGeometry(r, r, h, 16);
      geo.translate(0, h / 2, 0);
      return geo;
    }

    const w = config.postWidth ?? 0.08;
    const geo = new THREE.BoxGeometry(w, h, w);
    geo.translate(0, h / 2, 0);
    return geo;
  }

  private static getRailGeometry(config: FenceConfig) {
    if (config.railType === "none") return null;

    if (config.railShape === "round") {
      const r = config.railRadius ?? 0.03;
      const geo = new THREE.CylinderGeometry(r, r, 1, 10);
      geo.rotateX(Math.PI / 2);
      return geo;
    }

    const t = config.railThickness ?? 0.04;
    return new THREE.BoxGeometry(t, t, 1);
  }

  private static getSlatGeometry(config: FenceConfig) {
    const thickness = config.slatThickness;
    const height = config.postHeight * 0.7;
    const width = config.slatWidth;

    return new THREE.BoxGeometry(thickness, height, width);
  }

  private static pushMatrix(
    list: THREE.Matrix4[],
    temp: THREE.Object3D,
    pos: THREE.Vector3,
    angle: number,
    length: number
  ) {
    temp.position.copy(pos);
    temp.rotation.set(0, angle, 0);
    temp.scale.set(1, 1, length);
    temp.updateMatrix();
    list.push(temp.matrix.clone());
  }

  private static addInstanced(
    group: THREE.Group,
    geo: THREE.BufferGeometry | null,
    matrices: THREE.Matrix4[],
    color: number
  ) {
    if (!geo || matrices.length === 0) return;

    const mat = new THREE.MeshStandardMaterial({
      color,
      roughness: 0.5,
      metalness: 0.1,
    });
    const inst = new THREE.InstancedMesh(geo, mat, matrices.length);

    matrices.forEach((m, i) => inst.setMatrixAt(i, m));
    inst.instanceMatrix.needsUpdate = true;

    group.add(inst);
  }
}
// --- END FILE ---
</file>

<file path="src/features/editor/engine/managers/tools/FloorTool.ts">
// --- FILE: src/features/editor/engine/managers/tools/FloorTool.ts ---
import * as THREE from "three";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import type { FloorItem } from "@/types/editor";

export class FloorTool {
  private scene: THREE.Scene;
  private points: THREE.Vector3[] = [];
  private markers: THREE.Mesh[] = [];
  private previewLine: THREE.Line | null = null;

  constructor(scene: THREE.Scene) {
    this.scene = scene;
  }

  // RESET ----------------------------------------------------------
  public reset() {
    this.markers.forEach((m) => this.scene.remove(m));
    this.markers = [];

    if (this.previewLine) this.scene.remove(this.previewLine);
    this.previewLine = null;

    this.points = [];
  }

  // ADD POINT ------------------------------------------------------
  public addPoint(world: THREE.Vector3) {
    const p = world.clone();
    p.y = 0;

    if (this.points.length > 0 && p.distanceTo(this.points.at(-1)!) < 0.1) return;

    this.points.push(p);

    const marker = new THREE.Mesh(
      new THREE.SphereGeometry(0.12),
      new THREE.MeshBasicMaterial({ color: 0xe67e22 })
    );

    marker.position.copy(p);
    this.scene.add(marker);
    this.markers.push(marker);

    if (this.previewLine) this.scene.remove(this.previewLine);

    if (this.points.length > 1) {
      const geo = new THREE.BufferGeometry().setFromPoints(this.points);
      this.previewLine = new THREE.Line(
        geo,
        new THREE.LineBasicMaterial({ color: 0x9b59b6 })
      );
      this.scene.add(this.previewLine);
    }
  }

  // CREATE FLOOR ---------------------------------------------------
  public createFloor() {
    if (this.points.length < 3) return;

    const uuid = THREE.MathUtils.generateUUID();
    const box = new THREE.Box3().setFromPoints(this.points);
    const center = box.getCenter(new THREE.Vector3());

    const local = this.points.map((p) => ({
      x: p.x - center.x,
      z: p.z - center.z,
    }));

    const item: FloorItem = {
      uuid,
      productId: "custom_floor",
      name: "Suelo",
      type: "floor",
      price: 100,
      points: local,
      floorMaterial: "rubber_red",
      position: [center.x, 0, center.z],
      rotation: [0, 0, 0],
      scale: [1, 1, 1],
    };

    useSceneStore.getState().addItem(item);
    this.reset();
  }

  // FINALIZE --------------------------------------------------------
  public finalize() {
    this.createFloor();
  }
}
</file>

<file path="src/features/editor/engine/managers/tools/MeasurementTool.ts">
// --- FILE: src/features/editor/engine/managers/tools/MeasurementTool.ts ---
import * as THREE from "three";
import { useEditorStore } from "@/stores/editor/useEditorStore";

export class MeasurementTool {
  private scene: THREE.Scene;
  private points: THREE.Vector3[] = [];
  private markers: THREE.Mesh[] = [];
  private line: THREE.Line | null = null;

  constructor(scene: THREE.Scene) {
    this.scene = scene;
  }

  public reset() {
    this.markers.forEach((m) => this.scene.remove(m));
    this.markers = [];

    if (this.line) this.scene.remove(this.line);
    this.line = null;

    this.points = [];
  }

  public addPoint(world: THREE.Vector3) {
    const p = world.clone();
    p.y += 0.05;

    this.points.push(p);

    const m = new THREE.Mesh(
      new THREE.SphereGeometry(0.1),
      new THREE.MeshBasicMaterial({ color: 0xffff00 })
    );
    m.position.copy(p);
    this.scene.add(m);
    this.markers.push(m);

    if (this.points.length === 2) {
      const dist = this.points[0].distanceTo(this.points[1]);

      const g = new THREE.BufferGeometry().setFromPoints(this.points);
      const mat = new THREE.LineBasicMaterial({ color: 0xffff00 });
      this.line = new THREE.Line(g, mat);
      this.scene.add(this.line);

      // üîß Intento de enviar la medida al store (si existe ese m√©todo)
      const editorState = useEditorStore.getState() as any;
      if (typeof editorState.setMeasurementResult === "function") {
        editorState.setMeasurementResult(dist);
      } else {
        // TODO: conectar con el nuevo sistema de mediciones si lo hay
        console.log("Distancia medida:", dist.toFixed(3), "m");
      }

      this.reset();
    }
  }
}
</file>

<file path="src/features/editor/engine/managers/tools/PlacingTool.ts">
// --- FILE: src/features/editor/engine/managers/tools/PlacingTool.ts ---
import * as THREE from "three";
import { ObjectManager } from "../ObjectManager";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import type { ProductDefinition } from "@/types/catalog";
import type { ModelItem } from "@/types/editor";

export class PlacingTool {
  private objectManager: ObjectManager;

  // Recibimos la escena pero no la usamos por ahora (por eso no la guardo)
  constructor(_scene: THREE.Scene, objectManager: ObjectManager) {
    this.objectManager = objectManager;
  }

  public async place(point: THREE.Vector3, product: ProductDefinition) {
    if (!product.modelUrl) return;

    const uuid = THREE.MathUtils.generateUUID();

    const item: ModelItem = {
      uuid,
      type: "model",
      productId: product.id,
      name: product.name,
      modelUrl: product.modelUrl,
      price: product.price ?? 0,
      position: [point.x, 0, point.z] as [number, number, number],
      rotation: [0, 0, 0] as [number, number, number],
      scale: [1, 1, 1] as [number, number, number],
      data: product,
    };

    // SceneStore espera un SceneItem (ModelItem es compatible)
    useSceneStore.getState().addItem(item);

    // Y el ObjectManager crea el Object3D correspondiente
    await this.objectManager.createFromItem(item);
  }
}
</file>

<file path="src/features/editor/engine/managers/ToolsManager.ts">
// --- FILE: src/features/editor/engine/managers/ToolsManager.ts ---
import type * as THREE from "three";
import type { ObjectManager } from "./ObjectManager";

import { FloorTool } from "./tools/FloorTool";
import { FenceTool } from "./tools/FenceTool";
import { CADTool } from "./tools/CADTool";

export class ToolsManager {
  public floorTool: FloorTool;
  public fenceTool: FenceTool;
  public cadTool: CADTool;

  constructor(scene: THREE.Scene, objectManager: ObjectManager) {
    this.floorTool = new FloorTool(scene);
    this.fenceTool = new FenceTool(scene);
    this.cadTool = new CADTool(scene);
  }

  public clearTools() {
    this.floorTool.reset();
    this.fenceTool.reset();
    this.cadTool.reset();
  }
}
</file>

<file path="src/features/editor/engine/managers/WalkManager.ts">
// --- FILE: src/features/editor/engine/managers/WalkManager.ts ---
import * as THREE from "three";
import { PointerLockControls } from "three/examples/jsm/controls/PointerLockControls.js";
import type { A42Engine } from "../A42Engine";

export class WalkManager {
  private engine: A42Engine;
  private controls: PointerLockControls;

  private hud: HTMLElement | null = null;

  // Movimiento
  private vel = new THREE.Vector3();
  private dir = new THREE.Vector3();

  private moveForward = false;
  private moveBackward = false;
  private moveLeft = false;
  private moveRight = false;
  private moveUp = false;
  private moveDown = false;
  private isSlow = false;

  private baseSpeed = 80;
  private slowMultiplier = 0.2;

  constructor(engine: A42Engine) {
    this.engine = engine;

    this.controls = new PointerLockControls(
      this.engine.activeCamera,
      this.engine.renderer.domElement
    );
    this.controls.pointerSpeed = 0.15;

    this.createHUD();

    // PointerLock events
    this.controls.addEventListener("lock", () => {
      if (this.hud) this.hud.style.display = "block";
    });

    this.controls.addEventListener("unlock", () => {
      this.resetMovement();
      if (this.hud) this.hud.style.display = "none";
    });

    // Key listeners
    document.addEventListener("keydown", this.onKeyDown);
    document.addEventListener("keyup", this.onKeyUp);

    this.engine.scene.add(this.controls.getObject());
  }

  // ============================================================================
  // HUD
  // ============================================================================
  private createHUD() {
    const hud = document.createElement("div");
    hud.className = "walk-hud";

    hud.innerHTML = `
      <div class="walk-title">MODO PASEO</div>
      <div class="walk-info">
        üñ±Ô∏è Mueve para mirar ‚Äî  
        <b>WASD</b> mover ‚Äî  
        <b>Q/E</b> altura ‚Äî  
        <b>Espacio</b> lento ‚Äî  
        <b>ESC</b> salir<br/>
        <span class="walk-rec">üî¥ 'R' para grabar</span>
      </div>
    `;

    Object.assign(hud.style, {
      position: "absolute",
      bottom: "100px",
      left: "50%",
      transform: "translateX(-50%)",
      padding: "14px 24px",
      background: "rgba(0,0,0,0.55)",
      color: "#fff",
      fontFamily: "sans-serif",
      borderRadius: "28px",
      textAlign: "center",
      pointerEvents: "none",
      display: "none",
      zIndex: "2000",
      backdropFilter: "blur(6px)",
      border: "1px solid rgba(255,255,255,0.15)",
      fontSize: "13px",
      lineHeight: "18px"
    });

    document.body.appendChild(hud);
    this.hud = hud;
  }

  // ============================================================================
  // STATE
  // ============================================================================
  private resetMovement() {
    this.moveForward = false;
    this.moveBackward = false;
    this.moveLeft = false;
    this.moveRight = false;
    this.moveUp = false;
    this.moveDown = false;
    this.isSlow = false;
  }

  public enable() {
    this.controls.lock();
  }

  public disable() {
    this.controls.unlock();
  }

  public get isEnabled() {
    return this.controls.isLocked;
  }

  // ============================================================================
  // INPUT
  // ============================================================================
  private onKeyDown = (e: KeyboardEvent) => {
    if (document.activeElement instanceof HTMLInputElement) return;

    switch (e.code) {
      case "KeyW":
      case "ArrowUp":
        this.moveForward = true;
        break;

      case "KeyS":
      case "ArrowDown":
        this.moveBackward = true;
        break;

      case "KeyA":
      case "ArrowLeft":
        this.moveLeft = true;
        break;

      case "KeyD":
      case "ArrowRight":
        this.moveRight = true;
        break;

      case "KeyE":
        this.moveUp = true;
        break;

      case "KeyQ":
        this.moveDown = true;
        break;

      case "Space":
        this.isSlow = true;
        break;

      case "KeyR":
        if (this.isEnabled) {
          const rec = this.engine.recorderManager;
          rec.isRecording ? rec.stopRecording() : rec.startRecording();
        }
        break;
    }
  };

  private onKeyUp = (e: KeyboardEvent) => {
    switch (e.code) {
      case "KeyW":
      case "ArrowUp":
        this.moveForward = false;
        break;

      case "KeyS":
      case "ArrowDown":
        this.moveBackward = false;
        break;

      case "KeyA":
      case "ArrowLeft":
        this.moveLeft = false;
        break;

      case "KeyD":
      case "ArrowRight":
        this.moveRight = false;
        break;

      case "KeyE":
        this.moveUp = false;
        break;

      case "KeyQ":
        this.moveDown = false;
        break;

      case "Space":
        this.isSlow = false;
        break;
    }
  };

  // ============================================================================
  // UPDATE LOOP
  // ============================================================================
  public update(delta: number) {
    if (!this.controls.isLocked) return;

    // Damping
    this.vel.multiplyScalar(1 - 10 * delta);

    // Direcci√≥n
    this.dir.set(
      Number(this.moveRight) - Number(this.moveLeft),
      Number(this.moveUp) - Number(this.moveDown),
      Number(this.moveForward) - Number(this.moveBackward)
    );

    if (this.dir.lengthSq() > 0) this.dir.normalize();

    const speed = this.isSlow
      ? this.baseSpeed * this.slowMultiplier
      : this.baseSpeed;

    // Aplicar aceleraci√≥n
    this.vel.x -= this.dir.x * speed * delta;
    this.vel.y += this.dir.y * speed * delta;
    this.vel.z -= this.dir.z * speed * delta;

    this.controls.moveRight(-this.vel.x * delta);
    this.controls.moveForward(-this.vel.z * delta);

    const camObj = this.controls.getObject();
    camObj.position.y += this.vel.y * delta;
  }
}
</file>

<file path="src/features/editor/hooks/useEditorMedia.ts">
import { useState } from 'react';
import { useEngine } from '../context/EngineContext';


export const useEditorMedia = () => {
  const engine = useEngine();
  const [isRecording, setIsRecording] = useState(false);

  // --- FOTO Y VIDEO ---
  const takePhoto = async () => {
    if (!engine) return;
    await engine.recorderManager.takeScreenshot();
  };

  const start360Video = async () => {
    if (!engine) return;
    await engine.recorderManager.startOrbitAnimation();
  };

  const toggleRecording = () => {
    if (!engine) return;
    const manager = engine.recorderManager;
    
    if (isRecording) {
      manager.stopRecording();
      setIsRecording(false);
    } else {
      manager.startRecording();
      setIsRecording(true);
    }
  };

  // --- EXPORTACI√ìN ---
  const exportGLB = async () => {
    if (!engine) return;
    await engine.exportManager.exportGLB();
  };

  const exportDXF = async () => {
    if (!engine) return;
    await engine.exportManager.exportDXF();
  };

  const generatePDF = async () => {
    if (!engine) return;
    await engine.pdfManager.generatePDF();
  };

  return {
    isRecording,
    takePhoto,
    start360Video,
    toggleRecording,
    exportGLB,
    exportDXF,
    generatePDF
  };
};
</file>

<file path="src/features/editor/hooks/useProjectActions.ts">
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import { useEditorStore } from '@/stores/editor/useEditorStore';
import { useSceneStore } from '@/stores/scene/useSceneStore';
import { useProjectStore } from '@/stores/project/useProjectStore';
import { useUserStore } from '@/stores/user/useUserStore';
import { useEngine } from '../context/EngineContext';

export const useProjectActions = () => {
  const engine = useEngine();
  const [isSaving, setIsSaving] = useState(false);

  // Editor
  const { requestInput, cameraType } = useEditorStore();

  // Scene
  const items = useSceneStore((s) => s.items); // solo items

  // Project Store
  const projectId = useProjectStore((s) => s.projectId);
  const projectName = useProjectStore((s) => s.projectName);
  const isReadOnlyMode = useProjectStore((s) => s.isReadOnlyMode);
  const setProjectInfo = useProjectStore((s) => s.setProjectInfo);

  // User Store (REAL origen del usuario)
  const user = useUserStore.getState().user;

  // Total Price debe venir del ProjectStore
  const totalPrice = useProjectStore((s) => s.totalPrice ?? 0);

  const saveProject = async () => {
    if (isReadOnlyMode)
      return alert("‚ö†Ô∏è Modo Solo Lectura. No puedes sobrescribir este proyecto.");

    if (!user)
      return alert("üîí Inicia sesi√≥n para guardar tu proyecto.");

    if (!engine) return;

    // 1. GENERAR THUMBNAIL
    engine.renderer.render(engine.scene, engine.activeCamera);
    const thumbnailBase64 = engine.renderer.domElement.toDataURL("image/jpeg", 0.5);

    // 2. Datos del proyecto
    const projectData = {
      items,
      camera: cameraType,
    };

    // 3. Nombre del proyecto
    let nameToSave = projectName;
    let isOverwrite = false;

    if (projectId) {
      if (confirm(`¬øSobreescribir el proyecto "${projectName}"?`)) {
        isOverwrite = true;
      } else {
        const newName = await requestInput(
          "Guardar como nuevo:",
          projectName + " (Copia)"
        );
        if (!newName) return;
        nameToSave = newName;
        isOverwrite = false;
      }
    } else {
      const newName = await requestInput("Nombre del Proyecto:", "Mi Parque Nuevo");
      if (!newName) return;
      nameToSave = newName;
      isOverwrite = false;
    }

    setIsSaving(true);
    try {
      if (isOverwrite && projectId) {
        // === ACTUALIZAR EXISTENTE ===
        const { error } = await supabase
          .from("projects")
          .update({
            name: nameToSave,
            data: projectData,
            thumbnail_url: thumbnailBase64,
            total_price: totalPrice,
            updated_at: new Date(),
          })
          .eq("id", projectId);

        if (error) throw error;

        alert("‚úÖ Proyecto actualizado correctamente.");
      } else {
        // === CREAR NUEVO ===
        const { data, error } = await supabase
          .from("projects")
          .insert([
            {
              user_id: user.id,
              name: nameToSave,
              data: projectData,
              thumbnail_url: thumbnailBase64,
              total_price: totalPrice,
            },
          ])
          .select()
          .single();

        if (error) throw error;

        alert("üíæ Proyecto guardado correctamente.");

        if (data) setProjectInfo(data.id, data.name);
      }
    } catch (err: any) {
      console.error(err);
      alert("‚ùå Error al guardar: " + err.message);
    } finally {
      setIsSaving(false);
    }
  };

  // ================================
  // IMPORTAR GLB
  // ================================
  const importGLB = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const url = URL.createObjectURL(file);
    const fileName = file.name.replace(/\.(glb|gltf)$/i, "");

    useSceneStore.getState().addItem({
      uuid: crypto.randomUUID(),
      productId: "custom_upload",
      name: fileName,
      price: 0,
      type: "model",
      data: {},
      position: [0, 0, 0],
      rotation: [0, 0, 0],
      scale: [1, 1, 1],
      modelUrl: url,
    } as any);

    event.target.value = "";
  };

  return {
    saveProject,
    importGLB,
    isSaving,
  };
};
</file>

<file path="src/features/editor/hooks/useSceneTools.ts">
// --- FILE: src/features/editor/hooks/useSceneTools.ts ---
import { useEngine } from "../context/EngineContext";

export const useSceneTools = () => {
  const engine = useEngine();

  const activateWalkMode = () => {
    engine?.walkManager.enable();
  };

  const setCadSegment = (length: number, idxMove: number, idxAnchor: number) => {
    const tools = engine?.toolsManager as any;
    tools?.setSegmentLength?.(length, idxMove, idxAnchor);
  };

  const setCadAngle = (angle: number) => {
    const tools = engine?.toolsManager as any;
    tools?.setVertexAngle?.(angle);
  };

  const swapCadSelection = () => {
    const tools = engine?.toolsManager as any;
    tools?.swapSelectionOrder?.();
  };

  return {
    activateWalkMode,
    setCadSegment,
    setCadAngle,
    swapCadSelection,
  };
};
</file>

<file path="src/features/editor/ui/BudgetPanel.tsx">
// --- FIXED FILE: src/features/editor/ui/BudgetPanel.tsx ---

import { Trash2, X } from "lucide-react";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export const BudgetPanel = () => {
  // Editor UI
  const budgetVisible = useEditorStore((s) => s.budgetVisible);
  const toggleBudget = useEditorStore((s) => s.toggleBudget);

  // Scene data
  const items = useSceneStore((s) => s.items);
  const totalPrice = useSceneStore((s) => s.totalPrice ?? 0);
  const removeItem = useSceneStore((s) => s.removeItem);
  const resetScene = useSceneStore((s) => s.resetScene);

  // Selection
  const selectItem = useSelectionStore((s) => s.select);

  if (!budgetVisible) return null;

  return (
    <div className="absolute top-20 left-6 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl shadow-2xl w-80 max-h-[70vh] flex flex-col z-30 animate-in fade-in slide-in-from-left-5 duration-200">

      <div className="p-4 border-b border-neutral-700 flex justify-between items-center bg-neutral-800/50 rounded-t-xl">
        <h2 className="text-white font-bold text-lg flex items-center gap-2">
          üßæ Presupuesto
        </h2>
        <button onClick={toggleBudget} className="text-neutral-400 hover:text-white">
          <X size={20} />
        </button>
      </div>

      <div className="flex-grow overflow-y-auto p-2 custom-scrollbar space-y-2">
        {items.length === 0 ? (
          <div className="text-center py-8 text-neutral-500 italic">
            La escena est√° vac√≠a.
          </div>
        ) : (
          items.map((item) => (
            <div
              key={item.uuid}
              className="flex justify-between items-center p-3 bg-neutral-800 rounded-lg group hover:bg-neutral-700 transition-colors border border-transparent hover:border-blue-500/30 cursor-pointer"
              onClick={() => selectItem(item.uuid)}
            >
              <div className="flex flex-col">
                <span className="text-white font-medium text-sm">
                  {item.name || "Sin Nombre"}
                </span>

                <span className="text-xs text-neutral-500 uppercase font-mono">
                  {item.productId}
                </span>
              </div>

              <div className="flex items-center gap-3">
                <span className="text-sm font-bold text-neutral-400">
                  {item.price.toLocaleString()}‚Ç¨
                </span>

                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    removeItem(item.uuid);
                  }}
                  className="text-neutral-500 hover:text-red-400 p-2 rounded-full hover:bg-red-900/20 transition-all opacity-0 group-hover:opacity-100"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      <div className="p-4 border-t border-neutral-700 bg-neutral-800/50 rounded-b-xl space-y-3">
        <div className="flex justify-between items-end">
          <span className="text-neutral-400 text-sm">Total Estimado</span>
          <span className="text-2xl font-bold text-green-400">
            {totalPrice.toLocaleString()} ‚Ç¨
          </span>
        </div>

        {items.length > 0 && (
          <button
            onClick={() => {
              if (confirm("¬øBorrar todo?")) resetScene();
            }}
            className="w-full py-2 bg-red-900/30 hover:bg-red-600 text-red-200 hover:text-white rounded-lg text-sm font-medium transition-all flex justify-center items-center gap-2 border border-red-900/50"
          >
            <Trash2 size={16} />
            Borrar Todo
          </button>
        )}
      </div>
    </div>
  );
};

// --- END FIXED FILE ---
</file>

<file path="src/features/editor/ui/CadControl.tsx">
import { useEffect, useState } from "react";
import { useCADStore } from "@/stores/cad/useCADStore"; 
import { useSceneTools } from "../hooks/useSceneTools"; // üëà Hook nuevo
import { ArrowLeftRight } from "lucide-react";

export const CadControl = () => {
  const { setCadSegment, setCadAngle, swapCadSelection } = useSceneTools();
  
  const selectedVertexIndices = useCADStore((s) => s.selectedVertices);
  const dist = useCADStore((s) => s.distance);
  const angle = useCADStore((s) => s.angle);

  const [inputValue, setInputValue] = useState<string>("");

  const mode = selectedVertexIndices.length === 3 ? "ANGLE" : "DISTANCE";

  useEffect(() => {
      if (mode === "ANGLE" && angle !== null) {
        setInputValue(angle.toFixed(1));
      } else if (mode === "DISTANCE" && dist !== null) {
        setInputValue(dist.toFixed(3));
      }
    }, [dist, angle, mode]);

  const handleApply = () => {
    const val = parseFloat(inputValue);
    if (isNaN(val) || val <= 0) return;

    if (mode === "DISTANCE") {
      setCadSegment(val, selectedVertexIndices[1], selectedVertexIndices[0]);
    } else {
      setCadAngle(val);
    }
  };

  if (selectedVertexIndices.length < 2) return null;

  return (
    <div
      className={`p-3 rounded-lg mb-3 border-l-4 shadow-lg ${
        mode === "ANGLE"
          ? "border-yellow-500 bg-neutral-800"
          : "border-blue-500 bg-neutral-800"
      }`}
    >
      <div className="flex justify-between items-center mb-2">
        <span className="text-xs font-bold uppercase text-white">
          {mode === "ANGLE" ? "üìê √Ångulo" : "üìè Distancia"}
        </span>
        {mode === "DISTANCE" && (
          <button
            onClick={swapCadSelection}
            className="p-1 hover:bg-white/10 rounded text-blue-400"
            title="Cambiar direcci√≥n"
          >
            <ArrowLeftRight size={14} />
          </button>
        )}
      </div>

      <div className="flex gap-2">
        <input
          type="number"
          value={inputValue}
          onChange={(e) => setInputValue(e.target.value)}
          className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-sm text-white font-mono"
        />
        <button
          onClick={handleApply}
          className="bg-blue-600 hover:bg-blue-500 px-3 rounded text-xs font-bold text-white"
        >
          OK
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/ui/Catalog.tsx">
// --- FILE: src/features/editor/ui/Catalog.tsx ---
import { useEffect, useState, useMemo } from "react";
import { Search, X } from "lucide-react";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useCatalogStore } from "@/stores/catalog/useCatalogStore";

import {
  loadCatalogData,
  getCatalogDB,
  getCatalogLoadStatus,
  getProxiedImageUrl,
  type Product,
  type CatalogDB,
} from "../../../services/catalogService";

export const Catalog = () => {
  // üî• CORRECTO: Usamos setActiveTool y NO setMode
  const { setMode } = useEditorStore();

  // üî• CORRECTO: El store del cat√°logo usa selectProduct()
  const { selectProduct } = useCatalogStore();

  const [catalogDB, setCatalogDB] = useState<CatalogDB | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [currentLine, setCurrentLine] = useState<string | null>(null);
  const [currentCategory, setCurrentCategory] = useState<string | null>(null);

  const [searchTerm, setSearchTerm] = useState("");

  // ======================================================
  // LOAD CATALOG
  // ======================================================
  useEffect(() => {
    const fetchCatalog = async () => {
      setLoading(true);
      setError(null);

      await loadCatalogData();
      const status = getCatalogLoadStatus();

      if (status.error) setError(status.error);
      else if (status.isLoaded) setCatalogDB(getCatalogDB());

      setLoading(false);
    };

    fetchCatalog();
  }, []);

  // ======================================================
  // PRODUCTS LIST
  // ======================================================
  const allProducts = useMemo(() => {
    if (!catalogDB) return [];
    const products: Product[] = [];
    Object.values(catalogDB.lines).forEach((line) => {
      Object.values(line.categories).forEach((catProducts) => {
        products.push(...catProducts);
      });
    });
    return products;
  }, [catalogDB]);

  const filteredProducts = useMemo(() => {
    if (!searchTerm) return [];
    const t = searchTerm.toLowerCase();
    return allProducts.filter(
      (p) =>
        p.name.toLowerCase().includes(t) ||
        p.id.toLowerCase().includes(t)
    );
  }, [searchTerm, allProducts]);

  // ======================================================
  // CLICK PRODUCT ‚Üí activate placing mode
  // ======================================================
  const handleSelectProduct = (product: Product) => {
    selectProduct(product);
    setMode("placing_item"); // üî• YA FUNCIONA
  };

  const handleBackToLines = () => {
    setCurrentCategory(null);
    setCurrentLine(null);
    setSearchTerm("");
  };

  // ======================================================
  // LOADING STATES
  // ======================================================
  if (loading)
    return (
      <div className="absolute inset-0 bg-neutral-900/90 flex items-center justify-center z-50">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-white text-lg">Cargando cat√°logo...</p>
        </div>
      </div>
    );

  if (error)
    return (
      <div className="absolute inset-0 bg-neutral-900/90 flex flex-col items-center justify-center z-50 p-4">
        <p className="text-red-400 text-lg mb-4">Error al cargar cat√°logo:</p>
        <p className="text-red-300 text-sm text-center mb-6 max-w-lg">
          {error}
        </p>
        <button
          onClick={() => window.location.reload()}
          className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
        >
          Reintentar
        </button>
      </div>
    );

  if (!catalogDB) return null;

  // ======================================================
  // MAIN RENDER LOGIC
  // ======================================================
  const renderContent = () => {
    // --------------------------------------------------
    // 0. SEARCH RESULTS
    // --------------------------------------------------
    if (searchTerm) {
      if (filteredProducts.length === 0)
        return (
          <div className="flex flex-col items-center justify-center h-64 text-neutral-400">
            <Search size={48} className="mb-4 opacity-50" />
            <p className="text-xl">
              No se encontraron productos para "{searchTerm}"
            </p>
          </div>
        );

      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
            Resultados ({filteredProducts.length})
          </h2>

          <div
            className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 custom-scrollbar pr-2 pb-20"
            style={{ maxHeight: "calc(100vh - 200px)", overflowY: "auto" }}
          >
            {filteredProducts.map((product) => (
              <div
                key={product.id}
                className="group bg-neutral-800 rounded-xl overflow-hidden shadow-lg hover:shadow-blue-500/50 transition-all duration-300 border border-neutral-700 hover:border-blue-500 cursor-pointer flex flex-col"
                onClick={() => handleSelectProduct(product)}
              >
                <div className="aspect-square bg-white/5 p-4 flex items-center justify-center relative overflow-hidden">
                  {product.img_2d ? (
                    <img
                      src={getProxiedImageUrl(product.img_2d)}
                      alt={product.name}
                      className="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300"
                      loading="lazy"
                    />
                  ) : (
                    <span className="text-neutral-500 text-sm">
                      Sin imagen
                    </span>
                  )}
                </div>

                <div className="p-4 flex-grow flex flex-col justify-between bg-neutral-800">
                  <h3 className="text-white font-medium text-lg mb-2">
                    {product.name}
                  </h3>

                  <div className="flex justify-between items-end">
                    <span className="text-xs text-neutral-500">{product.id}</span>
                    <p className="text-green-400 font-bold">
                      {product.price.toLocaleString()} ‚Ç¨
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </>
      );
    }

    // --------------------------------------------------
    // 1. CATEGORY VIEW
    // --------------------------------------------------
    if (currentLine && currentCategory) {
      const products =
        catalogDB.lines[currentLine]?.categories[currentCategory];

      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
            <span className="opacity-50">{currentLine} /</span>{" "}
            {currentCategory}
          </h2>

          <div
            className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 custom-scrollbar pr-2 pb-20"
            style={{ maxHeight: "calc(100vh - 200px)", overflowY: "auto" }}
          >
            {products.map((product) => (
              <div
                key={product.id}
                className="group bg-neutral-800 rounded-xl overflow-hidden shadow-lg hover:shadow-blue-500/50 transition-all duration-300 border border-neutral-700 hover:border-blue-500 cursor-pointer flex flex-col"
                onClick={() => handleSelectProduct(product)}
              >
                <div className="aspect-square bg-white/5 p-4 flex items-center justify-center relative overflow-hidden">
                  {product.img_2d ? (
                    <img
                      src={getProxiedImageUrl(product.img_2d)}
                      alt={product.name}
                      className="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300"
                    />
                  ) : (
                    <span className="text-neutral-500 text-sm">
                      Sin imagen
                    </span>
                  )}
                </div>

                <div className="p-4 flex-grow flex flex-col justify-between bg-neutral-800">
                  <h3 className="text-white font-medium text-lg mb-2">
                    {product.name}
                  </h3>
                  <p className="text-green-400 font-bold">
                    {product.price.toLocaleString()} ‚Ç¨
                  </p>
                </div>
              </div>
            ))}
          </div>
        </>
      );
    }

    // --------------------------------------------------
    // 2. CATEGORY LIST
    // --------------------------------------------------
    if (currentLine) {
      const categories = catalogDB.lines[currentLine]?.categories;

      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6">{currentLine}</h2>

          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {Object.keys(categories).map((catName) => {
              const first = categories[catName][0];
              const bgImage = first?.img_2d
                ? getProxiedImageUrl(first.img_2d)
                : null;

              return (
                <div
                  key={catName}
                  onClick={() => setCurrentCategory(catName)}
                  className="relative h-48 rounded-xl overflow-hidden cursor-pointer shadow-lg hover:shadow-blue-500/40 transition-all duration-300 border border-neutral-700"
                >
                  {bgImage ? (
                    <div
                      className="absolute inset-0 bg-cover bg-center group-hover:scale-110 transition-transform duration-500"
                      style={{ backgroundImage: `url(${bgImage})` }}
                    />
                  ) : (
                    <div className="absolute inset-0 bg-neutral-800" />
                  )}

                  <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent" />
                  <div className="absolute bottom-0 left-0 p-4">
                    <h3 className="text-white text-xl font-bold">{catName}</h3>
                    <p className="text-neutral-300 text-xs">
                      {categories[catName].length} productos
                    </p>
                  </div>
                </div>
              );
            })}
          </div>
        </>
      );
    }

    // --------------------------------------------------
    // 3. LINE LIST (HOME)
    // --------------------------------------------------
    const lineNames = Object.keys(catalogDB.lines);

    return (
      <>
        <h2 className="text-2xl font-bold text-white mb-6">
          Nuestras L√≠neas
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {lineNames.map((lineName) => {
            const lineData = catalogDB.lines[lineName];
            const bgImage = lineData.lineImage
              ? getProxiedImageUrl(lineData.lineImage)
              : null;

            return (
              <div
                key={lineName}
                className="relative h-64 rounded-2xl overflow-hidden cursor-pointer shadow-2xl hover:shadow-purple-500/40 border border-neutral-700 transition-all duration-300 group"
                onClick={() => setCurrentLine(lineName)}
              >
                {bgImage ? (
                  <div
                    className="absolute inset-0 bg-cover bg-center group-hover:scale-105 transition-transform duration-700"
                    style={{ backgroundImage: `url(${bgImage})` }}
                  />
                ) : (
                  <div className="absolute inset-0 bg-neutral-800" />
                )}

                <div className="absolute inset-0 bg-black/30" />

                <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10">
                  <h3 className="text-4xl font-black text-white uppercase tracking-wider group-hover:-translate-y-1 transition-transform duration-300">
                    {lineName}
                  </h3>
                  <span className="mt-4 px-4 py-1 border border-white/30 rounded-full text-xs font-semibold text-white/80 uppercase tracking-widest backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-all duration-500">
                    Ver Colecci√≥n
                  </span>
                </div>
              </div>
            );
          })}
        </div>
      </>
    );
  };

  // ======================================================
  // MAIN LAYOUT
  // ======================================================
  return (
    <div className="absolute inset-0 bg-neutral-950/95 backdrop-blur-md z-40 flex flex-col animate-in fade-in duration-200">
      {/* HEADER */}
      <div className="flex justify-between items-center p-6 border-b border-white/10 bg-black/20 gap-4">
        {/* PATH (line/category) */}
        <div className="flex items-center space-x-3 flex-grow min-w-0">
          <button
            onClick={() => {
              setCurrentLine(null);
              setCurrentCategory(null);
              setSearchTerm("");
            }}
            className={`text-2xl font-bold ${
              !currentLine && !searchTerm
                ? "text-white"
                : "text-neutral-400 hover:text-white"
            }`}
          >
            Cat√°logo
          </button>

          {currentLine && !searchTerm && (
            <>
              <span className="text-neutral-600 text-2xl">/</span>
              <button
                onClick={handleBackToLines}
                className={`text-2xl font-bold whitespace-nowrap ${
                  !currentCategory
                    ? "text-white"
                    : "text-neutral-400 hover:text-white"
                }`}
              >
                {currentLine}
              </button>
            </>
          )}

          {currentCategory && !searchTerm && (
            <>
              <span className="text-neutral-600 text-2xl">/</span>
              <span className="text-2xl font-bold text-white whitespace-nowrap truncate">
                {currentCategory}
              </span>
            </>
          )}
        </div>

        {/* SEARCH BAR */}
        <div className="relative w-full md:w-80">
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <Search size={18} className="text-neutral-400" />
          </div>

          <input
            type="text"
            className="block w-full pl-10 pr-10 py-2 border border-neutral-700 rounded-full bg-neutral-900/50 text-white placeholder-neutral-500 focus:outline-none focus:bg-neutral-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm transition-all"
            placeholder="Buscar por nombre o ref..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />

          {searchTerm && (
            <button
              onClick={() => setSearchTerm("")}
              className="absolute inset-y-0 right-0 pr-3 flex items-center text-neutral-400 hover:text-white"
            >
              <X size={18} />
            </button>
          )}
        </div>

        {/* CLOSE BUTTON */}
        <button
          onClick={() => setMode("idle")} // üî• ya funciona correctamente
          className="p-2 hover:bg-white/10 rounded-full text-white/50 hover:text-white transition-all ml-2"
        >
          <X size={32} />
        </button>
      </div>

      {/* BODY */}
      <div className="flex-grow p-6 overflow-hidden relative">
        {renderContent()}
      </div>
    </div>
  );
};
// --- END FILE ---
</file>

<file path="src/features/editor/ui/Editor.css">
/* Efecto Cristal para los paneles */
.glass-panel {
  background: rgba(30, 30, 30, 0.7);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  padding: 8px;
  display: flex;
  gap: 8px;
  pointer-events: auto; /* Para que se pueda clicar aunque est√© sobre el 3D */
}

/* Botones de la barra */
.tool-btn {
  background: transparent;
  border: none;
  color: #aaa;
  width: 44px;
  height: 44px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.tool-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.tool-btn.active {
  background: #4a90e2; /* Azul A42 */
  color: white;
  box-shadow: 0 0 10px rgba(74, 144, 226, 0.4);
}

.tool-label {
  position: absolute;
  bottom: -25px;
  background: black;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  white-space: nowrap;
}

.tool-btn:hover .tool-label {
  opacity: 1;
}
</file>

<file path="src/features/editor/ui/EnvironmentPanel.tsx">
// --- START OF FILE src/features/editor/ui/EnvironmentPanel.tsx ---
//import React from 'react';
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { X, Sun, MountainSnow } from 'lucide-react';

export const EnvironmentPanel = () => {
  const { 
    envPanelVisible, 
    toggleEnvPanel, 
    sunPosition, 
    setSunPosition, 
    backgroundColor, 
    setBackgroundColor 
  } = useEditorStore();

  if (!envPanelVisible) return null;

  // Definici√≥n de colores
  const colors = [
    { name: 'Cielo', value: '#111111', isSky: true }, // Valor dummy, activar√° el sky
    { name: 'Blanco', value: '#ffffff' },
    { name: 'Azul', value: '#3b82f6' },
    { name: 'Verde', value: '#22c55e' },
    { name: 'Granate', value: '#7f1d1d' },
    { name: 'Negro', value: '#000000' },
  ];

  return (
    <div className="absolute top-20 right-6 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl shadow-2xl w-72 flex flex-col z-30 animate-in fade-in slide-in-from-right-5 duration-200">
      
      {/* Header */}
      <div className="p-4 border-b border-neutral-700 flex justify-between items-center bg-neutral-800/50 rounded-t-xl">
        <h2 className="text-white font-bold text-lg flex items-center gap-2">
          <Sun size={20} className="text-yellow-500" />
          Entorno
        </h2>
        <button onClick={toggleEnvPanel} className="text-neutral-400 hover:text-white">
          <X size={20} />
        </button>
      </div>

      <div className="p-4 space-y-6">
        
        {/* Controles de Sol */}
        <div className="space-y-4">
          <h3 className="text-neutral-400 text-xs uppercase font-bold tracking-wider">Iluminaci√≥n Solar</h3>
          
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-white">Rotaci√≥n</span>
              <span className="text-neutral-400">{sunPosition.azimuth}¬∞</span>
            </div>
            <input 
              type="range" 
              min="0" 
              max="360" 
              value={sunPosition.azimuth} 
              onChange={(e) => setSunPosition(Number(e.target.value), sunPosition.elevation)}
              className="w-full h-2 bg-neutral-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
            />
          </div>

          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-white">Altura</span>
              <span className="text-neutral-400">{sunPosition.elevation}¬∞</span>
            </div>
            <input 
              type="range" 
              min="0" 
              max="90" 
              value={sunPosition.elevation} 
              onChange={(e) => setSunPosition(sunPosition.azimuth, Number(e.target.value))}
              className="w-full h-2 bg-neutral-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
            />
          </div>
        </div>

        {/* Separador */}
        <div className="h-px bg-neutral-700/50" />

        {/* Fondos */}
        <div className="space-y-3">
          <h3 className="text-neutral-400 text-xs uppercase font-bold tracking-wider flex items-center gap-2">
            <MountainSnow size={14} /> Fondo
          </h3>
          
          <div className="grid grid-cols-3 gap-2">
            {colors.map((c) => (
              <button
                key={c.name}
                onClick={() => setBackgroundColor(c.value)}
                className={`
                  relative h-10 rounded-lg border-2 transition-all flex items-center justify-center
                  ${backgroundColor === c.value 
                    ? 'border-blue-500 scale-105 shadow-lg shadow-blue-500/20' 
                    : 'border-transparent hover:border-white/20 hover:scale-105'
                  }
                `}
                style={{ backgroundColor: c.value }}
                title={c.name}
              >
                {c.isSky && <span className="text-[10px] font-bold text-white/50 uppercase">Sky</span>}
              </button>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
};
// --- END OF FILE src/features/editor/ui/EnvironmentPanel.tsx ---
</file>

<file path="src/features/editor/ui/FenceProperties.tsx">
// --- START OF FILE src/features/editor/ui/FenceProperties.tsx ---
import { Fence, Palette } from "lucide-react";
import { FENCE_PRESETS } from "../data/fence_presets";

import { CadControl } from "./CadControl";

// Stores
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export const FenceProperties = () => {
  // ‚úî TU SELECTION STORE REAL: selectedUUID
  const selectedUUID = useSelectionStore((s) => s.selectedUUID);

  // ‚úî datos generales de escena
  const items = useSceneStore((s) => s.items);
  const updateItemFenceConfig = useSceneStore((s) => s.updateItemFenceConfig);

  // Buscar item seleccionado
  const selectedItem = items.find((i) => i.uuid === selectedUUID);

  // Si no es valla o no tiene config, no mostrar panel
  if (!selectedItem || selectedItem.type !== "fence" || !selectedItem.fenceConfig) {
    return null;
  }

  const currentConfig = selectedItem.fenceConfig;
  const currentPreset =
    FENCE_PRESETS[currentConfig.presetId] || FENCE_PRESETS["wood"];

  // --- Cambiar preset ---
  const handlePresetChange = (key: string) => {
    const preset = FENCE_PRESETS[key];

    const newConfig = {
      presetId: key,
      colors: {
        ...preset.defaultColors,
        ...currentConfig.colors,
      },
    };

    updateItemFenceConfig(selectedItem.uuid, newConfig);
  };

  // --- Cambiar color individual ---
  const handleColorChange = (
    key: "post" | "slatA" | "slatB" | "slatC",
    hex: string
  ) => {
    const colorInt = parseInt(hex.replace("#", "0x"));

    const newColors = {
      ...currentConfig.colors,
      [key]: colorInt,
    };

    updateItemFenceConfig(selectedItem.uuid, {
      presetId: currentConfig.presetId,
      colors: newColors,
    });
  };

  const toHex = (num: number) => "#" + num.toString(16).padStart(6, "0");

  return (
    <div className="absolute top-20 right-4 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl p-4 shadow-xl z-20 w-80 animate-in fade-in slide-in-from-right-2">

      {/* Panel CAD */}
      <CadControl />

      <h3 className="text-white text-sm font-bold mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
        <Fence size={16} /> Editar Valla
      </h3>

      {/* SELECTOR DE MODELO */}
      <div className="mb-4">
        <label className="text-xs text-neutral-400 mb-2 block uppercase font-bold">
          Modelo
        </label>

        <div className="grid grid-cols-2 gap-2">
          {Object.entries(FENCE_PRESETS).map(([key, preset]) => (
            <button
              key={key}
              onClick={() => handlePresetChange(key)}
              className={`text-xs p-2 rounded border text-left transition-all ${
                currentConfig.presetId === key
                  ? "bg-blue-600 border-blue-400 text-white"
                  : "bg-neutral-800 border-neutral-700 text-neutral-300 hover:bg-neutral-700"
              }`}
            >
              {preset.name}
            </button>
          ))}
        </div>
      </div>

      {/* COLORES */}
      <div className="space-y-3">
        <label className="text-xs text-neutral-400 uppercase font-bold flex items-center gap-2">
          <Palette size={12} /> Personalizaci√≥n
        </label>

        {/* Postes */}
        <div className="flex items-center justify-between">
          <span className="text-xs text-neutral-300">Postes / Estructura</span>
          <input
            type="color"
            value={toHex(currentConfig.colors.post)}
            onChange={(e) => handleColorChange("post", e.target.value)}
            className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
          />
        </div>

        {/* Lamas principales */}
        <div className="flex items-center justify-between">
          <span className="text-xs text-neutral-300">
            {currentPreset.isSolidPanel ? "Panel" : "Lamas Principales"}
          </span>
          <input
            type="color"
            value={toHex(currentConfig.colors.slatA)}
            onChange={(e) => handleColorChange("slatA", e.target.value)}
            className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
          />
        </div>

        {/* Multicolor */}
        {currentPreset.multiColor && (
          <>
            <div className="flex items-center justify-between">
              <span className="text-xs text-neutral-300">Lamas Secundarias</span>
              <input
                type="color"
                value={toHex(currentConfig.colors.slatB ?? currentConfig.colors.slatA)}
                onChange={(e) => handleColorChange("slatB", e.target.value)}
                className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
              />
            </div>

            <div className="flex items-center justify-between">
              <span className="text-xs text-neutral-300">Lamas Terciarias</span>
              <input
                type="color"
                value={toHex(currentConfig.colors.slatC ?? currentConfig.colors.slatA)}
                onChange={(e) => handleColorChange("slatC", e.target.value)}
                className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
              />
            </div>
          </>
        )}
      </div>

      <div className="mt-4 pt-2 border-t border-white/10 text-[10px] text-neutral-500 text-center">
        Clic Izq: Dibujar ‚Ä¢ Clic Dcho: Terminar
      </div>
    </div>
  );
};
// --- END OF FILE ---
</file>

<file path="src/features/editor/ui/FloorProperties.tsx">
import React, { useRef } from "react";
import { Palette, Upload, RotateCw, Move } from "lucide-react";

import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

import type { FloorMaterialType } from "@/types/editor";
import { CadControl } from "./CadControl";

export const FloorProperties: React.FC = () => {
  // ‚úî store correcto
  const selectedUUID = useSelectionStore((s) => s.selectedUUID);

  const items = useSceneStore((s) => s.items);
  const updateFloorMaterial = useSceneStore((s) => s.updateFloorMaterial);
  const updateFloorTexture = useSceneStore((s) => s.updateFloorTexture);

  const fileInputRef = useRef<HTMLInputElement>(null);

  // item real
  const selectedItem = items.find((i) => i.uuid === selectedUUID);

  // si no es suelo, cerrar panel
  if (!selectedItem || selectedItem.type !== "floor") return null;

  const materials: { id: FloorMaterialType; color: string; name: string }[] = [
    { id: "rubber_red", color: "#A04040", name: "Rojo" },
    { id: "rubber_green", color: "#22c55e", name: "Verde" },
    { id: "rubber_blue", color: "#3b82f6", name: "Azul" },
    { id: "grass", color: "#4ade80", name: "C√©sped" },
    { id: "concrete", color: "#9ca3af", name: "Hormig√≥n" },
  ];

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);

    updateFloorTexture(selectedItem.uuid, url, 1, 0);
  };

  const handleUpdateTextureParams = (scale: number, rotation: number) => {
    updateFloorTexture(
      selectedItem.uuid,
      selectedItem.textureUrl,
      scale,
      rotation
    );
  };

  return (
    <div className="absolute top-20 right-4 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl p-4 shadow-xl z-20 w-80 animate-in fade-in slide-in-from-right-2">

      <CadControl />

      <h3 className="text-white text-sm font-bold mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
        <Palette size={16} /> Propiedades del Suelo
      </h3>

      {/* MATERIAL BASE */}
      <div className="mb-4">
        <label className="text-xs text-neutral-400 mb-2 block uppercase font-bold">
          Material Base
        </label>

        <div className="flex gap-2">
          {materials.map((mat) => (
            <button
              key={mat.id}
              onClick={() => {
                updateFloorTexture(selectedItem.uuid, undefined, 1, 0);
                updateFloorMaterial(selectedItem.uuid, mat.id);
              }}
              className={`w-8 h-8 rounded-full border-2 transition-all ${
                !selectedItem.textureUrl &&
                selectedItem.floorMaterial === mat.id
                  ? "border-white scale-110"
                  : "border-transparent opacity-50 hover:opacity-100"
              }`}
              style={{ backgroundColor: mat.color }}
              title={mat.name}
            />
          ))}
        </div>
      </div>

      {/* TEXTURA PERSONALIZADA */}
      <div className="mb-2">
        <label className="text-xs text-neutral-400 mb-2 block uppercase font-bold">
          Textura Personalizada
        </label>

        <input
          type="file"
          ref={fileInputRef}
          onChange={handleFileChange}
          accept="image/*"
          className="hidden"
        />

        <button
          onClick={() => fileInputRef.current?.click()}
          className="w-full py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-600 rounded flex items-center justify-center gap-2 text-sm text-neutral-300 transition-colors mb-3"
        >
          <Upload size={14} />
          {selectedItem.textureUrl ? "Cambiar Imagen" : "Subir Imagen (JPG/PNG)"}
        </button>

        {/* Controles de textura */}
        {selectedItem.textureUrl && (
          <div className="grid grid-cols-2 gap-3">

            {/* ESCALA */}
            <div className="bg-neutral-800 p-2 rounded">
              <div className="flex justify-between mb-1">
                <span className="text-[10px] text-neutral-400 flex items-center gap-1">
                  <Move size={10} /> ESCALA
                </span>
                <span className="text-[10px] text-white">
                  {(selectedItem.textureScale ?? 1).toFixed(1)}x
                </span>
              </div>

              <input
                type="range"
                min="0.1"
                max="5"
                step="0.1"
                value={selectedItem.textureScale ?? 1}
                onChange={(e) =>
                  handleUpdateTextureParams(
                    parseFloat(e.target.value),
                    selectedItem.textureRotation ?? 0
                  )
                }
                className="w-full h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer accent-blue-500"
              />
            </div>

            {/* ROTACI√ìN */}
            <div className="bg-neutral-800 p-2 rounded">
              <div className="flex justify-between mb-1">
                <span className="text-[10px] text-neutral-400 flex items-center gap-1">
                  <RotateCw size={10} /> ROTACI√ìN
                </span>
                <span className="text-[10px] text-white">
                  {selectedItem.textureRotation ?? 0}¬∞
                </span>
              </div>

              <input
                type="range"
                min="0"
                max="360"
                step="15"
                value={selectedItem.textureRotation ?? 0}
                onChange={(e) =>
                  handleUpdateTextureParams(
                    selectedItem.textureScale ?? 1,
                    parseInt(e.target.value, 10)
                  )
                }
                className="w-full h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer accent-blue-500"
              />
            </div>
          </div>
        )}
      </div>

      <div className="mt-4 pt-2 border-t border-white/10 text-[10px] text-neutral-500 text-center">
        üí° Shift + Clic para seleccionar v√©rtices m√∫ltiples.
      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/ui/InputModal.tsx">
// --- START OF FILE src/features/editor/ui/InputModal.tsx ---
import React, { useState, useEffect, useRef } from 'react';
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { X, Check } from 'lucide-react';

export const InputModal = () => {
  const { inputModal, closeInputModal } = useEditorStore();
  const [value, setValue] = useState('');
  const inputRef = useRef<HTMLInputElement>(null);

  // Sincronizar estado local cuando se abre el modal
  useEffect(() => {
    if (inputModal.isOpen) {
      setValue(inputModal.defaultValue);
      // Enfocar el input autom√°ticamente al abrir
      setTimeout(() => inputRef.current?.focus(), 100);
    }
  }, [inputModal.isOpen, inputModal.defaultValue]);

  if (!inputModal.isOpen) return null;

  const handleSubmit = (e?: React.FormEvent) => {
    e?.preventDefault();
    closeInputModal(value); // Devuelve el texto
  };

  const handleCancel = () => {
    closeInputModal(null); // Devuelve null (como si dieras Cancelar en prompt)
  };

  return (
    <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-neutral-800 border border-neutral-600 rounded-xl shadow-2xl p-6 w-96 transform transition-all scale-100">
        <h3 className="text-white text-lg font-bold mb-4">{inputModal.title}</h3>
        
        <form onSubmit={handleSubmit}>
          <input
            ref={inputRef}
            type="text"
            value={value}
            onChange={(e) => setValue(e.target.value)}
            className="w-full bg-neutral-900 border border-neutral-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500 transition-colors mb-6"
            placeholder="Escribe aqu√≠..."
          />
          
          <div className="flex justify-end gap-3">
            <button
              type="button"
              onClick={handleCancel}
              className="px-4 py-2 rounded-lg text-neutral-400 hover:text-white hover:bg-white/10 transition-colors flex items-center gap-2"
            >
              <X size={18} /> Cancelar
            </button>
            <button
              type="submit"
              className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-medium transition-colors flex items-center gap-2"
            >
              <Check size={18} /> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
// --- END OF FILE src/features/editor/ui/InputModal.tsx ---
</file>

<file path="src/features/editor/ui/QRModal.tsx">
// --- FIXED FILE: src/features/editor/ui/QRModal.tsx ---
import React from "react";
import { QRCodeSVG } from "qrcode.react";
import { X, Save, LogIn, Smartphone } from "lucide-react";
import { useAuthStore } from "@/stores/auth/useAuthStore";
import { useNavigate } from "react-router-dom";
import { useProjectStore } from "@/stores/project/useProjectStore";

interface QRModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export const QRModal: React.FC<QRModalProps> = ({ isOpen, onClose }) => {
  const navigate = useNavigate();

  // Auth store
  const { user } = useAuthStore();

  // Project store (correct keys)
  const { projectId } = useProjectStore();

  if (!isOpen) return null;

  const shareUrl = projectId
    ? `${window.location.origin}/?project_id=${projectId}`
    : "";

  const isProjectSaved = !!projectId;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-neutral-900 border border-neutral-700 rounded-2xl p-8 shadow-2xl max-w-sm w-full relative flex flex-col items-center gap-6 text-center">
        
        <button
          onClick={onClose}
          className="absolute top-4 right-4 text-neutral-400 hover:text-white transition-colors"
        >
          <X size={24} />
        </button>

        {isProjectSaved ? (
          <>
            <div className="space-y-1">
              <div className="flex items-center justify-center gap-2 text-blue-400 mb-2">
                <Smartphone size={20} />
                <span className="text-xs font-bold uppercase tracking-wider">
                  Mobile Ready
                </span>
              </div>

              <h2 className="text-2xl font-bold text-white">Escanear Proyecto</h2>
              <p className="text-sm text-neutral-400">
                Abre la c√°mara de tu m√≥vil para ver el dise√±o.
              </p>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-inner">
              <QRCodeSVG value={shareUrl} size={220} level="M" />
            </div>

            <div className="text-xs text-neutral-500 px-4 break-all">
              ID:
              <span className="font-mono text-neutral-400 ml-1">
                {projectId}
              </span>
            </div>

            {!user && (
              <p className="text-xs text-yellow-500 bg-yellow-900/30 p-2 rounded">
                ‚ö†Ô∏è Enlace en modo <strong>solo lectura</strong>.
              </p>
            )}
          </>
        ) : user ? (
          <>
            <div className="w-16 h-16 bg-yellow-500/10 rounded-full flex items-center justify-center text-yellow-500 mb-2">
              <Save size={32} />
            </div>
            <h2 className="text-xl font-bold text-white">Proyecto no guardado</h2>
            <p className="text-sm text-neutral-400">
              Guarda el proyecto para generar un enlace √∫nico.
            </p>

            <button
              onClick={onClose}
              className="w-full py-3 bg-neutral-800 hover:bg-neutral-700 border border-neutral-600 text-white rounded-lg font-bold transition-colors"
            >
              Volver y Guardar
            </button>
          </>
        ) : (
          <>
            <div className="w-16 h-16 bg-neutral-800 rounded-full flex items-center justify-center text-neutral-400 mb-2">
              <LogIn size={32} />
            </div>

            <h2 className="text-xl font-bold text-white">Inicia Sesi√≥n</h2>
            <p className="text-sm text-neutral-400">
              Para guardar y compartir tu dise√±o necesitas una cuenta.
            </p>

            <button
              onClick={() => navigate("/login")}
              className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition-colors"
            >
              Ir al Login
            </button>
          </>
        )}
      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/ui/Toolbar.tsx">
import { useRef, useState } from "react";
import {
  MousePointer2,
  Grid3X3,
  Component,
  Trees,
  Grid,
  Undo2,
  Redo2,
  Eye,
  Box,
  ArrowUp,
  ArrowRight,
  GalleryVerticalEnd,
  Square,
  Sun,
  Upload,
  Ruler,
  Footprints,
  Video,
  Camera,
  Film,
  Download,
  FileText,
  ShieldAlert,
  FileDown,
  Save,
  LayoutDashboard,
} from "lucide-react";
import { useNavigate } from "react-router-dom";

// STORES
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useProjectStore } from "@/stores/project/useProjectStore";
import { useUserStore } from "@/stores/user/useUserStore";

// HOOKS
import { useEditorMedia } from "../hooks/useEditorMedia";
import { useSceneTools } from "../hooks/useSceneTools";
import { useProjectActions } from "../hooks/useProjectActions";

import "./Editor.css";

export const Toolbar = () => {
  const navigate = useNavigate();
  const fileInputRef = useRef<HTMLInputElement>(null);

  // 1. HOOKS DE L√ìGICA
  const {
    isRecording,
    takePhoto,
    start360Video,
    toggleRecording,
    exportGLB,
    exportDXF,
    generatePDF,
  } = useEditorMedia();
  const { activateWalkMode } = useSceneTools();
  const { saveProject, importGLB, isSaving } = useProjectActions();

  // 2. STORES UI
  const {
    mode,
    setMode,
    gridVisible,
    toggleGrid,
    cameraType,
    setCameraType,
    triggerView,
    envPanelVisible,
    toggleEnvPanel,
    setMeasurementResult,
    safetyZonesVisible,
    toggleSafetyZones,
  } = useEditorStore();

  const { undo, redo, past, future } = useSceneStore();
  const { isReadOnlyMode } = useProjectStore();
  const user = useUserStore((s) => s.user);

  const [showViews, setShowViews] = useState(false);

  const tools = [
    { id: "idle", icon: <MousePointer2 size={20} />, label: "Seleccionar" },
    { id: "drawing_floor", icon: <Grid3X3 size={20} />, label: "Suelo" },
    { id: "drawing_fence", icon: <Component size={20} />, label: "Valla" },
    { id: "catalog", icon: <Trees size={20} />, label: "Cat√°logo" },
  ] as const;

  const toggleMeasureMode = () => {
    if (mode === "measuring") {
      setMode("idle");
      setMeasurementResult(null);
    } else {
      setMode("measuring");
      setShowViews(false);
    }
  };

  return (
    <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center">
      {/* PANEL FLOTANTE DE VISTAS */}
      {showViews && (
        <div className="absolute bottom-full mb-4 glass-panel flex-row animate-in slide-in-from-bottom-2 fade-in duration-200">
          <button
            className={`tool-btn ${
              cameraType === "perspective" ? "active" : ""
            }`}
            onClick={() => setCameraType("perspective")}
            title="3D"
          >
            <Eye size={18} />
          </button>
          <button
            className={`tool-btn ${
              cameraType === "orthographic" ? "active" : ""
            }`}
            onClick={() => setCameraType("orthographic")}
            title="2D"
          >
            <Square size={18} />
          </button>
          <div className="w-px bg-white/10 mx-1" />
          <button
            className="tool-btn"
            onClick={() => triggerView("top")}
            title="Planta"
          >
            <ArrowUp size={18} />
          </button>
          <button
            className="tool-btn"
            onClick={() => triggerView("front")}
            title="Alzado"
          >
            <GalleryVerticalEnd size={18} />
          </button>
          <button
            className="tool-btn"
            onClick={() => triggerView("side")}
            title="Perfil"
          >
            <ArrowRight size={18} />
          </button>
          <button
            className="tool-btn"
            onClick={() => triggerView("iso")}
            title="Iso"
          >
            <Box size={18} />
          </button>
        </div>
      )}

      {/* BARRA DE HERRAMIENTAS PRINCIPAL */}
      <div className="glass-panel">
        {/* ENLACE AL PORTAL (Solo usuarios logueados) */}
        {user && (
          <button
            className="tool-btn text-blue-400 hover:text-blue-300"
            onClick={() =>
              navigate(
                user.email?.includes("admin") ||
                  user.email?.includes("levipark")
                  ? "/admin/crm"
                  : "/portal?tab=projects"
              )
            }
            title="Ir a Mis Proyectos"
          >
            <LayoutDashboard size={20} />{" "}
            <span className="tool-label">Portal</span>
          </button>
        )}
        {user && <div className="w-px bg-white/10 mx-1" />}

        {/* HERRAMIENTAS PRINCIPALES */}
        {tools.map((tool) => (
          <button
            key={tool.id}
            className={`tool-btn ${mode === tool.id ? "active" : ""}`}
            onClick={() => {
              setMode(tool.id as any);
              setShowViews(false);
            }}
          >
            {tool.icon} <span className="tool-label">{tool.label}</span>
          </button>
        ))}

        <div className="w-px bg-white/10 mx-1" />

        {/* GUARDAR PROYECTO */}
        <button
          className={`tool-btn ${isSaving ? "text-yellow-400" : ""}`}
          onClick={saveProject}
          disabled={isSaving || isReadOnlyMode || !user}
          title={
            !user
              ? "Login Requerido"
              : isReadOnlyMode
              ? "Solo Lectura"
              : "Guardar"
          }
          style={{
            opacity: isReadOnlyMode || !user ? 0.5 : 1,
            cursor: isReadOnlyMode || !user ? "not-allowed" : "pointer",
          }}
        >
          <Save size={20} className={isSaving ? "animate-pulse" : ""} />
          <span className="tool-label">
            {!user ? "Login" : isSaving ? "..." : "Guardar"}
          </span>
        </button>

        {/* IMPORTAR */}
        <input
          type="file"
          ref={fileInputRef}
          onChange={importGLB}
          accept=".glb,.gltf"
          className="hidden"
        />
        <button
          className="tool-btn"
          onClick={() => fileInputRef.current?.click()}
          title="Importar GLB"
        >
          <Upload size={20} /> <span className="tool-label">Importar</span>
        </button>

        <div className="w-px bg-white/10 mx-1" />

        {/* HELPERS */}
        <button
          className={`tool-btn ${showViews ? "active" : ""}`}
          onClick={() => setShowViews(!showViews)}
        >
          <Eye size={20} /> <span className="tool-label">Vistas</span>
        </button>
        <button
          className={`tool-btn ${envPanelVisible ? "active" : ""}`}
          onClick={toggleEnvPanel}
        >
          <Sun size={20} /> <span className="tool-label">Entorno</span>
        </button>
        <button
          className={`tool-btn ${mode === "measuring" ? "active" : ""}`}
          onClick={toggleMeasureMode}
        >
          <Ruler size={20} /> <span className="tool-label">Medir</span>
        </button>
        <button
          className={`tool-btn ${
            safetyZonesVisible ? "active text-red-400" : ""
          }`}
          onClick={toggleSafetyZones}
        >
          <ShieldAlert size={20} />{" "}
          <span className="tool-label">Zonas</span>
        </button>

        <div className="w-px bg-white/10 mx-1" />

        {/* MEDIA */}
        <button className="tool-btn" onClick={takePhoto}>
          <Camera size={20} /> <span className="tool-label">Foto</span>
        </button>
        <button className="tool-btn" onClick={start360Video}>
          <Film size={20} /> <span className="tool-label">360¬∫</span>
        </button>

        {/* EXPORTS (Solo Logueados) */}
        {user && (
          <>
            <button className="tool-btn" onClick={exportGLB}>
              <Download size={20} /> <span className="tool-label">3D</span>
            </button>
            <button className="tool-btn" onClick={exportDXF}>
              <FileText size={20} /> <span className="tool-label">
                CAD
              </span>
            </button>
          </>
        )}

        <button className="tool-btn" onClick={generatePDF}>
          <FileDown size={20} /> <span className="tool-label">PDF</span>
        </button>

        <div className="w-px bg-white/10 mx-1" />

        {/* WALK & REC */}
        <button className="tool-btn" onClick={activateWalkMode}>
          <Footprints size={20} />{" "}
          <span className="tool-label">Paseo</span>
        </button>
        <button
          className={`tool-btn ${
            isRecording ? "text-red-500 hover:text-red-400" : ""
          }`}
          onClick={toggleRecording}
        >
          <Video size={20} />{" "}
          <span className="tool-label">
            {isRecording ? "Stop" : "Rec"}
          </span>
        </button>

        <div className="w-px bg-white/10 mx-1" />

        {/* UTILS */}
        <button
          className={`tool-btn ${gridVisible ? "active" : ""}`}
          onClick={toggleGrid}
        >
          <Grid size={20} /> <span className="tool-label">Grid</span>
        </button>

        <div className="w-px bg-white/10 mx-1" />

        {/* UNDO / REDO */}
        <button
          className="tool-btn"
          onClick={undo}
          disabled={past.length === 0}
          style={{ opacity: past.length === 0 ? 0.3 : 1 }}
        >
          <Undo2 size={20} /> <span className="tool-label">Undo</span>
        </button>
        <button
          className="tool-btn"
          onClick={redo}
          disabled={future.length === 0}
          style={{ opacity: future.length === 0 ? 0.3 : 1 }}
        >
          <Redo2 size={20} /> <span className="tool-label">Redo</span>
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/index.css">
/* --- START OF FILE src/index.css --- */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Mantenemos nuestro fondo oscuro y el reset b√°sico */
:root {
  color-scheme: dark;
  background-color: #111;
  color: white;
}

body {
  margin: 0;
  overflow: hidden;
}

#root {
  width: 100vw;
  height: 100vh;
}

/* Custom Scrollbar (para el cat√°logo) */
.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  border: 2px solid rgba(255, 255, 255, 0.05);
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: rgba(255, 255, 255, 0.3);
}
/* --- END OF FILE src/index.css --- */
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_KEY;

if (!SUPABASE_URL || !SUPABASE_KEY) {
    throw new Error("Faltan las variables de entorno de Supabase en .env");
}

export const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
</file>

<file path="src/main.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
</file>

<file path="src/services/catalogService.ts">
// --- START OF FILE src/catalog/catalogService.ts ---

import type { ProductDefinition } from "@/types/catalog";

// Extendemos el tipo para que TypeScript no se queje de la descripci√≥n si no est√° en el store original
export type Product = ProductDefinition & { description?: string };

export interface CatalogDB {
  lines: {
    [lineName: string]: {
      lineImage?: string; 
      categories: {
        [categoryName: string]: Product[];
      };
    };
  };
}

let catalogData: CatalogDB | null = null;
let loadError: string | null = null;
let isLoaded = false;

// URL de tu Google Sheet
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfEbdFX3uyPiy45jEG3YLFsW9xqlbKfmdBigZzBStBjnVm1oWkw1AVesUcK11O0CXytHVeFY3l-gds/pub?output=csv";

// Helper para limpiar comillas extras del CSV
const cleanCell = (text: string) => text ? text.replace(/^"|"$/g, '').trim() : '';

// Helper para buscar √≠ndices ignorando may√∫sculas/min√∫sculas
const getColIndex = (headers: string[], possibleNames: string[]) => {
  const lowerHeaders = headers.map(h => cleanCell(h).toLowerCase());
  return lowerHeaders.findIndex(h => possibleNames.includes(h));
};

export const loadCatalogData = async () => {
  if (isLoaded && catalogData) return; 

  try {
    console.log('[CatalogService] Descargando CSV...');
    const response = await fetch(GOOGLE_SHEET_CSV_URL);
    
    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const csvText = await response.text();
    const rows = csvText.split('\n').map(r => r.trim()).filter(r => r.length > 0);
    if (rows.length < 2) throw new Error("CSV vac√≠o o sin datos.");

    // Procesar cabeceras
    const headers = rows[0].split(','); 
    
    // --- 1. IDENTIFICAR COLUMNAS (Aqu√≠ es donde a√±adimos las nuevas) ---
    const idxRef = getColIndex(headers, ['ref', 'id']);
    const idxNombre = getColIndex(headers, ['nombre', 'name']);
    const idxPrecio = getColIndex(headers, ['precio', 'price']);
    const idxCategoria = getColIndex(headers, ['categoria', 'categor√≠a', 'category']);
    const idxGlb = getColIndex(headers, ['archivo_glb', 'glb', 'modelo']);
    const idxImg = getColIndex(headers, ['img_2d', 'img', 'imagen']);
    const idxLinea = getColIndex(headers, ['linea', 'l√≠nea', 'line']);
    const idxImgLinea = getColIndex(headers, ['img_linea', 'img_line', 'imagen_linea', 'foto_linea']);
    
    // NUEVAS COLUMNAS (Las que faltaban)
    const idxUrlTech = getColIndex(headers, ['url_tech', 'ficha_tecnica', 'ficha t√©cnica']);
    const idxUrlCert = getColIndex(headers, ['url_cert', 'certificado']);
    const idxUrlInst = getColIndex(headers, ['url_inst', 'instrucciones', 'montaje']);
    const idxDesc    = getColIndex(headers, ['descripcion', 'descripci√≥n', 'description']);
    // ------------------------------------------------------------------

    if (idxNombre === -1 || idxGlb === -1) {
      throw new Error("Faltan columnas obligatorias en el CSV (Nombre o GLB).");
    }

    const tempDB: CatalogDB = { lines: {} };

    // Procesar filas
    for (let i = 1; i < rows.length; i++) {
      // Nota: split(',') es b√°sico, si una descripci√≥n tiene comas dentro podr√≠a romperse.
      // Para descripciones complejas se recomienda una librer√≠a parser CSV real, 
      // pero para esto servir√° si no hay comas en los textos.
      const cols = rows[i].split(',').map(cleanCell);
      
      if (cols.length < 3) continue;

      const ref = idxRef > -1 ? cols[idxRef] : `item_${i}`;
      const nombre = cols[idxNombre] || 'Sin Nombre';
      const precio = idxPrecio > -1 ? (parseFloat(cols[idxPrecio]) || 0) : 0;
      const linea = idxLinea > -1 ? (cols[idxLinea] || 'General') : 'General';
      const categoria = idxCategoria > -1 ? (cols[idxCategoria] || 'Varios') : 'Varios';
      const glbUrl = cols[idxGlb];
      const imgUrl = idxImg > -1 ? cols[idxImg] : undefined;
      const lineImgUrl = idxImgLinea > -1 ? cols[idxImgLinea] : undefined;

      // --- 2. EXTRAER DATOS NUEVOS ---
      const urlTech = idxUrlTech > -1 ? cols[idxUrlTech] : undefined;
      const urlCert = idxUrlCert > -1 ? cols[idxUrlCert] : undefined;
      const urlInst = idxUrlInst > -1 ? cols[idxUrlInst] : undefined;
      const desc    = idxDesc > -1    ? cols[idxDesc]    : undefined;
      // -------------------------------

      if (!glbUrl) continue;

      // --- 3. CREAR OBJETO PRODUCTO ---
      const product: Product = {
        id: ref,
        name: nombre,
        price: precio,
        type: 'model' as any, 
        modelUrl: glbUrl,
        img_2d: imgUrl,
        line: linea,
        category: categoria,
        
        // A√ëADIMOS LAS PROPIEDADES AL OBJETO
        url_tech: urlTech,
        url_cert: urlCert,
        url_inst: urlInst,
        description: desc 
      };

      // Organizar en categor√≠as
      if (!tempDB.lines[linea]) {
        tempDB.lines[linea] = { categories: {} };
      }
      
      if (lineImgUrl && !tempDB.lines[linea].lineImage) {
        tempDB.lines[linea].lineImage = lineImgUrl;
      }

      if (!tempDB.lines[linea].categories[categoria]) {
        tempDB.lines[linea].categories[categoria] = [];
      }

      tempDB.lines[linea].categories[categoria].push(product);
    }

    catalogData = tempDB;
    isLoaded = true;
    console.log('[CatalogService] CSV procesado correctamente. Datos cargados:', catalogData);

  } catch (err: any) {
    loadError = `Error CSV: ${err.message || err}`;
    console.error('[CatalogService]', err);
    isLoaded = false;
  }
};

export const getCatalogDB = (): CatalogDB | null => catalogData;
export const getCatalogLoadStatus = () => ({ isLoaded, error: loadError });

export const getProxiedImageUrl = (url: string): string => {
  return url;
};
// --- END OF FILE src/catalog/catalogService.ts ---
</file>

<file path="src/stores/auth/useAuthStore.ts">
import { create } from "zustand";
import { supabase } from "@/lib/supabase";
import type { Session, User } from "@supabase/supabase-js";

interface AuthState {
  user: User | null;
  session: Session | null;
  loading: boolean;

  setUser: (user: User | null) => void;
  setSession: (session: Session | null) => void;

  login: (email: string, password: string) => Promise<{ error: any }>;
  logout: () => Promise<void>;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  session: null,
  loading: false,

  setUser: (user) => set({ user }),
  setSession: (session) => set({ session }),

  // === LOGIN (opcional pero profesional) ===
  login: async (email, password) => {
    set({ loading: true });

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    set({
      loading: false,
      user: data?.user ?? null,
      session: data?.session ?? null,
    });

    return { error };
  },

  // === LOGOUT ===
  logout: async () => {
    await supabase.auth.signOut();
    set({
      user: null,
      session: null,
    });
  },
}));
</file>

<file path="src/stores/budget/useBudgetStore.ts">
import { create } from "zustand";

export interface ManualBudgetItem {
  id: string;
  name: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
  dimensions?: string; // ejemplo: "12 m¬≤" o "6 m"
}

interface BudgetState {
  manualItems: ManualBudgetItem[];

  discountRate: number; // porcentaje aplicado al total

  notes: string; // observaciones temporales
  isEditing: boolean;

  // === ACTIONS ===
  addManualItem: (item: ManualBudgetItem) => void;
  updateManualItem: (id: string, partial: Partial<ManualBudgetItem>) => void;
  removeManualItem: (id: string) => void;

  clearManualItems: () => void;

  setDiscountRate: (rate: number) => void;

  setNotes: (text: string) => void;
  setEditing: (state: boolean) => void;

  // C√°lculos globales (derivados)
  getSubtotal: () => number;
  getFinalTotal: () => number;
}

export const useBudgetStore = create<BudgetState>((set, get) => ({
  manualItems: [],

  discountRate: 0,

  notes: "",
  isEditing: false,

  // === ACTIONS ===

  addManualItem: (item) =>
    set((s) => ({
      manualItems: [...s.manualItems, item],
    })),

  updateManualItem: (id, partial) =>
    set((s) => ({
      manualItems: s.manualItems.map((i) =>
        i.id === id ? { ...i, ...partial, totalPrice: (partial.unitPrice ?? i.unitPrice) * (partial.quantity ?? i.quantity) } : i
      ),
    })),

  removeManualItem: (id) =>
    set((s) => ({
      manualItems: s.manualItems.filter((i) => i.id !== id),
    })),

  clearManualItems: () => set({ manualItems: [] }),

  setDiscountRate: (rate) => set({ discountRate: rate }),

  setNotes: (text) => set({ notes: text }),
  setEditing: (state) => set({ isEditing: state }),

  // === C√ÅLCULOS ===
  getSubtotal: () => {
    const { manualItems } = get();
    return manualItems.reduce((acc, i) => acc + i.totalPrice, 0);
  },

  getFinalTotal: () => {
    const subtotal = get().getSubtotal();
    const discount = subtotal * (get().discountRate / 100);
    return subtotal - discount;
  },
}));
</file>

<file path="src/stores/cad/useCADStore.ts">
import { create } from "zustand";

export interface CADState {
  // √çndices de v√©rtices seleccionados en una geometr√≠a
  selectedVertices: number[];

  // Distancia calculada entre dos puntos (modo medici√≥n)
  distance: number | null;

  // √Ångulo calculado cuando aplica
  angle: number | null;

  // === ACTIONS ===
  setSelectedVertices: (indices: number[], distance: number | null, angle: number | null) => void;

  clear: () => void;
}

export const useCADStore = create<CADState>((set) => ({
  selectedVertices: [],
  distance: null,
  angle: null,

  setSelectedVertices: (indices, distance, angle) =>
    set({
      selectedVertices: indices,
      distance,
      angle,
    }),

  clear: () =>
    set({
      selectedVertices: [],
      distance: null,
      angle: null,
    }),
}));
</file>

<file path="src/stores/catalog/useCatalogStore.ts">
import { create } from "zustand";
import type { ProductDefinition } from "@/types/catalog";

interface CatalogState {
  // Cat√°logo ya cargado y normalizado
  catalog: ProductDefinition[];

  // Estado de navegaci√≥n
  currentLine: string | null;
  currentCategory: string | null;

  // Buscador
  searchTerm: string;

  // Producto actualmente seleccionado en el cat√°logo
  selectedProduct: ProductDefinition | null;

  // ==== ACTIONS ====
  setCatalog: (items: ProductDefinition[]) => void;

  setLine: (line: string | null) => void;
  setCategory: (category: string | null) => void;

  setSearchTerm: (term: string) => void;

  selectProduct: (product: ProductDefinition | null) => void;

  clearNavigation: () => void;
  clearSearch: () => void;
}

export const useCatalogStore = create<CatalogState>((set) => ({
  // === DEFAULT STATE ===
  catalog: [],

  currentLine: null,
  currentCategory: null,

  searchTerm: "",

  selectedProduct: null,

  // === ACTIONS ===
  setCatalog: (items) => set({ catalog: items }),

  setLine: (line) =>
    set({
      currentLine: line,
      currentCategory: null, // reset category when line changes
      searchTerm: "",
    }),

  setCategory: (category) =>
    set({
      currentCategory: category,
      searchTerm: "",
    }),

  setSearchTerm: (term) => set({ searchTerm: term }),

  selectProduct: (product) => set({ selectedProduct: product }),

  clearNavigation: () =>
    set({
      currentLine: null,
      currentCategory: null,
    }),

  clearSearch: () => set({ searchTerm: "" }),
}));
</file>

<file path="src/stores/crm/useCRMStore.ts">
import { create } from "zustand";

export interface Client {
  id: string;
  name: string;
  phone?: string | null;
  email?: string | null;
  company?: string | null;
  notes?: string | null;
}

interface CRMState {
  clients: Client[];
  selectedClient: Client | null;

  // === ACTIONS ===
  setClients: (clients: Client[]) => void;
  addClient: (client: Client) => void;
  updateClient: (id: string, partial: Partial<Client>) => void;
  removeClient: (id: string) => void;

  selectClient: (client: Client | null) => void;
  clearSelection: () => void;
}

export const useCRMStore = create<CRMState>((set) => ({
  clients: [],
  selectedClient: null,

  // Reemplaza todos los clientes (carga inicial)
  setClients: (clients) => set({ clients }),

  // Agregar cliente
  addClient: (client) =>
    set((s) => ({
      clients: [...s.clients, client],
    })),

  // Actualizar parcial
  updateClient: (id, partial) =>
    set((s) => ({
      clients: s.clients.map((c) =>
        c.id === id ? { ...c, ...partial } : c
      ),
    })),

  // Eliminar
  removeClient: (id) =>
    set((s) => ({
      clients: s.clients.filter((c) => c.id !== id),
    })),

  // Seleccionar cliente
  selectClient: (client) => set({ selectedClient: client }),
  clearSelection: () => set({ selectedClient: null }),
}));
</file>

<file path="src/stores/editor/useEditorStore.ts">
import { create } from "zustand";
import type { CameraView, CameraType } from "@/types/editor";

// Modo principal del editor (armonizado)
export type EditorMode =
  | "idle"
  | "placing_item"
  | "drawing_floor"
  | "drawing_fence"
  | "catalog"
  | "measuring"
  | "editing";

interface EditorState {
  // UI toggles
  gridVisible: boolean;
  skyVisible: boolean;
  safetyZonesVisible: boolean;
  envPanelVisible: boolean;
  budgetVisible: boolean;
  qrModalOpen: boolean;

  // Editor mode
  mode: EditorMode;
  setMode: (mode: EditorMode) => void;

  // C√°mara
  cameraType: CameraType;
  setCameraType: (type: CameraType) => void;

  pendingView: CameraView | null;
  triggerView: (view: CameraView) => void;
  clearPendingView: () => void;

  // Fondo
  backgroundColor: string;
  setBackgroundColor: (color: string) => void;

  // Sol
  sunPosition: { azimuth: number; elevation: number };
  setSun: (azimuth: number, elevation: number) => void;

  // Alias para componentes antiguos
  setSunPosition: (azimuth: number, elevation: number) => void;

  // Medici√≥n
  measurementResult: number | null;
  setMeasurementResult: (value: number | null) => void;

  // Input modal
  inputModal: {
    isOpen: boolean;
    title: string;
    defaultValue: string;
    resolve: ((value: string | null) => void) | null;
  };
  requestInput: (title: string, defaultValue?: string) => Promise<string | null>;
  closeInputModal: (value: string | null) => void;

  // Toggles
  toggleGrid: () => void;
  toggleSky: () => void;
  toggleEnvPanel: () => void;
  toggleSafetyZones: () => void;
  toggleBudget: () => void;

  openQRModal: () => void;
  closeQRModal: () => void;
}

export const useEditorStore = create<EditorState>((set, get) => ({
  // UI defaults
  gridVisible: true,
  skyVisible: true,
  safetyZonesVisible: false,
  envPanelVisible: false,
  budgetVisible: false,
  qrModalOpen: false,

  // Editor mode
  mode: "idle",
  setMode: (mode) => set({ mode }),

  // C√°mara
  cameraType: "perspective",
  setCameraType: (type) => set({ cameraType: type }),

  pendingView: null,
  triggerView: (view) => set({ pendingView: view }),
  clearPendingView: () => set({ pendingView: null }),

  // Fondo
  backgroundColor: "#222222",
  setBackgroundColor: (color: string) => set({ backgroundColor: color }),

  // Sol (est√°ndar profesional)
  sunPosition: { azimuth: 180, elevation: 45 },
  setSun: (azimuth, elevation) =>
    set({ sunPosition: { azimuth, elevation } }),

  // Alias para compatibilidad (EnvironmentPanel usa este)
  setSunPosition: (azimuth, elevation) =>
    set({ sunPosition: { azimuth, elevation } }),

  // Medici√≥n
  measurementResult: null,
  setMeasurementResult: (value) => set({ measurementResult: value }),

  // Input modal
  inputModal: {
    isOpen: false,
    title: "",
    defaultValue: "",
    resolve: null,
  },

  requestInput: (title, defaultValue = "") =>
    new Promise((resolve) => {
      set({
        inputModal: {
          isOpen: true,
          title,
          defaultValue,
          resolve,
        },
      });
    }),

  closeInputModal: (value) => {
    const res = get().inputModal.resolve;
    if (res) res(value);

    set({
      inputModal: {
        isOpen: false,
        title: "",
        defaultValue: "",
        resolve: null,
      },
    });
  },

  // Toggles
  toggleGrid: () => set((s) => ({ gridVisible: !s.gridVisible })),
  toggleSky: () => set((s) => ({ skyVisible: !s.skyVisible })),
  toggleEnvPanel: () => set((s) => ({ envPanelVisible: !s.envPanelVisible })),
  toggleSafetyZones: () =>
    set((s) => ({ safetyZonesVisible: !s.safetyZonesVisible })),
  toggleBudget: () => set((s) => ({ budgetVisible: !s.budgetVisible })),

  openQRModal: () => set({ qrModalOpen: true }),
  closeQRModal: () => set({ qrModalOpen: false }),
}));
</file>

<file path="src/stores/fence/useFenceStore.ts">
import { create } from "zustand";
import type { FenceConfig } from "@/types/editor";

const DEFAULT_FENCE_CONFIG: FenceConfig = {
  presetId: "wood",
  colors: {
    post: 0,
    slatA: 0,
    slatB: 0,
    slatC: 0,
  },
};

interface FenceState {
  config: FenceConfig;

  // === ACTIONS ===
  setConfig: (partial: Partial<FenceConfig>) => void;
  resetConfig: () => void;
  setPreset: (presetId: string) => void;
  setColor: (section: keyof FenceConfig["colors"], colorIndex: number) => void;
}

export const useFenceStore = create<FenceState>((set) => ({
  config: { ...DEFAULT_FENCE_CONFIG },

  // Combina cambios superficiales y colores internos
  setConfig: (partial) =>
    set((state) => ({
      config: {
        ...state.config,
        ...partial,
        colors: {
          ...state.config.colors,
          ...(partial.colors ?? {}),
        },
      },
    })),

  // Restaura la configuraci√≥n por defecto
  resetConfig: () =>
    set({
      config: { ...DEFAULT_FENCE_CONFIG },
    }),

  // Cambia el preset manteniendo los colores actuales
  setPreset: (presetId) =>
    set((state) => ({
      config: {
        ...state.config,
        presetId,
      },
    })),

  // Cambia un color individual
  setColor: (section, colorIndex) =>
    set((state) => ({
      config: {
        ...state.config,
        colors: {
          ...state.config.colors,
          [section]: colorIndex,
        },
      },
    })),
}));
</file>

<file path="src/stores/project/useProjectStore.ts">
// --- FILE: src/stores/project/useProjectStore.ts ---
import { create } from "zustand";
import { supabase } from "@/lib/supabase";
import { useSceneStore } from "@/stores/scene/useSceneStore";

interface ProjectState {
  // Identificaci√≥n
  projectId: string | null;
  projectName: string;

  // Metadata
  thumbnailUrl: string | null;
  totalPrice: number | null;

  // Modo acceso
  isReadOnly: boolean;
  isReadOnlyMode: boolean; // alias UI

  // === ACCIONES ===
  setProjectInfo: (id: string | null, name: string) => void;
  setProjectName: (name: string) => void;
  setThumbnail: (url: string | null) => void;
  setTotalPrice: (price: number) => void;

  setReadOnly: (state: boolean) => void;

  clearProject: () => void;

  // ‚≠ê Nuevas (para que App.tsx y QRModal funcionen)
  loadProjectFromURL: (projectId: string) => Promise<void>;
  resetProject: () => void;
}

export const useProjectStore = create<ProjectState>((set) => ({
  // Estado inicial
  projectId: null,
  projectName: "",
  thumbnailUrl: null,
  totalPrice: null,
  isReadOnly: false,
  isReadOnlyMode: false,

  // ----------------------------------------------------
  // SETTERS
  // ----------------------------------------------------
  setProjectInfo: (id, name) =>
    set({ projectId: id, projectName: name }),

  setProjectName: (name) => set({ projectName: name }),

  setThumbnail: (url) => set({ thumbnailUrl: url }),

  setTotalPrice: (price) => set({ totalPrice: price }),

  setReadOnly: (state) =>
    set({
      isReadOnly: state,
      isReadOnlyMode: state, // mantener compatibilidad UI
    }),

  // ----------------------------------------------------
  // BORRAR TODO
  // ----------------------------------------------------
  clearProject: () =>
    set({
      projectId: null,
      projectName: "",
      thumbnailUrl: null,
      totalPrice: null,
      isReadOnly: false,
      isReadOnlyMode: false,
    }),

  // ----------------------------------------------------
  // CARGAR PROYECTO DESDE URL (?project_id=xxxx)
  // ----------------------------------------------------
  loadProjectFromURL: async (projectId: string) => {
    const { data, error } = await supabase
      .from("projects")
      .select("*")
      .eq("id", projectId)
      .single();

    if (error || !data) {
      console.error("‚ùå Error loading project:", error);
      return;
    }

    // Cargar escena
    useSceneStore.getState().setItems(data.data?.items ?? []);

    // Guardar info proyecto
    set({
      projectId,
      projectName: data.name,
      thumbnailUrl: data.thumbnail_url ?? null,
      totalPrice: data.total_price ?? null,
      isReadOnly: true,
      isReadOnlyMode: true,
    });
  },

  // ----------------------------------------------------
  // RESET (usado cuando haces: ?project_id=x&mode=clone)
  // ----------------------------------------------------
  resetProject: () => {
    useSceneStore.getState().clearScene();
    set({
      projectId: null,
      projectName: "Nuevo Proyecto",
      thumbnailUrl: null,
      totalPrice: null,
      isReadOnly: false,
      isReadOnlyMode: false,
    });
  },
}));
</file>

<file path="src/stores/scene/useSceneStore.ts">
// --- FILE: src/stores/scene/useSceneStore.ts ---
import { create } from "zustand";
import type { Vector3Array } from "@/types/editor";

export interface SceneItem {
  uuid: string;
  productId: string;
  name: string;

  price: number;

  position: Vector3Array;
  rotation: Vector3Array;
  scale: Vector3Array;

  description?: string;
  url_tech?: string;
  url_cert?: string;
  url_inst?: string;

  data?: any;

  type?: "model" | "floor" | "fence";
  info?: string;

  // ‚≠ê FENCE SUPPORT
  fenceConfig?: {
    presetId: string;
    colors: {
      post: number;
      slatA: number;
      slatB?: number;
      slatC?: number;
    };
  };

  // ‚≠ê FLOOR SUPPORT
  floorMaterial?: string;
  textureUrl?: string;
  textureScale?: number;
  textureRotation?: number;
}

interface SceneState {
  items: SceneItem[];
  totalPrice: number;

  past: SceneItem[][];
  future: SceneItem[][];
  undo: () => void;
  redo: () => void;

  addItem: (item: SceneItem) => void;
  updateItem: (uuid: string, partial: Partial<SceneItem>) => void;
  removeItem: (uuid: string) => void;

  updateItemFenceConfig: (uuid: string, cfg: any) => void;

  updateFloorMaterial: (uuid: string, material: string) => void;
  updateFloorTexture: (
    uuid: string,
    url?: string,
    scale?: number,
    rotation?: number
  ) => void;

  clearScene: () => void;
  resetScene: () => void;

  setItemTransform: (
    uuid: string,
    position: Vector3Array,
    rotation: Vector3Array,
    scale: Vector3Array
  ) => void;

  setItems: (items: SceneItem[]) => void;
}

export const useSceneStore = create<SceneState>((set) => ({
  items: [],
  totalPrice: 0,

  past: [],
  future: [],

  undo: () => {},
  redo: () => {},

  // =====================================================
  // ADD ITEM
  // =====================================================
  addItem: (item) =>
    set((s) => {
      const items = [...s.items, item];
      return {
        items,
        totalPrice: items.reduce((sum, it) => sum + (it.price ?? 0), 0),
      };
    }),

  // =====================================================
  // UPDATE ITEM
  // =====================================================
  updateItem: (uuid, partial) =>
    set((s) => {
      const items = s.items.map((it) =>
        it.uuid === uuid ? { ...it, ...partial } : it
      );
      return {
        items,
        totalPrice: items.reduce((sum, it) => sum + (it.price ?? 0), 0),
      };
    }),

  // =====================================================
  // FENCE CONFIG
  // =====================================================
  updateItemFenceConfig: (uuid, newConfig) =>
    set((s) => {
      const items = s.items.map((it) =>
        it.uuid === uuid ? { ...it, fenceConfig: newConfig } : it
      );
      return {
        items,
        totalPrice: items.reduce((sum, it) => sum + (it.price ?? 0), 0),
      };
    }),

  // =====================================================
  // FLOOR MATERIAL
  // =====================================================
  updateFloorMaterial: (uuid, material) =>
    set((s) => {
      const items = s.items.map((it) =>
        it.uuid === uuid ? { ...it, floorMaterial: material } : it
      );
      return { items, totalPrice: s.totalPrice };
    }),

  // =====================================================
  // FLOOR TEXTURE (image + scale + rotation)
  // =====================================================
  updateFloorTexture: (uuid, url, scale, rotation) =>
    set((s) => {
      const items = s.items.map((it) =>
        it.uuid === uuid
          ? {
              ...it,
              textureUrl: url ?? it.textureUrl,
              textureScale: scale ?? it.textureScale ?? 1,
              textureRotation: rotation ?? it.textureRotation ?? 0,
            }
          : it
      );
      return { items, totalPrice: s.totalPrice };
    }),

  // =====================================================
  // REMOVE ITEM
  // =====================================================
  removeItem: (uuid) =>
    set((s) => {
      const items = s.items.filter((it) => it.uuid !== uuid);
      return {
        items,
        totalPrice: items.reduce((sum, it) => sum + (it.price ?? 0), 0),
      };
    }),

  // =====================================================
  // TRANSFORM
  // =====================================================
  setItemTransform: (uuid, position, rotation, scale) =>
    set((s) => ({
      items: s.items.map((it) =>
        it.uuid === uuid ? { ...it, position, rotation, scale } : it
      ),
    })),

  // =====================================================
  // SET ITEMS (LOAD PROJECT)
  // =====================================================
  setItems: (items) =>
    set({
      items,
      totalPrice: items.reduce((sum, it) => sum + (it.price ?? 0), 0),
    }),

  // =====================================================
  // CLEAR SCENE
  // =====================================================
  clearScene: () => set({ items: [], totalPrice: 0 }),
  resetScene: () => set({ items: [], totalPrice: 0 }),
}));
</file>

<file path="src/stores/selection/useSelectionStore.ts">
import { create } from "zustand";

interface SelectionState {
  selectedUUID: string | null;

  // === ACTIONS ===
  select: (uuid: string | null) => void;
  clear: () => void;
}

export const useSelectionStore = create<SelectionState>((set) => ({
  selectedUUID: null,

  select: (uuid) => set({ selectedUUID: uuid }),
  clear: () => set({ selectedUUID: null }),
}));
</file>

<file path="src/stores/ui/useUIStore.ts">
import { create } from "zustand";

interface GlobalUIState {
  // --- APP GLOBAL (NO EDITOR 3D) ---
  sidebarOpen: boolean;
  loading: boolean;
  toast: {
    message: string;
    type: "success" | "error" | "info" | null;
    visible: boolean;
  };

  // === ACTIONS ===
  toggleSidebar: () => void;

  setLoading: (state: boolean) => void;

  showToast: (message: string, type?: "success" | "error" | "info") => void;
  hideToast: () => void;
}

export const useUIStore = create<GlobalUIState>((set) => ({
  // === DEFAULT STATE ===
  sidebarOpen: false,
  loading: false,

  toast: {
    message: "",
    type: null,
    visible: false,
  },

  // === ACTIONS ===

  toggleSidebar: () =>
    set((s) => ({
      sidebarOpen: !s.sidebarOpen,
    })),

  setLoading: (state) => set({ loading: state }),

  showToast: (message, type = "info") =>
    set({
      toast: {
        message,
        type,
        visible: true,
      },
    }),

  hideToast: () =>
    set({
      toast: {
        message: "",
        type: null,
        visible: false,
      },
    }),
}));
</file>

<file path="src/stores/user/useUserStore.ts">
import { create } from "zustand";

export interface UserProfile {
  id: string;
  email: string | null;
  full_name?: string | null;
  company_name?: string | null;
  phone?: string | null;
  role?: string | null;          // 'admin' | 'client' | ...
  discount_rate?: number | null; // para calculadora de precios
  cif?: string | null;
}

interface UserState {
  user: UserProfile | null;

  // === ACTIONS ===
  setUser: (user: UserProfile | null) => void;
  clearUser: () => void;
}

export const useUserStore = create<UserState>((set) => ({
  user: null,

  setUser: (user) => set({ user }),
  clearUser: () => set({ user: null }),
}));
</file>

<file path="src/types/catalog.ts">
export interface ProductDefinition {
  id: string;
  name: string;
  price: number;
  type: "model" | string;
  modelUrl: string;
  img_2d?: string;
  line?: string;
  category?: string;

  // Estos los a√±adimos pero son opcionales
  url_tech?: string;
  url_cert?: string;
  url_inst?: string;
  description?: string;
}
</file>

<file path="src/types/editor.ts">
// =============================================================================
//  A42 EDITOR TYPES (STRICT)
// =============================================================================

// --- 1. PRIMITIVES ---
export type Vector3Array = [number, number, number]; // [x, y, z]
export type Point2D = { x: number; z: number };

export type FloorMaterialType =
  | "rubber_red"
  | "rubber_green"
  | "rubber_blue"
  | "grass"
  | "concrete";

export interface FenceConfig {
  presetId: string;
  colors: {
    post: number;
    slatA: number;
    slatB?: number;
    slatC?: number;
  };
}

// --- 2. BASE ITEM (Shared properties) ---
interface BaseSceneItem {
  uuid: string;
  productId: string;
  name: string; // Hacemos obligatorio el nombre (aunque sea "Sin nombre")
  price: number;

  position: Vector3Array;
  rotation: Vector3Array;
  scale: Vector3Array;

  // Metadata opcional del cat√°logo
  description?: string;
  url_tech?: string;
  url_cert?: string;
  url_inst?: string;
  
  // Datos crudos del cat√°logo (para no perder info extra)
  data?: Record<string, any>;
}

// --- 3. SPECIFIC ITEMS ---

/** Objetos 3D importados (.glb/.gltf) */
export interface ModelItem extends BaseSceneItem {
  type: "model";
  modelUrl: string; // Obligatorio para modelos
  
  // Propiedades que NO deben existir aqu√≠:
  // points?: never;
  // fenceConfig?: never;
}

/** Suelos dibujados param√©tricamente */
export interface FloorItem extends BaseSceneItem {
  type: "floor";
  points: Point2D[]; // Obligatorio para suelos
  
  floorMaterial?: FloorMaterialType;
  textureUrl?: string;
  textureScale?: number;
  textureRotation?: number;
}

/** Vallas dibujadas param√©tricamente */
export interface FenceItem extends BaseSceneItem {
  type: "fence";
  points: Point2D[]; // Obligatorio para vallas
  fenceConfig: FenceConfig; // Obligatorio para vallas
}

// --- 4. THE UNION (La "SceneItem" final) ---
export type SceneItem = ModelItem | FloorItem | FenceItem;


// =============================================================================
//  EDITOR STATE TYPES
// =============================================================================

export type EditorMode =
  | "idle"
  | "editing"
  | "placing_item"
  | "drawing_floor"
  | "drawing_fence"
  | "measuring"
  | "catalog";

export type CameraView = "top" | "front" | "side" | "iso";
export type CameraType = "perspective" | "orthographic";
</file>

<file path="src/types/types.ts">
// --- src/types.ts ---

export interface Profile {
  id: string;
  email: string;
  role: 'client' | 'employee' | 'admin';
  company_name?: string;
  full_name?: string;
  shipping_address?: string;
  billing_address?: string;
  billing_email?: string;
  phone?: string;
  cif?: string;
  observations?: string;
  created_at: string;
}

export type OrderStatus = 'borrador' | 'pendiente' | 'presupuestado' | 'pedido' | 'en_proceso' | 'enviado' | 'entregado' | 'rechazado';

export interface Order {
  id: string;
  created_at: string;
  order_ref: string;
  user_id: string;
  project_id?: string;
  status: OrderStatus;
  total_price: number;
  estimated_delivery_date?: string;
  is_archived?: boolean; 
  
  // Relaciones (Supabase join)
  profiles?: Profile;
  // üëá AQU√ç ESTABA EL ERROR: Faltaba a√±adir 'id: string'
  projects?: { 
    id: string; 
    name: string; 
    thumbnail_url?: string 
  };
}
</file>

<file path="src/utils/budgetUtils.ts">
// --- START OF FILE src/utils/budgetUtils.ts ---
import type { SceneItem } from '@/types/editor';

export interface BudgetLineItem {
  id: string;
  name: string;
  category: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
  image?: string;
}

export const generateBillOfMaterials = (items: SceneItem[]): BudgetLineItem[] => {
  const groupedItems: Record<string, BudgetLineItem> = {};

  items.forEach((item) => {
    if (!item.productId) return;

    const key = item.productId;

    if (!groupedItems[key]) {
      // üî• Type Guard para sacar la imagen solo si es modelo
      const imageUrl = item.type === 'model' ? item.modelUrl : undefined;

      groupedItems[key] = {
        id: item.productId,
        name: item.name || 'Producto sin nombre',
        category: item.type,
        quantity: 0,
        unitPrice: item.price || 0,
        totalPrice: 0,
        image: imageUrl
      };
    }

    groupedItems[key].quantity += 1;
    groupedItems[key].totalPrice += item.price || 0;
  });

  return Object.values(groupedItems);
};

export const calculateGrandTotal = (lines: BudgetLineItem[]) => {
  return lines.reduce((acc, line) => acc + line.totalPrice, 0);
};
// --- END OF FILE src/utils/budgetUtils.ts ---
</file>

<file path="src/utils/pdfGenerator.ts">
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';


// Funci√≥n auxiliar local para formatear dinero
const formatMoney = (amount: number) => {
    return amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
};

export const generateBudgetPDF = async (order: any, items3D: any[], manualItems: any[]) => {
  const doc = new jsPDF();
  const margin = 20;
  const rightMargin = 190; // Alineaci√≥n derecha est√°ndar A4
  
  // --- CABECERA ---
  doc.setFontSize(22);
  doc.setTextColor(40, 40, 40);
  // Alineado a la derecha
  doc.text("PRESUPUESTO", rightMargin, 20, { align: 'right' });

  doc.setFontSize(10);
  doc.setTextColor(100);
  // Alineado a la derecha debajo del t√≠tulo
  doc.text(`Referencia: ${order.order_ref}`, rightMargin, 28, { align: 'right' });
  doc.text(`Fecha: ${new Date().toLocaleDateString()}`, rightMargin, 33, { align: 'right' });
  if(order.custom_name) {
      doc.text(`Proyecto: ${order.custom_name}`, rightMargin, 38, { align: 'right' });
  }

  // Datos de tu empresa
  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.text("Mi Empresa S.L.", margin, 20);
  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text("Calle Industria 123", margin, 26);
  doc.text("28000 Madrid", margin, 31);
  doc.text("info@miempresa.com", margin, 36);

  // L√≠nea separadora
  doc.setDrawColor(200);
  doc.line(margin, 45, rightMargin, 45);
  
  // Datos del Cliente
  doc.setFontSize(11);
  doc.setTextColor(0);
  doc.text("Cliente:", margin, 55);
  doc.setFontSize(10);
  doc.setTextColor(80);
  const clientName = order.profiles?.company_name || order.profiles?.full_name || 'Particular';
  const clientEmail = order.profiles?.email || '';
  const clientPhone = order.profiles?.phone || '';
  const clientCif = order.profiles?.cif ? `CIF/NIF: ${order.profiles.cif}` : '';
  
  doc.text(clientName, margin, 62);
  doc.text(clientEmail, margin, 67);
  doc.text(clientPhone, margin, 72);
  if (clientCif) doc.text(clientCif, margin, 77);

  // --- IMAGEN DEL PROYECTO (Con m√°s espacio) ---
  // Calculamos d√≥nde empezar√° la tabla din√°micamente
  let tableStartY = 95; // Posici√≥n por defecto si no hay imagen

  if (order.projects?.thumbnail_url) {
    try {
        const img = new Image();
        img.src = order.projects.thumbnail_url;
        img.crossOrigin = "Anonymous";
        await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });
        
        // Imagen alineada a la derecha
        doc.addImage(img, 'JPEG', 120, 50, 70, 45); // x, y, ancho, alto
        tableStartY = 110; // Bajamos la tabla para dejar aire
    } catch (e) {
        console.warn("No se pudo cargar imagen PDF", e);
    }
  }

  // --- TABLA DE ITEMS ---
  const tableRows: any[] = [];

  // 1. Items 3D
  items3D.forEach(item => {
    // L√≥gica para Referencia y Cantidad/Medida
    const ref = item.id ? item.id.substring(0, 8).toUpperCase() : '3D-DESIGN';
    // Si tiene 'info' (dimensiones calculadas), lo usamos. Si no, la cantidad.
    const qtyDisplay = item.info ? item.info : item.quantity.toString();

    tableRows.push([
        item.name,
        ref,
        qtyDisplay,
        formatMoney(item.unitPrice || item.price)
    ]);
  });

  // 2. Items Manuales
  manualItems.forEach(item => {
    const ref = 'EXTRA-MAN';
    const qtyDisplay = item.dimensions ? item.dimensions : item.quantity.toString();

    tableRows.push([
        item.name,
        ref,
        qtyDisplay,
        formatMoney(item.total_price)
    ]);
  });

  // @ts-ignore
  autoTable(doc, {
    startY: tableStartY,
    head: [['Concepto', 'Referencia', 'Cant. / Medida', 'Precio Total']], // Encabezados cambiados
    body: tableRows,
    theme: 'striped',
    headStyles: { 
        fillColor: [41, 128, 185],
        halign: 'left' // Alineaci√≥n general headers
    },
    styles: { fontSize: 10, cellPadding: 3 },
    columnStyles: { 
        0: { cellWidth: 'auto' }, // Concepto
        1: { cellWidth: 30 },     // Referencia
        2: { cellWidth: 30, halign: 'center' }, // Cant/Medida
        3: { cellWidth: 30, halign: 'right' }   // Precio (contenido)
    },
    // Forzar alineaci√≥n derecha espec√≠ficamente al header de la columna 3 (Precio)
    didParseCell: function(data) {
        if (data.section === 'head' && data.column.index === 3) {
            data.cell.styles.halign = 'right';
        }
    }
  });

  // --- C√ÅLCULO DE TOTALES E IVA ---
  // @ts-ignore
  let finalY = doc.lastAutoTable.finalY + 10;
  
  // 1. Recuperar valores
  const finalSavedPrice = order.total_price; // Este es el precio final negociado (Base Imponible)
  const discountRate = order.profiles?.discount_rate || 0;
  
  // 2. C√°lculo inverso para sacar el Subtotal Bruto antes de descuento
  let subtotalBruto = finalSavedPrice;
  if (discountRate > 0 && finalSavedPrice > 0) {
      subtotalBruto = finalSavedPrice / (1 - (discountRate / 100));
  } else if (finalSavedPrice === 0) {
      // Fallback por si es 0
      subtotalBruto = items3D.reduce((a,b) => a + b.totalPrice, 0) + manualItems.reduce((a,b) => a + b.total_price, 0);
  }

  // 3. C√°lculo de IVA
  const baseImponible = finalSavedPrice > 0 ? finalSavedPrice : subtotalBruto; // Lo que queda tras el descuento
  const ivaAmount = baseImponible * 0.21; // 21% IVA
  const totalConIva = baseImponible + ivaAmount;

  // --- PINTAR TOTALES ---
  const textXLabel = 135; // Columna etiquetas
  const textXValue = 190; // Columna valores (alineados derecha)
  
  doc.setFontSize(10);
  doc.setTextColor(0);
  
  // Subtotal
  doc.text(`Subtotal:`, textXLabel, finalY);
  doc.text(formatMoney(subtotalBruto), textXValue, finalY, { align: 'right' });
  
  // Descuento (si hay)
  if (discountRate > 0) {
      finalY += 6;
      doc.setTextColor(230, 126, 34); // Naranja
      doc.text(`Dto. (${discountRate}%):`, textXLabel, finalY);
      const discountAmount = subtotalBruto - baseImponible;
      doc.text(`-${formatMoney(discountAmount)}`, textXValue, finalY, { align: 'right' });
  }

  // Base Imponible
  finalY += 6;
  doc.setTextColor(0); // Negro
  doc.text(`Base Imponible:`, textXLabel, finalY);
  doc.text(formatMoney(baseImponible), textXValue, finalY, { align: 'right' });

  // IVA
  finalY += 6;
  doc.text(`IVA (21%):`, textXLabel, finalY);
  doc.text(formatMoney(ivaAmount), textXValue, finalY, { align: 'right' });

  // TOTAL FINAL
  finalY += 10;
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text(`TOTAL:`, textXLabel, finalY);
  doc.setTextColor(41, 128, 185); // Azul
  doc.text(formatMoney(totalConIva), textXValue, finalY, { align: 'right' });

  // --- PIE ---
  doc.setFontSize(8);
  doc.setTextColor(150);
  doc.setFont('helvetica', 'normal');
  doc.text("Este presupuesto tiene una validez de 15 d√≠as.", margin, 280);
  doc.text("Forma de pago: 50% al aceptar, 50% antes de la entrega.", margin, 284);

  return doc.output('blob');
};
</file>

<file path="src/utils/PriceCalculator.ts">
// --- START OF FILE src/utils/PriceCalculator.ts ---
import type { SceneItem } from '@/types/editor';

// PRECIOS BASE (Configuraci√≥n centralizada)
export const PRICES = {
    FLOOR_M2: 35,   // Precio por m¬≤ suelo
    FENCE_M: 45,    // Precio por metro lineal valla
};

export class PriceCalculator {

    /** Obtiene el precio total de un √≠tem */
    static getItemPrice(item: SceneItem): number {
        // 1. Suelos (√Årea)
        if (item.type === 'floor' && item.points) {
            const area = this.calculateArea(item.points);
            const unitPrice = item.price > 0 ? item.price : PRICES.FLOOR_M2;
            return parseFloat((area * unitPrice).toFixed(2));
        } 
        
        // 2. Vallas (Longitud)
        if (item.type === 'fence' && item.points) {
            const length = this.calculateLength(item.points);
            const unitPrice = item.price > 0 ? item.price : PRICES.FENCE_M;
            return parseFloat((length * unitPrice).toFixed(2));
        }

        // 3. Modelos 3D est√°ndar
        return item.price || 0;
    }

    /** Obtiene el texto de dimensiones para mostrar (ej: "12.50 m¬≤") */
    static getItemDimensions(item: SceneItem): string {
        if (item.type === 'floor' && item.points) {
            const area = this.calculateArea(item.points);
            return `${area.toFixed(2)} m¬≤`;
        }
        if (item.type === 'fence' && item.points) {
            const length = this.calculateLength(item.points);
            return `${length.toFixed(2)} ml`;
        }
        return "1 ud";
    }

    /** Calcula el total de una lista de items */
    static calculateProjectTotal(items: SceneItem[]): number {
        return items.reduce((total, item) => total + this.getItemPrice(item), 0);
    }

    // -------------------------------------------------
    // FUNCIONES INTERNAS
    // -------------------------------------------------
    private static calculateArea(points: { x: number, z: number }[]): number {
        if (!points || points.length < 3) return 0;
        let area = 0;
        for (let i = 0; i < points.length; i++) {
            const j = (i + 1) % points.length;
            area += points[i].x * points[j].z;
            area -= points[j].x * points[i].z;
        }
        return Math.abs(area) / 2;
    }

    private static calculateLength(points: { x: number, z: number }[]): number {
        if (!points || points.length < 2) return 0;
        let length = 0;
        for (let i = 0; i < points.length - 1; i++) {
            const p1 = points[i];
            const p2 = points[i+1];
            const dist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.z - p1.z, 2));
            length += dist;
        }
        return length;
    }
}
// --- END OF FILE src/utils/PriceCalculator.ts ---
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,

    "baseUrl": "./src",
    "paths": {
      "@/*": ["*"],
      "@features/*": ["features/*"],
      "@stores/*": ["stores/*"],
      "@lib/*": ["lib/*"],
      "@utils/*": ["utils/*"],
      "@components/*": ["components/*"]
    }
  },

  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vercel.json">
{
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  
  // 1. TU CONFIGURACI√ìN ACTUAL (Vital para Three.js)
  resolve: {
    alias: {
      // Mantener this para evitar varias copias de Three
      three: path.resolve(__dirname, './node_modules/three'),

      '@': path.resolve(__dirname, './src'),
      '@features': path.resolve(__dirname, './src/features'),
      '@stores': path.resolve(__dirname, './src/stores'),
      '@lib': path.resolve(__dirname, './src/lib'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@components': path.resolve(__dirname, './src/components')
    }
  },

  // 2. CONFIGURACI√ìN DE OPTIMIZACI√ìN (Para quitar el aviso amarillo)
  build: {
    chunkSizeWarningLimit: 1600, // Aumentamos el l√≠mite de aviso a 1.6MB
    rollupOptions: {
      output: {
        manualChunks(id) {
          // Separa las librer√≠as (node_modules) del c√≥digo de tu app
          // Esto crea un archivo 'vendor.js' que el navegador cachea mejor
          if (id.includes('node_modules')) {
            return 'vendor';
          }
        }
      }
    }
  }
})
</file>

</files>
