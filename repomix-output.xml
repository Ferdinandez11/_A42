This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.env.example
.gitattributes
.gitignore
eslint.config.js
index.html
package.json
postcss.config.js
public/banco.glb
public/columpio.glb
public/muelle.glb
public/tobogan.glb
public/vite.svg
README.md
src/App.tsx
src/components/layout/DashboardLayout.tsx
src/components/layout/ViewerLayout.tsx
src/components/ui/ConfirmModal.tsx
src/features/crm/index.ts
src/features/crm/pages/AdminCalendarPage.tsx
src/features/crm/pages/AdminClientDetailPage.tsx
src/features/crm/pages/AdminOrderDetailPage.tsx
src/features/crm/pages/BudgetDetailPage.tsx
src/features/crm/pages/ClientDashboard.tsx
src/features/crm/pages/ClientsPage.tsx
src/features/crm/pages/CrmDashboard.tsx
src/features/crm/pages/ProfilePage.tsx
src/features/editor/data/fence_presets.ts
src/features/editor/Editor3D.tsx
src/features/editor/engine/A42Engine_old_gpt_01.txt
src/features/editor/engine/A42Engine_old_gpt.txt
src/features/editor/engine/A42Engine.ts
src/features/editor/engine/managers/ExportManager.ts
src/features/editor/engine/managers/InteractionManager_old_gpt_01.txt
src/features/editor/engine/managers/InteractionManager_old_gpt.txt
src/features/editor/engine/managers/InteractionManager.ts
src/features/editor/engine/managers/ObjectManager.ts
src/features/editor/engine/managers/PDFManager.ts
src/features/editor/engine/managers/RecorderManager.ts
src/features/editor/engine/managers/SceneManager.ts
src/features/editor/engine/managers/ToolsManager.ts
src/features/editor/engine/managers/WalkManager.ts
src/features/editor/ui/BudgetPanel.tsx
src/features/editor/ui/CadControl.tsx
src/features/editor/ui/Catalog.tsx
src/features/editor/ui/Editor.css
src/features/editor/ui/EnvironmentPanel.tsx
src/features/editor/ui/FenceProperties.tsx
src/features/editor/ui/FloorProperties.tsx
src/features/editor/ui/InputModal.tsx
src/features/editor/ui/QRModal.tsx
src/features/editor/ui/Toolbar.tsx
src/index.css
src/lib/supabase.ts
src/main.tsx
src/services/catalogService.ts
src/stores/auth/useAuthStore.ts
src/stores/cad/useCADStore.ts
src/stores/catalog/useCatalogStore.ts
src/stores/crm/useCRMStore.ts
src/stores/editor/useEditorStore.ts
src/stores/editor/useHistoryStore.ts
src/stores/fence/useFenceStore.ts
src/stores/project/useProjectStore.ts
src/stores/scene/useSceneStore.ts
src/stores/selection/useSelectionStore.ts
src/stores/ui/useUIStore.ts
src/stores/user/useUserStore.ts
src/types/catalog.ts
src/types/editor.ts
src/types/types.ts
src/utils/budgetUtils.ts
src/utils/pdfGenerator.ts
src/utils/PriceCalculator.ts
tailwind.config.js
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vercel.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".env.example">
VITE_SUPABASE_URL=https://ikcjeiyidbrbkbletpxh.supabase.co
VITE_SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrY2plaXlpZGJyYmtibGV0cHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDM2NTQsImV4cCI6MjA3OTgxOTY1NH0.6x6bLTzHIqqInO2_9N83weQ3SVR0mrQV07pItqpisMs
</file>

<file path=".gitattributes">
# Auto detect text files and perform LF normalization
* text=auto
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
.env
.env.*
.env.local
.env.*.local
!/.env.example

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>a42-app</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="package.json">
{
  "name": "a42-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.86.0",
    "@types/three": "^0.158.0",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "lucide-react": "^0.555.0",
    "pdfjs-dist": "^5.4.449",
    "qrcode.react": "^4.2.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.9.6",
    "three": "^0.158.0",
    "zustand": "^5.0.8"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.22",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```
</file>

<file path="src/App.tsx">
import React from "react";
import {
  BrowserRouter,
  Routes,
  Route,
  Link,
  Outlet,
  useNavigate,
} from "react-router-dom";
import { supabase } from "./lib/supabase";

// --- IMPORTS ---
import { Editor3D } from "./features/editor/Editor3D";
import { useAuthStore } from "@/stores/auth/useAuthStore";
import { useProjectStore } from "@/stores/project/useProjectStore";
import { CrmDashboard } from "./features/crm/pages/CrmDashboard";
import { ClientDashboard } from "./features/crm/pages/ClientDashboard";
import { ProfilePage } from "./features/crm/pages/ProfilePage";
import { BudgetDetailPage } from "./features/crm/pages/BudgetDetailPage";
import { AdminOrderDetailPage } from "./features/crm/pages/AdminOrderDetailPage";
import { AdminClientDetailPage } from "./features/crm/pages/AdminClientDetailPage";
import { AdminCalendarPage } from "./features/crm/pages/AdminCalendarPage";

// --- ESTILOS ---
const badgeStyle: React.CSSProperties = {
  backgroundColor: "#333",
  color: "white",
  padding: "8px 16px",
  borderRadius: "20px",
  textDecoration: "none",
  fontSize: "14px",
  fontWeight: "bold",
  display: "flex",
  alignItems: "center",
  gap: "8px",
  boxShadow: "0 4px 6px rgba(0,0,0,0.3)",
  border: "1px solid #444",
  cursor: "pointer",
  transition: "all 0.2s ease",
};

const navLinkStyle: React.CSSProperties = {
  color: "#aaa",
  textDecoration: "none",
  padding: "8px 12px",
  borderRadius: "6px",
  transition: "color 0.2s",
  fontSize: "14px",
  display: "block",
};

// --- LOGOUT ---
const performLogout = async () => {
  await supabase.auth.signOut();
  useAuthStore.getState().setUser(null);
  useAuthStore.getState().setSession(null);
  localStorage.clear();
  window.location.href = "/";
};

// ------------------------------------------------------------------------------------
// EMPLOYEE LAYOUT
const EmployeeLayout = () => (
  <div
    style={{
      display: "flex",
      height: "100vh",
      fontFamily: "sans-serif",
      background: "#121212",
      color: "#e0e0e0",
    }}
  >
    <aside
      style={{
        width: "240px",
        background: "#1e1e1e",
        borderRight: "1px solid #333",
        display: "flex",
        flexDirection: "column",
      }}
    >
      <div style={{ padding: "20px", borderBottom: "1px solid #333" }}>
        <h3 style={{ margin: 0, color: "#fff" }}>Intranet üè¢</h3>
        <small style={{ color: "#666" }}>Modo Empleado</small>
      </div>

      <nav
        style={{
          display: "flex",
          flexDirection: "column",
          padding: "15px",
          gap: "5px",
        }}
      >
        <Link
          to="/admin/crm"
          style={{ ...navLinkStyle, color: "#fff", background: "#2a2a2a" }}
        >
          üë• CRM (Listado)
        </Link>
        <Link to="/admin/calendar" style={navLinkStyle}>
          üìÖ Calendario Entregas
        </Link>
        <Link to="/admin/erp" style={navLinkStyle}>
          üè≠ ERP (F√°brica)
        </Link>
        <Link to="/admin/purchases" style={navLinkStyle}>
          üõí Compras
        </Link>
      </nav>

      <div
        style={{
          marginTop: "auto",
          padding: "20px",
          borderTop: "1px solid #333",
          display: "flex",
          flexDirection: "column",
          gap: "10px",
        }}
      >
        <button
          onClick={performLogout}
          style={{
            background: "transparent",
            border: "none",
            color: "#e74c3c",
            cursor: "pointer",
            textAlign: "left",
            padding: 0,
          }}
        >
          Cerrar Sesi√≥n
        </button>

        <Link
          to="/"
          style={{ color: "#666", textDecoration: "none", fontSize: "13px" }}
        >
          ‚Üê Volver al Visor 3D
        </Link>
      </div>
    </aside>

    <main style={{ flex: 1, overflow: "auto" }}>
      <Outlet />
    </main>
  </div>
);

// ------------------------------------------------------------------------------------
// CLIENT PORTAL LAYOUT
const ClientPortalLayout = () => (
  <div
    style={{
      height: "100vh",
      display: "flex",
      flexDirection: "column",
      background: "#121212",
      color: "#e0e0e0",
      fontFamily: "sans-serif",
      overflow: "hidden",
    }}
  >
    <header
      style={{
        background: "#1e1e1e",
        borderBottom: "1px solid #333",
        padding: "15px 40px",
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        flexShrink: 0,
      }}
    >
      <h3 style={{ margin: 0, color: "#fff" }}>Portal del Cliente üëã</h3>

      <nav style={{ display: "flex", gap: "20px", alignItems: "center" }}>
        <Link to="/portal?tab=projects" style={{ color: "#fff" }}>
          Mis Proyectos
        </Link>
        <Link to="/portal?tab=budgets" style={{ color: "#bbb" }}>
          Mis Presupuestos
        </Link>
        <Link to="/portal?tab=orders" style={{ color: "#bbb" }}>
          Mis Pedidos
        </Link>
        <Link to="/portal/profile" style={{ color: "#bbb" }}>
          Mi Perfil üë§
        </Link>

        <Link
          to="/"
          style={{ ...badgeStyle, fontSize: "12px", padding: "6px 12px" }}
        >
          + Nuevo Proyecto 3D
        </Link>

        <button
          onClick={performLogout}
          style={{ background: "none", border: "none", color: "#666" }}
        >
          Salir
        </button>
      </nav>
    </header>

    <main style={{ flex: 1, overflowY: "auto", padding: "40px" }}>
      <div style={{ maxWidth: "1200px", margin: "0 auto" }}>
        <div
          style={{
            background: "#1e1e1e",
            padding: "30px",
            borderRadius: "12px",
            border: "1px solid #333",
          }}
        >
          <Outlet />
        </div>
      </div>
    </main>
  </div>
);

// ------------------------------------------------------------------------------------
// LOGIN PAGE (como la ten√≠as)
const LoginPage = () => {
  const navigate = useNavigate();
  const { setUser, setSession } = useAuthStore();

  const [step, setStep] = React.useState<"selection" | "form">("selection");
  const [targetRole, setTargetRole] = React.useState<"client" | "employee">(
    "client"
  );
  const [isRegistering, setIsRegistering] = React.useState(false);

  const [email, setEmail] = React.useState("");
  const [password, setPassword] = React.useState("");
  const [loading, setLoading] = React.useState(false);
  const [errorMsg, setErrorMsg] = React.useState("");

  const selectRole = (role: "client" | "employee") => {
    setTargetRole(role);
    setStep("form");
    setErrorMsg("");
  };

  const checkUserStatus = async (userId: string) => {
    const { data: profile } = await supabase
      .from("profiles")
      .select("role, is_approved")
      .eq("id", userId)
      .single();

    if (profile) {
      if (profile.role === "admin" || profile.role === "employee") {
        navigate("/admin/crm");
        return;
      }

      if (profile.is_approved) {
        navigate("/portal");
      } else {
        await supabase.auth.signOut();
        throw new Error("üîí Cuenta creada. Pendiente de validaci√≥n.");
      }
    }
  };

  const handleAuth = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setErrorMsg("");

    try {
      let result;

      if (isRegistering) {
        result = await supabase.auth.signUp({
          email,
          password,
          options: { data: { role: "client" } },
        });
      } else {
        result = await supabase.auth.signInWithPassword({ email, password });
      }

      if (result.error) throw result.error;

      if (!result.data.user) throw new Error("Error desconocido.");

      setUser(result.data.user);
      const session = (await supabase.auth.getSession()).data.session;
      setSession(session);

      await checkUserStatus(result.data.user.id);
    } catch (error: any) {
      setErrorMsg(error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      {step === "selection" ? (
        // pantalla selecci√≥n
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            justifyContent: "center",
            alignItems: "center",
            height: "100vh",
            background: "#000",
            color: "#fff",
          }}
        >
          <div
            style={{
              padding: "3rem",
              background: "#1e1e1e",
              borderRadius: "16px",
              border: "1px solid #333",
              textAlign: "center",
              minWidth: "350px",
            }}
          >
            <h2 style={{ marginBottom: "10px" }}>Bienvenido</h2>

            <div
              style={{
                display: "flex",
                gap: "15px",
                justifyContent: "center",
                margin: "30px 0",
              }}
            >
              <button
                onClick={() => selectRole("client")}
                style={{
                  ...badgeStyle,
                  flexDirection: "column",
                  padding: "20px",
                  width: "140px",
                  background: "#333",
                }}
              >
                <span style={{ fontSize: "30px" }}>üëã</span>
                <span>Soy Cliente</span>
              </button>

              <button
                onClick={() => selectRole("employee")}
                style={{
                  ...badgeStyle,
                  flexDirection: "column",
                  padding: "20px",
                  width: "140px",
                  background: "#222",
                  border: "1px solid #555",
                }}
              >
                <span style={{ fontSize: "30px" }}>üè¢</span>
                <span>Soy Empleado</span>
              </button>
            </div>

            <button
              onClick={() => navigate("/")}
              style={{
                background: "transparent",
                border: "none",
                color: "#666",
                cursor: "pointer",
                textDecoration: "underline",
              }}
            >
              Volver al Visor 3D
            </button>
          </div>
        </div>
      ) : (
        // --- FORMULARIO ORIGINAL ----
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            justifyContent: "center",
            alignItems: "center",
            height: "100vh",
            background: "#000",
            color: "#fff",
            fontFamily: "sans-serif",
          }}
        >
          <div
            style={{
              padding: "3rem",
              background: "#1e1e1e",
              borderRadius: "16px",
              border: "1px solid #333",
              textAlign: "center",
              minWidth: "350px",
            }}
          >
            <h2 style={{ marginBottom: "5px" }}>
              {targetRole === "employee"
                ? "Acceso Empleados"
                : isRegistering
                ? "Nuevo Registro"
                : "Acceso Clientes"}
            </h2>

            {errorMsg && (
              <div
                style={{
                  background: errorMsg.includes("validaci√≥n")
                    ? "rgba(39, 174, 96, 0.2)"
                    : "rgba(231, 76, 60, 0.2)",
                  color: errorMsg.includes("validaci√≥n")
                    ? "#2ecc71"
                    : "#e74c3c",
                  padding: "10px",
                  borderRadius: "6px",
                  marginBottom: "15px",
                  fontSize: "13px",
                }}
              >
                {errorMsg}
              </div>
            )}

            <form
              onSubmit={handleAuth}
              style={{ display: "flex", flexDirection: "column", gap: "15px" }}
            >
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={{
                  padding: "12px",
                  borderRadius: "6px",
                  border: "1px solid #444",
                  background: "#2a2a2a",
                  color: "white",
                }}
                required
              />
              <input
                type="password"
                placeholder="Contrase√±a"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={{
                  padding: "12px",
                  borderRadius: "6px",
                  border: "1px solid #444",
                  background: "#2a2a2a",
                  color: "white",
                }}
                required
              />

              <button
                type="submit"
                disabled={loading}
                style={{
                  ...badgeStyle,
                  justifyContent: "center",
                  backgroundColor:
                    targetRole === "employee" ? "#e67e22" : "#3b82f6",
                  border: "none",
                  padding: "12px",
                  marginTop: "10px",
                }}
              >
                {loading
                  ? "Procesando..."
                  : isRegistering
                  ? "Crear Cuenta"
                  : "Entrar"}
              </button>
            </form>

            {targetRole === "client" && (
              <div
                style={{
                  marginTop: "15px",
                  fontSize: "13px",
                  color: "#888",
                }}
              >
                {isRegistering ? "¬øYa tienes cuenta?" : "¬øNo tienes cuenta?"}{" "}
                <button
                  onClick={() => {
                    setIsRegistering(!isRegistering);
                    setErrorMsg("");
                  }}
                  style={{
                    background: "none",
                    border: "none",
                    color: "#3b82f6",
                    cursor: "pointer",
                    fontWeight: "bold",
                    textDecoration: "underline",
                  }}
                >
                  {isRegistering ? "Inicia Sesi√≥n" : "Reg√≠strate aqu√≠"}
                </button>
              </div>
            )}

            <button
              onClick={() => setStep("selection")}
              style={{
                marginTop: "20px",
                background: "transparent",
                border: "none",
                color: "#666",
                cursor: "pointer",
                textDecoration: "underline",
              }}
            >
              ‚Üê Volver
            </button>
          </div>
        </div>
      )}
    </>
  );
};


// VISOR 3D PAGE
const ViewerPage = () => {
  // Stores correctos (SIN useAppStore)
  const isReadOnlyMode = useProjectStore((s) => s.isReadOnlyMode);

  const loadProjectFromURL = useProjectStore((s) => s.loadProjectFromURL);
  const resetProject = useProjectStore((s) => s.resetProject);




  const { user, setUser } = useAuthStore();
  const navigate = useNavigate();

  // cargar usuario
  React.useEffect(() => {
    const loadUser = async () => {
      const { data } = await supabase.auth.getUser();
      const authUser = data.user;

      if (authUser) {
        const { data: profile } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", authUser.id)
          .single();

        setUser(profile ? { ...authUser, role: profile.role } : authUser);
      }
    };
    loadUser();
  }, [setUser]);

  React.useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const projectId = params.get("project_id");
    const isClone = params.get("mode") === "clone";

    if (projectId) {
      loadProjectFromURL(projectId).then(() => {
        if (isClone) resetProject();
      });
    }
  }, [loadProjectFromURL, resetProject]);

  const isAdminOrEmployee =
    user?.role === "admin" || user?.role === "employee";

  return (
    <div
      style={{
        width: "100vw",
        height: "100vh",
        position: "relative",
        overflow: "hidden",
        background: "#000",
      }}
    >
      <div
        style={{
          position: "absolute",
          top: 20,
          left: 20,
          zIndex: 2000,
          display: "flex",
          flexDirection: "column",
          gap: "10px",
        }}
      >
        {isAdminOrEmployee && (
          <button
            onClick={() => navigate("/admin/crm")}
            style={{
              background: "#e67e22",
              color: "white",
              padding: "10px 20px",
              borderRadius: "8px",
              border: "none",
              cursor: "pointer",
              fontWeight: "bold",
            }}
          >
            ‚¨ÖÔ∏è Volver al Panel
          </button>
        )}

        {!user && !isReadOnlyMode && (
          <Link to="/login" style={badgeStyle}>
            üë§ Acceso / Login
          </Link>
        )}
      </div>

      <Editor3D />

    </div>
  );
};

// ------------------------------------------------------------------------------------
// APP ROOT
function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<ViewerPage />} />
        <Route path="/login" element={<LoginPage />} />

        <Route path="/admin" element={<EmployeeLayout />}>
          <Route index element={<CrmDashboard />} />
          <Route path="crm" element={<CrmDashboard />} />
          <Route path="order/:id" element={<AdminOrderDetailPage />} />
          <Route path="client/:id" element={<AdminClientDetailPage />} />
          <Route path="calendar" element={<AdminCalendarPage />} />
        </Route>

        <Route path="/portal" element={<ClientPortalLayout />}>
          <Route index element={<ClientDashboard />} />
          <Route path="profile" element={<ProfilePage />} />
          <Route path="order/:id" element={<BudgetDetailPage />} />
        </Route>
      </Routes>
    </BrowserRouter>
  );
}

export default App;
</file>

<file path="src/components/ui/ConfirmModal.tsx">
import React from 'react';

interface ConfirmModalProps {
  isOpen: boolean;
  title: string;
  message: string;
  onConfirm: () => void;
  onCancel: () => void;
  isDestructive?: boolean; // Para poner el bot√≥n rojo
}

export const ConfirmModal: React.FC<ConfirmModalProps> = ({ 
  isOpen, title, message, onConfirm, onCancel, isDestructive = false 
}) => {
  if (!isOpen) return null;

  return (
    <div style={{
      position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
      background: 'rgba(0,0,0,0.8)', zIndex: 9999,
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      backdropFilter: 'blur(2px)'
    }}>
      <div style={{
        background: '#1e1e1e', border: '1px solid #333', borderRadius: '12px',
        padding: '25px', width: '400px', maxWidth: '90%',
        boxShadow: '0 10px 25px rgba(0,0,0,0.5)'
      }}>
        <h3 style={{ margin: '0 0 10px 0', color: 'white' }}>{title}</h3>
        <p style={{ color: '#aaa', fontSize: '14px', marginBottom: '25px', lineHeight: '1.5' }}>
          {message}
        </p>
        
        <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
          <button 
            onClick={onCancel}
            style={{
              padding: '10px 20px', borderRadius: '6px', border: '1px solid #444',
              background: 'transparent', color: '#ccc', cursor: 'pointer'
            }}
          >
            Cancelar
          </button>
          <button 
            onClick={onConfirm}
            style={{
              padding: '10px 20px', borderRadius: '6px', border: 'none',
              background: isDestructive ? '#c0392b' : '#3b82f6', 
              color: 'white', fontWeight: 'bold', cursor: 'pointer'
            }}
          >
            {isDestructive ? 'Borrar / Ejecutar' : 'Confirmar'}
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/features/crm/pages/AdminCalendarPage.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';

// --- ESTILOS ---
const containerStyle = { padding: '20px', color: '#e0e0e0', height: '100vh', display: 'flex', flexDirection: 'column' as const };
const headerStyle = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', background: '#1e1e1e', padding: '15px', borderRadius: '12px', border: '1px solid #333' };
const controlsStyle = { display: 'flex', gap: '15px', alignItems: 'center' };
const inputStyle = { background: '#252525', border: '1px solid #444', color: 'white', padding: '8px 12px', borderRadius: '6px', outline: 'none' };
const btnStyle = { background: '#333', color: 'white', border: '1px solid #555', padding: '8px 12px', borderRadius: '6px', cursor: 'pointer' };

// Estilos Grilla Calendario
const calendarGridStyle = { 
    display: 'grid', 
    gridTemplateColumns: 'repeat(7, 1fr)', 
    gap: '1px', 
    background: '#333', // Color de las l√≠neas
    border: '1px solid #333',
    borderRadius: '8px',
    overflow: 'hidden',
    flex: 1
};
const dayHeaderStyle = { background: '#2a2a2a', padding: '10px', textAlign: 'center' as const, fontWeight: 'bold', color: '#888', textTransform: 'uppercase' as const, fontSize: '12px' };
const dayCellStyle = { background: '#121212', minHeight: '100px', padding: '5px', position: 'relative' as const };
const dayNumberStyle = { position: 'absolute' as const, top: '5px', right: '8px', color: '#444', fontWeight: 'bold' };
const eventStyle = (status: string) => {
    let bg = '#3498db'; // Azul por defecto (pedido)
    if (status === 'presupuestado') bg = '#8e44ad';
    if (status === 'fabricacion') bg = '#e67e22';
    if (status === 'entregado') bg = '#27ae60';
    if (status === 'retrasado') bg = '#c0392b';

    return {
        background: bg, color: 'white', padding: '4px 6px', borderRadius: '4px', marginBottom: '4px', 
        fontSize: '11px', cursor: 'pointer', whiteSpace: 'nowrap' as const, overflow: 'hidden', textOverflow: 'ellipsis',
        borderLeft: '3px solid rgba(0,0,0,0.2)'
    };
};

const WEEKDAYS = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];

export const AdminCalendarPage = () => {
  const navigate = useNavigate();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [orders, setOrders] = useState<any[]>([]);
  const [, setLoading] = useState(true);
  
  // Filtros
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<'all' | 'client' | 'ref'>('all');

  useEffect(() => { loadOrders(); }, []);

  const loadOrders = async () => {
    setLoading(true);
    // Traemos pedidos que no est√©n cancelados ni rechazados y que tengan fecha
    const { data } = await supabase
        .from('orders')
        .select('id, order_ref, custom_name, estimated_delivery_date, status, profiles(company_name, email, full_name)')
        .not('estimated_delivery_date', 'is', null)
        .neq('status', 'rechazado')
        .neq('status', 'cancelado');
    
    setOrders(data || []);
    setLoading(false);
  };

  // --- L√ìGICA DE CALENDARIO ---
  const getDaysInMonth = (date: Date) => {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      // Ajustar para que la semana empiece en Lunes (0 = Domingo en JS, lo convertimos)
      let startDay = firstDay.getDay() - 1; 
      if (startDay === -1) startDay = 6; // Si es domingo, ponerlo al final

      const days = [];
      // Rellenar huecos previos
      for (let i = 0; i < startDay; i++) { days.push(null); }
      // Rellenar d√≠as del mes
      for (let i = 1; i <= lastDay.getDate(); i++) { days.push(new Date(year, month, i)); }
      
      return days;
  };

  const changeMonth = (offset: number) => {
      const newDate = new Date(currentDate.setMonth(currentDate.getMonth() + offset));
      setCurrentDate(new Date(newDate));
  };

  // --- FILTRADO ---
  const filteredOrders = orders.filter(o => {
      const searchLower = searchTerm.toLowerCase();
      const matchesRef = o.order_ref.toLowerCase().includes(searchLower) || (o.custom_name && o.custom_name.toLowerCase().includes(searchLower));
      const clientName = o.profiles?.company_name || o.profiles?.full_name || o.profiles?.email || '';
      const matchesClient = clientName.toLowerCase().includes(searchLower);

      if (filterType === 'all') return matchesRef || matchesClient;
      if (filterType === 'client') return matchesClient;
      if (filterType === 'ref') return matchesRef;
      return true;
  });

  const getEventsForDay = (day: Date) => {
      return filteredOrders.filter(o => {
          const d = new Date(o.estimated_delivery_date);
          return d.getDate() === day.getDate() && d.getMonth() === day.getMonth() && d.getFullYear() === day.getFullYear();
      });
  };

  const calendarDays = getDaysInMonth(currentDate);

  return (
    <div style={containerStyle}>
        
        {/* CABECERA Y CONTROLES */}
        <div style={headerStyle}>
            <div style={{display:'flex', alignItems:'center', gap:'15px'}}>
                <button onClick={() => changeMonth(-1)} style={btnStyle}>‚óÄ</button>
                <h2 style={{margin:0, color:'white', width:'200px', textAlign:'center'}}>
                    {currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase()}
                </h2>
                <button onClick={() => changeMonth(1)} style={btnStyle}>‚ñ∂</button>
            </div>

            <div style={controlsStyle}>
                <select 
                    value={filterType} 
                    onChange={e => setFilterType(e.target.value as any)}
                    style={{...inputStyle, width:'120px', cursor:'pointer'}}
                >
                    <option value="all">üîç Todo</option>
                    <option value="client">üë§ Cliente</option>
                    <option value="ref">üì¶ Pedido/Ref</option>
                </select>
                <input 
                    type="text" 
                    placeholder="Buscar..." 
                    value={searchTerm}
                    onChange={e => setSearchTerm(e.target.value)}
                    style={{...inputStyle, width:'200px'}}
                />
                <button onClick={loadOrders} style={{...btnStyle, background:'#27ae60', border:'none'}}>üîÑ</button>
            </div>
        </div>

        {/* LEYENDA */}
        <div style={{display:'flex', gap:'15px', marginBottom:'10px', fontSize:'12px', color:'#888'}}>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#8e44ad', borderRadius:'2px'}}></span> Presupuestado (Fin Validez)</div>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#e67e22', borderRadius:'2px'}}></span> Fabricaci√≥n</div>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#3498db', borderRadius:'2px'}}></span> Pedido Confirmado</div>
            <div style={{display:'flex', alignItems:'center', gap:'5px'}}><span style={{width:10, height:10, background:'#27ae60', borderRadius:'2px'}}></span> Entregado</div>
        </div>

        {/* CALENDARIO */}
        <div style={calendarGridStyle}>
            {/* Cabeceras D√≠as */}
            {WEEKDAYS.map(d => <div key={d} style={dayHeaderStyle}>{d}</div>)}
            
            {/* Celdas */}
            {calendarDays.map((day, idx) => {
                if (!day) return <div key={`empty-${idx}`} style={{...dayCellStyle, background:'#1a1a1a'}}></div>;
                
                const events = getEventsForDay(day);
                const isToday = new Date().toDateString() === day.toDateString();

                return (
                    <div key={day.toISOString()} style={{...dayCellStyle, background: isToday ? '#1e251e' : '#121212', border: isToday ? '1px solid #27ae60' : 'none'}}>
                        <span style={{...dayNumberStyle, color: isToday ? '#27ae60' : '#444'}}>{day.getDate()}</span>
                        
                        <div style={{marginTop:'25px', display:'flex', flexDirection:'column', gap:'2px'}}>
                            {events.map(ev => (
                                <div 
                                    key={ev.id} 
                                    onClick={() => navigate(`/admin/order/${ev.id}`)}
                                    title={`Cliente: ${ev.profiles?.company_name || ev.profiles?.email}\nRef: ${ev.order_ref}`}
                                    style={eventStyle(ev.status)}
                                >
                                    <strong>{ev.order_ref}</strong>
                                    <div style={{fontSize:'9px', opacity:0.9}}>
                                        {ev.custom_name || ev.profiles?.company_name || 'Sin nombre'}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
  );
};
</file>

<file path="src/features/crm/pages/AdminClientDetailPage.tsx">
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';

const containerStyle = { padding: '20px', color: '#e0e0e0', fontFamily: 'sans-serif' };
const cardStyle = { background: '#1e1e1e', borderRadius: '12px', border: '1px solid #333', padding: '25px', marginBottom: '20px' };
const labelStyle = { display: 'block', color: '#aaa', marginBottom: '5px', fontSize: '13px' };
const inputStyle = { background: '#252525', border: '1px solid #444', color: 'white', padding: '10px', borderRadius: '6px', width: '100%', marginBottom: '15px' };
const sectionTitleStyle = { borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', color: 'white' };

export const AdminClientDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [profile, setProfile] = useState<any>(null);
  const [clientOrders, setClientOrders] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => { loadClientData(); }, [id]);

  const loadClientData = async () => {
    if (!id) return;
    setLoading(true);

    // 1. Cargar Perfil
    const { data: p } = await supabase.from('profiles').select('*').eq('id', id).single();
    if (p) setProfile(p);

    // 2. Cargar Historial de Pedidos
    const { data: o } = await supabase.from('orders')
        .select('*, projects(name)')
        .eq('user_id', id)
        .order('created_at', { ascending: false });
    setClientOrders(o || []);
    
    setLoading(false);
  };

  const handleSave = async () => {
    // IMPORTANTE: Convertimos descuento a n√∫mero para evitar error al guardar
    const discountValue = parseFloat(profile.discount_rate) || 0;

    const { error } = await supabase.from('profiles').update({
        company_name: profile.company_name,
        full_name: profile.full_name,
        email: profile.email, // A√±adido campo email al guardado
        phone: profile.phone,
        cif: profile.cif,
        shipping_address: profile.shipping_address,
        billing_address: profile.billing_address,
        discount_rate: discountValue
    }).eq('id', id);

    if (error) alert("Error al guardar: " + error.message);
    else alert("‚úÖ Cliente actualizado correctamente");
  };

  if (loading) return <p>Cargando ficha...</p>;
  if (!profile) return <p>Cliente no encontrado.</p>;

  return (
    <div style={containerStyle}>
      <div style={{display:'flex', justifyContent:'space-between', marginBottom:'20px'}}>
        <button onClick={() => navigate('/admin/crm')} style={{ background: 'none', border: 'none', color: '#888', cursor: 'pointer' }}>‚Üê Volver al Listado</button>
        <h2 style={{margin:0, color:'white'}}>Ficha Cliente: <span style={{color:'#3b82f6'}}>{profile.email}</span></h2>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px' }}>
        
        {/* COLUMNA IZQUIERDA: DATOS EDITABLES */}
        <div>
            <div style={cardStyle}>
                <h3 style={sectionTitleStyle}>üè¢ Datos de Empresa & Facturaci√≥n</h3>
                
                {/* ZONA DESCUENTO - DESTACADA */}
                <div style={{background: 'rgba(230, 126, 34, 0.1)', padding:'15px', borderRadius:'8px', border:'1px solid #e67e22', marginBottom:'20px'}}>
                    <label style={{...labelStyle, color:'#e67e22', fontWeight:'bold'}}>Descuento Comercial Fijo (%)</label>
                    <input 
                        type="number" 
                        value={profile.discount_rate || 0} 
                        onChange={e => setProfile({...profile, discount_rate: e.target.value})}
                        style={{...inputStyle, border:'1px solid #e67e22', fontSize:'18px', fontWeight:'bold', width:'100px', marginBottom:0}}
                    />
                    <small style={{color:'#888', display:'block', marginTop:'5px'}}>Este descuento se aplicar√° autom√°ticamente al calcular presupuestos.</small>
                </div>

                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px'}}>
                    <div>
                        <label style={labelStyle}>Nombre Empresa</label>
                        <input type="text" value={profile.company_name || ''} onChange={e => setProfile({...profile, company_name: e.target.value})} style={inputStyle} />
                    </div>
                    <div>
                        <label style={labelStyle}>CIF / NIF</label>
                        <input type="text" value={profile.cif || ''} onChange={e => setProfile({...profile, cif: e.target.value})} style={inputStyle} />
                    </div>
                </div>

                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px'}}>
                    <div>
                        <label style={labelStyle}>Persona de Contacto</label>
                        <input type="text" value={profile.full_name || ''} onChange={e => setProfile({...profile, full_name: e.target.value})} style={inputStyle} />
                    </div>
                    <div>
                        <label style={labelStyle}>Tel√©fono</label>
                        <input type="text" value={profile.phone || ''} onChange={e => setProfile({...profile, phone: e.target.value})} style={inputStyle} />
                    </div>
                </div>

                {/* NUEVO CAMPO EMAIL */}
                <label style={labelStyle}>Email Principal (CRM)</label>
                <input 
                    type="email" 
                    value={profile.email || ''} 
                    onChange={e => setProfile({...profile, email: e.target.value})} 
                    style={inputStyle} 
                />

                <label style={labelStyle}>Direcci√≥n de Facturaci√≥n</label>
                <textarea rows={3} value={profile.billing_address || ''} onChange={e => setProfile({...profile, billing_address: e.target.value})} style={{...inputStyle, resize:'none'}} />

                <label style={labelStyle}>Direcci√≥n de Env√≠o</label>
                <textarea rows={3} value={profile.shipping_address || ''} onChange={e => setProfile({...profile, shipping_address: e.target.value})} style={{...inputStyle, resize:'none'}} />

                <div style={{textAlign:'right', marginTop:'10px'}}>
                    <button onClick={handleSave} style={{background:'#27ae60', color:'white', border:'none', padding:'12px 30px', borderRadius:'6px', cursor:'pointer', fontWeight:'bold', fontSize:'16px'}}>
                        üíæ Guardar Cambios
                    </button>
                </div>
            </div>
        </div>

        {/* COLUMNA DERECHA: HISTORIAL */}
        <div>
            <div style={cardStyle}>
                <h3 style={sectionTitleStyle}>üì¶ Historial de Pedidos ({clientOrders.length})</h3>
                <div style={{display:'flex', flexDirection:'column', gap:'10px', maxHeight:'600px', overflowY:'auto'}}>
                    {clientOrders.length === 0 && <p style={{color:'#666'}}>Sin pedidos.</p>}
                    {clientOrders.map(order => (
                        <div key={order.id} style={{background:'#252525', padding:'10px', borderRadius:'6px', border:'1px solid #333'}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                                <span style={{color:'white', fontWeight:'bold'}}>{order.order_ref}</span>
                                <span style={{fontSize:'12px', color:'#aaa'}}>{new Date(order.created_at).toLocaleDateString()}</span>
                            </div>
                            <div style={{fontSize:'13px', color:'#888', marginBottom:'5px'}}>{order.projects?.name}</div>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span style={{
                                    fontSize:'10px', padding:'2px 6px', borderRadius:'4px',
                                    background: order.status === 'pedido' ? '#3498db' : '#444', color:'white'
                                }}>
                                    {order.status.toUpperCase()}
                                </span>
                                <button onClick={() => navigate(`/admin/order/${order.id}`)} style={{background:'none', border:'none', color:'#3b82f6', cursor:'pointer', fontSize:'12px'}}>Ver ‚Üó</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

      </div>
    </div>
  );
};
</file>

<file path="src/features/crm/pages/AdminOrderDetailPage.tsx">
import { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';
import { PriceCalculator, PRICES } from '../../../utils/PriceCalculator';
import { generateBillOfMaterials } from '../../../utils/budgetUtils';
import { generateBudgetPDF } from '../../../utils/pdfGenerator'; // <--- IMPORTANTE

const CATALOG_ITEMS = [
    { id: 'bench_01', name: 'Banco Cl√°sico', type: 'model', price: 150 },
    { id: 'swing_01', name: 'Columpio Doble', type: 'model', price: 1200 },
    { id: 'slide_01', name: 'Tobog√°n Espiral', type: 'model', price: 2500 },
    { id: 'fence_wood', name: 'Valla de Madera', type: 'fence', price: PRICES.FENCE_M },
    { id: 'floor_rubber', name: 'Suelo de Caucho', type: 'floor', price: PRICES.FLOOR_M2 },
];

const containerStyle = { display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', height: '100%', color: '#e0e0e0', fontFamily: 'sans-serif' };
const cardStyle = { background: '#1e1e1e', borderRadius: '12px', border: '1px solid #333', padding: '20px', display: 'flex', flexDirection: 'column' as const, marginBottom: '20px' };
const inputStyle = { background: '#252525', border: '1px solid #444', color: 'white', padding: '10px', borderRadius: '6px', width: '100%', marginBottom: '15px' };
const labelStyle = { display: 'block', color: '#aaa', marginBottom: '5px', fontSize: '13px' };

const formatMoney = (amount: number) => {
    return amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
};

export const AdminOrderDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [order, setOrder] = useState<any>(null);
  
  // Items
  const [items3D, setItems3D] = useState<any[]>([]); 
  const [manualItems, setManualItems] = useState<any[]>([]); 
  const [calculatedBasePrice, setCalculatedBasePrice] = useState(0); 

  // Chat y Datos
  const [messages, setMessages] = useState<any[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [newDate, setNewDate] = useState(''); 
  
  // OBSERVACIONES
  const [observations, setObservations] = useState<any[]>([]);
  const [newObservation, setNewObservation] = useState('');

  // Archivos
  const [attachments, setAttachments] = useState<any[]>([]);
  const [uploading, setUploading] = useState(false);
  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false); // Estado visual para el PDF

  // UI
  const [isCatalogOpen, setIsCatalogOpen] = useState(false);
  const [parametricModal, setParametricModal] = useState<{isOpen: boolean, item: any | null, value: string}>({ isOpen: false, item: null, value: '' });

  const chatEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => { loadData(); }, [id]);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const loadData = async () => {
    if (!id) return;
    
    // 1. Cargar Pedido
    const { data: o } = await supabase
        .from('orders')
        .select('*, projects(*), profiles(*)') 
        .eq('id', id)
        .single();
    
    if (o) {
        setOrder(o);
        if (o.estimated_delivery_date) {
            setNewDate(new Date(o.estimated_delivery_date).toISOString().slice(0, 16));
        } else {
            setNewDate('');
        }
        
        // 1.1 Procesar Items 3D
        let total3D = 0;
        let processed3DItems: any[] = [];
        const raw3DItems = o.projects?.data?.items || o.projects?.items || [];

        if (raw3DItems.length > 0) {
            const itemsWithRealPrices = raw3DItems.map((item: any) => ({
                ...item,
                price: PriceCalculator.getItemPrice(item) 
            }));
            processed3DItems = generateBillOfMaterials(itemsWithRealPrices);
            total3D = processed3DItems.reduce((acc, line) => acc + line.totalPrice, 0);
        }
        setItems3D(processed3DItems);

        // 1.2 Cargar Items Manuales
        const { data: mItems } = await supabase.from('order_items').select('*').eq('order_id', id);
        const manual = mItems || [];
        setManualItems(manual);

        // 1.3 Calcular Total Base Real
        const totalManual = manual.reduce((acc: number, item: any) => acc + item.total_price, 0);
        setCalculatedBasePrice(total3D + totalManual);
    }

    // 2. Chat
    const { data: m } = await supabase.from('order_messages').select('*, profiles(full_name, role)').eq('order_id', id).order('created_at', { ascending: true });
    setMessages(m || []);

    // 3. Adjuntos
    const { data: att } = await supabase.from('order_attachments').select('*').eq('order_id', id);
    setAttachments(att || []);

    // 4. Observaciones
    const { data: obs } = await supabase
        .from('order_observations')
        .select('*, profiles(full_name, role)')
        .eq('order_id', id)
        .order('created_at', { ascending: false });
    setObservations(obs || []);
  };

  // --- ACTUALIZAR PEDIDO Y GENERAR PDF ---
  const handleUpdateOrder = async () => {
    if (!order) return;
    setIsGeneratingPDF(true); // Bloquear bot√≥n visualmente

    try {
        const dateToSave = newDate ? new Date(newDate).toISOString() : null;

        // 1. Guardar cambios en la Base de Datos
        const { error } = await supabase.from('orders').update({
            status: order.status,
            custom_name: order.custom_name, 
            estimated_delivery_date: dateToSave,
            total_price: order.total_price 
        }).eq('id', id);

        if (error) throw error;

        // 2. Si el estado es "presupuestado", generar PDF autom√°tico
        if (order.status === 'presupuestado') {
            // Generar Blob del PDF
            const pdfBlob = await generateBudgetPDF(order, items3D, manualItems);
            
            // Nombre del archivo: Presupuesto_REF_FECHA.pdf
            const fileName = `Presupuesto_${order.order_ref}_${Date.now()}.pdf`;
            const filePath = `${id}/${fileName}`;

            // Subir a Supabase Storage
            const { error: uploadError } = await supabase.storage.from('attachments').upload(filePath, pdfBlob);
            if (uploadError) throw uploadError;

            // Obtener URL P√∫blica
            const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filePath);

            // Guardar registro en la tabla de adjuntos
            const { data: { user } } = await supabase.auth.getUser();
            const { error: dbError } = await supabase.from('order_attachments').insert([{
                order_id: id,
                file_name: `üìÑ ${fileName}`, // Icono para distinguir
                file_url: publicUrl,
                uploader_id: user?.id
            }]);

            if (dbError) throw dbError;
            
            alert("‚úÖ Cambios guardados y PDF de Presupuesto generado y enviado al cliente.");
        } else {
            alert("‚úÖ Pedido actualizado correctamente.");
        }

        loadData(); // Recargar para ver el PDF en la lista
    } catch (error: any) {
        alert("Error: " + error.message);
    } finally {
        setIsGeneratingPDF(false);
    }
  };

  const handleStatusChangeRaw = (e: React.ChangeEvent<HTMLSelectElement>) => {
      const status = e.target.value;
      const now = new Date();
      let calculatedDateStr = newDate;

      if (status === 'presupuestado') {
          const d = new Date(now.getTime() + (48 * 60 * 60 * 1000));
          d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
          calculatedDateStr = d.toISOString().slice(0, 16);
      } 
      else if (status === 'pedido') {
          const d = new Date(now.getTime() + (42 * 24 * 60 * 60 * 1000));
          d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
          calculatedDateStr = d.toISOString().slice(0, 16);
      }

      setNewDate(calculatedDateStr);
      setOrder({...order, status: status});
  };

  const applyClientDiscount = () => {
      const discount = order.profiles?.discount_rate || 0;
      const discountAmount = calculatedBasePrice * (discount / 100);
      const finalPrice = calculatedBasePrice - discountAmount;
      if(confirm(`Base: ${formatMoney(calculatedBasePrice)}\nDto (${discount}%): -${formatMoney(discountAmount)}\n\nTotal: ${formatMoney(finalPrice)}`)) {
          setOrder({ ...order, total_price: finalPrice }); 
      }
  };

  const copyBasePrice = () => {
      setOrder({ ...order, total_price: calculatedBasePrice });
  };

  // --- OBSERVACIONES ---
  const handleAddObservation = async () => {
    if(!newObservation.trim()) return;
    const { data: { user } } = await supabase.auth.getUser();
    const { error } = await supabase.from('order_observations').insert([{
        order_id: id, user_id: user?.id, content: newObservation
    }]);
    if(error) alert("Error: " + error.message);
    else { setNewObservation(''); loadData(); }
  };

  // --- ITEMS MANUALES ---
  const handleAddItem = (item: any) => {
      if (item.type === 'fence' || item.type === 'floor') setParametricModal({ isOpen: true, item: item, value: '' });
      else saveManualItem(item.id, item.name, 1, item.price, '1 ud');
  };

  const confirmParametricItem = () => {
      const val = parseFloat(parametricModal.value);
      if (!val || val <= 0) return alert("Valor inv√°lido");
      const item = parametricModal.item;
      let price = 0;
      let dimensions = '';
      if (item.type === 'fence') { price = val * PRICES.FENCE_M; dimensions = `${val} ml`; } 
      else { price = val * PRICES.FLOOR_M2; dimensions = `${val} m¬≤`; }
      saveManualItem(item.id, item.name, 1, price, dimensions);
      setParametricModal({ isOpen: false, item: null, value: '' });
  };

  const saveManualItem = async (prodId: string, name: string, qty: number, total: number, dims: string) => {
      await supabase.from('order_items').insert([{
          order_id: id, product_id: prodId, name: name, quantity: qty, total_price: total, dimensions: dims
      }]);
      setIsCatalogOpen(false);
      loadData(); 
  };

  const handleDeleteManualItem = async (itemId: string) => {
      if(!confirm("¬øBorrar l√≠nea?")) return;
      await supabase.from('order_items').delete().eq('id', itemId);
      loadData();
  };

  // --- CHAT & FILES ---
  const handleSendMessage = async () => {
    if (!newMessage.trim()) return;
    const { data: { user } } = await supabase.auth.getUser();
    await supabase.from('order_messages').insert([{ order_id: id, user_id: user?.id, content: newMessage }]);
    setNewMessage(''); loadData();
  };

  const handleFileUpload = async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;
      setUploading(true);
      try {
          const fileExt = file.name.split('.').pop();
          const fileName = `${Math.random()}.${fileExt}`;
          const filePath = `${id}/${fileName}`;
          await supabase.storage.from('attachments').upload(filePath, file);
          const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filePath);
          await supabase.from('order_attachments').insert([{
              order_id: id, file_name: file.name, file_url: publicUrl, uploader_id: (await supabase.auth.getUser()).data.user?.id
          }]);
          loadData();
      } catch (error: any) { alert('Error: ' + error.message); } 
      finally { setUploading(false); }
  };

  const handleDeleteAttachment = async (attId: string) => {
      if(!confirm("¬øBorrar archivo?")) return;
      await supabase.from('order_attachments').delete().eq('id', attId);
      loadData();
  };

  if (!order) return <p>Cargando...</p>;
  const isMyMessage = (role: string) => role === 'admin' || role === 'employee';

  return (
    <div style={{ padding: '20px', height: '100vh', display:'flex', flexDirection:'column' }}>
      <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px'}}>
        <button onClick={() => navigate('/admin/crm')} style={{ background: 'none', border: 'none', color: '#888', cursor: 'pointer' }}>‚Üê Volver al Panel</button>
        <h2 style={{margin:0, color:'white'}}>Pedido Ref: <span style={{color:'#3b82f6'}}>{order.order_ref}</span></h2>
      </div>
      
      <div style={containerStyle}>
        
        {/* COLUMNA IZQUIERDA */}
        <div style={{ display:'flex', flexDirection:'column', gap:'10px', overflowY:'auto' }}>
            
            {/* ESTADO Y DATOS PRINCIPALES */}
            <div style={cardStyle}>
                <h3 style={{margin:'0 0 15px 0', borderBottom:'1px solid #333', paddingBottom:'10px', color:'white'}}>‚öôÔ∏è Control y Datos</h3>
                
                <div style={{marginBottom:'15px'}}>
                     <label style={labelStyle}>Nombre del Proyecto (Editable)</label>
                     <input 
                        type="text" 
                        value={order.custom_name || ''} 
                        onChange={e => setOrder({...order, custom_name: e.target.value})}
                        placeholder="Ej: Parque Ayuntamiento Norte"
                        style={{...inputStyle, border:'1px solid #3b82f6'}}
                     />
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div>
                        <label style={labelStyle}>Estado</label>
                        <select value={order.status} onChange={handleStatusChangeRaw} style={inputStyle}>
                            <option value="pendiente">üü† Pendiente</option>
                            <option value="presupuestado">üü£ Presupuestado (Auto: +48h)</option>
                            <option value="pedido">üîµ Pedido Aceptado (Auto: +6sem)</option>
                            <option value="fabricacion">üü† En Fabricaci√≥n</option>
                            <option value="entregado">üü¢ Entregado</option>
                            <option value="rechazado">üî¥ Rechazado</option>
                            <option value="cancelado">‚ö´ Cancelado</option>
                        </select>
                    </div>
                    <div>
                        <label style={labelStyle}>Fecha Entrega Estimada</label>
                        <input type="datetime-local" value={newDate} onChange={(e) => setNewDate(e.target.value)} style={inputStyle} />
                    </div>
                </div>

                {/* --- SECCI√ìN PRECIOS --- */}
                <div style={{background:'rgba(59, 130, 246, 0.1)', padding:'15px', borderRadius:'8px', border:'1px solid rgba(59, 130, 246, 0.3)'}}>
                    
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px', borderBottom:'1px solid rgba(255,255,255,0.1)', paddingBottom:'10px'}}>
                        <span style={{color:'#aaa', fontSize:'13px'}}>Total Tarifa (Suma Items):</span>
                        <span style={{fontSize:'16px', fontWeight:'bold', color:'white'}}>{formatMoney(calculatedBasePrice)}</span>
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'1fr auto auto', gap:'10px', alignItems:'end'}}>
                        <div>
                            <label style={{...labelStyle, color:'#3b82f6', fontWeight:'bold'}}>Precio Final Oferta (‚Ç¨)</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                value={order.total_price} 
                                onChange={(e) => setOrder({...order, total_price: parseFloat(e.target.value)})} 
                                style={{...inputStyle, marginBottom:0, fontSize:'16px', fontWeight:'bold'}} 
                            />
                        </div>
                        <button 
                            onClick={applyClientDiscount} 
                            title={`Aplicar Descuento Cliente (${order.profiles?.discount_rate || 0}%)`}
                            style={{background:'#e67e22', color:'white', border:'none', borderRadius:'6px', padding:'0 15px', height:'42px', cursor:'pointer', fontWeight:'bold'}}
                        >
                            % Dto
                        </button>
                        <button 
                            onClick={copyBasePrice} 
                            title="Copiar precio base a precio oferta"
                            style={{background:'#333', color:'white', border:'1px solid #555', borderRadius:'6px', padding:'0 15px', height:'42px', cursor:'pointer'}}
                        >
                            Igualar ‚¨á
                        </button>
                    </div>
                </div>
                
                <div style={{marginTop:'20px', display:'flex', justifyContent:'flex-end'}}>
                     <button 
                        onClick={handleUpdateOrder} 
                        disabled={isGeneratingPDF}
                        style={{background:'#27ae60', color:'white', padding:'12px 30px', border:'none', borderRadius:'6px', cursor: isGeneratingPDF ? 'wait' : 'pointer', fontWeight:'bold', fontSize:'14px', opacity: isGeneratingPDF ? 0.7 : 1}}
                    >
                        {isGeneratingPDF ? 'Guardando y Generando PDF...' : 'üíæ Guardar Cambios'}
                    </button>
                </div>
            </div>

            {/* OBSERVACIONES */}
            <div style={{...cardStyle, borderLeft:'4px solid #e67e22'}}>
                <h4 style={{margin:'0 0 15px 0', color:'#e67e22'}}>üìù Historial de Observaciones</h4>
                <div style={{maxHeight:'200px', overflowY:'auto', marginBottom:'15px', display:'flex', flexDirection:'column', gap:'10px'}}>
                    {observations.length === 0 && <p style={{color:'#666', fontStyle:'italic', fontSize:'13px'}}>No hay observaciones registradas.</p>}
                    {observations.map(obs => (
                        <div key={obs.id} style={{background:'#252525', padding:'10px', borderRadius:'6px', borderLeft:`3px solid ${obs.profiles?.role === 'admin' ? '#e67e22' : '#3b82f6'}`}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'4px'}}>
                                <span style={{fontWeight:'bold', fontSize:'12px', color:'white'}}>
                                    {obs.profiles?.role === 'admin' ? 'üè¢ T√∫ (Admin)' : 'üë§ Cliente'}
                                </span>
                                <span style={{fontSize:'11px', color:'#888'}}>{new Date(obs.created_at).toLocaleString()}</span>
                            </div>
                            <p style={{margin:0, fontSize:'13px', color:'#ddd', whiteSpace:'pre-wrap'}}>{obs.content}</p>
                        </div>
                    ))}
                </div>
                <div style={{display:'flex', gap:'10px'}}>
                    <input type="text" value={newObservation} onChange={e => setNewObservation(e.target.value)} placeholder="A√±adir nota interna o mensaje..." style={{flex:1, padding:'8px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} />
                    <button onClick={handleAddObservation} style={{background:'#e67e22', color:'white', border:'none', padding:'0 15px', borderRadius:'6px', cursor:'pointer'}}>A√±adir</button>
                </div>
            </div>

            {/* DESGLOSE DE MATERIALES */}
            <div style={cardStyle}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'15px'}}>
                    <h3 style={{margin:0, color:'white'}}>üìã Desglose Materiales</h3>
                    <div style={{display:'flex', gap:'10px'}}>
                        <button onClick={() => setIsCatalogOpen(true)} style={{padding:'5px 15px', background:'#27ae60', color:'white', border:'none', borderRadius:'4px', cursor:'pointer', fontWeight:'bold'}}>+ A√±adir Item</button>
                        <button onClick={() => {if(order.project_id) window.location.href=`/?project_id=${order.project_id}&mode=readonly`}} style={{padding:'5px 10px', background:'#333', color:'white', border:'1px solid #555', borderRadius:'4px', cursor:'pointer'}}>Ver 3D ‚Üó</button>
                    </div>
                </div>

                <div style={{background:'#252525', borderRadius:'8px', overflow:'hidden'}}>
                    <table style={{width:'100%', borderCollapse:'collapse', fontSize:'13px'}}>
                        <thead style={{background:'#333', color:'#aaa'}}>
                            <tr>
                                <th style={{padding:'8px', textAlign:'left'}}>√çtem</th>
                                <th style={{padding:'8px', textAlign:'center'}}>Origen</th>
                                <th style={{padding:'8px', textAlign:'right'}}>Precio</th>
                                <th style={{padding:'8px'}}></th>
                            </tr>
                        </thead>
                        <tbody>
                            {items3D.map((line, idx) => (
                                <tr key={`3d-${idx}`} style={{borderBottom:'1px solid #333'}}>
                                    <td style={{padding:'8px', color:'white'}}>
                                        {line.name} <span style={{color:'#666', fontSize:'10px'}}>x{line.quantity}</span>
                                    </td>
                                    <td style={{padding:'8px', textAlign:'center', color:'#888', fontSize:'11px'}}>DISE√ëO 3D</td>
                                    <td style={{padding:'8px', textAlign:'right', color:'#ccc'}}>{formatMoney(line.totalPrice)}</td>
                                    <td style={{textAlign:'right', padding:'8px'}}><small style={{color:'#666'}}>Auto</small></td>
                                </tr>
                            ))}
                            {manualItems.map((item) => (
                                <tr key={item.id} style={{borderBottom:'1px solid #333', background:'rgba(59, 130, 246, 0.1)'}}>
                                    <td style={{padding:'8px', color:'white'}}>
                                        {item.name} <span style={{color:'#888', fontSize:'11px'}}>({item.dimensions})</span>
                                    </td>
                                    <td style={{padding:'8px', textAlign:'center', color:'#3b82f6', fontSize:'11px'}}>EXTRA MANUAL</td>
                                    <td style={{padding:'8px', textAlign:'right', color:'white', fontWeight:'bold'}}>{formatMoney(item.total_price)}</td>
                                    <td style={{textAlign:'right', padding:'8px'}}>
                                        <button onClick={() => handleDeleteManualItem(item.id)} style={{color:'#e74c3c', background:'none', border:'none', cursor:'pointer'}}>üóëÔ∏è</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot style={{background:'#2a2a2a', fontWeight:'bold'}}>
                             <tr>
                                <td colSpan={2} style={{padding:'10px', textAlign:'right', color:'#aaa'}}>SUMA TOTAL</td>
                                <td style={{padding:'10px', textAlign:'right', color:'white'}}>{formatMoney(calculatedBasePrice)}</td>
                                <td></td>
                             </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            {/* ARCHIVOS */}
            <div style={cardStyle}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
                    <h3 style={{margin:0, color:'white'}}>üìé Archivos Adjuntos</h3>
                    <label style={{background:'#3b82f6', color:'white', padding:'5px 10px', borderRadius:'4px', cursor:'pointer', fontSize:'12px'}}>
                        {uploading ? 'Subiendo...' : '+ Subir Archivo'}
                        <input type="file" onChange={handleFileUpload} style={{display:'none'}} disabled={uploading} />
                    </label>
                </div>
                {attachments.length === 0 ? <p style={{color:'#666', fontSize:'13px'}}>No hay archivos.</p> : (
                    <ul style={{listStyle:'none', padding:0, margin:0}}>
                        {attachments.map(att => (
                            <li key={att.id} style={{display:'flex', justifyContent:'space-between', background:'#252525', padding:'8px', marginBottom:'5px', borderRadius:'4px'}}>
                                <a href={att.file_url} target="_blank" rel="noreferrer" style={{color:'#3b82f6', textDecoration:'none', fontSize:'13px'}}>{att.file_name}</a>
                                <button onClick={() => handleDeleteAttachment(att.id)} style={{border:'none', background:'none', color:'#e74c3c', cursor:'pointer'}}>üóëÔ∏è</button>
                            </li>
                        ))}
                    </ul>
                )}
            </div>
        </div>

        {/* COLUMNA DERECHA: CHAT */}
        <div style={{...cardStyle, maxHeight:'90vh', marginBottom:0}}>
            <h3 style={{color:'white', borderBottom:'1px solid #333', paddingBottom:'10px'}}>üí¨ Chat</h3>
            <div style={{flex:1, overflowY:'auto', display:'flex', flexDirection:'column', gap:'15px'}}>
                {messages.map(msg => {
                    const amITheSender = isMyMessage(msg.profiles?.role);
                    return (
                        <div key={msg.id} style={{alignSelf: amITheSender ? 'flex-end' : 'flex-start', maxWidth: '85%', background: amITheSender ? '#3b82f6' : '#444', color: 'white', padding: '10px', borderRadius: '8px'}}>
                            {msg.content}
                        </div>
                    );
                })}
                <div ref={chatEndRef} />
            </div>
            <div style={{marginTop:'15px', display:'flex', gap:'10px'}}>
                <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value)} onKeyDown={e => e.key==='Enter' && handleSendMessage()} style={{flex:1, padding:'10px', borderRadius:'6px', border:'none'}} placeholder="Responder..." />
                <button onClick={handleSendMessage} style={{background:'#3b82f6', color:'white', border:'none', padding:'0 15px', borderRadius:'6px'}}>‚û§</button>
            </div>
        </div>

      </div>
      {/* ... MODALES ... */}
       {isCatalogOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:999}}>
              <div style={{background:'#1e1e1e', width:'600px', maxHeight:'80vh', borderRadius:'12px', border:'1px solid #444', display:'flex', flexDirection:'column'}}>
                  <div style={{padding:'20px', borderBottom:'1px solid #333', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                      <h3 style={{margin:0, color:'white'}}>A√±adir Extra</h3>
                      <button onClick={() => setIsCatalogOpen(false)} style={{background:'none', border:'none', color:'#888', fontSize:'20px'}}>‚úï</button>
                  </div>
                  <div style={{padding:'20px', overflowY:'auto', display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                      {CATALOG_ITEMS.map(item => (
                          <div key={item.id} onClick={() => handleAddItem(item)} style={{background:'#252525', padding:'15px', borderRadius:'8px', cursor:'pointer', border:'1px solid #333'}}>
                              <div style={{fontWeight:'bold', color:'white'}}>{item.name}</div>
                              <div style={{color:'#888', fontSize:'12px'}}>{item.type === 'model' ? `${item.price} ‚Ç¨` : 'Param√©trico'}</div>
                          </div>
                      ))}
                  </div>
              </div>
          </div>
      )}
      {parametricModal.isOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:1000}}>
              <div style={{background:'#1e1e1e', padding:'30px', borderRadius:'12px', width:'350px', border:'1px solid #444'}}>
                  <h3 style={{margin:'0 0 15px 0', color:'white'}}>{parametricModal.item?.name}</h3>
                  <input type="number" autoFocus value={parametricModal.value} onChange={e => setParametricModal({...parametricModal, value: e.target.value})} placeholder="Cantidad" style={{width:'100%', padding:'10px', marginBottom:'20px'}}/>
                  <div style={{display:'flex', gap:'10px', justifyContent:'flex-end'}}>
                      <button onClick={() => setParametricModal({isOpen:false, item:null, value:''})}>Cancelar</button>
                      <button onClick={confirmParametricItem}>A√±adir</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/BudgetDetailPage.tsx">
import { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';
import { ConfirmModal } from '../../../components/ui/ConfirmModal';
import { PriceCalculator, PRICES } from '../../../utils/PriceCalculator';
import type { Order } from '../../../types/types';

const CATALOG_ITEMS = [
    { id: 'bench_01', name: 'Banco Cl√°sico', type: 'model', price: 150 },
    { id: 'swing_01', name: 'Columpio Doble', type: 'model', price: 1200 },
    { id: 'slide_01', name: 'Tobog√°n Espiral', type: 'model', price: 2500 },
    { id: 'fence_wood', name: 'Valla de Madera', type: 'fence', price: PRICES.FENCE_M },
    { id: 'floor_rubber', name: 'Suelo de Caucho', type: 'floor', price: PRICES.FLOOR_M2 },
];

const containerStyle = { display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', height: '100%' };
const cardStyle = { background: '#1e1e1e', borderRadius: '12px', border: '1px solid #333', padding: '20px', display: 'flex', flexDirection: 'column' as const, marginBottom: '20px' };
const sectionHeaderStyle = { color: 'white', marginTop: 0, borderBottom: '1px solid #333', paddingBottom: '10px', display:'flex', justifyContent:'space-between', alignItems:'center' };

const formatMoney = (amount: number) => amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';

const getStatusBadge = (status: string) => {
    switch(status) {
        case 'pendiente': return { label: 'PENDIENTE DE REVISI√ìN', color: '#e67e22' }; 
        case 'presupuestado': return { label: 'PRESUPUESTADO', color: '#8e44ad' }; 
        case 'pedido': return { label: 'PEDIDO CONFIRMADO', color: '#27ae60' }; 
        case 'fabricacion': return { label: 'EN FABRICACI√ìN', color: '#d35400' }; 
        case 'rechazado': return { label: 'RECHAZADO', color: '#c0392b' }; 
        case 'cancelado': return { label: 'CANCELADO', color: '#7f8c8d' };
        default: return { label: status.toUpperCase(), color: '#95a5a6' };
    }
};

export const BudgetDetailPage = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  
  const [order, setOrder] = useState<Order | null>(null);
  const [items3D, setItems3D] = useState<any[]>([]);
  const [manualItems, setManualItems] = useState<any[]>([]);
  const [messages, setMessages] = useState<any[]>([]);
  
  // Nombres y Notas
  const [customName, setCustomName] = useState('');
  
  // OBSERVACIONES (Historial)
  const [observations, setObservations] = useState<any[]>([]);
  const [newObservation, setNewObservation] = useState('');
  
  // Archivos
  const [attachments, setAttachments] = useState<any[]>([]);
  const [uploading, setUploading] = useState(false);

  // UI
  const [loading, setLoading] = useState(true);
  const [isCatalogOpen, setIsCatalogOpen] = useState(false);
  const [newMessage, setNewMessage] = useState('');
  const chatEndRef = useRef<HTMLDivElement>(null);
  
  // Modals
  const [parametricModal, setParametricModal] = useState<{isOpen: boolean, item: any | null, value: string}>({ isOpen: false, item: null, value: '' });
  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDestructive: false });
  const closeModal = () => setModal({ ...modal, isOpen: false });

  useEffect(() => { loadOrderData(); }, [id]);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const loadOrderData = async () => {
    if (!id) return;
    setLoading(true);

    const { data: orderData } = await supabase.from('orders').select('*, projects(*), profiles(discount_rate)').eq('id', id).single();
    if (!orderData) { navigate('/portal'); return; }
    
    // Items 3D (Carga segura)
    let calculated3DItems: any[] = [];
    const raw3DItems = orderData.projects?.data?.items || orderData.projects?.items || [];
    
    if (raw3DItems.length > 0) {
        calculated3DItems = raw3DItems.map((item: any) => ({
            uuid: item.uuid,
            name: item.name || 'Elemento 3D',
            quantity: 1,
            info: PriceCalculator.getItemDimensions(item),
            price: PriceCalculator.getItemPrice(item),
            is3D: true
        }));
    }
    setItems3D(calculated3DItems);
    setOrder(orderData as any);
    
    // Cargar Nombre si existe
    if(orderData.custom_name) setCustomName(orderData.custom_name);

    // Items Manuales
    const { data: mItems } = await supabase.from('order_items').select('*').eq('order_id', id);
    setManualItems(mItems || []);

    // Chat
    const { data: chatData } = await supabase.from('order_messages').select('*, profiles(full_name, role)').eq('order_id', id).order('created_at', { ascending: true });
    setMessages(chatData || []);

    // Adjuntos
    const { data: att } = await supabase.from('order_attachments').select('*').eq('order_id', id);
    setAttachments(att || []);

    // Cargar Historial Observaciones
    const { data: obs } = await supabase
        .from('order_observations')
        .select('*, profiles(full_name, role)')
        .eq('order_id', id)
        .order('created_at', { ascending: false }); 
    setObservations(obs || []);

    setLoading(false);
  };

  const calculateTotal = () => {
      const total3D = items3D.reduce((acc, item) => acc + item.price, 0);
      const totalManual = manualItems.reduce((acc, item) => acc + item.total_price, 0);
      const subtotal = total3D + totalManual;
      const discountRate = (order as any)?.profiles?.discount_rate || 0;
      const discountAmount = subtotal * (discountRate / 100);
      return { subtotal, discountRate, discountAmount, final: subtotal - discountAmount };
  };
  const totals = calculateTotal();

  // --- ACCIONES DATOS ---
  const handleSaveName = async () => {
      // Guardado directo del nombre
      const { error } = await supabase.from('orders').update({ custom_name: customName }).eq('id', id);
      if(error) alert("Error: " + error.message);
      else alert("‚úÖ Nombre guardado");
  };

  const handleAddObservation = async () => {
      if(!newObservation.trim()) return;
      const { data: { user } } = await supabase.auth.getUser();
      
      const { error } = await supabase.from('order_observations').insert([{
          order_id: id,
          user_id: user?.id,
          content: newObservation
      }]);
      
      if(error) alert("Error: " + error.message);
      else {
          setNewObservation('');
          loadOrderData();
      }
  };

  // --- ACCIONES ITEMS ---
  const handleAddItem = (item: any) => {
      if (order?.status !== 'pendiente') return alert("Solo puedes a√±adir elementos si el presupuesto est√° pendiente.");
      
      if (item.type === 'fence' || item.type === 'floor') {
          setParametricModal({ isOpen: true, item: item, value: '' });
      } else {
          saveManualItem(item.id, item.name, 1, item.price, '1 ud');
      }
  };

  const confirmParametricItem = () => {
      const val = parseFloat(parametricModal.value);
      if (!val || val <= 0) return alert("Valor inv√°lido");
      const item = parametricModal.item;
      let price = 0;
      let dimensions = '';
      if (item.type === 'fence') { price = val * PRICES.FENCE_M; dimensions = `${val} ml`; } 
      else { price = val * PRICES.FLOOR_M2; dimensions = `${val} m¬≤`; }
      saveManualItem(item.id, item.name, 1, price, dimensions);
      setParametricModal({ isOpen: false, item: null, value: '' });
  };

  const saveManualItem = async (prodId: string, name: string, qty: number, total: number, dims: string) => {
      await supabase.from('order_items').insert([{
          order_id: id, product_id: prodId, name: name, quantity: qty, total_price: total, dimensions: dims
      }]);
      setIsCatalogOpen(false);
      loadOrderData(); 
  };

  const handleDeleteManualItem = async (itemId: string) => {
      if (order?.status !== 'pendiente') return alert("Solo editable en fase pendiente.");
      if(!confirm("¬øBorrar l√≠nea?")) return;
      await supabase.from('order_items').delete().eq('id', itemId);
      loadOrderData();
  };

  // --- ARCHIVOS ---
  const handleFileUpload = async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;
      setUploading(true);
      try {
          const fileExt = file.name.split('.').pop();
          const fileName = `${Math.random()}.${fileExt}`;
          const filePath = `${id}/${fileName}`;
          await supabase.storage.from('attachments').upload(filePath, file);
          const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filePath);
          await supabase.from('order_attachments').insert([{
              order_id: id, file_name: file.name, file_url: publicUrl, uploader_id: (await supabase.auth.getUser()).data.user?.id
          }]);
          loadOrderData();
      } catch (error: any) { alert('Error al subir: ' + error.message); } 
      finally { setUploading(false); }
  };

  const handleDeleteAttachment = async (attId: string) => {
      if(!confirm("¬øBorrar archivo?")) return;
      await supabase.from('order_attachments').delete().eq('id', attId);
      loadOrderData();
  };

  // --- ESTADOS Y BOTONES ---
  const handleStatusChange = (status: string) => {
      setModal({
          isOpen: true,
          title: status === 'pedido' ? 'Confirmar Pedido' : 'Rechazar Presupuesto',
          message: status === 'pedido' ? 'Al aceptar, el pedido pasar√° a fabricaci√≥n.' : 'El presupuesto pasar√° a archivados.',
          isDestructive: status === 'rechazado',
          onConfirm: async () => {
              const update: any = { status: status, total_price: totals.final };
              if (status === 'pedido') {
                  const d = new Date(); d.setDate(d.getDate() + 42); 
                  update.estimated_delivery_date = d.toISOString();
              }
              await supabase.from('orders').update(update).eq('id', id);
              if (status==='pedido') navigate('/portal?tab=orders');
              else navigate('/portal?tab=archived');
              closeModal();
          }
      });
  };

  const handleDelete = () => {
      setModal({
          isOpen: true, title: 'Borrar Solicitud', message: 'Se borrar√° la solicitud y el dise√±o. ¬øContinuar?', isDestructive: true,
          onConfirm: async () => {
              await supabase.from('orders').delete().eq('id', id);
              navigate('/portal?tab=orders');
              closeModal();
          }
      });
  };
  
  const handleCancelOrder = () => {
      setModal({
          isOpen: true, title: 'Cancelar Pedido', message: 'El pedido pasar√° a cancelado.', isDestructive: true,
          onConfirm: async () => {
              await supabase.from('orders').update({ status: 'cancelado', is_archived: true }).eq('id', id);
              navigate('/portal?tab=archived');
              closeModal();
          }
      });
  };

  const handleSendMessage = async () => {
    if (!newMessage.trim() || !id) return;
    const { data: { user } } = await supabase.auth.getUser();
    await supabase.from('order_messages').insert([{ order_id: id, user_id: user?.id, content: newMessage }]);
    setNewMessage(''); loadOrderData();
  };

  if (loading) return <p style={{color:'#888', padding:'20px'}}>Cargando...</p>;
  if (!order) return <p>Error.</p>;

  const badge = getStatusBadge(order.status);
  const isPending = order.status === 'pendiente'; 
  const isDecisionTime = order.status === 'presupuestado';
  const isOrderConfirmed = order.status === 'pedido'; 
  const isLocked = !isPending && !isOrderConfirmed && order.status !== 'presupuestado';

  return (
    <div className="budget-detail-container">
      <ConfirmModal {...modal} onCancel={closeModal} />

      <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px', flexWrap:'wrap', gap:'10px'}}>
        <button onClick={() => navigate(-1)} style={{background:'none', border:'none', color:'#888', cursor:'pointer'}}>‚Üê Volver</button>
        <div style={{display:'flex', gap:'10px', alignItems:'center'}}>
             {isLocked && <span style={{color:'#888', fontSize:'12px', marginRight:'10px'}}>‚ö†Ô∏è Cambios solo v√≠a chat</span>}
             {isDecisionTime && (
                <>
                    <button onClick={() => handleStatusChange('pedido')} style={{background:'#27ae60', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer', fontWeight:'bold'}}>‚úÖ Aceptar Presupuesto</button>
                    <button onClick={() => handleStatusChange('rechazado')} style={{background:'#c0392b', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer', fontWeight:'bold'}}>‚ùå Rechazar</button>
                </>
             )}
             {isOrderConfirmed && <button onClick={handleCancelOrder} style={{background:'#c0392b', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer'}}>üö´ Cancelar Pedido</button>}
             {isPending && <button onClick={handleDelete} style={{background:'#c0392b', color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', cursor:'pointer'}}>üóëÔ∏è Borrar Solicitud</button>}
        </div>
      </div>
      
      <div style={containerStyle}>
        
        {/* COLUMNA IZQUIERDA */}
        <div style={{ display:'flex', flexDirection:'column', gap:'10px' }}>
            
            {/* INFO Y NOMBRE */}
            <div style={cardStyle}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                    <h2 style={{margin:0, color:'white'}}>Ref: {order.order_ref}</h2>
                    <span style={{padding:'5px 10px', borderRadius:'4px', background: badge.color, color: 'white', fontWeight:'bold'}}>{badge.label}</span>
                </div>
                
                {/* CAMPO NOMBRE PERSONALIZADO */}
                <div style={{marginTop:'15px'}}>
                    <label style={{color:'#aaa', fontSize:'12px', display:'block', marginBottom:'5px'}}>Nombre del Proyecto / Referencia Personal:</label>
                    <div style={{display:'flex', gap:'10px'}}>
                        <input 
                            type="text" 
                            value={customName}
                            onChange={e => setCustomName(e.target.value)}
                            placeholder="Ej: Reforma Parque Infantil Comunidad..."
                            disabled={!isPending && !isDecisionTime}
                            style={{flex:1, padding:'10px', background:'#252525', border:'1px solid #444', borderRadius:'6px', color:'white'}}
                        />
                        {(isPending || isDecisionTime) && (
                            <button onClick={handleSaveName} style={{background:'#333', border:'1px solid #555', color:'white', borderRadius:'6px', padding:'0 15px', cursor:'pointer'}} title="Guardar Nombre">üíæ</button>
                        )}
                    </div>
                </div>
                
                <p style={{color:'#888', marginTop:'10px', fontSize:'13px'}}>Solicitado el: {new Date(order.created_at).toLocaleString()}</p>
                {order.estimated_delivery_date && (
                    <p style={{color:'#3498db', marginTop:'0', fontWeight:'bold'}}>üìÖ Fecha Entrega Estimada: {new Date(order.estimated_delivery_date).toLocaleDateString()}</p>
                )}
            </div>

            {/* OBSERVACIONES CRONOL√ìGICAS (NUEVO) */}
            <div style={cardStyle}>
                <h3 style={sectionHeaderStyle}>üìù Historial de Observaciones</h3>
                
                {/* Lista de observaciones anteriores */}
                <div style={{maxHeight:'200px', overflowY:'auto', marginBottom:'15px', display:'flex', flexDirection:'column', gap:'10px'}}>
                    {observations.length === 0 && <p style={{color:'#666', fontStyle:'italic', fontSize:'13px'}}>No hay observaciones registradas.</p>}
                    {observations.map(obs => (
                        <div key={obs.id} style={{background:'#252525', padding:'10px', borderRadius:'6px', borderLeft:`3px solid ${obs.profiles?.role === 'admin' ? '#e67e22' : '#3b82f6'}`}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'4px'}}>
                                <span style={{fontWeight:'bold', fontSize:'12px', color:'white'}}>
                                    {obs.profiles?.role === 'admin' ? 'üè¢ Administrador' : 'üë§ T√∫'}
                                </span>
                                <span style={{fontSize:'11px', color:'#888'}}>{new Date(obs.created_at).toLocaleString()}</span>
                            </div>
                            <p style={{margin:0, fontSize:'13px', color:'#ddd', whiteSpace:'pre-wrap'}}>{obs.content}</p>
                        </div>
                    ))}
                </div>

                {/* Input nueva observaci√≥n */}
                {(isPending || isDecisionTime) ? (
                    <div style={{display:'flex', gap:'10px'}}>
                        <input 
                            type="text" 
                            value={newObservation}
                            onChange={e => setNewObservation(e.target.value)}
                            placeholder="A√±adir nueva observaci√≥n o nota..."
                            style={{flex:1, padding:'10px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}}
                        />
                        <button onClick={handleAddObservation} style={{background:'#3b82f6', color:'white', border:'none', padding:'0 20px', borderRadius:'6px', cursor:'pointer'}}>A√±adir</button>
                    </div>
                ) : (
                    <p style={{fontSize:'12px', color:'#666'}}>* No se pueden a√±adir m√°s observaciones en este estado.</p>
                )}
            </div>

            {/* ARCHIVOS */}
            <div style={cardStyle}>
                <div style={sectionHeaderStyle}>
                    <h3 style={{margin:0}}>üìé Archivos y Planos</h3>
                    <label style={{background:'#333', color:'white', padding:'5px 10px', borderRadius:'4px', cursor:'pointer', fontSize:'12px', border:'1px solid #555'}}>
                        {uploading ? '...' : '+ Adjuntar'}
                        <input type="file" onChange={handleFileUpload} style={{display:'none'}} disabled={uploading} />
                    </label>
                </div>
                {attachments.length === 0 ? <p style={{color:'#666', fontSize:'13px'}}>Sin archivos.</p> : (
                    <ul style={{listStyle:'none', padding:0, margin:0}}>
                        {attachments.map(att => (
                            <li key={att.id} style={{display:'flex', justifyContent:'space-between', background:'#252525', padding:'8px', marginBottom:'5px', borderRadius:'4px'}}>
                                <a href={att.file_url} target="_blank" rel="noreferrer" style={{color:'#3b82f6', textDecoration:'none', fontSize:'13px'}}>{att.file_name}</a>
                                <button onClick={() => handleDeleteAttachment(att.id)} style={{border:'none', background:'none', color:'#e74c3c', cursor:'pointer'}}>üóëÔ∏è</button>
                            </li>
                        ))}
                    </ul>
                )}
            </div>

            {/* MATERIALES */}
            <div style={cardStyle}>
                <div style={sectionHeaderStyle}>
                    <h3 style={{margin:0}}>üìã Desglose</h3>
                    {isPending && <button onClick={() => setIsCatalogOpen(true)} style={{background:'#3b82f6', color:'white', border:'none', padding:'5px 15px', borderRadius:'4px', cursor:'pointer'}}>+ A√±adir Extra</button>}
                </div>

                <table style={{width:'100%', borderCollapse:'collapse', fontSize:'14px', marginTop:'10px'}}>
                    <tbody>
                        {items3D.map((item, idx) => (
                            <tr key={`3d-${idx}`} style={{borderBottom:'1px solid #2a2a2a'}}>
                                <td style={{padding:'12px', color:'white'}}>{item.name}</td>
                                <td style={{padding:'12px', color:'#aaa', fontSize:'12px'}}>üïã 3D</td>
                                <td style={{padding:'12px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(item.price)}</td>
                            </tr>
                        ))}
                        {manualItems.map((item) => (
                            <tr key={item.id} style={{borderBottom:'1px solid #2a2a2a', background:'rgba(59, 130, 246, 0.05)'}}>
                                <td style={{padding:'12px', color:'white'}}>{item.name} <small>({item.dimensions})</small></td>
                                <td style={{padding:'12px', color:'#3b82f6', fontSize:'12px'}}>‚úèÔ∏è Manual</td>
                                <td style={{padding:'12px', textAlign:'right', fontWeight:'bold'}}>{formatMoney(item.total_price)}</td>
                                <td style={{textAlign:'right'}}>
                                    {isPending && <button onClick={() => handleDeleteManualItem(item.id)} style={{color:'#e74c3c', background:'none', border:'none', cursor:'pointer'}}>üóëÔ∏è</button>}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                <div style={{marginTop:'20px', borderTop:'1px solid #333', textAlign:'right', paddingTop:'10px'}}>
                    {isPending ? (
                        <div style={{fontSize:'18px', color:'white'}}>Estimado: {formatMoney(totals.subtotal)}</div>
                    ) : (
                        <>
                            <div style={{color:'#aaa'}}>Subtotal: {formatMoney(totals.subtotal)}</div>
                            {totals.discountRate > 0 && <div style={{color:'#2ecc71'}}>Dto {totals.discountRate}%: -{formatMoney(totals.discountAmount)}</div>}
                            <div style={{fontSize:'22px', fontWeight:'bold', color:'#3b82f6', marginTop:'5px'}}>Total: {formatMoney(totals.final)}</div>
                        </>
                    )}
                </div>
            </div>

            {/* PROYECTO 3D */}
            {order.projects && (
                <div style={cardStyle}>
                     <h3 style={sectionHeaderStyle}>Dise√±o 3D</h3>
                     <div style={{height:'150px', background:'#000', borderRadius:'8px', display:'flex', alignItems:'center', justifyContent:'center', overflow:'hidden', border:'1px solid #333'}}>
                         {order.projects.thumbnail_url ? <img src={order.projects.thumbnail_url} style={{width:'100%', objectFit:'cover'}} alt="Vista"/> : 'üèûÔ∏è'}
                     </div>
                     <button onClick={() => window.location.href=`/?project_id=${order.project_id}&mode=readonly`} style={{marginTop:'15px', background:'#333', color:'white', border:'1px solid #555', padding:'10px', width:'100%', borderRadius:'6px', cursor:'pointer'}}>Abrir Visor 3D üëÅÔ∏è</button>
                </div>
            )}
        </div>

        {/* CHAT */}
        <div style={{...cardStyle, maxHeight:'80vh', marginBottom:0}}>
            <h3 style={sectionHeaderStyle}>üí¨ Chat</h3>
            <div style={{flex:1, overflowY:'auto', display:'flex', flexDirection:'column', gap:'10px', paddingRight:'5px'}}>
                {messages.map(msg => {
                    const isMe = msg.profiles?.role === 'client';
                    return (
                        <div key={msg.id} style={{alignSelf: isMe ? 'flex-end' : 'flex-start', maxWidth:'85%', background: isMe ? '#3b82f6' : '#444', color:'white', padding:'10px 15px', borderRadius:'12px'}}>
                            {msg.content}
                        </div>
                    );
                })}
                <div ref={chatEndRef} />
            </div>
            <div style={{marginTop:'15px', display:'flex', gap:'10px'}}>
                <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} onKeyDown={(e) => e.key==='Enter' && handleSendMessage()} placeholder="Mensaje..." style={{flex:1, padding:'10px', borderRadius:'6px', background:'#252525', border:'none', color:'white'}}/>
                <button onClick={handleSendMessage} style={{padding:'0 15px', background:'#3b82f6', border:'none', borderRadius:'6px', color:'white'}}>‚û§</button>
            </div>
        </div>
      </div>

      {/* MODALES CATALOGO (IGUAL QUE ADMIN) */}
      {isCatalogOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:999}}>
              <div style={{background:'#1e1e1e', width:'600px', maxHeight:'80vh', borderRadius:'12px', border:'1px solid #444', display:'flex', flexDirection:'column'}}>
                  <div style={{padding:'20px', borderBottom:'1px solid #333', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                      <h3 style={{margin:0, color:'white'}}>A√±adir Extra</h3>
                      <button onClick={() => setIsCatalogOpen(false)} style={{background:'none', border:'none', color:'#888', fontSize:'20px'}}>‚úï</button>
                  </div>
                  <div style={{padding:'20px', overflowY:'auto', display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                      {CATALOG_ITEMS.map(item => (
                          <div key={item.id} onClick={() => handleAddItem(item)} style={{background:'#252525', padding:'15px', borderRadius:'8px', cursor:'pointer', border:'1px solid #333'}}>
                              <div style={{fontWeight:'bold', color:'white'}}>{item.name}</div>
                              <div style={{color:'#888', fontSize:'12px'}}>{item.type === 'model' ? `${item.price} ‚Ç¨` : 'Param√©trico'}</div>
                          </div>
                      ))}
                  </div>
              </div>
          </div>
      )}
      {parametricModal.isOpen && (
          <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:1000}}>
              <div style={{background:'#1e1e1e', padding:'30px', borderRadius:'12px', width:'350px', border:'1px solid #444'}}>
                  <h3 style={{margin:'0 0 15px 0', color:'white'}}>{parametricModal.item?.name}</h3>
                  <input type="number" autoFocus value={parametricModal.value} onChange={e => setParametricModal({...parametricModal, value: e.target.value})} placeholder="Cantidad" style={{width:'100%', padding:'10px', marginBottom:'20px'}}/>
                  <div style={{display:'flex', gap:'10px', justifyContent:'flex-end'}}>
                      <button onClick={() => setParametricModal({isOpen:false, item:null, value:''})}>Cancelar</button>
                      <button onClick={confirmParametricItem}>A√±adir</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/ClientDashboard.tsx">
import { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';
import { ConfirmModal } from '../../../components/ui/ConfirmModal';

// --- ESTILOS ---
const containerStyle = { color: '#e0e0e0', padding: '20px', fontFamily: 'sans-serif', minHeight: '100vh', display:'flex', flexDirection:'column' as const };
const headerStyle = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px', borderBottom: '1px solid #333', paddingBottom: '15px' };
const tabContainerStyle = { display: 'flex', gap: '20px', marginBottom: '20px', borderBottom: '1px solid #333' };
const tabStyle = (isActive: boolean) => ({
  cursor: 'pointer', padding: '10px 15px', borderBottom: isActive ? '3px solid #3b82f6' : '3px solid transparent',
  color: isActive ? '#fff' : '#888', fontWeight: isActive ? 'bold' : 'normal', transition: 'all 0.2s', marginBottom: '-2px'
});
const gridStyle = { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '20px' };
const cardStyle = { background: '#1e1e1e', border: '1px solid #333', borderRadius: '12px', overflow: 'hidden', display: 'flex', flexDirection: 'column' as const };
const cardImgStyle = { height: '160px', background: '#2a2a2a', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '40px', color: '#555', backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' };
const cardBodyStyle = { padding: '15px' };
const btnActionStyle = { flex: 1, padding: '8px', borderRadius: '6px', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: 'bold' };
const tableStyle = { width: '100%', borderCollapse: 'collapse' as const, background: '#1e1e1e', borderRadius: '8px', overflow: 'hidden' };
const thStyle = { textAlign: 'left' as const, padding: '15px', background: '#252525', color: '#aaa', borderBottom: '1px solid #333' };
const tdStyle = { padding: '15px', borderBottom: '1px solid #333' };

type TabType = 'projects' | 'budgets' | 'orders' | 'archived';

const getStatusColor = (status: string) => {
    switch(status) {
        case 'pedido': return '#3498db'; 
        case 'fabricacion': return '#e67e22'; 
        case 'entregado_parcial': return '#f1c40f'; 
        case 'entregado': return '#27ae60'; 
        case 'pendiente': return 'orange';
        case 'rechazado': return '#c0392b';
        case 'cancelado': return '#7f8c8d';
        default: return '#27ae60';
    }
};

export const ClientDashboard = () => {
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();
  const initialTab = (searchParams.get('tab') as TabType) || 'projects';
  const [activeTab, setActiveTab] = useState<TabType>(initialTab);
  
  const [projects, setProjects] = useState<any[]>([]);
  const [dataList, setDataList] = useState<any[]>([]); 
  const [loading, setLoading] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);

  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, isDestructive: false });
  const closeModal = () => setModal({ ...modal, isOpen: false });

  useEffect(() => { setSearchParams({ tab: activeTab }); }, [activeTab, setSearchParams]);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { navigate('/login'); return; }
      setUserId(user.id);

      try {
        if (activeTab === 'projects') {
          const { data } = await supabase.from('projects').select('*, orders(id)').eq('user_id', user.id).order('updated_at', { ascending: false });
          const cleanProjects = (data || []).filter((p: any) => !p.orders || p.orders.length === 0);
          setProjects(cleanProjects);
        }
        else {
            let query = supabase.from('orders').select('*, projects(name)').order('created_at', { ascending: false });
            
            if (activeTab === 'budgets') query = query.eq('is_archived', false).in('status', ['pendiente', 'presupuestado', 'rechazado']);
            else if (activeTab === 'orders') query = query.eq('is_archived', false).in('status', ['pedido', 'fabricacion', 'entregado_parcial', 'entregado', 'completado']);
            else if (activeTab === 'archived') query = query.eq('is_archived', true);

            const { data } = await query;
            setDataList(data || []);
        }
      } catch (error) { console.error(error); } finally { setLoading(false); }
    };
    fetchData();
  }, [activeTab, navigate]);

  const handleCreateManualBudget = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    const ref = 'MAN-' + Math.floor(10000 + Math.random() * 90000);
    
    const { data, error } = await supabase.from('orders').insert([{
        user_id: user?.id,
        order_ref: ref,
        status: 'pendiente',
        total_price: 0,
        is_archived: false,
        created_at: new Date().toISOString()
    }]).select();

    if (error) { alert("Error al crear: " + error.message); return; }
    if (data) navigate(`/portal/order/${data[0].id}`);
  };

  const handleRequestQuote = (project: any) => {
    setModal({
      isOpen: true, title: 'Solicitar Presupuesto', message: `¬øQuieres enviar "${project.name}" a revisi√≥n?`, isDestructive: false,
      onConfirm: async () => {
        const estimatedDate = new Date(); estimatedDate.setHours(estimatedDate.getHours() + 48);
        const ref = 'SOL-' + Math.floor(10000 + Math.random() * 90000);
        const { data } = await supabase.from('orders').insert([{ 
            user_id: userId, project_id: project.id, order_ref: ref, total_price: 0, 
            status: 'pendiente', estimated_delivery_date: estimatedDate.toISOString() 
        }]).select();
        
        if(data) { navigate(`/portal/order/${data[0].id}`); }
        closeModal();
      }
    });
  };

  const handleDeleteProject = (id: string) => {
    setModal({
      isOpen: true, title: 'Borrar Proyecto', message: '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.', isDestructive: true,
      onConfirm: async () => {
        await supabase.from('projects').delete().eq('id', id);
        setProjects(p => p.filter(x => x.id !== id));
        closeModal();
      }
    });
  };

  const handleReactivate = (order: any) => {
    setModal({
      isOpen: true, title: 'Reactivar Presupuesto', message: 'El presupuesto volver√° a la lista de "Mis Presupuestos".', isDestructive: false,
      onConfirm: async () => {
        await supabase.from('orders').update({ is_archived: false, status: 'pendiente', created_at: new Date().toISOString() }).eq('id', order.id);
        setActiveTab('budgets');
        closeModal();
      }
    });
  };

  return (
    <div style={containerStyle}>
      <ConfirmModal {...modal} onCancel={closeModal} />

      <div style={headerStyle}>
        <h2 style={{ margin: 0, color: '#fff' }}>Mi Espacio Personal</h2>
        <div style={{display:'flex', gap:'15px'}}>
             {/* --- BOTONES DE ACCI√ìN PRINCIPAL --- */}
            <button onClick={handleCreateManualBudget} style={{ background: '#3b82f6', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '6px', fontWeight: 'bold', cursor: 'pointer', display:'flex', alignItems:'center', gap:'8px' }}>
                üìù Crear Presupuesto Manual
            </button>
            <a href="/" style={{ background: '#27ae60', color: 'white', textDecoration: 'none', padding: '10px 20px', borderRadius: '6px', fontWeight: 'bold', display:'flex', alignItems:'center', gap:'8px' }}>
                + Nuevo Proyecto 3D
            </a>
        </div>
      </div>

      <div style={tabContainerStyle}>
        <div onClick={() => setActiveTab('projects')} style={tabStyle(activeTab === 'projects')}>üìÇ Mis Proyectos</div>
        <div onClick={() => setActiveTab('budgets')} style={tabStyle(activeTab === 'budgets')}>üìë Mis Presupuestos</div>
        <div onClick={() => setActiveTab('orders')} style={tabStyle(activeTab === 'orders')}>üì¶ Mis Pedidos</div>
        <div onClick={() => setActiveTab('archived')} style={tabStyle(activeTab === 'archived')}>üóÑÔ∏è Archivados</div>
      </div>

      {loading ? ( <p style={{color:'#666'}}>Cargando datos...</p> ) : (
        <>
            {activeTab === 'projects' && (
                <div style={gridStyle}>
                    {projects.map(p => (
                        <div key={p.id} style={cardStyle}>
                            <div style={{...cardImgStyle, backgroundImage: p.thumbnail_url ? `url(${p.thumbnail_url})` : 'none'}}>{!p.thumbnail_url && 'üèûÔ∏è'}</div>
                            <div style={cardBodyStyle}>
                                <h4 style={{margin:'0 0 5px 0', color:'white'}}>{p.name || 'Sin Nombre'}</h4>
                                <div style={{display:'flex', gap:'8px', marginTop:'10px'}}>
                                    <button onClick={() => navigate(`/?project_id=${p.id}`)} style={{...btnActionStyle, background:'#3b82f6', color:'white'}}>‚úèÔ∏è Editar</button>
                                    <button onClick={() => handleRequestQuote(p)} style={{...btnActionStyle, background:'#e67e22', color:'white'}}>üõí Pedir</button>
                                    <button onClick={() => handleDeleteProject(p.id)} style={{...btnActionStyle, background:'#e74c3c', color:'white', flex:0}}>üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    ))}
                    {projects.length === 0 && <p style={{color:'#666'}}>No tienes proyectos pendientes.</p>}
                </div>
            )}

            {activeTab !== 'projects' && (
                <table style={tableStyle}>
                    <thead>
                        <tr>
                            <th style={thStyle}>Ref</th>
                            <th style={thStyle}>Proyecto</th>
                            <th style={thStyle}>{activeTab === 'orders' ? 'F. Inicio Pedido' : 'F. Solicitud'}</th>
                            <th style={thStyle}>F. Entrega Est.</th>
                            <th style={thStyle}>Estado</th>
                            <th style={thStyle}>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {dataList.map(o => (
                            <tr key={o.id} style={{borderBottom:'1px solid #333'}}>
                                <td style={tdStyle}><strong style={{color:'#fff'}}>{o.order_ref}</strong></td>
                                <td style={tdStyle}>{o.projects?.name || '---'}</td>
                                <td style={tdStyle}>{new Date(o.created_at).toLocaleDateString()}</td>
                                <td style={{...tdStyle, color: o.estimated_delivery_date ? '#ccc' : '#666'}}>
                                    {o.estimated_delivery_date ? new Date(o.estimated_delivery_date).toLocaleDateString() : '--'}
                                </td>
                                <td style={tdStyle}>
                                    <span style={{ color: getStatusColor(o.status), fontWeight:'bold', textTransform:'uppercase', fontSize:'12px'}}>
                                        {o.status.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style={tdStyle}>
                                    {activeTab === 'archived' ? (
                                        <button onClick={() => handleReactivate(o)} style={{background:'#3b82f6', color:'white', border:'none', padding:'5px 10px', borderRadius:'4px', cursor:'pointer'}}>Reactivar üîÑ</button>
                                    ) : (
                                        <button onClick={() => navigate(`/portal/order/${o.id}`)} style={{background:'#333', color:'white', border:'1px solid #555', padding:'5px 10px', borderRadius:'4px', cursor:'pointer'}}>Ver Ficha üëÅÔ∏è</button>
                                    )}
                                </td>
                            </tr>
                        ))}
                        {dataList.length === 0 && (
                            <tr><td colSpan={6} style={{padding:'20px', textAlign:'center', color:'#666'}}>No hay datos en esta secci√≥n.</td></tr>
                        )}
                    </tbody>
                </table>
            )}
        </>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/CrmDashboard.tsx">
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../../../lib/supabase';

// ESTILOS
const containerStyle = { color: '#e0e0e0', padding: '20px', fontFamily: 'sans-serif' };
const headerStyle = { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px', borderBottom: '1px solid #333', paddingBottom: '15px' };
const tabBtnStyle = (active: boolean) => ({
  background: active ? '#e67e22' : '#333', color: active ? '#fff' : '#aaa',
  border: 'none', padding: '10px 20px', marginRight: '10px', borderRadius: '6px', cursor: 'pointer', fontWeight: 'bold' as const
});
const tableStyle = { width: '100%', borderCollapse: 'collapse' as const, fontSize: '13px', background: '#1e1e1e', borderRadius: '8px', overflow: 'hidden' };
const thStyle = { textAlign: 'left' as const, padding: '12px', background: '#2a2a2a', color: '#888', borderBottom: '1px solid #333', whiteSpace: 'nowrap' as const };
const tdStyle = { padding: '12px', borderBottom: '1px solid #333', verticalAlign: 'middle' };
const selectStyle = {
    background: '#252525', color: 'white', border: '1px solid #444', padding: '4px', borderRadius: '4px', cursor: 'pointer', maxWidth: '130px'
};

const formatMoney = (amount: number) => amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';

const BUDGET_STATUSES = ['pendiente', 'presupuestado', 'rechazado'];
const ORDER_STATUSES = ['pedido', 'fabricacion', 'entregado_parcial', 'entregado', 'completado', 'cancelado'];

export const CrmDashboard = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<'clients' | 'budgets' | 'orders'>('budgets');
  const [loading, setLoading] = useState(false);
  const [dataList, setDataList] = useState<any[]>([]);
  const [clients, setClients] = useState<any[]>([]);
  
  // Modal Cliente
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [newClientData, setNewClientData] = useState({ email: '', company_name: '', full_name: '', phone: '', discount_rate: 0 });

  useEffect(() => { loadData(); }, [activeTab]);

  const loadData = async () => {
    setLoading(true);
    try {
      if (activeTab === 'clients') {
        const { data } = await supabase.from('profiles').select('*, is_approved').order('created_at', { ascending: false });
        setClients(data || []);
      } else {
        // CORRECCI√ìN: A√±adido 'discount_rate' en el select de profiles
        let query = supabase.from('orders')
            .select(`*, profiles(company_name, email, discount_rate), projects(name), order_messages(created_at, profiles(role))`)
            .order('created_at', { ascending: false });
        
        if (activeTab === 'budgets') query = query.in('status', BUDGET_STATUSES);
        else if (activeTab === 'orders') query = query.in('status', ORDER_STATUSES);

        const { data } = await query;
        setDataList(data || []);
      }
    } catch (err: any) { console.error(err); } finally { setLoading(false); }
  };

  const handleApproveClient = async (clientId: string) => {
    const { error } = await supabase.from('profiles').update({ is_approved: true }).eq('id', clientId);
    if (!error) { alert("Usuario aprobado."); loadData(); }
  };

  const handleCreateClient = async () => {
    if (!newClientData.email) return alert("Email obligatorio");
    const { error } = await supabase.from('pre_clients').insert([newClientData]);
    if (error) alert("Error: " + error.message);
    else {
        alert(`‚úÖ Ficha creada para ${newClientData.email}.`);
        setShowCreateModal(false);
        setNewClientData({ email: '', company_name: '', full_name: '', phone: '', discount_rate: 0 });
    }
  };

  const handleDeleteClient = async (id: string) => {
    if(!confirm("¬øBorrar cliente?")) return;
    await supabase.from('profiles').delete().eq('id', id);
    loadData();
  };
  const handleDeleteOrder = async (id: string) => {
    if(!confirm("¬øBorrar registro?")) return;
    await supabase.from('orders').delete().eq('id', id);
    loadData();
  };
  
  const handleStatusUpdate = async (id: string, newStatus: string) => {
      const confirmMsg = `¬øCambiar estado a "${newStatus.toUpperCase()}"?`;
      if(!confirm(confirmMsg)) return; 
      
      const updateData: any = { status: newStatus };
      const now = new Date();
      
      if (newStatus === 'pedido') updateData.estimated_delivery_date = new Date(now.getTime() + (6 * 7 * 24 * 60 * 60 * 1000)).toISOString();
      else if (newStatus === 'presupuestado') updateData.estimated_delivery_date = new Date(now.getTime() + (48 * 60 * 60 * 1000)).toISOString();

      await supabase.from('orders').update(updateData).eq('id', id);
      loadData();
  };

  const getAlertStatus = (order: any) => {
    const messages = order.order_messages || [];
    messages.sort((a: any, b: any) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
    if (!messages[0]) return null;
    if (messages[0].profiles?.role === 'client') return { icon: 'üî¥', text: 'Cliente escribi√≥' };
    return { icon: 'üü¢', text: 'Respondido' };
  };

  return (
    <div style={containerStyle}>
      <div style={headerStyle}>
        <div><h2 style={{ margin: 0, color: 'white' }}>Panel de Control üè¢</h2><small>Vista Administrador</small></div>
        <div style={{display:'flex', gap:'10px'}}>
          <button onClick={() => setActiveTab('clients')} style={tabBtnStyle(activeTab === 'clients')}>üë• Clientes</button>
          <button onClick={() => setActiveTab('budgets')} style={tabBtnStyle(activeTab === 'budgets')}>üìë Presupuestos</button>
          <button onClick={() => setActiveTab('orders')} style={tabBtnStyle(activeTab === 'orders')}>üì¶ Pedidos</button>
          <button onClick={() => loadData()} style={{...tabBtnStyle(false), background: '#27ae60', color: 'white'}}>üîÑ</button>
        </div>
      </div>

      {loading ? <p>Cargando...</p> : (
        <>
          {(activeTab === 'budgets' || activeTab === 'orders') && (
             <div style={{overflowX: 'auto'}}>
                <table style={tableStyle}>
                  <thead>
                    <tr>
                      <th style={thStyle}>Aviso</th>
                      <th style={thStyle}>REF</th>
                      <th style={thStyle}>Cliente</th>
                      <th style={thStyle}>Estado</th>
                      <th style={thStyle}>F. Solicitud</th>
                      <th style={thStyle}>F. Entrega Est.</th>
                      <th style={{...thStyle, borderLeft:'1px solid #444'}}>Total / Oferta</th>
                      <th style={thStyle}>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {dataList.map(o => {
                        const alert = getAlertStatus(o);
                        // --- C√ÅLCULO VISUAL DE DESCUENTOS ---
                        const finalPrice = o.total_price || 0;
                        const discount = o.profiles?.discount_rate || 0;
                        let basePrice = finalPrice;
                        
                        // Si hay descuento, calculamos el precio base original inverso
                        // Precio Final = Base * (1 - Dto/100)  =>  Base = Precio Final / (1 - Dto/100)
                        if (discount > 0 && finalPrice > 0) {
                            basePrice = finalPrice / (1 - (discount / 100));
                        }

                        return (
                        <tr key={o.id}>
                            <td style={{...tdStyle, textAlign:'center'}} title={alert?.text}>{alert ? alert.icon : '‚ö™'}</td>
                            <td style={tdStyle}>
                                <strong>{o.order_ref}</strong>
                                {o.custom_name && <div style={{fontSize:'11px', color:'#aaa'}}>{o.custom_name}</div>}
                            </td>
                            <td style={{...tdStyle, color: o.profiles ? '#4a90e2' : '#999'}}>{o.profiles ? (o.profiles.company_name || o.profiles.email) : 'Eliminado'}</td>
                            <td style={tdStyle}>
                                <select value={o.status} onChange={(e) => handleStatusUpdate(o.id, e.target.value)} style={selectStyle}>
                                    {activeTab==='budgets' ? (
                                        <>
                                            <option value="pendiente">üü† Pendiente</option>
                                            <option value="presupuestado">üü£ Presupuestado</option>
                                            <option value="rechazado">üî¥ Rechazado</option>
                                            <option value="pedido">‚û°Ô∏è A PEDIDO</option>
                                        </>
                                    ) : (
                                        <>
                                            <option value="pedido">üîµ Pedido</option>
                                            <option value="fabricacion">üü† Fabricaci√≥n</option>
                                            <option value="entregado">üü¢ Entregado</option>
                                            <option value="completado">üèÅ Completado</option>
                                        </>
                                    )}
                                </select>
                            </td>
                            <td style={tdStyle}>{new Date(o.created_at).toLocaleDateString()}</td>
                            <td style={tdStyle}>
                                {o.estimated_delivery_date ? (
                                    <span style={{color: activeTab === 'orders' ? '#e67e22' : '#ccc'}}>
                                        {new Date(o.estimated_delivery_date).toLocaleDateString()}
                                    </span>
                                ) : '--'}
                            </td>
                            
                            {/* COLUMNA TOTAL MODIFICADA */}
                            <td style={tdStyle}>
                                {discount > 0 ? (
                                    <div style={{display:'flex', flexDirection:'column', alignItems:'flex-start'}}>
                                        <span style={{textDecoration:'line-through', color:'#666', fontSize:'11px'}}>
                                            Base: {formatMoney(basePrice)}
                                        </span>
                                        <span style={{color:'white', fontWeight:'bold'}}>
                                            {formatMoney(finalPrice)} 
                                            <span style={{color:'#e67e22', fontSize:'11px', marginLeft:'5px'}}>({discount}%)</span>
                                        </span>
                                    </div>
                                ) : (
                                    <span style={{fontWeight:'bold'}}>{formatMoney(finalPrice)}</span>
                                )}
                            </td>

                            <td style={tdStyle}>
                                <button onClick={() => navigate(`/admin/order/${o.id}`)} style={{background:'#333', color:'white', border:'1px solid #555', padding:'5px 10px', borderRadius:'4px', marginRight:'5px'}}>üëÅÔ∏è</button>
                                <button onClick={() => handleDeleteOrder(o.id)} style={{background:'none', border:'none', color:'#666'}}>üóëÔ∏è</button>
                            </td>
                        </tr>
                    )})}
                    {dataList.length === 0 && <tr><td colSpan={8} style={{padding:'20px', textAlign:'center', color:'#666'}}>Sin datos.</td></tr>}
                  </tbody>
                </table>
             </div>
          )}

          {activeTab === 'clients' && (
            <div>
                <div style={{marginBottom:'15px', textAlign:'right'}}>
                    <button onClick={() => setShowCreateModal(true)} style={{background:'#3b82f6', color:'white', border:'none', padding:'10px 20px', borderRadius:'6px', fontWeight:'bold', cursor:'pointer'}}>+ Nuevo Cliente</button>
                </div>
                <table style={tableStyle}>
                <thead>
                    <tr>
                        <th style={thStyle}>Estado</th>
                        <th style={thStyle}>Empresa</th>
                        <th style={thStyle}>Email</th>
                        <th style={thStyle}>Dto.</th>
                        <th style={thStyle}>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {clients.map(c => (
                    <tr key={c.id}>
                        <td style={tdStyle}>{c.is_approved ? <span title="Activo">‚úÖ</span> : <button onClick={() => handleApproveClient(c.id)} style={{background:'#e67e22', color:'white', border:'none', padding:'4px 8px', borderRadius:'4px', cursor:'pointer'}}>Aprobar</button>}</td>
                        <td style={{...tdStyle, fontWeight:'bold'}}>{c.company_name || '---'}</td>
                        <td style={tdStyle}>{c.email}</td>
                        <td style={{...tdStyle, color:'#2ecc71', fontWeight:'bold'}}>{c.discount_rate}%</td>
                        <td style={tdStyle}>
                            <button onClick={() => navigate(`/admin/client/${c.id}`)} style={{background:'#333', color:'white', border:'1px solid #555', padding:'5px 10px', borderRadius:'4px', marginRight:'5px'}}>Ficha</button>
                            <button onClick={() => handleDeleteClient(c.id)} style={{background:'none', border:'none', color:'#e74c3c'}}>üóëÔ∏è</button>
                        </td>
                    </tr>
                    ))}
                </tbody>
                </table>
            </div>
          )}
        </>
      )}

      {showCreateModal && (
        <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.7)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:9999}}>
            <div style={{background:'#1e1e1e', padding:'30px', borderRadius:'12px', width:'400px', border:'1px solid #444'}}>
                <h3 style={{marginTop:0, color:'white'}}>Dar de Alta Cliente</h3>
                <input type="email" placeholder="Email (Obligatorio)" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.email} onChange={e => setNewClientData({...newClientData, email: e.target.value})} />
                <input type="text" placeholder="Nombre Empresa" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.company_name} onChange={e => setNewClientData({...newClientData, company_name: e.target.value})} />
                <input type="text" placeholder="Contacto" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.full_name} onChange={e => setNewClientData({...newClientData, full_name: e.target.value})} />
                <input type="text" placeholder="Tel√©fono" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.phone} onChange={e => setNewClientData({...newClientData, phone: e.target.value})} />
                <input type="number" placeholder="Descuento %" style={{width:'100%', padding:'10px', marginBottom:'15px', background:'#252525', border:'1px solid #444', color:'white', borderRadius:'6px'}} value={newClientData.discount_rate} onChange={e => setNewClientData({...newClientData, discount_rate: parseFloat(e.target.value)})} />
                
                <div style={{display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                    <button onClick={() => setShowCreateModal(false)} style={{background:'transparent', color:'#888', border:'none', cursor:'pointer'}}>Cancelar</button>
                    <button onClick={handleCreateClient} style={{background:'#3b82f6', color:'white', border:'none', padding:'10px 20px', borderRadius:'6px', fontWeight:'bold', cursor:'pointer'}}>Crear</button>
                </div>
            </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/features/crm/pages/ProfilePage.tsx">
import { useEffect, useState } from 'react';
import { supabase } from '../../../lib/supabase';
import type { Profile } from '../../../types/types';

const inputStyle = {
  width: '100%',
  padding: '10px',
  background: '#2a2a2a',
  border: '1px solid #444',
  borderRadius: '6px',
  color: 'white',
  marginTop: '5px'
};

const labelStyle = { display: 'block', marginBottom: '15px', color: '#aaa', fontSize: '14px' };
const sectionTitleStyle = { color: '#e67e22', borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', marginTop: '30px' };

export const ProfilePage = () => {
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
  
  const [formData, setFormData] = useState<Partial<Profile>>({
    company_name: '',
    full_name: '',
    email: '', // A√±adido campo email
    cif: '',
    phone: '',
    shipping_address: '',
    billing_address: '',
    billing_email: '',
    observations: ''
  });

  useEffect(() => {
    loadProfile();
  }, []);

  const loadProfile = async () => {
    setLoading(true);
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (data) setFormData(data);
    }
    setLoading(false);
  };

  const handleSave = async () => {
    setLoading(true);
    setMessage(null);
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) return;

    try {
      const { error } = await supabase
        .from('profiles')
        .update(formData)
        .eq('id', user.id);

      if (error) throw error;
      setMessage({ text: '‚úÖ Perfil actualizado correctamente', type: 'success' });
    } catch (error: any) {
      setMessage({ text: '‚ùå Error al guardar: ' + error.message, type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: '800px', margin: '0 auto', color: '#e0e0e0' }}>
      <h2 style={{ color: 'white' }}>Mi Zona Personal</h2>
      <p style={{ color: '#888' }}>Gestiona tus datos de facturaci√≥n y env√≠o.</p>

      {message && (
        <div style={{ 
          padding: '10px', 
          borderRadius: '6px', 
          background: message.type === 'success' ? 'rgba(39, 174, 96, 0.2)' : 'rgba(231, 76, 60, 0.2)',
          color: message.type === 'success' ? '#2ecc71' : '#e74c3c',
          marginBottom: '20px'
        }}>
          {message.text}
        </div>
      )}

      <div style={{ background: '#1e1e1e', padding: '30px', borderRadius: '12px', border: '1px solid #333' }}>
        
        {/* DATOS EMPRESA */}
        <h4 style={{ ...sectionTitleStyle, marginTop: 0 }}>üè¢ Datos Fiscales</h4>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
          <label style={labelStyle}>
            Nombre Empresa
            <input 
              type="text" 
              style={inputStyle} 
              value={formData.company_name || ''} 
              onChange={e => setFormData({...formData, company_name: e.target.value})} 
            />
          </label>
          <label style={labelStyle}>
            CIF / NIF
            <input 
              type="text" 
              style={inputStyle} 
              value={formData.cif || ''} 
              onChange={e => setFormData({...formData, cif: e.target.value})} 
            />
          </label>
        </div>

        {/* CONTACTO */}
        <h4 style={sectionTitleStyle}>üë§ Contacto Principal</h4>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
          <label style={labelStyle}>
            Nombre Completo
            <input 
              type="text" 
              style={inputStyle} 
              value={formData.full_name || ''} 
              onChange={e => setFormData({...formData, full_name: e.target.value})} 
            />
          </label>
          <label style={labelStyle}>
            Tel√©fono
            <input 
              type="tel" 
              style={inputStyle} 
              value={formData.phone || ''} 
              onChange={e => setFormData({...formData, phone: e.target.value})} 
            />
          </label>
        </div>
        
        {/* NUEVO: EMAIL DE CONTACTO */}
        <label style={labelStyle}>
            Email de Contacto (CRM)
            <input 
              type="email" 
              style={inputStyle} 
              value={formData.email || ''} 
              onChange={e => setFormData({...formData, email: e.target.value})} 
              placeholder="ejemplo@empresa.com"
            />
        </label>

        <label style={labelStyle}>
            Email para Facturaci√≥n (si es distinto)
            <input 
              type="email" 
              style={inputStyle} 
              value={formData.billing_email || ''} 
              onChange={e => setFormData({...formData, billing_email: e.target.value})} 
              placeholder="contabilidad@empresa.com..."
            />
        </label>

        {/* DIRECCIONES */}
        <h4 style={sectionTitleStyle}>üìç Direcciones</h4>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
            <label style={labelStyle}>
                Direcci√≥n de Env√≠o
                <textarea 
                rows={3}
                style={{...inputStyle, resize: 'none'}} 
                value={formData.shipping_address || ''} 
                onChange={e => setFormData({...formData, shipping_address: e.target.value})} 
                />
            </label>
            <label style={labelStyle}>
                Direcci√≥n de Facturaci√≥n
                <textarea 
                rows={3}
                style={{...inputStyle, resize: 'none'}} 
                value={formData.billing_address || ''} 
                onChange={e => setFormData({...formData, billing_address: e.target.value})} 
                />
            </label>
        </div>

        {/* OBSERVACIONES */}
        <h4 style={sectionTitleStyle}>üìù Otros</h4>
        <label style={labelStyle}>
            Observaciones Generales
            <textarea 
              rows={2}
              style={{...inputStyle, resize: 'none'}} 
              value={formData.observations || ''} 
              onChange={e => setFormData({...formData, observations: e.target.value})} 
            />
        </label>

        <div style={{ marginTop: '30px', display: 'flex', justifyContent: 'flex-end' }}>
          <button 
            onClick={handleSave} 
            disabled={loading}
            style={{ 
              background: '#3b82f6', 
              color: 'white', 
              border: 'none', 
              padding: '12px 30px', 
              borderRadius: '6px', 
              fontWeight: 'bold', 
              cursor: loading ? 'wait' : 'pointer',
              opacity: loading ? 0.7 : 1
            }}
          >
            {loading ? 'Guardando...' : 'Guardar Cambios'}
          </button>
        </div>

      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/data/fence_presets.ts">
// --- START OF FILE src/features/editor/data/fence_presets.ts ---
export interface FencePreset {
    name: string;
    ref: string;
    price: number;
    postType: 'square' | 'round';
    postWidth?: number;
    postRadius?: number;
    postHeight: number;
    railType: 'frame' | 'none';
    railShape?: 'square' | 'round';
    railThickness?: number;
    railRadius?: number;
    slatWidth: number;
    slatThickness: number;
    slatGap?: number;
    fixedCount?: number;
    multiColor?: boolean;
    isSolidPanel?: boolean;
    defaultColors: {
        post: number;
        slatA: number;
        slatB?: number;
        slatC?: number;
    };
}

export const FENCE_PRESETS: Record<string, FencePreset> = {
    "wood": {
        name: "Valla Madera Cl√°sica",
        ref: "VALMAD-01",
        price: 36,
        postType: "square",
        postWidth: 0.1,
        postHeight: 1.0,
        railType: "frame",
        railShape: "square",
        railThickness: 0.08, 
        slatWidth: 0.1,
        slatThickness: 0.02,
        slatGap: 0.05,
        defaultColors: { 
            post: 0x8b5a2b, 
            slatA: 0xd2b48c 
        }
    },
    "metal_slats": {
        name: "Valla Met√°lica Fina",
        ref: "VALFN-01",
        price: 42,
        postType: "round",
        postRadius: 0.04,
        postHeight: 1.0,
        railType: "frame",
        railShape: "round",
        railRadius: 0.03,
        slatWidth: 0.08,
        slatThickness: 0.01,
        fixedCount: 9,
        multiColor: true,
        defaultColors: { 
            post: 0x1a1a1a, 
            slatA: 0xcccccc, 
            slatB: 0x888888, 
            slatC: 0x444444 
        }
    },
    "wide_panel": {
        name: "Valla Met√°lica Ancha",
        ref: "VALAN-01",
        price: 45,
        postType: "round",
        postRadius: 0.04,
        postHeight: 1.0,
        railType: "frame",
        railShape: "round",
        railRadius: 0.04,
        slatWidth: 0.20,
        slatThickness: 0.02,
        fixedCount: 6,
        multiColor: true,
        defaultColors: { 
            post: 0x222222, 
            slatA: 0x22c55e, 
            slatB: 0x3b82f6, 
            slatC: 0xeab308 
        }
    },
    "game_panel": {
        name: "Valla Lisa / Panel",
        ref: "VALLI-01",
        price: 61,
        postType: "round",
        postRadius: 0.04,
        postHeight: 1.0,
        railType: "frame",
        railShape: "round",
        railRadius: 0.03,
        isSolidPanel: true,
        slatWidth: 1.0,
        slatThickness: 0.02,
        defaultColors: { 
            post: 0x111111, 
            slatA: 0xffffff 
        }
    }
};
// --- END OF FILE src/features/editor/data/fence_presets.ts ---
</file>

<file path="src/features/editor/Editor3D.tsx">
// --- START OF FILE src/features/editor/Editor3D.tsx ---
import React, { useEffect, useRef } from "react";
import { A42Engine } from "./engine/A42Engine";

import { Toolbar } from "./ui/Toolbar";
import { BudgetPanel } from "./ui/BudgetPanel";
import { EnvironmentPanel } from "./ui/EnvironmentPanel";
import { FloorProperties } from "./ui/FloorProperties";
import { FenceProperties } from "./ui/FenceProperties";
import { InputModal } from "./ui/InputModal";
import { QRModal } from "./ui/QRModal";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { useProjectStore } from "@/stores/project/useProjectStore";

import {
  Euro,
  Move,
  RotateCw,
  Scaling,
  Trash2,
  Copy,
  QrCode,
} from "lucide-react";

export const Editor3D = () => {
  const containerRef = useRef<HTMLDivElement>(null);
  const engineRef = useRef<A42Engine | null>(null);

  // --- STORES ---
  const {
    mode,
    gridVisible,
    items,
    cameraType,
    pendingView,
    clearPendingView,
    sunPosition,
    backgroundColor,
    safetyZonesVisible,
    totalPrice,
  } = useEditorStore();

  const {
    selectedItemId,
    duplicateSelection,
    removeSelection,
    measuredDistance,
  } = useSelectionStore();

  const { isReadOnlyMode } = useProjectStore();

  const [qrVisible, setQRVisible] = React.useState(false);

  // --------------------------
  // INIT ENGINE
  // --------------------------
  useEffect(() => {
    if (!containerRef.current) return;

    const engine = new A42Engine(containerRef.current);
    engine.init();

    const canvas = engine.renderer.domElement as HTMLCanvasElement;
    if (canvas) {
      canvas.style.pointerEvents = "auto";
      canvas.style.touchAction = "none";
    }

    engineRef.current = engine;
    // @ts-ignore
    window.editorEngine = engine;

    engine.setGridVisible(gridVisible);
    engine.updateSunPosition(sunPosition.azimuth, sunPosition.elevation);

    if (backgroundColor === "#111111") engine.setSkyVisible(true);
    else engine.setBackgroundColor(backgroundColor);

    return () => engine.dispose();
  }, []);

  // --------------------------
  // REACTIONS
  // --------------------------
  useEffect(() => {
    engineRef.current?.syncSceneFromStore(items);
  }, [items]);

  useEffect(() => {
    engineRef.current?.setGridVisible(gridVisible);
  }, [gridVisible]);

  useEffect(() => {
    const eng = engineRef.current;
    if (!eng) return;

    eng.switchCamera(cameraType);
    eng.interactionManager.updateCamera(eng.activeCamera);
  }, [cameraType]);

  useEffect(() => {
    engineRef.current?.updateSafetyZones(safetyZonesVisible);
  }, [safetyZonesVisible]);

  useEffect(() => {
    engineRef.current?.updateSunPosition(
      sunPosition.azimuth,
      sunPosition.elevation
    );
  }, [sunPosition]);

  useEffect(() => {
    if (!pendingView) return;
    engineRef.current?.setView(pendingView);
    clearPendingView();
  }, [pendingView, clearPendingView]);

  useEffect(() => {
    if (backgroundColor === "#111111") engineRef.current?.setSkyVisible(true);
    else engineRef.current?.setBackgroundColor(backgroundColor);
  }, [backgroundColor]);

  return (
    <div className="w-screen h-screen relative bg-neutral-900 overflow-hidden">
      <div
        ref={containerRef}
        className="absolute inset-0 z-0"

        onPointerDown={(e) =>
          engineRef.current?.interactionManager.onPointerDown(e.nativeEvent)
        }
        onPointerMove={(e) =>
          engineRef.current?.interactionManager.onPointerMove(e.nativeEvent)
        }
        onPointerUp={(e) =>
          engineRef.current?.interactionManager.onPointerUp(e.nativeEvent)
        }

        onContextMenu={(e) => e.preventDefault()}
      />

      <BudgetPanel />
      <EnvironmentPanel />
      <FloorProperties />
      <FenceProperties />

      <button
        onClick={() => setQRVisible(true)}
        className="absolute top-6 right-6 z-20 bg-neutral-800/90 hover:bg-neutral-700 text-white p-3 rounded-full border border-neutral-600 shadow-lg"
      >
        <QrCode size={20} />
      </button>

      {!isReadOnlyMode && (
        <div className="absolute bottom-6 left-6 z-20">
          <button className="bg-neutral-800/90 px-4 py-3 rounded-full border border-neutral-600 text-white flex gap-3 items-center">
            <Euro size={18} />
            <span className="text-lg">{totalPrice.toLocaleString()} ‚Ç¨</span>
          </button>
        </div>
      )}

      {selectedItemId && mode === "editing" && (
        <div className="absolute bottom-20 left-1/2 -translate-x-1/2 flex gap-2 glass-panel p-2 rounded-xl">
          <button onClick={() => engineRef.current?.setGizmoMode("translate")}>
            <Move size={16} />
          </button>
          <button onClick={() => engineRef.current?.setGizmoMode("rotate")}>
            <RotateCw size={16} />
          </button>
          <button onClick={() => engineRef.current?.setGizmoMode("scale")}>
            <Scaling size={16} />
          </button>

          <button onClick={duplicateSelection}>
            <Copy size={16} />
          </button>

          <button onClick={removeSelection}>
            <Trash2 size={16} />
          </button>
        </div>
      )}

      {mode === "measuring" && (
        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black/80 px-6 py-3 text-white rounded-full border border-white/20 backdrop-blur-md font-mono">
          {measuredDistance !== null
            ? `Distancia: ${measuredDistance.toFixed(2)} m`
            : "Selecciona punto A y B"}
        </div>
      )}

      <Toolbar />
      <QRModal isOpen={qrVisible} onClose={() => setQRVisible(false)} />

      <InputModal />

      <div className="absolute bottom-6 right-6 text-white/5 font-black text-4xl pointer-events-none select-none">
        A42
      </div>
    </div>
  );
};
// --- END OF FILE ---
</file>

<file path="src/features/editor/engine/A42Engine_old_gpt_01.txt">
// --- START OF FILE src/features/editor/engine/A42Engine.ts ---
import * as THREE from "three";
import { ARButton } from "three/examples/jsm/webxr/ARButton.js";

import type { SceneItem, CameraView, CameraType } from "@/types/editor";

import { SceneManager } from "./managers/SceneManager";
import { ObjectManager } from "./managers/ObjectManager";
import { ToolsManager } from "./managers/ToolsManager";
import { InteractionManager } from "./managers/InteractionManager";
import { WalkManager } from "./managers/WalkManager";
import { RecorderManager } from "./managers/RecorderManager";
import { ExportManager } from "./managers/ExportManager";
import { PDFManager } from "./managers/PDFManager";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export class A42Engine {
  public sceneManager: SceneManager;
  public objectManager: ObjectManager;
  public toolsManager: ToolsManager;
  public interactionManager: InteractionManager;
  public walkManager: WalkManager;
  public recorderManager: RecorderManager;
  public exportManager: ExportManager;
  public pdfManager: PDFManager;

  private clock: THREE.Clock;
  private savedBackground: THREE.Color | THREE.Texture | null = null;
  private wasSkyVisible = true;
  private transparentElements: HTMLElement[] = [];

  constructor(container: HTMLElement) {
    this.clock = new THREE.Clock();

    // --- CORE MANAGERS ---
    this.sceneManager = new SceneManager(container);
    this.sceneManager.renderer.xr.enabled = true;

    this.objectManager = new ObjectManager(this.sceneManager.scene);
    this.toolsManager = new ToolsManager(this.sceneManager.scene);
    this.interactionManager = new InteractionManager(this);
    this.walkManager = new WalkManager(this);
    this.recorderManager = new RecorderManager(this);
    this.exportManager = new ExportManager(this);
    this.pdfManager = new PDFManager(this);

    // --- GLOBAL EVENTS ---
    window.addEventListener("resize", this.onWindowResize);
    window.addEventListener("keydown", this.onKeyDown);

    // Exponer para debug
    // @ts-ignore
    window.editorEngine = this;
  }

  // -------------------------------------------------------
  // GETTERS C√ìMODOS
  // -------------------------------------------------------
  public get scene() {
    return this.sceneManager.scene;
  }
  public get activeCamera() {
    return this.sceneManager.activeCamera;
  }
  public get renderer() {
    return this.sceneManager.renderer;
  }

  // -------------------------------------------------------
  // INPUT RAT√ìN DESDE REACT
  // -------------------------------------------------------
  public onMouseDown = (event: MouseEvent) => {
    this.interactionManager.onMouseDown(event);
  };

  // -------------------------------------------------------
  // AJUSTES DE ESCENA
  // -------------------------------------------------------
  public setBackgroundColor(color: string) {
    this.sceneManager.setBackgroundColor(color);
  }
  public setSkyVisible(visible: boolean) {
    this.sceneManager.setSkyVisible(visible);
  }
  public setGridVisible(v: boolean) {
    this.sceneManager.setGridVisible(v);
  }
  public updateSunPosition(azimuth: number, elevation: number) {
    this.sceneManager.updateSunPosition(azimuth, elevation);
  }

  // Marco portada PDF
  public togglePDFFraming(visible: boolean) {
    this.sceneManager.setFrameVisible(visible);
  }

  // -------------------------------------------------------
  // C√ÅMARAS / VISTAS
  // -------------------------------------------------------
  public switchCamera(type: CameraType) {
    this.sceneManager.switchCamera(type);

    // actualizar c√°mara en control orbital y gizmo
    this.sceneManager.controls.object = this.sceneManager.activeCamera;
    this.interactionManager.updateCamera(this.sceneManager.activeCamera);
  }

  public setView(view: CameraView) {
    this.sceneManager.setView(view);
  }

  // -------------------------------------------------------
  // TOOLS / GIZMO
  // -------------------------------------------------------
  public clearTools() {
    this.toolsManager.clearTools();
    if (this.interactionManager.transformControl) {
      this.interactionManager.transformControl.detach();
      this.interactionManager.transformControl.visible = false;
    }
  }

  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    this.interactionManager.setGizmoMode(mode);
  }

  // -------------------------------------------------------
  // SAFETY ZONES
  // -------------------------------------------------------
  public updateSafetyZones(visible: boolean) {
    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone) {
        obj.visible = visible;
      }
    });
  }

  public checkSafetyCollisions() {
    const { safetyZonesVisible } = useEditorStore.getState();
    if (!safetyZonesVisible) return;

    const zones: THREE.Mesh[] = [];
    const boxes: THREE.Box3[] = [];

    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone && obj.visible) {
        zones.push(obj as THREE.Mesh);
        boxes.push(new THREE.Box3().setFromObject(obj));

        (obj as THREE.Mesh).material = new THREE.MeshBasicMaterial({
          color: 0xff0000,
          transparent: true,
          opacity: 0.3,
          depthWrite: false,
          side: THREE.DoubleSide,
        });
      }
    });

    for (let i = 0; i < zones.length; i++) {
      for (let j = i + 1; j < zones.length; j++) {
        if (boxes[i].intersectsBox(boxes[j])) {
          const alertMat = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.8,
            depthWrite: false,
            side: THREE.DoubleSide,
          });
          zones[i].material = alertMat;
          zones[j].material = alertMat;
        }
      }
    }
  }

  public isObjectColliding(target: THREE.Object3D): boolean {
    const { safetyZonesVisible } = useEditorStore.getState();
    if (!safetyZonesVisible) return false;

    const targetZones: THREE.Box3[] = [];
    target.traverse((child) => {
      if (child.userData?.isSafetyZone) {
        targetZones.push(new THREE.Box3().setFromObject(child));
      }
    });

    if (targetZones.length === 0) return false;

    const otherZones: THREE.Box3[] = [];
    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone && obj.visible) {
        let isChildOfTarget = false;
        let parent = obj.parent;
        while (parent) {
          if (parent === target) {
            isChildOfTarget = true;
            break;
          }
          parent = parent.parent;
        }
        if (!isChildOfTarget) {
          otherZones.push(new THREE.Box3().setFromObject(obj));
        }
      }
    });

    for (const tBox of targetZones) {
      for (const oBox of otherZones) {
        if (tBox.intersectsBox(oBox)) {
          return true;
        }
      }
    }

    return false;
  }

  // -------------------------------------------------------
  // AR INIT
  // -------------------------------------------------------
  private async initAR() {
    if (!("xr" in navigator)) return;
    try {
      // @ts-ignore
      const isSupported = await navigator.xr.isSessionSupported("immersive-ar");
      if (!isSupported) return;
    } catch {
      return;
    }

    const arBtn = ARButton.createButton(this.renderer, {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body },
    });

    this.renderer.xr.addEventListener("sessionstart", () => {
      this.savedBackground = this.scene.background;
      this.wasSkyVisible = this.sceneManager.sky
        ? this.sceneManager.sky.visible
        : false;

      this.scene.background = null;
      this.setSkyVisible(false);
      this.setGridVisible(false);
      this.renderer.setClearColor(0x000000, 0);

      this.transparentElements = [];
      let el: HTMLElement | null = this.renderer.domElement;
      while (el && el !== document.documentElement) {
        this.transparentElements.push(el);
        el.style.setProperty("background", "transparent", "important");
        el.style.setProperty("background-color", "transparent", "important");
        el = el.parentElement;
      }
      document.body.style.setProperty("background", "transparent", "important");
      document.documentElement.style.setProperty(
        "background",
        "transparent",
        "important"
      );
    });

    this.renderer.xr.addEventListener("sessionend", () => {
      const { gridVisible } = useEditorStore.getState();

      if (this.savedBackground) this.scene.background = this.savedBackground;
      if (this.wasSkyVisible) this.setSkyVisible(true);
      this.setGridVisible(gridVisible);

      this.transparentElements.forEach((el) => {
        el.style.removeProperty("background");
        el.style.removeProperty("background-color");
      });
      document.body.style.removeProperty("background");
      document.documentElement.style.removeProperty("background");
    });

    const arContainer = document.createElement("div");
    arContainer.style.position = "absolute";
    arContainer.style.bottom = "20px";
    arContainer.style.right = "20px";
    arContainer.style.zIndex = "1000";
    arContainer.style.display = "flex";
    arContainer.style.justifyContent = "flex-end";
    arContainer.style.pointerEvents = "none";

    arBtn.style.position = "static";
    arBtn.style.transform = "none";
    arBtn.style.left = "auto";
    arBtn.style.bottom = "auto";
    arBtn.style.width = "160px";
    arBtn.style.background = "rgba(0,0,0,0.85)";
    arBtn.style.border = "1px solid rgba(255,255,255,0.3)";
    arBtn.style.borderRadius = "30px";
    arBtn.style.color = "#fff";
    arBtn.style.fontFamily = "sans-serif";
    arBtn.style.fontSize = "12px";
    arBtn.style.fontWeight = "bold";
    arBtn.style.padding = "10px 0";
    arBtn.style.cursor = "pointer";
    arBtn.style.pointerEvents = "auto";

    arContainer.appendChild(arBtn);
    document.body.appendChild(arContainer);
  }

  // -------------------------------------------------------
  // SYNC ESCENA <-> STORE
  //  (MODELO 1: NO RECREAR SI NO HACE FALTA)
  // -------------------------------------------------------
  public async syncSceneFromStore(storeItems: SceneItem[]) {
    // mapa de objetos de escena actuales
    const sceneItemsMap = new Map<string, THREE.Object3D>();
    this.scene.children.forEach((child) => {
      if (child.userData?.isItem && child.uuid) {
        sceneItemsMap.set(child.uuid, child);
      }
    });

    for (const item of storeItems) {
      const sceneObj = sceneItemsMap.get(item.uuid);

      if (sceneObj) {
        // ---------- FLOOR ----------
        if (item.type === "floor") {
          const hasChanged =
            JSON.stringify(sceneObj.userData.points) !==
              JSON.stringify(item.points) ||
            sceneObj.userData.floorMaterial !== item.floorMaterial ||
            sceneObj.userData.textureUrl !== item.textureUrl ||
            sceneObj.userData.textureScale !== item.textureScale ||
            sceneObj.userData.textureRotation !== item.textureRotation;

          if (hasChanged) {
            this.scene.remove(sceneObj);
            this.objectManager.recreateFloor(item);
            sceneItemsMap.delete(item.uuid);
            continue;
          }
        }

        // ---------- FENCE ----------
        if (item.type === "fence") {
          const hasConfigChanged =
            JSON.stringify(sceneObj.userData.fenceConfig) !==
            JSON.stringify(item.fenceConfig);
          const hasPointsChanged =
            JSON.stringify(sceneObj.userData.points) !==
            JSON.stringify(item.points);

          if (hasConfigChanged || hasPointsChanged) {
            this.scene.remove(sceneObj);
            this.objectManager.recreateFence(item);
            sceneItemsMap.delete(item.uuid);
            continue;
          }
        }

        // ---------- MODEL / TRANSFORM ----------
        sceneObj.position.fromArray(item.position);
        sceneObj.rotation.fromArray(item.rotation);
        sceneObj.scale.fromArray(item.scale);
        sceneItemsMap.delete(item.uuid);
      } else {
        // No existe en escena ‚Üí crearlo
        if (item.type === "model" && item.modelUrl) {
          await this.objectManager.recreateModel(item);
        } else if (item.type === "floor" && item.points) {
          this.objectManager.recreateFloor(item);
        } else if (item.type === "fence" && item.points) {
          this.objectManager.recreateFence(item);
        }
      }
    }

    // Eliminar objetos que sobran
    for (const [uuid, obj] of sceneItemsMap) {
      this.scene.remove(obj);

      if (this.interactionManager.transformControl?.object?.uuid === uuid) {
        this.interactionManager.transformControl.detach();
        this.interactionManager.transformControl.visible = false;
      }
      if (this.toolsManager.activeFloorId === uuid) {
        this.toolsManager.activeFloorId = null;
        this.toolsManager.clearFloorEditMarkers();
      }
    }
  }

  // -------------------------------------------------------
  // INPUT / TECLAS
  // -------------------------------------------------------
  private onKeyDown = (e: KeyboardEvent) => {
    if (this.walkManager.isEnabled) return;

    const editor = useEditorStore.getState();
    const selection = useSelectionStore.getState();

    if (editor.mode !== "editing") return;

    // CTRL+Z -> undo
    if (e.key === "z" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      editor.undo();
      return;
    }

    const tc = this.interactionManager.transformControl;
    if (!tc?.visible) return;

    if (e.key === "t") tc.setMode("translate");
    else if (e.key === "r") tc.setMode("rotate");
    else if (e.key === "e") tc.setMode("scale");
    else if (e.key === "Delete" || e.key === "Backspace") {
      const obj = tc.object;
      if (obj && !obj.userData.isFloorMarker) {
        tc.detach();
        tc.visible = false;
        this.scene.remove(obj);
        this.sceneManager.controls.enabled = true;

        editor.removeItem(obj.uuid);
        selection.selectItem(null);
        this.toolsManager.activeFloorId = null;
        this.toolsManager.clearFloorEditMarkers();
      }
    }
  };

  private onWindowResize = () => {
    this.sceneManager.onWindowResize();
  };

  // -------------------------------------------------------
  // CICLO VIDA
  // -------------------------------------------------------
  public init() {
    this.initAR();
    this.renderer.setAnimationLoop(this.render);
  }

  private render = () => {
    const delta = this.clock.getDelta();
    this.walkManager.update(delta);
    this.recorderManager.update(delta);

    this.checkSafetyCollisions();

    if (!this.walkManager.isEnabled) {
      this.sceneManager.controls.update();
    }
    this.sceneManager.renderer.render(this.scene, this.activeCamera);
  };

  public dispose() {
    this.renderer.setAnimationLoop(null);
    window.removeEventListener("keydown", this.onKeyDown);
    window.removeEventListener("resize", this.onWindowResize);
    this.sceneManager.dispose();
  }
}
// --- END OF FILE src/features/editor/engine/A42Engine.ts ---
</file>

<file path="src/features/editor/engine/A42Engine_old_gpt.txt">
// --- START OF FILE src/features/editor/engine/A42Engine.ts ---
import * as THREE from "three";
import { ARButton } from "three/examples/jsm/webxr/ARButton.js";

import type { SceneItem, CameraView } from "@/types/editor";

import { SceneManager } from "./managers/SceneManager";
import { ObjectManager } from "./managers/ObjectManager";
import { ToolsManager } from "./managers/ToolsManager";
import { InteractionManager } from "./managers/InteractionManager";
import { WalkManager } from "./managers/WalkManager";
import { RecorderManager } from "./managers/RecorderManager";
import { ExportManager } from "./managers/ExportManager";
import { PDFManager } from "./managers/PDFManager";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export class A42Engine {
  public sceneManager: SceneManager;
  public objectManager: ObjectManager;
  public toolsManager: ToolsManager;
  public interactionManager: InteractionManager;
  public walkManager: WalkManager;
  public recorderManager: RecorderManager;
  public exportManager: ExportManager;
  public pdfManager: PDFManager;

  private clock: THREE.Clock;
  private savedBackground: THREE.Color | THREE.Texture | null = null;
  private wasSkyVisible: boolean = true;
  private transparentElements: HTMLElement[] = [];

  constructor(container: HTMLElement) {
    this.clock = new THREE.Clock();

    this.sceneManager = new SceneManager(container);
    this.sceneManager.renderer.xr.enabled = true;

    this.objectManager = new ObjectManager(this.sceneManager.scene);
    this.toolsManager = new ToolsManager(this.sceneManager.scene);
    this.interactionManager = new InteractionManager(this);
    this.walkManager = new WalkManager(this);
    this.recorderManager = new RecorderManager(this);
    this.exportManager = new ExportManager(this);
    this.pdfManager = new PDFManager(this);

    window.addEventListener("resize", this.onWindowResize);
    window.addEventListener("keydown", this.onKeyDown);

    // @ts-ignore
    window.editorEngine = this;
  }

  public get scene() {
    return this.sceneManager.scene;
  }
  public get activeCamera() {
    return this.sceneManager.activeCamera;
  }
  public get renderer() {
    return this.sceneManager.renderer;
  }

  public onMouseDown = (event: MouseEvent) => {
    this.interactionManager.onMouseDown(event);
  };

  public setBackgroundColor(color: string) {
    this.sceneManager.setBackgroundColor(color);
  }
  public setSkyVisible(visible: boolean) {
    this.sceneManager.setSkyVisible(visible);
  }
  public setGridVisible(v: boolean) {
    this.sceneManager.setGridVisible(v);
  }
  public updateSunPosition(azimuth: number, elevation: number) {
    this.sceneManager.updateSunPosition(azimuth, elevation);
  }

  // Marco portada PDF
  public togglePDFFraming(visible: boolean) {
    this.sceneManager.setFrameVisible(visible);
  }

  public switchCamera(type: "perspective" | "orthographic") {
    this.sceneManager.switchCamera(type);
    this.interactionManager.updateCamera(this.sceneManager.activeCamera);
  }

  public setView(view: CameraView) {
    this.sceneManager.setView(view);
  }

  public clearTools() {
    this.toolsManager.clearTools();
    if (this.interactionManager.transformControl) {
      this.interactionManager.transformControl.detach();
    }
  }

  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    this.interactionManager.setGizmoMode(mode);
  }

  public updateSafetyZones(visible: boolean) {
    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone) {
        obj.visible = visible;
      }
    });
  }

  // ---------------- SAFETY COLLISIONS ----------------

  public checkSafetyCollisions() {
    const { safetyZonesVisible } = useEditorStore.getState();
    if (!safetyZonesVisible) return;

    const zones: THREE.Mesh[] = [];
    const boxes: THREE.Box3[] = [];

    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone && obj.visible) {
        zones.push(obj as THREE.Mesh);
        boxes.push(new THREE.Box3().setFromObject(obj));

        (obj as THREE.Mesh).material = new THREE.MeshBasicMaterial({
          color: 0xff0000,
          transparent: true,
          opacity: 0.3,
          depthWrite: false,
          side: THREE.DoubleSide,
        });
      }
    });

    for (let i = 0; i < zones.length; i++) {
      for (let j = i + 1; j < zones.length; j++) {
        if (boxes[i].intersectsBox(boxes[j])) {
          const alertMat = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.8,
            depthWrite: false,
            side: THREE.DoubleSide,
          });
          zones[i].material = alertMat;
          zones[j].material = alertMat;
        }
      }
    }
  }

  public isObjectColliding(target: THREE.Object3D): boolean {
    const { safetyZonesVisible } = useEditorStore.getState();
    if (!safetyZonesVisible) return false;

    const targetZones: THREE.Box3[] = [];
    target.traverse((child) => {
      if (child.userData?.isSafetyZone) {
        targetZones.push(new THREE.Box3().setFromObject(child));
      }
    });

    if (targetZones.length === 0) return false;

    const otherZones: THREE.Box3[] = [];
    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone && obj.visible) {
        let isChildOfTarget = false;
        let parent = obj.parent;
        while (parent) {
          if (parent === target) {
            isChildOfTarget = true;
            break;
          }
          parent = parent.parent;
        }
        if (!isChildOfTarget) {
          otherZones.push(new THREE.Box3().setFromObject(obj));
        }
      }
    });

    for (const tBox of targetZones) {
      for (const oBox of otherZones) {
        if (tBox.intersectsBox(oBox)) {
          return true;
        }
      }
    }

    return false;
  }

  // ---------------- AR INIT ----------------

  private async initAR() {
    if (!("xr" in navigator)) return;
    try {
      // @ts-ignore
      const isSupported = await navigator.xr.isSessionSupported("immersive-ar");
      if (!isSupported) return;
    } catch (e) {
      return;
    }

    const arBtn = ARButton.createButton(this.renderer, {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body },
    });

    this.renderer.xr.addEventListener("sessionstart", () => {
      this.savedBackground = this.scene.background;
      this.wasSkyVisible = this.sceneManager.sky
        ? this.sceneManager.sky.visible
        : false;

      this.scene.background = null;
      this.setSkyVisible(false);
      this.setGridVisible(false);
      this.renderer.setClearColor(0x000000, 0);

      this.transparentElements = [];
      let el: HTMLElement | null = this.renderer.domElement;
      while (el && el !== document.documentElement) {
        this.transparentElements.push(el);
        el.style.setProperty("background", "transparent", "important");
        el.style.setProperty("background-color", "transparent", "important");
        el = el.parentElement;
      }
      document.body.style.setProperty("background", "transparent", "important");
      document.documentElement.style.setProperty(
        "background",
        "transparent",
        "important"
      );
    });

    this.renderer.xr.addEventListener("sessionend", () => {
      const { gridVisible } = useEditorStore.getState();

      if (this.savedBackground) this.scene.background = this.savedBackground;
      if (this.wasSkyVisible) this.setSkyVisible(true);
      this.setGridVisible(gridVisible);

      this.transparentElements.forEach((el) => {
        el.style.removeProperty("background");
        el.style.removeProperty("background-color");
      });
      document.body.style.removeProperty("background");
      document.documentElement.style.removeProperty("background");
    });

    const arContainer = document.createElement("div");
    arContainer.style.position = "absolute";
    arContainer.style.bottom = "20px";
    arContainer.style.right = "20px";
    arContainer.style.zIndex = "1000";
    arContainer.style.display = "flex";
    arContainer.style.justifyContent = "flex-end";
    arContainer.style.pointerEvents = "none";

    arBtn.style.position = "static";
    arBtn.style.transform = "none";
    arBtn.style.left = "auto";
    arBtn.style.bottom = "auto";
    arBtn.style.width = "160px";
    arBtn.style.background = "rgba(0,0,0,0.85)";
    arBtn.style.border = "1px solid rgba(255,255,255,0.3)";
    arBtn.style.borderRadius = "30px";
    arBtn.style.color = "#fff";
    arBtn.style.fontFamily = "sans-serif";
    arBtn.style.fontSize = "12px";
    arBtn.style.fontWeight = "bold";
    arBtn.style.padding = "10px 0";
    arBtn.style.cursor = "pointer";
    arBtn.style.pointerEvents = "auto";

    arContainer.appendChild(arBtn);
    document.body.appendChild(arContainer);
  }

  // ---------------- SYNC ESCENA <-> STORE ----------------

  public async syncSceneFromStore(storeItems: SceneItem[]) {
    const sceneItemsMap = new Map<string, THREE.Object3D>();
    this.scene.children.forEach((child) => {
      if (child.userData?.isItem && child.uuid) {
        sceneItemsMap.set(child.uuid, child);
      }
    });

    for (const item of storeItems) {
      const sceneObj = sceneItemsMap.get(item.uuid);
      if (sceneObj) {
        // FLOOR
        if (item.type === "floor") {
          const hasChanged =
            JSON.stringify(sceneObj.userData.points) !==
              JSON.stringify(item.points) ||
            sceneObj.userData.floorMaterial !== item.floorMaterial ||
            sceneObj.userData.textureUrl !== item.textureUrl ||
            sceneObj.userData.textureScale !== item.textureScale ||
            sceneObj.userData.textureRotation !== item.textureRotation;

          if (hasChanged) {
            this.scene.remove(sceneObj);
            this.objectManager.recreateFloor(item);
            sceneItemsMap.delete(item.uuid);
            continue;
          }
        }

        // FENCE
        if (item.type === "fence") {
          const hasConfigChanged =
            JSON.stringify(sceneObj.userData.fenceConfig) !==
            JSON.stringify(item.fenceConfig);
          const hasPointsChanged =
            JSON.stringify(sceneObj.userData.points) !==
            JSON.stringify(item.points);

          if (hasConfigChanged || hasPointsChanged) {
            this.scene.remove(sceneObj);
            this.objectManager.recreateFence(item);
            sceneItemsMap.delete(item.uuid);
            continue;
          }
        }

        // MODEL / TRANSFORM
        sceneObj.position.fromArray(item.position);
        sceneObj.rotation.fromArray(item.rotation);
        sceneObj.scale.fromArray(item.scale);
        sceneItemsMap.delete(item.uuid);
      } else {
        if (item.type === "model" && item.modelUrl) {
          await this.objectManager.recreateModel(item);
        } else if (item.type === "floor" && item.points) {
          this.objectManager.recreateFloor(item);
        } else if (item.type === "fence" && item.points) {
          this.objectManager.recreateFence(item);
        }
      }
    }

    // Eliminar objetos que sobran
    for (const [uuid, obj] of sceneItemsMap) {
      this.scene.remove(obj);
      if (this.interactionManager.transformControl?.object?.uuid === uuid) {
        this.interactionManager.transformControl.detach();
      }
      if (this.toolsManager.activeFloorId === uuid) {
        this.toolsManager.activeFloorId = null;
        this.toolsManager.clearFloorEditMarkers();
      }
    }
  }

  // ---------------- INPUT / TECLAS ----------------

  private onKeyDown = (e: KeyboardEvent) => {
    if (this.walkManager.isEnabled) return;

    const editor = useEditorStore.getState();
    const selection = useSelectionStore.getState();

    if (editor.mode !== "editing") return;

    // CTRL+Z -> undo
    if (e.key === "z" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      editor.undo();
      return;
    }

    const tc = this.interactionManager.transformControl;
    if (!tc?.visible) return;

    if (e.key === "t") tc.setMode("translate");
    else if (e.key === "r") tc.setMode("rotate");
    else if (e.key === "e") tc.setMode("scale");
    else if (e.key === "Delete" || e.key === "Backspace") {
      const obj = tc.object;
      if (obj && !obj.userData.isFloorMarker) {
        tc.detach();
        tc.visible = false;
        this.scene.remove(obj);
        this.sceneManager.controls.enabled = true;

        editor.removeItem(obj.uuid);
        selection.selectItem(null);
        this.toolsManager.activeFloorId = null;
        this.toolsManager.clearFloorEditMarkers();
      }
    }
  };

  private onWindowResize = () => {
    this.sceneManager.onWindowResize();
  };

  // ---------------- CICLO VIDA ----------------

  public init() {
    this.initAR();
    this.renderer.setAnimationLoop(this.render);
  }

  private render = () => {
    const delta = this.clock.getDelta();
    this.walkManager.update(delta);
    this.recorderManager.update(delta);

    this.checkSafetyCollisions();

    if (!this.walkManager.isEnabled) {
      this.sceneManager.controls.update();
    }
    this.sceneManager.renderer.render(this.scene, this.activeCamera);
  };

  public dispose() {
    this.renderer.setAnimationLoop(null);
    window.removeEventListener("keydown", this.onKeyDown);
    window.removeEventListener("resize", this.onWindowResize);
    this.sceneManager.dispose();
  }
}
// --- END OF FILE src/features/editor/engine/A42Engine.ts ---
</file>

<file path="src/features/editor/engine/A42Engine.ts">
// --- START OF FILE src/features/editor/engine/A42Engine.ts ---
import * as THREE from "three";
import { ARButton } from "three/examples/jsm/webxr/ARButton.js";

import type { SceneItem, CameraView, CameraType } from "@/types/editor";

import { SceneManager } from "./managers/SceneManager";
import { ObjectManager } from "./managers/ObjectManager";
import { ToolsManager } from "./managers/ToolsManager";
import { InteractionManager } from "./managers/InteractionManager";
import { WalkManager } from "./managers/WalkManager";
import { RecorderManager } from "./managers/RecorderManager";
import { ExportManager } from "./managers/ExportManager";
import { PDFManager } from "./managers/PDFManager";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export class A42Engine {
  public sceneManager: SceneManager;
  public objectManager: ObjectManager;
  public toolsManager: ToolsManager;
  public interactionManager: InteractionManager;
  public walkManager: WalkManager;
  public recorderManager: RecorderManager;
  public exportManager: ExportManager;
  public pdfManager: PDFManager;

  private clock: THREE.Clock;
  private savedBackground: THREE.Color | THREE.Texture | null = null;
  private wasSkyVisible = true;
  private transparentElements: HTMLElement[] = [];

  constructor(container: HTMLElement) {
    this.clock = new THREE.Clock();

    // --- CORE MANAGERS ---
    this.sceneManager = new SceneManager(container);
    this.sceneManager.renderer.xr.enabled = true;

    this.objectManager = new ObjectManager(this.sceneManager.scene);
    this.toolsManager = new ToolsManager(this.sceneManager.scene);
    this.interactionManager = new InteractionManager(this);
    this.walkManager = new WalkManager(this);
    this.recorderManager = new RecorderManager(this);
    this.exportManager = new ExportManager(this);
    this.pdfManager = new PDFManager(this);

    // --- GLOBAL EVENTS ---
    window.addEventListener("resize", this.onWindowResize);
    window.addEventListener("keydown", this.onKeyDown);

    // Exponer para debug
    // @ts-ignore
    window.editorEngine = this;
  }

  // -------------------------------------------------------
  // GETTERS C√ìMODOS
  // -------------------------------------------------------
  public get scene() {
    return this.sceneManager.scene;
  }
  public get activeCamera() {
    return this.sceneManager.activeCamera;
  }
  public get renderer() {
    return this.sceneManager.renderer;
  }

  // -------------------------------------------------------
  // INPUT RAT√ìN DESDE REACT
  // -------------------------------------------------------
  public onMouseDown = (event: MouseEvent) => {
    this.interactionManager.onMouseDown(event);
  };

  // -------------------------------------------------------
  // AJUSTES DE ESCENA
  // -------------------------------------------------------
  public setBackgroundColor(color: string) {
    this.sceneManager.setBackgroundColor(color);
  }
  public setSkyVisible(visible: boolean) {
    this.sceneManager.setSkyVisible(visible);
  }
  public setGridVisible(v: boolean) {
    this.sceneManager.setGridVisible(v);
  }
  public updateSunPosition(azimuth: number, elevation: number) {
    this.sceneManager.updateSunPosition(azimuth, elevation);
  }

  // Marco portada PDF
  public togglePDFFraming(visible: boolean) {
    this.sceneManager.setFrameVisible(visible);
  }

  // -------------------------------------------------------
  // C√ÅMARAS / VISTAS
  // -------------------------------------------------------
  public switchCamera(type: CameraType) {
    this.sceneManager.switchCamera(type);

    // actualizar c√°mara en control orbital y gizmo
    this.sceneManager.controls.object = this.sceneManager.activeCamera;
    this.interactionManager.updateCamera(this.sceneManager.activeCamera);
  }

  public setView(view: CameraView) {
    this.sceneManager.setView(view);
  }

  // -------------------------------------------------------
  // TOOLS / GIZMO
  // -------------------------------------------------------
  public clearTools() {
    this.toolsManager.clearTools();
    if (this.interactionManager.transformControl) {
      this.interactionManager.transformControl.detach();
      this.interactionManager.transformControl.visible = false;
    }
  }

  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    this.interactionManager.setGizmoMode(mode);
  }

  // -------------------------------------------------------
  // SAFETY ZONES
  // -------------------------------------------------------
  public updateSafetyZones(visible: boolean) {
    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone) {
        obj.visible = visible;
      }
    });
  }

  public checkSafetyCollisions() {
    const { safetyZonesVisible } = useEditorStore.getState();
    if (!safetyZonesVisible) return;

    const zones: THREE.Mesh[] = [];
    const boxes: THREE.Box3[] = [];

    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone && obj.visible) {
        zones.push(obj as THREE.Mesh);
        boxes.push(new THREE.Box3().setFromObject(obj));

        (obj as THREE.Mesh).material = new THREE.MeshBasicMaterial({
          color: 0xff0000,
          transparent: true,
          opacity: 0.3,
          depthWrite: false,
          side: THREE.DoubleSide,
        });
      }
    });

    for (let i = 0; i < zones.length; i++) {
      for (let j = i + 1; j < zones.length; j++) {
        if (boxes[i].intersectsBox(boxes[j])) {
          const alertMat = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.8,
            depthWrite: false,
            side: THREE.DoubleSide,
          });
          zones[i].material = alertMat;
          zones[j].material = alertMat;
        }
      }
    }
  }

  public isObjectColliding(target: THREE.Object3D): boolean {
    const { safetyZonesVisible } = useEditorStore.getState();
    if (!safetyZonesVisible) return false;

    const targetZones: THREE.Box3[] = [];
    target.traverse((child) => {
      if (child.userData?.isSafetyZone) {
        targetZones.push(new THREE.Box3().setFromObject(child));
      }
    });

    if (targetZones.length === 0) return false;

    const otherZones: THREE.Box3[] = [];
    this.scene.traverse((obj) => {
      if (obj.userData?.isSafetyZone && obj.visible) {
        let isChildOfTarget = false;
        let parent = obj.parent;
        while (parent) {
          if (parent === target) {
            isChildOfTarget = true;
            break;
          }
          parent = parent.parent;
        }
        if (!isChildOfTarget) {
          otherZones.push(new THREE.Box3().setFromObject(obj));
        }
      }
    });

    for (const tBox of targetZones) {
      for (const oBox of otherZones) {
        if (tBox.intersectsBox(oBox)) {
          return true;
        }
      }
    }

    return false;
  }

  // -------------------------------------------------------
  // AR INIT
  // -------------------------------------------------------
  private async initAR() {
    if (!("xr" in navigator)) return;
    try {
      // @ts-ignore
      const isSupported = await navigator.xr.isSessionSupported("immersive-ar");
      if (!isSupported) return;
    } catch {
      return;
    }

    const arBtn = ARButton.createButton(this.renderer, {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body },
    });

    this.renderer.xr.addEventListener("sessionstart", () => {
      this.savedBackground = this.scene.background;
      this.wasSkyVisible = this.sceneManager.sky
        ? this.sceneManager.sky.visible
        : false;

      this.scene.background = null;
      this.setSkyVisible(false);
      this.setGridVisible(false);
      this.renderer.setClearColor(0x000000, 0);

      this.transparentElements = [];
      let el: HTMLElement | null = this.renderer.domElement;
      while (el && el !== document.documentElement) {
        this.transparentElements.push(el);
        el.style.setProperty("background", "transparent", "important");
        el.style.setProperty("background-color", "transparent", "important");
        el = el.parentElement;
      }
      document.body.style.setProperty("background", "transparent", "important");
      document.documentElement.style.setProperty(
        "background",
        "transparent",
        "important"
      );
    });

    this.renderer.xr.addEventListener("sessionend", () => {
      const { gridVisible } = useEditorStore.getState();

      if (this.savedBackground) this.scene.background = this.savedBackground;
      if (this.wasSkyVisible) this.setSkyVisible(true);
      this.setGridVisible(gridVisible);

      this.transparentElements.forEach((el) => {
        el.style.removeProperty("background");
        el.style.removeProperty("background-color");
      });
      document.body.style.removeProperty("background");
      document.documentElement.style.removeProperty("background");
    });

    const arContainer = document.createElement("div");
    arContainer.style.position = "absolute";
    arContainer.style.bottom = "20px";
    arContainer.style.right = "20px";
    arContainer.style.zIndex = "1000";
    arContainer.style.display = "flex";
    arContainer.style.justifyContent = "flex-end";
    arContainer.style.pointerEvents = "none";

    arBtn.style.position = "static";
    arBtn.style.transform = "none";
    arBtn.style.left = "auto";
    arBtn.style.bottom = "auto";
    arBtn.style.width = "160px";
    arBtn.style.background = "rgba(0,0,0,0.85)";
    arBtn.style.border = "1px solid rgba(255,255,255,0.3)";
    arBtn.style.borderRadius = "30px";
    arBtn.style.color = "#fff";
    arBtn.style.fontFamily = "sans-serif";
    arBtn.style.fontSize = "12px";
    arBtn.style.fontWeight = "bold";
    arBtn.style.padding = "10px 0";
    arBtn.style.cursor = "pointer";
    arBtn.style.pointerEvents = "auto";

    arContainer.appendChild(arBtn);
    document.body.appendChild(arContainer);
  }

  // -------------------------------------------------------
  // SYNC ESCENA <-> STORE
  //  (MODELO 1: NO RECREAR SI NO HACE FALTA)
  // -------------------------------------------------------
  public async syncSceneFromStore(storeItems: SceneItem[]) {
    // mapa de objetos de escena actuales
    const sceneItemsMap = new Map<string, THREE.Object3D>();
    this.scene.children.forEach((child) => {
      if (child.userData?.isItem && child.uuid) {
        sceneItemsMap.set(child.uuid, child);
      }
    });

    for (const item of storeItems) {
      const sceneObj = sceneItemsMap.get(item.uuid);

      if (sceneObj) {
        // ---------- FLOOR ----------
        if (item.type === "floor") {
          const hasChanged =
            JSON.stringify(sceneObj.userData.points) !==
              JSON.stringify(item.points) ||
            sceneObj.userData.floorMaterial !== item.floorMaterial ||
            sceneObj.userData.textureUrl !== item.textureUrl ||
            sceneObj.userData.textureScale !== item.textureScale ||
            sceneObj.userData.textureRotation !== item.textureRotation;

          if (hasChanged) {
            this.scene.remove(sceneObj);
            this.objectManager.recreateFloor(item);
            sceneItemsMap.delete(item.uuid);
            continue;
          }
        }

        // ---------- FENCE ----------
        if (item.type === "fence") {
          const hasConfigChanged =
            JSON.stringify(sceneObj.userData.fenceConfig) !==
            JSON.stringify(item.fenceConfig);
          const hasPointsChanged =
            JSON.stringify(sceneObj.userData.points) !==
            JSON.stringify(item.points);

          if (hasConfigChanged || hasPointsChanged) {
            this.scene.remove(sceneObj);
            this.objectManager.recreateFence(item);
            sceneItemsMap.delete(item.uuid);
            continue;
          }
        }

        // ---------- MODEL / TRANSFORM ----------
        sceneObj.position.fromArray(item.position);
        sceneObj.rotation.fromArray(item.rotation);
        sceneObj.scale.fromArray(item.scale);
        sceneItemsMap.delete(item.uuid);
      } else {
        // No existe en escena ‚Üí crearlo
        if (item.type === "model" && item.modelUrl) {
          await this.objectManager.recreateModel(item);
        } else if (item.type === "floor" && item.points) {
          this.objectManager.recreateFloor(item);
        } else if (item.type === "fence" && item.points) {
          this.objectManager.recreateFence(item);
        }
      }
    }

    // Eliminar objetos que sobran
    for (const [uuid, obj] of sceneItemsMap) {
      this.scene.remove(obj);

      if (this.interactionManager.transformControl?.object?.uuid === uuid) {
        this.interactionManager.transformControl.detach();
        this.interactionManager.transformControl.visible = false;
      }
      if (this.toolsManager.activeFloorId === uuid) {
        this.toolsManager.activeFloorId = null;
        this.toolsManager.clearFloorEditMarkers();
      }
    }

  }

  // -------------------------------------------------------
  // INPUT / TECLAS
  // -------------------------------------------------------
  private onKeyDown = (e: KeyboardEvent) => {
    if (this.walkManager.isEnabled) return;

    const editor = useEditorStore.getState();
    const selection = useSelectionStore.getState();

    if (editor.mode !== "editing") return;

    // CTRL+Z -> undo
    if (e.key === "z" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      editor.undo();
      return;
    }

    const tc = this.interactionManager.transformControl;
    if (!tc?.visible) return;

    if (e.key === "t") tc.setMode("translate");
    else if (e.key === "r") tc.setMode("rotate");
    else if (e.key === "e") tc.setMode("scale");
    else if (e.key === "Delete" || e.key === "Backspace") {
      const obj = tc.object;
      if (obj && !obj.userData.isFloorMarker) {
        tc.detach();
        tc.visible = false;
        this.scene.remove(obj);
        this.sceneManager.controls.enabled = true;

        editor.removeItem(obj.uuid);
        selection.selectItem(null);
        this.toolsManager.activeFloorId = null;
        this.toolsManager.clearFloorEditMarkers();
      }
    }
  };

  private onWindowResize = () => {
    this.sceneManager.onWindowResize();
  };

  // -------------------------------------------------------
  // CICLO VIDA
  // -------------------------------------------------------
  public init() {
    this.initAR();
    this.renderer.setAnimationLoop(this.render);
  }

  private render = () => {
    const delta = this.clock.getDelta();
    this.walkManager.update(delta);
    this.recorderManager.update(delta);

    this.checkSafetyCollisions();

    if (!this.walkManager.isEnabled) {
      this.sceneManager.controls.update();
    }
    this.sceneManager.renderer.render(this.scene, this.activeCamera);
  };

  public dispose() {
    this.renderer.setAnimationLoop(null);
    window.removeEventListener("keydown", this.onKeyDown);
    window.removeEventListener("resize", this.onWindowResize);
    this.sceneManager.dispose();
  }
}
// --- END OF FILE src/features/editor/engine/A42Engine.ts ---
</file>

<file path="src/features/editor/engine/managers/ExportManager.ts">
// --- START OF FILE src/features/editor/engine/managers/ExportManager.ts ---
import * as THREE from "three";
import { GLTFExporter } from "three/examples/jsm/exporters/GLTFExporter.js";
import type { A42Engine } from "../A42Engine";
import { useEditorStore } from "@/stores/editor/useEditorStore";

export class ExportManager {
  private engine: A42Engine;

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  // --- 1. EXPORTAR A GLB ---
  public async exportGLB() {
    const name = await useEditorStore
      .getState()
      .requestInput("Nombre del archivo 3D (.glb):", "proyecto-3d");

    if (name === null) return;

    const exporter = new GLTFExporter();
    const exportableObjects: THREE.Object3D[] = [];

    this.engine.scene.traverse((child) => {
      if (child.userData?.isItem) {
        exportableObjects.push(child);
      }
    });

    if (exportableObjects.length === 0) {
      alert("No hay objetos para exportar.");
      return;
    }

    const exportGroup = new THREE.Group();
    exportableObjects.forEach((obj) => exportGroup.add(obj.clone()));

    exporter.parse(
      exportGroup,
      (gltf) => {
        const blob = new Blob([gltf as ArrayBuffer], {
          type: "application/octet-stream",
        });
        this.downloadFile(blob, `${name}.glb`);
      },
      (error) => {
        console.error("Error exportando GLB:", error);
        alert("Error al exportar GLB.");
      },
      { binary: true }
    );
  }

  // --- 2. EXPORTAR A DXF ---
  public async exportDXF() {
    const name = await useEditorStore
      .getState()
      .requestInput("Nombre del plano (.dxf):", "planta-cad");

    if (name === null) return;

    let dxf = this.getDXFHeader();
    this.engine.scene.updateMatrixWorld(true);

    this.engine.scene.traverse((child) => {
      if (!child.userData.isItem) return;

      if (child.userData.type === "floor" && child.userData.points) {
        const points = child.userData.points;
        const worldPoints = points.map((p: any) => {
          const vec = new THREE.Vector3(p.x, p.y, p.z);
          vec.applyMatrix4(child.matrixWorld);
          return vec;
        });

        for (let i = 0; i < worldPoints.length; i++) {
          const p1 = worldPoints[i];
          const p2 = worldPoints[(i + 1) % worldPoints.length];
          dxf += this.line(p1.x, -p1.z, p2.x, -p2.z, "SUELOS", 4);
        }
      } else {
        const layerName =
          child.userData.type === "fence" ? "VALLAS" : "MOBILIARIO";
        const layerColor = child.userData.type === "fence" ? 1 : 3;

        child.traverse((mesh) => {
          if ((mesh as THREE.Mesh).isMesh) {
            const geometry = (mesh as THREE.Mesh).geometry;
            const edges = new THREE.EdgesGeometry(geometry, 15);
            const positions = edges.attributes.position.array;

            if ((mesh as THREE.InstancedMesh).isInstancedMesh) {
              const instanced = mesh as THREE.InstancedMesh;
              const instanceMatrix = new THREE.Matrix4();

              for (let k = 0; k < instanced.count; k++) {
                instanced.getMatrixAt(k, instanceMatrix);
                const finalMatrix = new THREE.Matrix4();
                finalMatrix.multiplyMatrices(
                  instanced.matrixWorld,
                  instanceMatrix
                );
                dxf += this.drawGeometryPoints(
                  positions,
                  finalMatrix,
                  layerName,
                  layerColor
                );
              }
            } else {
              dxf += this.drawGeometryPoints(
                positions,
                mesh.matrixWorld,
                layerName,
                layerColor
              );
            }
          }
        });
      }
    });

    dxf += this.getDXFFooter();

    const blob = new Blob([dxf], { type: "application/dxf" });
    this.downloadFile(blob, `${name}.dxf`);
  }

  private drawGeometryPoints(
    positions: ArrayLike<number>,
    matrix: THREE.Matrix4,
    layer: string,
    color: number
  ): string {
    let output = "";
    for (let i = 0; i < positions.length; i += 6) {
      const v1 = new THREE.Vector3(
        positions[i],
        positions[i + 1],
        positions[i + 2]
      );
      const v2 = new THREE.Vector3(
        positions[i + 3],
        positions[i + 4],
        positions[i + 5]
      );

      v1.applyMatrix4(matrix);
      v2.applyMatrix4(matrix);

      output += this.line(v1.x, -v1.z, v2.x, -v2.z, layer, color);
    }
    return output;
  }

  private getDXFHeader() {
    return `0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1009\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n`;
  }
  private getDXFFooter() {
    return `0\nENDSEC\n0\nEOF`;
  }

  private line(
    x1: number,
    y1: number,
    x2: number,
    y2: number,
    layer: string,
    color: number
  ) {
    return `0\nLINE\n8\n${layer}\n62\n${color}\n10\n${x1.toFixed(
      4
    )}\n20\n${y1.toFixed(4)}\n11\n${x2.toFixed(4)}\n21\n${y2.toFixed(4)}\n`;
  }

  private downloadFile(blob: Blob, filename: string) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }, 100);
  }
}
// --- END OF FILE ---
</file>

<file path="src/features/editor/engine/managers/InteractionManager_old_gpt_01.txt">
// --- START OF FILE src/features/editor/engine/managers/InteractionManager.ts ---
import * as THREE from "three";
import { TransformControls } from "three/examples/jsm/controls/TransformControls.js";

import type { A42Engine } from "../A42Engine";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { useCatalogStore } from "@/stores/catalog/useCatalogStore";

export class InteractionManager {
  private engine: A42Engine;
  public transformControl: TransformControls | null = null;

  private raycaster: THREE.Raycaster;
  private pointer: THREE.Vector2;
  public interactionPlane: THREE.Mesh;

  public isDraggingGizmo = false;
  private dragStartPosition = new THREE.Vector3();

  constructor(engine: A42Engine) {
    this.engine = engine;
    this.raycaster = new THREE.Raycaster();
    this.pointer = new THREE.Vector2();

    // Plano "suelo" para colocar/dibujar cosas
    this.interactionPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(5000, 5000),
      new THREE.MeshBasicMaterial({ visible: false })
    );
    this.interactionPlane.rotation.x = -Math.PI / 2;
    this.interactionPlane.userData.isInteractionPlane = true;
    this.engine.scene.add(this.interactionPlane);

    this.initTransformControls();
  }

  // --------------------------------------------------
  // INIT TRANSFORM CONTROLS (GIZMO)
  // --------------------------------------------------
  private initTransformControls() {
    try {
      this.transformControl = new TransformControls(
        this.engine.activeCamera as THREE.Camera,
        this.engine.renderer.domElement
      );

      this.transformControl.rotationSnap = Math.PI / 12;

      // NO capas raras ‚Üí mismo layer que todo lo dem√°s
      this.engine.scene.add(this.transformControl);

      // --- Evento cuando empieza/termina drag ---
      this.transformControl.addEventListener(
        "dragging-changed",
        (event: any) => {
          const editor = useEditorStore.getState();

          this.isDraggingGizmo = event.value;
          this.engine.sceneManager.controls.enabled = !event.value;

          const obj = this.transformControl?.object;
          if (!obj) return;

          if (event.value) {
            // Empezar drag ‚Üí snapshot para UNDO
            this.dragStartPosition.copy(obj.position);
            editor.saveSnapshot();
          } else {
            // Terminar drag
            if (this.engine.isObjectColliding(obj)) {
              // Rebote si choca zona de seguridad
              this.animateRevert(obj, this.dragStartPosition);
            } else {
              if (obj.userData.isFloorMarker) {
                this.engine.toolsManager.updateFloorFromMarkers(obj);
              } else if (obj.userData.isItem) {
                this.engine.objectManager.adjustObjectToGround(obj);
                this.syncTransformToStore(obj);
              }
            }
          }
        }
      );

      // Ajustar al suelo mientras se mueve
      this.transformControl.addEventListener("objectChange", () => {
        const obj = this.transformControl?.object;
        if (obj && obj.userData.isItem && !this.isDraggingGizmo) {
          this.engine.objectManager.adjustObjectToGround(obj);
        }
      });

      this.transformControl.detach();
      this.transformControl.visible = false;
    } catch (e) {
      console.error("ERROR: TransformControls", e);
      this.transformControl = null;
    }
  }

  // --------------------------------------------------
  // REBOTE EN CASO DE COLISI√ìN
  // --------------------------------------------------
  private animateRevert(obj: THREE.Object3D, targetPos: THREE.Vector3) {
    const startPos = obj.position.clone();
    let t = 0;

    const animate = () => {
      t += 0.1;
      if (t >= 1) {
        obj.position.copy(targetPos);
        this.engine.checkSafetyCollisions();
        return;
      }
      obj.position.lerpVectors(startPos, targetPos, t);
      this.engine.checkSafetyCollisions();
      requestAnimationFrame(animate);
    };

    animate();
  }

  // --------------------------------------------------
  // ACTUALIZAR C√ÅMARA ACTIVA PARA EL GIZMO
  // --------------------------------------------------
  public updateCamera(camera: THREE.Camera) {
    if (this.transformControl) {
      this.transformControl.camera = camera;
    }
  }

  // --------------------------------------------------
  // MOUSE DOWN PRINCIPAL
  // --------------------------------------------------
  public onMouseDown = (event: MouseEvent) => {
    // Si estamos arrastrando el gizmo, no hacemos nada m√°s
    if (this.transformControl && this.isDraggingGizmo) return;

    const rect = this.engine.renderer.domElement.getBoundingClientRect();
    this.pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    this.pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    this.raycaster.setFromCamera(this.pointer, this.engine.activeCamera);

    const editor = useEditorStore.getState();
    const catalog = useCatalogStore.getState();
    const selectionStore = useSelectionStore.getState();

    const mode = editor.mode;

    // ----------------------------
    // DRAW FLOOR
    // ----------------------------
    if (mode === "drawing_floor") {
      const intersects = this.raycaster.intersectObject(this.interactionPlane);
      if (intersects.length > 0) {
        if (event.button === 0) {
          this.engine.toolsManager.addDraftPoint(intersects[0].point);
        } else if (event.button === 2) {
          if (this.engine.toolsManager.floorPoints.length >= 3) {
            this.engine.toolsManager.createSolidFloor();
          }
        }
      }
      return;
    }

    // ----------------------------
    // DRAW FENCE
    // ----------------------------
    if (mode === "drawing_fence") {
      const intersects = this.raycaster.intersectObject(this.interactionPlane);
      if (intersects.length > 0) {
        if (event.button === 0) {
          this.engine.toolsManager.addFenceDraftPoint(intersects[0].point);
        } else if (event.button === 2) {
          this.engine.toolsManager.createSolidFence();
        }
      }
      return;
    }

    // ----------------------------
    // MEASURING
    // ----------------------------
    if (mode === "measuring") {
      const planeHit = this.raycaster.intersectObject(this.interactionPlane);
      if (planeHit.length > 0) {
        this.engine.toolsManager.handleMeasurementClick(planeHit[0].point);
      }
      return;
    }

    // ----------------------------
    // PLACE ITEM
    // ----------------------------
    if (mode === "placing_item" && catalog.selectedProduct) {
      if (event.button !== 0) return;

      const intersects = this.raycaster.intersectObject(this.interactionPlane);
      if (intersects.length > 0) {
        this.engine.objectManager.placeObject(
          intersects[0].point.x,
          intersects[0].point.z,
          catalog.selectedProduct,
          (uuid) => {
            // Seleccionamos el nuevo objeto y entramos en edici√≥n
            selectionStore.selectItem(uuid);
            editor.setMode("editing");
          }
        );
      }
      return;
    }

    // ----------------------------
    // IDLE / EDITING
    // ----------------------------
    if (mode === "idle" || mode === "editing") {
      if (event.button !== 0) return;

      // --- Edici√≥n de v√©rtices de suelo ---
      if (this.engine.toolsManager.floorEditMarkers.length > 0) {
        const markerIntersects = this.raycaster.intersectObjects(
          this.engine.toolsManager.floorEditMarkers
        );

        if (markerIntersects.length > 0) {
          const hit = markerIntersects[0].object;
          const index = hit.userData.pointIndex;

          if (event.shiftKey || event.ctrlKey) {
            this.engine.toolsManager.selectVertex(index, true);
            if (this.transformControl) this.transformControl.detach();
            return;
          }

          this.engine.toolsManager.selectVertex(index, false);
          if (this.transformControl) {
            this.transformControl.attach(hit);
            this.transformControl.setMode("translate");
            this.transformControl.visible = true;
          }
          return;
        }
      }

      // --- Selecci√≥n de objetos ---
      const interactables = this.engine.scene.children.filter(
        (obj) => obj.userData?.isItem && obj !== this.transformControl
      );

      const intersects = this.raycaster.intersectObjects(interactables, true);

      if (intersects.length > 0) {
        let target: THREE.Object3D | null = intersects[0].object;

        while (
          target &&
          !target.userData?.isItem &&
          target.parent &&
          target.parent !== this.engine.scene
        ) {
          target = target.parent;
        }

        if (target && target.userData?.isItem) {
          this.selectObject(target);

          // Buscar el SceneItem correspondiente EN EL EDITOR STORE
          const floor = useEditorStore
            .getState()
            .items.find(
              (item) => item.uuid === target!.uuid && item.type === "floor"
            );

          if (floor?.points) {
            this.engine.toolsManager.showFloorEditMarkers(
              target.uuid,
              floor.points
            );
          } else {
            this.engine.toolsManager.clearFloorEditMarkers();
          }
        }
      } else {
        // Click en vac√≠o ‚Üí deseleccionar (si no estamos en un marker)
        if (
          this.transformControl?.object &&
          !this.engine.toolsManager.floorEditMarkers.includes(
            this.transformControl.object as THREE.Mesh
          )
        ) {
          this.selectObject(null);
          this.engine.toolsManager.clearFloorEditMarkers();
        }
      }
    }
  };

  // --------------------------------------------------
  // SELECCI√ìN DE OBJETO + MODO
  // --------------------------------------------------
  public selectObject(object: THREE.Object3D | null) {
    const selection = useSelectionStore.getState();
    const editor = useEditorStore.getState();

    if (!this.transformControl) {
      selection.selectItem(null);
      editor.setMode("idle");
      return;
    }

    // Quitamos cualquier selecci√≥n previa
    if (this.transformControl.object) {
      this.transformControl.detach();
      this.transformControl.visible = false;
      this.engine.sceneManager.controls.enabled = true;
    }

    // Si no hay objeto ‚Üí deseleccionar
    if (!object) {
      selection.selectItem(null);
      editor.setMode("idle");
      return;
    }

    // Nueva selecci√≥n
    this.transformControl.attach(object);
    selection.selectItem(object.uuid);
    editor.setMode("editing");
    this.transformControl.visible = true;
  }

  // --------------------------------------------------
  // SINCRONIZAR POS / ROT / SCALE CON STORE
  // --------------------------------------------------
  private syncTransformToStore(obj: THREE.Object3D) {
    const editor = useEditorStore.getState();
    if (obj.userData.isItem) {
      editor.updateItemTransform(
        obj.uuid,
        [obj.position.x, obj.position.y, obj.position.z],
        [obj.rotation.x, obj.rotation.y, obj.rotation.z],
        [obj.scale.x, obj.scale.y, obj.scale.z]
      );
    }
  }

  // --------------------------------------------------
  // CAMBIAR MODO DEL GIZMO
  // --------------------------------------------------
  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    if (this.transformControl) this.transformControl.setMode(mode);
  }
}
// --- END OF FILE src/features/editor/engine/managers/InteractionManager.ts ---
</file>

<file path="src/features/editor/engine/managers/InteractionManager_old_gpt.txt">
// --- START OF FILE src/features/editor/engine/managers/InteractionManager.ts ---
import * as THREE from "three";
import { TransformControls } from "three/examples/jsm/controls/TransformControls.js";

import type { A42Engine } from "../A42Engine";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { useCatalogStore } from "@/stores/catalog/useCatalogStore";
import { useSceneStore } from "@/stores/scene/useSceneStore";

export class InteractionManager {
  private engine: A42Engine;
  public transformControl: TransformControls | null = null;

  private raycaster: THREE.Raycaster;
  private pointer: THREE.Vector2;
  private interactionPlane: THREE.Mesh;

  public isDraggingGizmo = false;
  private dragStartPosition = new THREE.Vector3();

  constructor(engine: A42Engine) {
    this.engine = engine;
    this.raycaster = new THREE.Raycaster();
    this.pointer = new THREE.Vector2();

    // Plano "suelo" para colocar/dibujar cosas
    this.interactionPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(1000, 1000),
      new THREE.MeshBasicMaterial({ visible: false })
    );
    this.interactionPlane.rotation.x = -Math.PI / 2;
    this.interactionPlane.layers.set(0);
    this.engine.scene.add(this.interactionPlane);

    this.initTransformControls();
  }

  // --------------------------------------------------
  // INIT TRANSFORM CONTROLS (GIZMO)
  // --------------------------------------------------
  private initTransformControls() {
    try {
      this.transformControl = new TransformControls(
        this.engine.activeCamera as THREE.Camera,
        this.engine.renderer.domElement
      );

      this.transformControl.rotationSnap = Math.PI / 12;

      // A√±adimos el gizmo a la escena en la misma capa que el resto
      this.engine.scene.add(this.transformControl);

      // --- Evento cuando empieza/termina drag ---
      this.transformControl.addEventListener(
        "dragging-changed",
        (event: any) => {
          const editor = useEditorStore.getState();

          this.isDraggingGizmo = event.value;
          this.engine.sceneManager.controls.enabled = !event.value;

          const obj = this.transformControl?.object;
          if (!obj) return;

          if (event.value) {
            // Empezar drag ‚Üí snapshot para UNDO
            this.dragStartPosition.copy(obj.position);
            editor.saveSnapshot();
          } else {
            // Terminar drag
            if (this.engine.isObjectColliding(obj)) {
              // Rebote si choca zona de seguridad
              this.animateRevert(obj, this.dragStartPosition);
            } else {
              if (obj.userData.isFloorMarker) {
                this.engine.toolsManager.updateFloorFromMarkers(obj);
              } else if (obj.userData.isItem) {
                this.engine.objectManager.adjustObjectToGround(obj);
                this.syncTransformToStore(obj);
              }
            }
          }
        }
      );

      // Ajustar al suelo mientras se mueve (para items)
      this.transformControl.addEventListener("objectChange", () => {
        const obj = this.transformControl?.object;
        if (obj && obj.userData.isItem) {
          this.engine.objectManager.adjustObjectToGround(obj);
        }
      });

      this.transformControl.detach();
      this.transformControl.visible = false;
    } catch (e) {
      console.error("ERROR: TransformControls", e);
      this.transformControl = null;
    }
  }

  // --------------------------------------------------
  // REBOTE EN CASO DE COLISI√ìN
  // --------------------------------------------------
  private animateRevert(obj: THREE.Object3D, targetPos: THREE.Vector3) {
    const startPos = obj.position.clone();
    let t = 0;

    const animate = () => {
      t += 0.1;
      if (t >= 1) {
        obj.position.copy(targetPos);
        this.engine.checkSafetyCollisions();
        return;
      }
      obj.position.lerpVectors(startPos, targetPos, t);
      this.engine.checkSafetyCollisions();
      requestAnimationFrame(animate);
    };

    animate();
  }

  // --------------------------------------------------
  // ACTUALIZAR C√ÅMARA ACTIVA PARA EL GIZMO
  // --------------------------------------------------
  public updateCamera(camera: THREE.Camera) {
    if (this.transformControl) {
      this.transformControl.camera = camera;
    }
  }

  // --------------------------------------------------
  // MOUSE DOWN PRINCIPAL
  // --------------------------------------------------
  public onMouseDown = (event: MouseEvent) => {
    // Si estamos arrastrando el gizmo, no hacemos nada m√°s
    if (this.transformControl && this.isDraggingGizmo) return;

    const rect = this.engine.renderer.domElement.getBoundingClientRect();
    this.pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    this.pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    this.raycaster.setFromCamera(this.pointer, this.engine.activeCamera);

    const editor = useEditorStore.getState();
    const catalog = useCatalogStore.getState();
    const selectionStore = useSelectionStore.getState();
    const scene = useSceneStore.getState();

    const mode = editor.mode;

    // ------------------------------------------------
    // 1) CLICK EN GIZMO ‚Üí dejar que TransformControls act√∫e
    // ------------------------------------------------
    if (this.transformControl) {
      const gizmoObjects: THREE.Object3D[] = [];
      this.transformControl.traverse((child) => gizmoObjects.push(child));

      const gizmoHits = this.raycaster.intersectObjects(gizmoObjects, true);
      if (gizmoHits.length > 0) {
        // Click sobre el gizmo ‚Üí NO tocar selecci√≥n ni modos
        return;
      }
    }

    // ----------------------------
    // DRAW FLOOR
    // ----------------------------
    if (mode === "drawing_floor") {
      const intersects = this.raycaster.intersectObject(this.interactionPlane);
      if (intersects.length > 0) {
        if (event.button === 0) {
          this.engine.toolsManager.addDraftPoint(intersects[0].point);
        } else if (event.button === 2) {
          if (this.engine.toolsManager.floorPoints.length >= 3) {
            this.engine.toolsManager.createSolidFloor();
          }
        }
      }
      return;
    }

    // ----------------------------
    // DRAW FENCE
    // ----------------------------
    if (mode === "drawing_fence") {
      const intersects = this.raycaster.intersectObject(this.interactionPlane);
      if (intersects.length > 0) {
        if (event.button === 0) {
          this.engine.toolsManager.addFenceDraftPoint(intersects[0].point);
        } else if (event.button === 2) {
          this.engine.toolsManager.createSolidFence();
        }
      }
      return;
    }

    // ----------------------------
    // MEASURING
    // ----------------------------
    if (mode === "measuring") {
      const intersects = this.raycaster.intersectObjects(
        this.engine.scene.children,
        true
      );
      const hit = intersects.find(
        (i) =>
          i.object.visible &&
          (i.object.userData.isItem || i.object === this.interactionPlane)
      );

      if (hit) {
        this.engine.toolsManager.handleMeasurementClick(hit.point);
      } else {
        const planeHit = this.raycaster.intersectObject(this.interactionPlane);
        if (planeHit.length > 0) {
          this.engine.toolsManager.handleMeasurementClick(planeHit[0].point);
        }
      }
      return;
    }

    // ----------------------------
    // PLACE ITEM
    // ----------------------------
    if (mode === "placing_item" && catalog.selectedProduct) {
      if (event.button !== 0) return;

      const intersects = this.raycaster.intersectObject(this.interactionPlane);
      if (intersects.length > 0) {
        this.engine.objectManager.placeObject(
          intersects[0].point.x,
          intersects[0].point.z,
          catalog.selectedProduct,
          (uuid) => {
            // Seleccionamos el nuevo objeto y entramos en edici√≥n
            selectionStore.selectItem(uuid);
            editor.setMode("editing");
          }
        );
      }
      return;
    }

    // ----------------------------
    // IDLE / EDITING
    // ----------------------------
    if (mode === "idle" || mode === "editing") {
      if (event.button !== 0) return;

      // --- Edici√≥n de v√©rtices de suelo ---
      if (this.engine.toolsManager.floorEditMarkers.length > 0) {
        const markerIntersects = this.raycaster.intersectObjects(
          this.engine.toolsManager.floorEditMarkers
        );

        if (markerIntersects.length > 0) {
          const hit = markerIntersects[0].object;
          const index = hit.userData.pointIndex;

          if (event.shiftKey || event.ctrlKey) {
            this.engine.toolsManager.selectVertex(index, true);
            if (this.transformControl) this.transformControl.detach();
            return;
          }

          this.engine.toolsManager.selectVertex(index, false);
          if (this.transformControl) {
            this.transformControl.attach(hit);
            this.transformControl.setMode("translate");
            this.transformControl.visible = true;
          }
          return;
        }
      }

      // --- Selecci√≥n de objetos ---
      const intersects = this.raycaster.intersectObjects(
        this.engine.scene.children,
        true
      );

      let target: THREE.Object3D | null = null;

      for (const hit of intersects) {
        let obj: THREE.Object3D | null = hit.object;
        let isGizmo = false;

        while (obj) {
          if (this.transformControl && obj === this.transformControl) {
            isGizmo = true;
            break;
          }
          if (obj.userData?.isItem) break;
          obj = obj.parent as THREE.Object3D | null;
        }

        if (isGizmo) {
          // Click en el gizmo ‚Üí no cambiar selecci√≥n
          return;
        }

        if (obj && obj.userData?.isItem) {
          target = obj;
          break;
        }
      }

      if (target && target.userData?.isItem) {
        this.selectObject(target);

        // Buscar el SceneItem correspondiente
        const floor = scene.items.find(
          (item) => item.uuid === target!.uuid && item.type === "floor"
        );

        if (floor?.points) {
          this.engine.toolsManager.showFloorEditMarkers(
            target.uuid,
            floor.points
          );
        } else {
          this.engine.toolsManager.clearFloorEditMarkers();
        }
      } else {
        // Click en vac√≠o ‚Üí deseleccionar (si no estamos en un marker)
        if (
          this.transformControl?.object &&
          !this.engine.toolsManager.floorEditMarkers.includes(
            this.transformControl.object as THREE.Mesh
          )
        ) {
          this.selectObject(null);
          this.engine.toolsManager.clearFloorEditMarkers();
        }
      }
    }
  };

  // --------------------------------------------------
  // SELECCI√ìN DE OBJETO + MODO
  // --------------------------------------------------
  public selectObject(object: THREE.Object3D | null) {
    const selection = useSelectionStore.getState();
    const editor = useEditorStore.getState();

    if (!this.transformControl) {
      selection.selectItem(null);
      editor.setMode("idle");
      return;
    }

    // Si clicamos de nuevo en el mismo objeto ya enganchado
    if (
      object &&
      this.transformControl.object?.uuid === object.uuid &&
      selection.selectedItemId !== object.uuid
    ) {
      selection.selectItem(object.uuid);
      editor.setMode("editing");
      return;
    }

    // Quitamos cualquier selecci√≥n previa
    if (this.transformControl.object) {
      this.transformControl.detach();
      this.transformControl.visible = false;
      this.engine.sceneManager.controls.enabled = true;
    }

    // Si no hay objeto ‚Üí deseleccionar
    if (!object) {
      selection.selectItem(null);
      editor.setMode("idle");
      return;
    }

    // Nueva selecci√≥n
    this.transformControl.attach(object);
    selection.selectItem(object.uuid);
    editor.setMode("editing");
    this.transformControl.visible = true;
  }

  // --------------------------------------------------
  // SINCRONIZAR POS / ROT / SCALE CON STORE
  // --------------------------------------------------
  private syncTransformToStore(obj: THREE.Object3D) {
    const scene = useSceneStore.getState();
    if (obj.userData.isItem) {
      scene.updateItem(obj.uuid, {
        position: [obj.position.x, obj.position.y, obj.position.z],
        rotation: [obj.rotation.x, obj.rotation.y, obj.rotation.z],
        scale: [obj.scale.x, obj.scale.y, obj.scale.z],
      });
    }
  }

  // --------------------------------------------------
  // CAMBIAR MODO DEL GIZMO
  // --------------------------------------------------
  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    if (this.transformControl) this.transformControl.setMode(mode);
  }
}
// --- END OF FILE src/features/editor/engine/managers/InteractionManager.ts ---
</file>

<file path="src/features/editor/engine/managers/InteractionManager.ts">
// --- START OF FILE src/features/editor/engine/managers/InteractionManager.ts ---
import * as THREE from "three";
import { TransformControls } from "three/examples/jsm/controls/TransformControls.js";

import type { A42Engine } from "../A42Engine";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { useCatalogStore } from "@/stores/catalog/useCatalogStore";

export class InteractionManager {
  private engine: A42Engine;
  public transformControl: TransformControls | null = null;

  private raycaster: THREE.Raycaster;
  private pointer: THREE.Vector2;
  public interactionPlane: THREE.Mesh;

  public isDraggingGizmo = false;
  private dragStartPosition = new THREE.Vector3();

  constructor(engine: A42Engine) {
    this.engine = engine;
    this.raycaster = new THREE.Raycaster();
    this.pointer = new THREE.Vector2();

    // Plano para clicks
    this.interactionPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(5000, 5000),
      new THREE.MeshBasicMaterial({ visible: false })
    );
    this.interactionPlane.rotation.x = -Math.PI / 2;
    this.interactionPlane.userData.isInteractionPlane = true;
    this.engine.scene.add(this.interactionPlane);

    this.initTransformControls();
  }

  // ---------------------------------------------
  // TRANSFORM CONTROLS (GIZMO)
  // ---------------------------------------------
  private initTransformControls() {
    try {
      this.transformControl = new TransformControls(
        this.engine.activeCamera as THREE.Camera,
        this.engine.renderer.domElement
      );

      this.transformControl.rotationSnap = Math.PI / 12;
      this.engine.scene.add(this.transformControl);

      // Evento arrastrar
      this.transformControl.addEventListener("dragging-changed", (event: any) => {
        const editor = useEditorStore.getState();

        this.isDraggingGizmo = event.value;
        this.engine.sceneManager.controls.enabled = !event.value;

        const obj = this.transformControl?.object;
        if (!obj) return;

        if (event.value) {
          this.dragStartPosition.copy(obj.position);
          editor.saveSnapshot();
        } else {
          if (this.engine.isObjectColliding(obj)) {
            this.animateRevert(obj, this.dragStartPosition);
          } else {
            if (obj.userData.isFloorMarker) {
              this.engine.toolsManager.updateFloorFromMarkers(obj);
            } else if (obj.userData.isItem) {
              this.engine.objectManager.adjustObjectToGround(obj);
              this.syncTransformToStore(obj);
            }
          }
        }
      });

      // Ajuste al suelo durante movimiento
      this.transformControl.addEventListener("objectChange", () => {
        const obj = this.transformControl?.object;
        if (obj && obj.userData.isItem && !this.isDraggingGizmo) {
          this.engine.objectManager.adjustObjectToGround(obj);
        }
      });

      this.transformControl.detach();
      this.transformControl.visible = false;
    } catch (e) {
      console.error("ERROR: TransformControls", e);
      this.transformControl = null;
    }
  }

  private animateRevert(obj: THREE.Object3D, targetPos: THREE.Vector3) {
    const startPos = obj.position.clone();
    let t = 0;

    const animate = () => {
      t += 0.1;
      if (t >= 1) {
        obj.position.copy(targetPos);
        this.engine.checkSafetyCollisions();
        return;
      }
      obj.position.lerpVectors(startPos, targetPos, t);
      this.engine.checkSafetyCollisions();
      requestAnimationFrame(animate);
    };

    animate();
  }

  public updateCamera(camera: THREE.Camera) {
    if (this.transformControl) {
      this.transformControl.camera = camera;
    }
  }

  // ============================================================
  // üî• EVENTOS DE PUNTERO ‚Äî FIX REAL DEL GIZMO
  // ============================================================

  public onPointerDown = (event: MouseEvent) => {
    if (this.transformControl) this.transformControl.pointerDown(event);
    this.handleMouseDown(event);
  };

  public onPointerMove = (event: MouseEvent) => {
    if (this.transformControl) this.transformControl.pointerMove(event);
  };

  public onPointerUp = (event: MouseEvent) => {
    if (this.transformControl) this.transformControl.pointerUp(event);
  };

  // ============================================================
  // üî• TODA TU L√ìGICA ORIGINAL DE onMouseDown AHORA VA AQU√ç
  // ============================================================
  private handleMouseDown(event: MouseEvent) {
    if (this.transformControl && this.isDraggingGizmo) return;

    const rect = this.engine.renderer.domElement.getBoundingClientRect();
    this.pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    this.pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    this.raycaster.setFromCamera(this.pointer, this.engine.activeCamera);

    const editor = useEditorStore.getState();
    const catalog = useCatalogStore.getState();
    const selectionStore = useSelectionStore.getState();

    const mode = editor.mode;

    // FLOOR DRAW
    if (mode === "drawing_floor") {
      const hit = this.raycaster.intersectObject(this.interactionPlane);
      if (hit.length > 0) {
        if (event.button === 0) this.engine.toolsManager.addDraftPoint(hit[0].point);
        else if (event.button === 2) this.engine.toolsManager.createSolidFloor();
      }
      return;
    }

    // FENCE DRAW
    if (mode === "drawing_fence") {
      const hit = this.raycaster.intersectObject(this.interactionPlane);
      if (hit.length > 0) {
        if (event.button === 0) this.engine.toolsManager.addFenceDraftPoint(hit[0].point);
        else if (event.button === 2) this.engine.toolsManager.createSolidFence();
      }
      return;
    }

    // MEASURE
    if (mode === "measuring") {
      const hit = this.raycaster.intersectObject(this.interactionPlane);
      if (hit.length > 0) this.engine.toolsManager.handleMeasurementClick(hit[0].point);
      return;
    }

    // PLACE OBJECT
    if (mode === "placing_item" && catalog.selectedProduct) {
      if (event.button !== 0) return;

      const hit = this.raycaster.intersectObject(this.interactionPlane);
      if (hit.length > 0) {
        this.engine.objectManager.placeObject(
          hit[0].point.x,
          hit[0].point.z,
          catalog.selectedProduct,
          (uuid) => {
            selectionStore.selectItem(uuid);
            editor.setMode("editing");
          }
        );
      }
      return;
    }

    // ---------------------------------------------
    // IDLE / EDITING ‚Äì SELECCI√ìN
    // ---------------------------------------------
    if (mode === "idle" || mode === "editing") {
      if (event.button !== 0) return;

      // Click en markers de suelos
      const markerHit = this.raycaster.intersectObjects(
        this.engine.toolsManager.floorEditMarkers
      );
      if (markerHit.length > 0) {
        const hit = markerHit[0].object;
        const idx = hit.userData.pointIndex;

        if (event.shiftKey || event.ctrlKey) {
          this.engine.toolsManager.selectVertex(idx, true);
          this.transformControl?.detach();
          return;
        }

        this.engine.toolsManager.selectVertex(idx, false);
        if (this.transformControl) {
          this.transformControl.attach(hit);
          this.transformControl.setMode("translate");
          this.transformControl.visible = true;
        }
        return;
      }

      // Selecci√≥n normal
      const interactables = this.engine.scene.children.filter(
        (obj) => obj.userData?.isItem && obj !== this.transformControl
      );

      const intersects = this.raycaster.intersectObjects(interactables, true);
      if (intersects.length > 0) {
        let target: THREE.Object3D | null = intersects[0].object;

        while (
          target &&
          !target.userData?.isItem &&
          target.parent &&
          target.parent !== this.engine.scene
        ) {
          target = target.parent;
        }

        if (target && target.userData?.isItem) {
          this.selectObject(target);

          const floorItem = useEditorStore
            .getState()
            .items.find(
              (i) => i.uuid === target!.userData.uuid && i.type === "floor"
            );

          if (floorItem?.points) {
            this.engine.toolsManager.showFloorEditMarkers(
              target.userData.uuid,
              floorItem.points
            );
          } else {
            this.engine.toolsManager.clearFloorEditMarkers();
          }
        }
      } else {
        if (
          this.transformControl?.object &&
          !this.engine.toolsManager.floorEditMarkers.includes(
            this.transformControl.object as THREE.Mesh
          )
        ) {
          this.selectObject(null);
          this.engine.toolsManager.clearFloorEditMarkers();
        }
      }
    }
  }

  // ---------------------------------------------
  // SELECCI√ìN
  // ---------------------------------------------
  public selectObject(object: THREE.Object3D | null) {
    const selection = useSelectionStore.getState();
    const editor = useEditorStore.getState();

    if (!this.transformControl) {
      selection.selectItem(null);
      editor.setMode("idle");
      return;
    }

    if (this.transformControl.object) {
      this.transformControl.detach();
      this.transformControl.visible = false;
      this.engine.sceneManager.controls.enabled = true;
    }

    if (!object) {
      selection.selectItem(null);
      editor.setMode("idle");
      return;
    }

    this.transformControl.attach(object);
    selection.selectItem(object.userData.uuid);
    editor.setMode("editing");
    this.transformControl.visible = true;
  }

  // ---------------------------------------------
  // SYNC TRANSFORM
  // ---------------------------------------------
  private syncTransformToStore(obj: THREE.Object3D) {
    const editor = useEditorStore.getState();
    if (obj.userData.isItem) {
      editor.updateItemTransform(
        obj.userData.uuid,
        [obj.position.x, obj.position.y, obj.position.z],
        [obj.rotation.x, obj.rotation.y, obj.rotation.z],
        [obj.scale.x, obj.scale.y, obj.scale.z]
      );
    }
  }

  public setGizmoMode(mode: "translate" | "rotate" | "scale") {
    if (this.transformControl) this.transformControl.setMode(mode);
  }
}
// --- END OF FILE ---
</file>

<file path="src/features/editor/engine/managers/ObjectManager.ts">
// --- START OF FILE src/features/editor/engine/managers/ObjectManager.ts ---
import * as THREE from "three";
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { FENCE_PRESETS } from "@/features/editor/data/fence_presets";

import type {
  SceneItem,
  FenceConfig,
  FloorMaterialType,
} from "@/types/editor";

import type { Product } from "@/services/catalogService";

type PlaceableProduct = Product & { initialScale?: [number, number, number] };

export class ObjectManager {
  private scene: THREE.Scene;
  private loader: GLTFLoader;
  private textureLoader: THREE.TextureLoader;

  private assetCache: Record<string, THREE.Group> = {};

  private floorMaterials: Record<FloorMaterialType, THREE.Material>;

  constructor(scene: THREE.Scene) {
    this.scene = scene;
    this.loader = new GLTFLoader();
    this.textureLoader = new THREE.TextureLoader();

    this.floorMaterials = {
      rubber_red: new THREE.MeshStandardMaterial({
        color: 0xa04040,
        roughness: 0.9,
      }),
      rubber_green: new THREE.MeshStandardMaterial({
        color: 0x22c55e,
        roughness: 0.9,
      }),
      rubber_blue: new THREE.MeshStandardMaterial({
        color: 0x3b82f6,
        roughness: 0.9,
      }),
      grass: new THREE.MeshStandardMaterial({
        color: 0x4ade80,
        roughness: 1,
      }),
      concrete: new THREE.MeshStandardMaterial({
        color: 0x9ca3af,
        roughness: 0.8,
      }),
    };
  }

  // ----------------------------------------------------------
  //  CARGA DE MODELOS CON CACH√â
  // ----------------------------------------------------------

  public async loadModel(url: string): Promise<THREE.Group> {
    if (this.assetCache[url]) return this.assetCache[url].clone();
    const gltf = await this.loader.loadAsync(url);
    this.assetCache[url] = gltf.scene;
    return gltf.scene.clone();
  }

  // ----------------------------------------------------------
  //  RECREAR OBJETO 'model'
  // ----------------------------------------------------------

  public async recreateModel(item: SceneItem) {
    if (!item.modelUrl) return;

    try {
      const model = await this.loadModel(item.modelUrl);

      model.uuid = item.uuid;
      model.position.fromArray(item.position);
      model.rotation.fromArray(item.rotation);
      model.scale.fromArray(item.scale);

      // üëá SOLO el grupo ra√≠z es el "item" seleccionable
      model.userData = {
        isItem: true,
        type: "model",
        uuid: item.uuid,
        productId: item.productId,
      };

      // Zonas de seguridad
      const editor = useEditorStore.getState();
      const isZonesVisible = editor.safetyZonesVisible;

      const safetyMat = new THREE.MeshBasicMaterial({
        color: 0xff0000,
        transparent: true,
        opacity: 0.3,
        depthWrite: false,
        side: THREE.DoubleSide,
      });

      model.traverse((child) => {
        if ((child as THREE.Mesh).isMesh) {
          const mesh = child as THREE.Mesh;
          mesh.castShadow = true;
          mesh.receiveShadow = true;

          const name = mesh.name.toLowerCase();
          const mat =
            (mesh.material as THREE.Material).name?.toLowerCase() ?? "";

          if (
            name.includes("zona") ||
            name.includes("seguridad") ||
            name.includes("safety") ||
            mat.includes("zona") ||
            mat.includes("seguridad") ||
            mat.includes("safety")
          ) {
            mesh.material = safetyMat.clone();
            mesh.visible = isZonesVisible;
            mesh.userData.isSafetyZone = true;
            mesh.castShadow = false;
            mesh.receiveShadow = false;
          }
        }
      });

      this.scene.add(model);
    } catch (e) {
      console.error("Error recreating model:", e);
    }
  }

  // ----------------------------------------------------------
  //  RECREAR SUELO
  // ----------------------------------------------------------

  public recreateFloor(item: SceneItem) {
    if (!item.points || item.points.length < 3) return;

    const shape = new THREE.Shape();
    shape.moveTo(item.points[0].x, -item.points[0].z);
    for (let i = 1; i < item.points.length; i++) {
      shape.lineTo(item.points[i].x, -item.points[i].z);
    }
    shape.lineTo(item.points[0].x, -item.points[0].z);

    const geometry = new THREE.ExtrudeGeometry(shape, {
      depth: 0.05,
      bevelEnabled: false,
    });

    geometry.rotateX(-Math.PI / 2);

    const pos = geometry.attributes.position;
    const uv = geometry.attributes.uv;

    const scale = item.textureScale ?? 1;
    const rotRad = THREE.MathUtils.degToRad(item.textureRotation ?? 0);

    for (let i = 0; i < pos.count; i++) {
      const x = pos.getX(i);
      const z = pos.getZ(i);

      const u = (x * Math.cos(rotRad) - z * Math.sin(rotRad)) / scale;
      const v = (x * Math.sin(rotRad) + z * Math.cos(rotRad)) / scale;

      uv.setXY(i, u, v);
    }

    let material: THREE.Material;

    if (item.textureUrl) {
      const tex = this.textureLoader.load(item.textureUrl);
      tex.wrapS = THREE.RepeatWrapping;
      tex.wrapT = THREE.RepeatWrapping;

      material = new THREE.MeshStandardMaterial({
        map: tex,
        roughness: 0.8,
        side: THREE.DoubleSide,
      });
    } else {
      material = this.floorMaterials[item.floorMaterial ?? "concrete"];
    }

    const mesh = new THREE.Mesh(geometry, material);
    mesh.uuid = item.uuid;
    mesh.receiveShadow = true;

    mesh.userData = {
      isItem: true,
      type: "floor",
      uuid: item.uuid,
      points: item.points,
      floorMaterial: item.floorMaterial,
      textureUrl: item.textureUrl,
      textureScale: item.textureScale,
      textureRotation: item.textureRotation,
    };

    this.scene.add(mesh);
  }

  // ----------------------------------------------------------
  //  RECREAR VALLA
  // ----------------------------------------------------------

  public recreateFence(item: SceneItem) {
    if (!item.points || !item.fenceConfig) return;

    const points = item.points.map((p) => new THREE.Vector3(p.x, 0, p.z));
    const fence = this.createFenceObject(points, item.fenceConfig);

    if (!fence) return;

    fence.uuid = item.uuid;

    // üëá SOLO el grupo ra√≠z tiene isItem
    fence.userData = {
      isItem: true,
      type: "fence",
      uuid: item.uuid,
      productId: item.productId,
      points: item.points,
      fenceConfig: item.fenceConfig,
    };

    this.scene.add(fence);
  }

  // ----------------------------------------------------------
  //  CREAR VALLA (instanced meshes)
  // ----------------------------------------------------------

  public createFenceObject(
    points: THREE.Vector3[],
    config: FenceConfig
  ): THREE.Group | null {
    if (!points || points.length < 2) return null;

    const preset = FENCE_PRESETS[config.presetId] || FENCE_PRESETS["wood"];
    const colors = config.colors;

    const parts: Record<
      string,
      { geo: THREE.BufferGeometry; matrices: THREE.Matrix4[]; colors: number[] }
    > = {};
    const temp = new THREE.Object3D();

    const addPart = (
      key: string,
      geo: THREE.BufferGeometry,
      pos: THREE.Vector3,
      rot: THREE.Euler,
      scl: THREE.Vector3,
      colorHex: number
    ) => {
      if (!parts[key]) {
        parts[key] = { geo, matrices: [], colors: [] };
      }

      temp.position.copy(pos);
      temp.rotation.copy(rot);
      temp.scale.copy(scl);
      temp.updateMatrix();

      parts[key].matrices.push(temp.matrix.clone());
      parts[key].colors.push(colorHex);
    };

    // POSTES
    let postGeo: THREE.BufferGeometry;
    if (preset.postType === "round") {
      postGeo = new THREE.CylinderGeometry(
        preset.postRadius!,
        preset.postRadius!,
        preset.postHeight,
        16
      );
      postGeo.translate(0, preset.postHeight / 2, 0);
    } else {
      postGeo = new THREE.BoxGeometry(
        preset.postWidth!,
        preset.postHeight,
        preset.postWidth!
      );
      postGeo.translate(0, preset.postHeight / 2, 0);
    }

    // RIELES
    let railGeo: THREE.BufferGeometry | null = null;
    if (preset.railType === "frame") {
      if (preset.railShape === "square") {
        railGeo = new THREE.BoxGeometry(
          preset.railThickness!,
          preset.railThickness!,
          1
        );
      } else {
        railGeo = new THREE.CylinderGeometry(
          preset.railRadius!,
          preset.railRadius!,
          1,
          12
        );
        railGeo.rotateX(Math.PI / 2);
      }
    }

    // LAMAS
    const slatGeo = new THREE.BoxGeometry(
      preset.slatThickness,
      1,
      preset.slatWidth
    );

    const topRailY = preset.postHeight - 0.12;
    const botRailY = 0.12;
    const slatHeight = topRailY - botRailY - 0.08;
    const slatCenterY = (topRailY + botRailY) * 0.5;

    const slatColorList = [
      colors.slatA,
      colors.slatB ?? colors.slatA,
      colors.slatC ?? colors.slatA,
    ];

    for (let i = 0; i < points.length - 1; i++) {
      const A = points[i];
      const B = points[i + 1];
      const dist = A.distanceTo(B);

      const dir = new THREE.Vector3().subVectors(B, A).normalize();
      const angle = Math.atan2(dir.x, dir.z);

      const module = 2.0;
      const count = Math.max(1, Math.ceil(dist / module));
      const moduleLen = dist / count;

      for (let m = 0; m < count; m++) {
        const t0 = m / count;
        const t1 = (m + 1) / count;

        const P0 = new THREE.Vector3().lerpVectors(A, B, t0);
        const P1 = new THREE.Vector3().lerpVectors(A, B, t1);
        const PC = new THREE.Vector3().lerpVectors(P0, P1, 0.5);

        // Poste inicio de m√≥dulo
        addPart(
          "post",
          postGeo,
          P0,
          new THREE.Euler(0, angle, 0),
          new THREE.Vector3(1, 1, 1),
          colors.post
        );

        // Rieles
        if (railGeo) {
          const railLen = Math.max(moduleLen - 0.1, 0.05);

          addPart(
            "rail",
            railGeo,
            new THREE.Vector3(PC.x, topRailY, PC.z),
            new THREE.Euler(0, angle, 0),
            new THREE.Vector3(1, 1, railLen),
            colors.post
          );

          addPart(
            "rail",
            railGeo,
            new THREE.Vector3(PC.x, botRailY, PC.z),
            new THREE.Euler(0, angle, 0),
            new THREE.Vector3(1, 1, railLen),
            colors.post
          );
        }

        // Panel o lamas
        if (preset.isSolidPanel) {
          const panelLen = moduleLen - 0.1;
          addPart(
            "slat",
            slatGeo,
            new THREE.Vector3(PC.x, slatCenterY, PC.z),
            new THREE.Euler(0, angle, 0),
            new THREE.Vector3(1, slatHeight, panelLen / preset.slatWidth),
            slatColorList[0]
          );
        } else {
          let slatCount: number;
          if (preset.fixedCount) {
            slatCount = preset.fixedCount;
          } else {
            const unit = preset.slatWidth + (preset.slatGap ?? 0.05);
            slatCount = Math.max(1, Math.floor(moduleLen / unit));
          }

          for (let s = 0; s < slatCount; s++) {
            const tSlat = (s + 0.5) / slatCount;
            const Pslat = new THREE.Vector3().lerpVectors(P0, P1, tSlat);
            Pslat.y = slatCenterY;

            const color = slatColorList[s % slatColorList.length];

            addPart(
              "slat",
              slatGeo,
              Pslat,
              new THREE.Euler(0, angle, 0),
              new THREE.Vector3(1, slatHeight, 1),
              color
            );
          }
        }
      }
    }

    const last = points[points.length - 1];
    addPart(
      "post",
      postGeo,
      last,
      new THREE.Euler(0, 0, 0),
      new THREE.Vector3(1, 1, 1),
      colors.post
    );

    const group = new THREE.Group();

    for (const key in parts) {
      const { geo, matrices, colors } = parts[key];
      const count = matrices.length;

      const mat = new THREE.MeshStandardMaterial({
        roughness: 0.5,
        metalness: 0.1,
      });
      const mesh = new THREE.InstancedMesh(geo, mat, count);

      for (let i = 0; i < count; i++) {
        mesh.setMatrixAt(i, matrices[i]);
        mesh.setColorAt(i, new THREE.Color(colors[i]));
      }

      mesh.instanceMatrix!.needsUpdate = true;
      mesh.instanceColor!.needsUpdate = true;

      mesh.castShadow = true;
      mesh.receiveShadow = true;

      group.add(mesh);
    }

    return group;
  }

  // ----------------------------------------------------------
  //  COLOCAR OBJETO NUEVO (CAT√ÅLOGO)
  // ----------------------------------------------------------

  public async placeObject(
    x: number,
    z: number,
    product: PlaceableProduct,
    afterPlace?: (uuid: string) => void
  ) {
    if (!product.modelUrl) return;

    try {
      const model = await this.loadModel(product.modelUrl);

      model.position.set(x, 0, z);

      const initialScale = product.initialScale
        ? new THREE.Vector3(...product.initialScale)
        : new THREE.Vector3(1, 1, 1);

      model.scale.copy(initialScale);
      model.updateMatrixWorld(true);

      this.adjustObjectToGround(model);

      const editor = useEditorStore.getState();
      const isZonesVisible = editor.safetyZonesVisible;

      const safetyMat = new THREE.MeshBasicMaterial({
        color: 0xff0000,
        transparent: true,
        opacity: 0.3,
        depthWrite: false,
        side: THREE.DoubleSide,
      });

      model.traverse((child) => {
        if ((child as THREE.Mesh).isMesh) {
          const mesh = child as THREE.Mesh;
          mesh.castShadow = true;
          mesh.receiveShadow = true;

          const name = mesh.name.toLowerCase();
          const mat =
            (mesh.material as THREE.Material).name?.toLowerCase() ?? "";

          if (
            name.includes("zona") ||
            name.includes("seguridad") ||
            name.includes("safety") ||
            mat.includes("zona") ||
            mat.includes("seguridad") ||
            mat.includes("safety")
          ) {
            mesh.material = safetyMat.clone();
            mesh.visible = isZonesVisible;
            mesh.userData.isSafetyZone = true;
            mesh.castShadow = false;
          }
        }
      });

      // Animaci√≥n pop
      const targetScale = model.scale.clone();
      model.scale.set(0, 0, 0);
      let t = 0;

      const animate = () => {
        t += 0.05;
        if (t < 1) {
          model.scale.lerpVectors(new THREE.Vector3(0, 0, 0), targetScale, t);
          requestAnimationFrame(animate);
        } else {
          model.scale.copy(targetScale);
        }
      };
      animate();

      // --- GUARDAR EN STORE ---
      const uuid = THREE.MathUtils.generateUUID();
      model.uuid = uuid;

      model.userData = {
        isItem: true,
        type: "model",
        uuid,
        productId: product.id,
      };

      useEditorStore.getState().addItem({
        uuid,
        productId: product.id,
        name: product.name,
        price: product.price,
        modelUrl: product.modelUrl,

        position: [x, model.position.y, z],
        rotation: [0, 0, 0],
        scale: [initialScale.x, initialScale.y, initialScale.z],

        type: "model",

        url_tech: product.url_tech,
        url_cert: product.url_cert,
        url_inst: product.url_inst,

        description: product.description,
        data: product,
      });

      this.scene.add(model);
      afterPlace?.(uuid);
    } catch (e) {
      console.error("Error placing object:", e);
    }
  }

  // ----------------------------------------------------------
  //  AJUSTAR OBJETO AL SUELO
  // ----------------------------------------------------------

  public adjustObjectToGround(object: THREE.Object3D) {
    object.updateMatrixWorld();
    const box = new THREE.Box3().setFromObject(object);
    object.position.y -= box.min.y;
  }
}
// --- END OF FILE ---
</file>

<file path="src/features/editor/engine/managers/PDFManager.ts">
// --- START OF FILE src/features/editor/engine/managers/PDFManager.ts ---
import * as THREE from "three";
import { jsPDF } from "jspdf";
import autoTable from "jspdf-autotable";

import type { A42Engine } from "../A42Engine";
import type { SceneItem } from "@/types/editor";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useUserStore } from "@/stores/user/useUserStore";
import { PriceCalculator } from "@/utils/PriceCalculator";

export class PDFManager {
  private engine: A42Engine;

  // Variables de restauraci√≥n
  private savedRendererSize = new THREE.Vector2();
  private savedPixelRatio = 1;
  private savedCameraPos = new THREE.Vector3();
  private savedCameraRot = new THREE.Euler();
  private savedControlsTarget = new THREE.Vector3();
  private savedBg: THREE.Color | THREE.Texture | null = null;
  private savedFog: THREE.FogBase | null = null;
  private wasSkyVisible = false;

  constructor(engine: A42Engine) {
    this.engine = engine;
  }

  public async generatePDF() {
    const editor = useEditorStore.getState();
    const { user } = useUserStore.getState();

    const items = editor.items;

    const projectName = await editor.requestInput(
      "Nombre del Proyecto:",
      "Levipark21"
    );
    if (!projectName) return;

    const doc = new jsPDF();

    // 1. PREPARAR ESCENA
    this.saveSceneState();

    // Apagar todo para la foto
    this.engine.sceneManager.controls.enabled = false;
    this.engine.scene.background = new THREE.Color(0xffffff);
    this.engine.scene.fog = null;
    this.engine.setGridVisible(false);
    this.engine.setSkyVisible(false);
    this.hideHelpers(true);

    // 2. FOTOS

    // -- PORTADA --
    this.resizeRendererInternal(1600, 1200);
    this.engine.switchCamera("perspective");
    this.setVisibilityForAllItems(true);
    this.fitCameraToScene(1.3);
    this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
    const coverImg = this.takeShot("image/jpeg");

    // -- VISTAS T√âCNICAS --
    this.engine.switchCamera("orthographic");
    this.setShadows(false);
    this.resizeRendererInternal(1200, 1200);

    const sceneBox = this.getSceneBoundingBox();
    const center = sceneBox.getCenter(new THREE.Vector3());
    const size = sceneBox.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    const orthoSize = maxDim * 0.7;
    const cam = this.engine.sceneManager.orthoCamera;
    cam.zoom = 1;
    cam.left = -orthoSize;
    cam.right = orthoSize;
    cam.top = orthoSize;
    cam.bottom = -orthoSize;
    cam.updateProjectionMatrix();

    const views: Record<string, string> = {};
    const viewConfig = [
      { name: "front", pos: [0, 0, 100], up: [0, 1, 0] },
      { name: "side", pos: [100, 0, 0], up: [0, 1, 0] },
      { name: "top", pos: [0, 100, 0], up: [0, 0, -1] },
      { name: "iso", pos: [100, 60, 100], up: [0, 1, 0] },
    ] as const;

    for (const v of viewConfig) {
      cam.position.set(
        center.x + v.pos[0],
        center.y + v.pos[1],
        center.z + v.pos[2]
      );
      cam.up.set(v.up[0], v.up[1], v.up[2]);
      cam.lookAt(center);
      cam.updateProjectionMatrix();
      this.engine.renderer.render(this.engine.scene, cam);
      views[v.name] = this.engine.renderer.domElement.toDataURL(
        "image/jpeg",
        0.9
      );
    }

    // -- ITEMS (√∫nicos) --
    const uniqueItemsMap = new Map<string, SceneItem>();
    items.forEach((item) => {
      const key = item.productId === "custom_upload" ? item.uuid : item.productId;
      if (!uniqueItemsMap.has(key)) uniqueItemsMap.set(key, item);
    });

    this.engine.switchCamera("perspective");
    this.setShadows(true);
    this.resizeRendererInternal(1024, 768);

    const itemImages: Record<
      string,
      { img: string; width: number; height: number }
    > = {};
    for (const [key, item] of uniqueItemsMap) {
      this.setVisibilityForAllItems(false);
      this.setVisibilityForItem(item.uuid, true);
      const obj = this.engine.scene.getObjectByProperty("uuid", item.uuid);
      if (obj) {
        this.fitCameraToSingleObject(obj);
        this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
        itemImages[key] = {
          img: this.engine.renderer.domElement.toDataURL("image/png"),
          width: 1024,
          height: 768,
        };
      }
    }

    // 3. RESTAURAR
    this.restoreSceneState();

    // 4. GENERAR PDF
    this.generatePDFDocument(
      doc,
      projectName,
      coverImg,
      views,
      items,
      uniqueItemsMap,
      itemImages,
      user
    );
  }

  // --------------------------------------------------------------------------
  // GESTI√ìN DE ESTADO
  // --------------------------------------------------------------------------

  private saveSceneState() {
    this.engine.renderer.getSize(this.savedRendererSize);
    this.savedPixelRatio = this.engine.renderer.getPixelRatio();
    this.savedCameraPos.copy(this.engine.activeCamera.position);
    this.savedCameraRot.copy(this.engine.activeCamera.rotation);
    this.savedControlsTarget.copy(this.engine.sceneManager.controls.target);
    this.savedBg = this.engine.scene.background;
    this.savedFog = this.engine.scene.fog;
    this.wasSkyVisible = this.engine.sceneManager.sky?.visible ?? false;
  }

  private restoreSceneState() {
    this.engine.renderer.setSize(
      this.savedRendererSize.x,
      this.savedRendererSize.y
    );
    this.engine.renderer.setPixelRatio(this.savedPixelRatio);
    this.engine.switchCamera("perspective");
    this.engine.sceneManager.onWindowResize();

    this.engine.activeCamera.position.copy(this.savedCameraPos);
    this.engine.activeCamera.rotation.copy(this.savedCameraRot);
    this.engine.sceneManager.controls.target.copy(this.savedControlsTarget);
    this.engine.sceneManager.controls.enabled = true;
    this.engine.sceneManager.controls.update();

    this.engine.scene.background = this.savedBg;
    this.engine.scene.fog = this.savedFog;
    this.engine.setSkyVisible(this.wasSkyVisible);
    this.setVisibilityForAllItems(true);
    this.hideHelpers(false);
    this.setShadows(true);

    const shouldGridBeVisible = useEditorStore.getState().gridVisible;
    this.engine.setGridVisible(shouldGridBeVisible);
    this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
    setTimeout(() => {
      this.engine.setGridVisible(shouldGridBeVisible);
    }, 100);
  }

  private resizeRendererInternal(w: number, h: number) {
    this.engine.renderer.setSize(w, h);
    if (this.engine.activeCamera instanceof THREE.PerspectiveCamera) {
      this.engine.activeCamera.aspect = w / h;
      this.engine.activeCamera.updateProjectionMatrix();
    }
  }

  private takeShot(format: string): string {
    return this.engine.renderer.domElement.toDataURL(format, 0.9);
  }

  // --------------------------------------------------------------------------
  // UTILS C√ÅMARA & OBJETOS
  // --------------------------------------------------------------------------
  private fitCameraToSingleObject(obj: THREE.Object3D) {
    const box = this.getObjectBoundingBox(obj);
    if (box.isEmpty()) return;
    this.positionCameraFromBox(box, 1.2);
  }

  private fitCameraToScene(margin = 1.2) {
    const box = this.getSceneBoundingBox();
    if (box.isEmpty()) return;
    this.positionCameraFromBox(box, margin);
  }

  private positionCameraFromBox(box: THREE.Box3, margin: number) {
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);
    if (this.engine.activeCamera instanceof THREE.PerspectiveCamera) {
      const fov = (this.engine.activeCamera.fov * Math.PI) / 180;
      let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * margin;
      const aspect = this.engine.activeCamera.aspect;
      if (aspect < 1) cameraZ = cameraZ / aspect;
      const dir = new THREE.Vector3(1, 0.5, 1).normalize();
      const newPos = dir.multiplyScalar(cameraZ).add(center);
      this.engine.activeCamera.position.copy(newPos);
      this.engine.activeCamera.lookAt(center);
    }
  }

  private setVisibilityForAllItems(visible: boolean) {
    this.engine.scene.traverse((obj) => {
      if (obj.userData?.isItem) {
        obj.visible = visible;
        obj.traverse((c) => {
          if (c !== obj) c.visible = visible;
        });
      }
    });
  }

  private setVisibilityForItem(uuid: string, visible: boolean) {
    const obj = this.engine.scene.getObjectByProperty("uuid", uuid);
    if (obj) {
      obj.visible = visible;
      obj.traverse((child) => (child.visible = visible));
      let parent = obj.parent;
      while (parent && parent !== this.engine.scene) {
        parent.visible = true;
        parent = parent.parent;
      }
    }
  }

  private getObjectBoundingBox(obj: THREE.Object3D): THREE.Box3 {
    const box = new THREE.Box3();
    obj.traverse((child) => {
      if ((child as THREE.Mesh).isMesh) {
        const mesh = child as THREE.Mesh;
        if (!mesh.geometry.boundingBox) mesh.geometry.computeBoundingBox();
        box.expandByObject(mesh);
      }
    });
    return box;
  }

  private getSceneBoundingBox(): THREE.Box3 {
    const box = new THREE.Box3();
    this.engine.scene.traverse((obj) => {
      if (obj.visible && obj.userData?.isItem) {
        box.expandByObject(obj);
      }
    });
    if (box.isEmpty())
      box.setFromCenterAndSize(
        new THREE.Vector3(),
        new THREE.Vector3(5, 5, 5)
      );
    return box;
  }

  private hideHelpers(hide: boolean) {
    this.engine.scene.traverse((obj) => {
      const isGrid = obj instanceof THREE.GridHelper;
      const isHelper = obj.type.includes("Helper") || obj.name.includes("Helper");
      const isZone = obj.userData?.isSafetyZone;
      const isShadowPlane = obj.name === "ShadowPlane";
      if (isGrid || isHelper || isZone || isShadowPlane) {
        obj.visible = !hide;
      }
    });
  }

  private setShadows(enabled: boolean) {
    if (this.engine.sceneManager.dirLight) {
      this.engine.sceneManager.dirLight.castShadow = enabled;
    }
  }

  // ========================================================================
  // MAQUETACI√ìN PDF
  // ========================================================================

  private generatePDFDocument(
    doc: jsPDF,
    projectName: string,
    coverImg: string,
    views: Record<string, string>,
    items: SceneItem[],
    uniqueItemsMap: Map<string, SceneItem>,
    itemImages: Record<string, { img: string; width: number; height: number }>,
    user: any
  ) {
    const m = 15;
    const w = doc.internal.pageSize.getWidth();

    // --- PORTADA ---
    this.addHeader(doc, projectName, "Dossier del Proyecto");
    if (coverImg) this.drawImageProp(doc, coverImg, m, 50, w - 2 * m, 120);
    this.addFooter(doc);

    // --- VISTAS T√âCNICAS ---
    doc.addPage();
    this.addHeader(doc, "Vistas T√©cnicas", "");
    const gw = (w - 3 * m) / 2;
    const gh = 80;
    const yRow1 = 50;
    const yRow2 = yRow1 + gh + 15;

    doc.setFontSize(10);
    doc.text("Alzado (Frontal)", m, yRow1 - 2);
    if (views.front) this.drawImageProp(doc, views.front, m, yRow1, gw, gh);
    doc.text("Perfil (Lateral)", m + gw + m, yRow1 - 2);
    if (views.side)
      this.drawImageProp(doc, views.side, m + gw + m, yRow1, gw, gh);
    doc.text("Planta (Superior)", m, yRow2 - 2);
    if (views.top) this.drawImageProp(doc, views.top, m, yRow2, gw, gh);
    doc.text("Isom√©trica", m + gw + m, yRow2 - 2);
    if (views.iso)
      this.drawImageProp(doc, views.iso, m + gw + m, yRow2, gw, gh);
    this.addFooter(doc);

    // --- PRESUPUESTO (SOLO SI HAY USER) ---
    if (user) {
      doc.addPage();
      this.addHeader(doc, "Estimaci√≥n orientativa", "");
      let total = 0;
      const tableData = items.map((item) => {
        const price = PriceCalculator.getItemPrice(item);
        total += price;
        return [
          item.name || "Elemento",
          item.productId.substring(0, 15).toUpperCase(),
          PriceCalculator.getItemDimensions(item),
          price.toLocaleString("es-ES", {
            style: "currency",
            currency: "EUR",
          }),
        ];
      });
      const iva = total * 0.21;
      autoTable(doc, {
        head: [["Concepto", "Ref", "Ud/Dim", "Precio"]],
        body: tableData,
        startY: 40,
        theme: "striped",
        headStyles: { fillColor: [41, 128, 185] },
        foot: [
          [
            "",
            "",
            "Base Imponible",
            total.toLocaleString("es-ES", {
              style: "currency",
              currency: "EUR",
            }),
          ],
          [
            "",
            "",
            "IVA 21%",
            iva.toLocaleString("es-ES", {
              style: "currency",
              currency: "EUR",
            }),
          ],
          [
            "",
            "",
            "TOTAL",
            (total + iva).toLocaleString("es-ES", {
              style: "currency",
              currency: "EUR",
            }),
          ],
        ],
        footStyles: {
          fillColor: [240, 240, 240],
          textColor: 0,
          fontStyle: "bold",
          halign: "right",
        },
        columnStyles: { 3: { halign: "right" } },
      });
      this.addFooter(doc);
    }

    // --- FICHAS ---
    for (const [key, item] of uniqueItemsMap) {
      doc.addPage();
      const anyItem = item as any;

      this.addHeader(
        doc,
        item.name || "Ficha T√©cnica",
        item.productId.toUpperCase()
      );

      if (itemImages[key]) {
        this.drawImageProp(doc, itemImages[key].img, m, 40, w - 2 * m, 100);
      }

      const yStart = 150;
      doc.setFontSize(12);
      doc.setTextColor(0);
      doc.text("Descripci√≥n:", m, yStart);
      doc.setFontSize(10);
      doc.setTextColor(80);

      const descRaw = this.findValueInItem(anyItem, [
        "DESCRIPCION",
        "Descripcion",
        "Description",
        "description",
      ]);
      const finalDesc = descRaw
        ? descRaw
        : "Elemento certificado para uso p√∫blico conforme a normativa vigente.";
      const splitDesc = doc.splitTextToSize(finalDesc, w - 2 * m);
      doc.text(splitDesc, m, yStart + 7);

      // --- LINKS DIN√ÅMICOS ---
      let linkY = yStart + 20 + splitDesc.length * 5;
      doc.setFont("helvetica", "bold");

      const urlTech = this.findValueInItem(anyItem, [
        "URL_TECH",
        "url_tech",
        "Url_Tech",
      ]);
      linkY += this.renderLinkLine(
        doc,
        "Ficha T√©cnica (PDF)",
        urlTech,
        m,
        linkY
      );

      const urlCert = this.findValueInItem(anyItem, [
        "URL_CERT",
        "url_cert",
        "Url_Cert",
      ]);
      linkY += this.renderLinkLine(
        doc,
        "Certificado de Conformidad",
        urlCert,
        m,
        linkY
      );

      const urlInst = this.findValueInItem(anyItem, [
        "URL_INST",
        "url_inst",
        "Url_Inst",
      ]);
      linkY += this.renderLinkLine(
        doc,
        "Instrucciones de Montaje",
        urlInst,
        m,
        linkY
      );

      this.addFooter(doc);
    }

    doc.save(`${projectName}_Levipark.pdf`);
  }

  private renderLinkLine(
    doc: jsPDF,
    label: string,
    url: string | undefined,
    x: number,
    y: number
  ): number {
    if (!url || url.length < 5 || url.toLowerCase() === "undefined") {
      return 0;
    }
    doc.setTextColor(0, 102, 204);
    doc.text(`>> ${label}`, x, y);
    doc.link(x, y - 5, 100, 8, { url: url.trim() });
    return 8;
  }

  private findValueInItem(item: any, keys: string[]): string | undefined {
    const data = item.data || {};
    for (const k of keys) {
      if (data[k]) return data[k];
      if (item[k]) return item[k];
    }
    return undefined;
  }

  private drawImageProp(
    doc: jsPDF,
    imgData: string,
    x: number,
    y: number,
    w: number,
    h: number
  ) {
    const props = doc.getImageProperties(imgData);
    const ratioBox = w / h;
    const ratioImg = props.width / props.height;
    let newW = w;
    let newH = h;
    if (ratioImg > ratioBox) newH = w / ratioImg;
    else newW = h * ratioImg;
    const offsetX = x + (w - newW) / 2;
    const offsetY = y + (h - newH) / 2;
    doc.addImage(imgData, "JPEG", offsetX, offsetY, newW, newH);
  }

  private addHeader(doc: jsPDF, title: string, subtitle: string) {
    doc.setFontSize(22);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(40);
    doc.text(title, 20, 20);
    if (subtitle) {
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(150);
      doc.text(subtitle, 190, 20, { align: "right" });
    }
    doc.setDrawColor(200);
    doc.line(20, 25, 190, 25);
  }

  private addFooter(doc: jsPDF) {
    const h = doc.internal.pageSize.getHeight();
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.text(`Generado: ${new Date().toLocaleDateString()}`, 20, h - 10);
    doc.text("Levipark 21 - www.levipark21.es", 190, h - 10, {
      align: "right",
    });
  }
}
// --- END OF FILE src/features/editor/engine/managers/PDFManager.ts ---
</file>

<file path="src/features/editor/engine/managers/RecorderManager.ts">
// --- START OF FILE src/features/editor/engine/managers/RecorderManager.ts ---
import * as THREE from "three";
import type { A42Engine } from "../A42Engine";
import { useEditorStore } from "@/stores/editor/useEditorStore";

export class RecorderManager {
  private engine: A42Engine;
  private mediaRecorder: MediaRecorder | null = null;
  private recordedChunks: Blob[] = [];
  public isRecording: boolean = false;
  private recIndicator: HTMLElement | null = null;

  // Variables para la animaci√≥n 360
  private isOrbiting = false;
  private orbitCenter = new THREE.Vector3();
  private orbitRadius = 10;
  private orbitHeight = 10;
  private orbitDuration = 8.0;
  private orbitTimeElapsed = 0;

  private pendingFileName: string = "";

  constructor(engine: A42Engine) {
    this.engine = engine;
    this.createRecIndicator();
  }

  private createRecIndicator() {
    this.recIndicator = document.createElement("div");
    this.recIndicator.innerText = "üî¥ REC";
    this.recIndicator.style.position = "absolute";
    this.recIndicator.style.top = "20px";
    this.recIndicator.style.right = "20px";
    this.recIndicator.style.color = "red";
    this.recIndicator.style.fontWeight = "bold";
    this.recIndicator.style.fontSize = "20px";
    this.recIndicator.style.fontFamily = "monospace";
    this.recIndicator.style.background = "rgba(0, 0, 0, 0.5)";
    this.recIndicator.style.padding = "5px 15px";
    this.recIndicator.style.borderRadius = "5px";
    this.recIndicator.style.pointerEvents = "none";
    this.recIndicator.style.display = "none";
    this.recIndicator.style.zIndex = "9999";

    this.recIndicator.style.animation = "blink 1s infinite";
    const style = document.createElement("style");
    style.innerHTML = `
      @keyframes blink { 
        0% { opacity: 1; } 
        50% { opacity: 0.3; } 
        100% { opacity: 1; } 
      }
    `;
    document.head.appendChild(style);
    document.body.appendChild(this.recIndicator);
  }

  // --- 1. FOTO ---
  public async takeScreenshot() {
    const name = await useEditorStore.getState().requestInput(
      "Nombre de la foto:",
      "captura"
    );
    if (name === null) return;

    this.engine.renderer.render(this.engine.scene, this.engine.activeCamera);
    const dataURL = this.engine.renderer.domElement.toDataURL("image/png");

    const a = document.createElement("a");
    a.href = dataURL;
    a.download = `${name}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // --- 2. ORBIT 360 ---
  public async startOrbitAnimation() {
    if (this.isRecording || this.isOrbiting) return;

    const name = await useEditorStore.getState().requestInput(
      "Nombre del video 360:",
      "video-360"
    );
    if (name === null) return;

    this.pendingFileName = name;

    const box = new THREE.Box3();
    let hasItems = false;
    this.engine.scene.traverse((obj) => {
      if (obj.userData?.isItem) {
        box.expandByObject(obj);
        hasItems = true;
      }
    });
    if (!hasItems) {
      alert("A√±ade objetos a la escena.");
      return;
    }

    box.getCenter(this.orbitCenter);
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.z);

    this.orbitRadius = maxDim * 0.85 + 2;
    this.orbitHeight = maxDim * 0.4 + 1;
    this.orbitTimeElapsed = 0;

    this.engine.switchCamera("perspective");
    this.engine.sceneManager.controls.enabled = false;

    this.isOrbiting = true;
    this.startRecording();
  }

  public update(delta: number) {
    if (!this.isOrbiting) return;

    this.orbitTimeElapsed += delta;
    const progress = this.orbitTimeElapsed / this.orbitDuration;
    const angle = progress * Math.PI * 2;

    const camX = this.orbitCenter.x + Math.cos(angle) * this.orbitRadius;
    const camZ = this.orbitCenter.z + Math.sin(angle) * this.orbitRadius;

    this.engine.activeCamera.position.set(
      camX,
      this.orbitCenter.y + this.orbitHeight,
      camZ
    );
    this.engine.activeCamera.lookAt(this.orbitCenter);

    if (this.orbitTimeElapsed >= this.orbitDuration) {
      this.stopOrbitAnimation();
    }
  }

  private stopOrbitAnimation() {
    this.isOrbiting = false;
    this.stopRecording();
    this.engine.sceneManager.controls.enabled = true;
  }

  // --- GRABACI√ìN ---
  public startRecording() {
    if (this.isRecording) return;

    if (!this.isOrbiting) this.pendingFileName = "";

    const canvas = this.engine.renderer.domElement;
    const stream = canvas.captureStream(30);

    let mimeType = "video/webm;codecs=vp9";
    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "video/webm";

    const options: MediaRecorderOptions = { mimeType };

    try {
      this.mediaRecorder = new MediaRecorder(stream, options);
    } catch (e) {
      console.error("Error recorder:", e);
      return;
    }

    this.recordedChunks = [];
    this.isRecording = true;

    if (this.recIndicator) this.recIndicator.style.display = "block";

    this.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) this.recordedChunks.push(event.data);
    };

    this.mediaRecorder.onstop = this.saveVideo;
    this.mediaRecorder.start();
    console.log("üé• Grabaci√≥n iniciada...");
  }

  public stopRecording() {
    if (!this.mediaRecorder || !this.isRecording) return;

    this.mediaRecorder.stop();
    this.isRecording = false;
    if (this.recIndicator) this.recIndicator.style.display = "none";
    console.log("üõë Grabaci√≥n detenida.");
  }

  private saveVideo = async () => {
    let fileName = this.pendingFileName;

    if (!fileName) {
      setTimeout(async () => {
        const result = await useEditorStore.getState().requestInput(
          "Nombre del recorrido:",
          "paseo-virtual"
        );
        if (result === null) return;
        this.downloadBlob(result);
      }, 50);
    } else {
      this.downloadBlob(fileName);
    }
  };

  private downloadBlob(filename: string) {
    const blob = new Blob(this.recordedChunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.style.display = "none";
    a.href = url;
    a.download = `${filename}.webm`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }, 100);
  }
}
// --- END OF FILE src/features/editor/engine/managers/RecorderManager.ts ---
</file>

<file path="src/features/editor/engine/managers/SceneManager.ts">
// --- START OF FILE src/features/editor/engine/managers/SceneManager.ts ---
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
import { Sky } from 'three/examples/jsm/objects/Sky.js';

// üî• YA NO DEPENDE DE useAppStore ‚Üí definimos aqu√≠ el tipo
export type CameraView = "top" | "front" | "side" | "iso";

export class SceneManager {
  public scene: THREE.Scene;
  public perspectiveCamera: THREE.PerspectiveCamera;
  public orthoCamera: THREE.OrthographicCamera;
  public activeCamera: THREE.Camera;
  public renderer: THREE.WebGLRenderer;
  public controls: OrbitControls;
  public gridHelper: THREE.GridHelper | null = null;
  public dirLight: THREE.DirectionalLight | null = null;
  public sky: Sky | null = null;

  private container: HTMLElement;
  private frameOverlay: HTMLElement | null = null;

  constructor(container: HTMLElement) {
    this.container = container;
    const width = container.clientWidth;
    const height = container.clientHeight;
    const aspect = width / height;

    // SCENE
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0x222222);

    // PERSPECTIVE CAMERA
    this.perspectiveCamera = new THREE.PerspectiveCamera(45, aspect, 0.1, 10000);
    this.perspectiveCamera.position.set(10, 15, 10);

    // ORTHOGRAPHIC CAMERA
    const frustumSize = 20;
    this.orthoCamera = new THREE.OrthographicCamera(
      (frustumSize * aspect) / -2,
      (frustumSize * aspect) / 2,
      frustumSize / 2,
      frustumSize / -2,
      0.1,
      10000
    );
    this.orthoCamera.position.set(20, 20, 20);
    this.orthoCamera.lookAt(0, 0, 0);

    this.activeCamera = this.perspectiveCamera;

    // RENDERER
    this.renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: false,
      preserveDrawingBuffer: true,
      powerPreference: "high-performance"
    });

    this.renderer.setSize(width, height);
    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    this.renderer.shadowMap.enabled = true;
    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    this.renderer.outputColorSpace = THREE.SRGBColorSpace;
    this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
    this.renderer.toneMappingExposure = 1.0;

    container.appendChild(this.renderer.domElement);

    // ORBIT CONTROLS
    this.controls = new OrbitControls(this.activeCamera, this.renderer.domElement);
    this.controls.enableDamping = true;
    this.controls.dampingFactor = 0.05;

    this.controls.screenSpacePanning = true;

    this.controls.minDistance = 1;
    this.controls.maxDistance = 500;
    this.controls.maxPolarAngle = Math.PI / 2 - 0.02;

    this.controls.mouseButtons = {
      LEFT: THREE.MOUSE.ROTATE,
      MIDDLE: THREE.MOUSE.DOLLY,
      RIGHT: THREE.MOUSE.PAN
    };

    this.initEnvironment();
    this.initFrameOverlay();

    // SHADOW RECEIVER PLANE
    const shadowPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(2000, 2000),
      new THREE.ShadowMaterial({ opacity: 0.3, color: 0x000000 })
    );
    shadowPlane.rotation.x = -Math.PI / 2;
    shadowPlane.position.y = 0.001;
    shadowPlane.receiveShadow = true;
    shadowPlane.name = "ShadowPlane";
    this.scene.add(shadowPlane);
  }

  // ---------------------------------------------------------------------
  // FRAME MASK FOR PDF AREA
  // ---------------------------------------------------------------------
  private initFrameOverlay() {
    this.frameOverlay = document.createElement('div');

    this.frameOverlay.style.position = 'absolute';
    this.frameOverlay.style.border = '2px dashed rgba(255,255,255,0.9)';
    this.frameOverlay.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.7)';
    this.frameOverlay.style.pointerEvents = 'none';
    this.frameOverlay.style.zIndex = '100';
    this.frameOverlay.style.display = 'none';
    this.frameOverlay.style.left = '50%';
    this.frameOverlay.style.top = '50%';
    this.frameOverlay.style.transform = 'translate(-50%, -50%)';

    const label = document.createElement('div');
    label.innerText = '√ÅREA PDF PORTADA';
    label.style.position = 'absolute';
    label.style.bottom = '-25px';
    label.style.left = '50%';
    label.style.transform = 'translateX(-50%)';
    label.style.color = 'white';
    label.style.fontWeight = 'bold';
    label.style.fontSize = '12px';

    this.frameOverlay.appendChild(label);

    if (getComputedStyle(this.container).position === 'static') {
      this.container.style.position = 'relative';
    }

    this.container.appendChild(this.frameOverlay);
  }

  public setFrameVisible(visible: boolean) {
    if (this.frameOverlay) {
      this.frameOverlay.style.display = visible ? 'block' : 'none';
      if (visible) this.updateFrameDimensions();
    }
  }

  public updateFrameDimensions() {
    if (!this.frameOverlay || this.frameOverlay.style.display === 'none') return;

    const containerW = this.container.clientWidth;
    const containerH = this.container.clientHeight;

    const targetAspect = 170 / 120;
    const screenAspect = containerW / containerH;

    let frameW, frameH;

    if (screenAspect > targetAspect) {
      frameH = containerH * 0.85;
      frameW = frameH * targetAspect;
    } else {
      frameW = containerW * 0.85;
      frameH = frameW / targetAspect;
    }

    this.frameOverlay.style.width = `${frameW}px`;
    this.frameOverlay.style.height = `${frameH}px`;
  }

  // ---------------------------------------------------------------------
  // ENVIRONMENT
  // ---------------------------------------------------------------------
  private initEnvironment() {
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6);
    this.scene.add(hemiLight);

    this.dirLight = new THREE.DirectionalLight(0xffffff, 2.5);
    this.dirLight.position.set(50, 80, 50);
    this.dirLight.castShadow = true;
    this.dirLight.shadow.mapSize.width = 2048;
    this.dirLight.shadow.mapSize.height = 2048;

    const d = 50;
    this.dirLight.shadow.camera.left = -d;
    this.dirLight.shadow.camera.right = d;
    this.dirLight.shadow.camera.top = d;
    this.dirLight.shadow.camera.bottom = -d;
    this.dirLight.shadow.bias = -0.0001;

    this.scene.add(this.dirLight);

    this.sky = new Sky();
    this.sky.scale.setScalar(450000);

    const u = this.sky.material.uniforms;
    u['turbidity'].value = 10;
    u['rayleigh'].value = 3;
    u['mieCoefficient'].value = 0.005;
    u['mieDirectionalG'].value = 0.7;

    this.updateSunPosition(180, 45);
    this.scene.add(this.sky);

    this.gridHelper = new THREE.GridHelper(100, 100, 0x888888, 0x444444);
    this.gridHelper.visible = true;
    this.gridHelper.position.y = 0.002;
    this.scene.add(this.gridHelper);
  }

  public updateSunPosition(azimuth: number, elevation: number) {
    if (!this.sky || !this.dirLight) return;

    const phi = THREE.MathUtils.degToRad(90 - elevation);
    const theta = THREE.MathUtils.degToRad(azimuth);

    const sunPos = new THREE.Vector3();
    sunPos.setFromSphericalCoords(1, phi, theta);

    this.sky.material.uniforms['sunPosition'].value.copy(sunPos);
    this.dirLight.position.copy(sunPos).multiplyScalar(100);
  }

  public setBackgroundColor(color: string) {
    this.scene.background = new THREE.Color(color);
    if (this.sky) this.sky.visible = false;
  }

  public setSkyVisible(visible: boolean) {
    if (this.sky) {
      this.sky.visible = visible;
      if (visible) this.scene.background = null;
    }
  }

  public setGridVisible(v: boolean) {
    if (this.gridHelper) this.gridHelper.visible = v;
  }

  // ---------------------------------------------------------------------
  // CAMERAS
  // ---------------------------------------------------------------------
  public switchCamera(type: "perspective" | "orthographic") {
    const oldPos = this.activeCamera.position.clone();
    const target = this.controls.target.clone();

    if (type === "orthographic") {
      this.activeCamera = this.orthoCamera;
      this.orthoCamera.zoom = 1;
      this.orthoCamera.updateProjectionMatrix();
    } else {
      this.activeCamera = this.perspectiveCamera;
    }

    this.activeCamera.position.copy(oldPos);
    this.activeCamera.lookAt(target);

    this.controls.object = this.activeCamera;
    this.controls.update();
  }

  public setView(view: CameraView) {
    const d = 20;
    const t = new THREE.Vector3(0, 0, 0);

    let p = new THREE.Vector3();

    if (view === "top") p.set(0, d, 0);
    else if (view === "front") p.set(0, 0, d);
    else if (view === "side") p.set(d, 0, 0);
    else p.set(d, d, d);

    this.activeCamera.position.copy(p);
    this.activeCamera.lookAt(t);

    this.controls.target.copy(t);
    this.controls.update();
  }

  // ---------------------------------------------------------------------
  // RESIZE + DISPOSE
  // ---------------------------------------------------------------------
  public onWindowResize = () => {
    if (!this.container) return;

    const w = this.container.clientWidth;
    const h = this.container.clientHeight;

    this.perspectiveCamera.aspect = w / h;
    this.perspectiveCamera.updateProjectionMatrix();

    const a = w / h;
    const s = 20;
    this.orthoCamera.left = -(s * a) / 2;
    this.orthoCamera.right = (s * a) / 2;
    this.orthoCamera.top = s / 2;
    this.orthoCamera.bottom = -s / 2;
    this.orthoCamera.updateProjectionMatrix();

    this.renderer.setSize(w, h);

    this.updateFrameDimensions();
  };

  public dispose() {
    try {
      this.container.removeChild(this.renderer.domElement);
      if (this.frameOverlay) this.container.removeChild(this.frameOverlay);
    } catch (e) {}
    this.controls.dispose();
    this.renderer.dispose();
  }
}
// --- END OF FILE ---
</file>

<file path="src/features/editor/engine/managers/ToolsManager.ts">
// --- START OF FILE src/features/editor/engine/managers/ToolsManager.ts ---
import * as THREE from "three";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useCADStore } from "@/stores/cad/useCADStore";
import { useFenceStore } from "@/stores/fence/useFenceStore";

export class ToolsManager {
  private scene: THREE.Scene;

  // Floor Tools
  public floorPoints: THREE.Vector3[] = [];
  private floorMarkers: THREE.Mesh[] = [];
  private previewLine: THREE.Line | null = null;
  public floorEditMarkers: THREE.Mesh[] = [];
  public activeFloorId: string | null = null;

  // FENCE TOOLS
  public fencePoints: THREE.Vector3[] = [];
  private fenceMarkers: THREE.Mesh[] = [];
  private fencePreviewLine: THREE.Line | null = null;

  // CAD Selection (√≠ndices de marcadores)
  private selectedMarkerIndices: number[] = [];

  // Measure Tools
  private measurePoints: THREE.Vector3[] = [];
  private measureLine: THREE.Line | null = null;
  private measureMarkers: THREE.Mesh[] = [];

  constructor(scene: THREE.Scene) {
    this.scene = scene;
  }

  public clearTools() {
    // Medidas
    this.measureMarkers.forEach((m) => this.scene.remove(m));
    this.measureMarkers = [];
    if (this.measureLine) {
      this.scene.remove(this.measureLine);
      this.measureLine = null;
    }
    this.measurePoints = [];

    // Suelos (dibujo)
    this.floorMarkers.forEach((m) => this.scene.remove(m));
    this.floorMarkers = [];
    if (this.previewLine) {
      this.scene.remove(this.previewLine);
      this.previewLine = null;
    }
    this.floorPoints = [];

    // Vallas
    this.fenceMarkers.forEach((m) => this.scene.remove(m));
    this.fenceMarkers = [];
    if (this.fencePreviewLine) {
      this.scene.remove(this.fencePreviewLine);
      this.fencePreviewLine = null;
    }
    this.fencePoints = [];

    // CAD
    this.selectedMarkerIndices = [];
    useCADStore.getState().setSelectedVertices([], null, null);

    // Si no estamos en modo edici√≥n, quitamos tambi√©n marcadores de edici√≥n de suelo
    const editor = useEditorStore.getState();
    if (editor.mode !== "editing") {
      this.clearFloorEditMarkers();
      this.activeFloorId = null;
    }
  }

  // ---------------------------------------------------------------------------
  // DRAWING FLOOR
  // ---------------------------------------------------------------------------
  public addDraftPoint(point: THREE.Vector3) {
    const p = point.clone();
    p.y = 0.05;
    if (
      this.floorPoints.length > 0 &&
      p.distanceTo(this.floorPoints[this.floorPoints.length - 1]) < 0.1
    )
      return;

    this.floorPoints.push(p);
    const marker = new THREE.Mesh(
      new THREE.SphereGeometry(0.15),
      new THREE.MeshBasicMaterial({ color: 0xe67e22 })
    );
    marker.position.copy(p);
    this.scene.add(marker);
    this.floorMarkers.push(marker);

    if (this.previewLine) this.scene.remove(this.previewLine);
    if (this.floorPoints.length > 1) {
      const geometry = new THREE.BufferGeometry().setFromPoints(
        this.floorPoints
      );
      this.previewLine = new THREE.Line(
        geometry,
        new THREE.LineBasicMaterial({ color: 0x9b59b6 })
      );
      this.scene.add(this.previewLine);
    }
  }

  public createSolidFloor() {
    if (this.floorPoints.length < 3) return;

    const editor = useEditorStore.getState();
    const uuid = THREE.MathUtils.generateUUID();
    const points2D = this.floorPoints.map((p) => ({ x: p.x, z: p.z }));

    editor.addItem({
      uuid,
      productId: "custom_floor",
      name: "Suelo a medida",
      price: 100,
      position: [0, 0, 0],
      rotation: [0, 0, 0],
      scale: [1, 1, 1],
      type: "floor",
      points: points2D,
      floorMaterial: "rubber_red",
    });

    this.clearTools();
    editor.setMode("idle");
  }

  // ---------------------------------------------------------------------------
  // DRAWING FENCE
  // ---------------------------------------------------------------------------
  public addFenceDraftPoint(point: THREE.Vector3) {
    const p = point.clone();
    p.y = 0;
    if (
      this.fencePoints.length > 0 &&
      p.distanceTo(this.fencePoints[this.fencePoints.length - 1]) < 0.1
    )
      return;

    this.fencePoints.push(p);
    const marker = new THREE.Mesh(
      new THREE.SphereGeometry(0.15),
      new THREE.MeshBasicMaterial({ color: 0x3b82f6 })
    );
    marker.position.copy(p);
    this.scene.add(marker);
    this.fenceMarkers.push(marker);

    if (this.fencePreviewLine) this.scene.remove(this.fencePreviewLine);
    if (this.fencePoints.length > 1) {
      const geometry = new THREE.BufferGeometry().setFromPoints(
        this.fencePoints
      );
      this.fencePreviewLine = new THREE.Line(
        geometry,
        new THREE.LineBasicMaterial({ color: 0x3b82f6, linewidth: 2 })
      );
      this.scene.add(this.fencePreviewLine);
    }
  }

  public createSolidFence() {
    if (this.fencePoints.length < 2) return;

    // @ts-ignore ‚Äì el engine global ya lo est√°s usando en otros sitios
    const engine = window.editorEngine as any;
    if (!engine) return;

    const fenceStore = useFenceStore.getState();
    const editor = useEditorStore.getState();

    const points2D = this.fencePoints.map((p) => ({ x: p.x, z: p.z }));
    const currentConfig = fenceStore.config;

    const fenceGroup = engine.objectManager.createFenceObject(
      this.fencePoints,
      currentConfig
    );

    if (fenceGroup) {
      const uuid = THREE.MathUtils.generateUUID();
      fenceGroup.uuid = uuid;
      fenceGroup.userData.isItem = true;
      fenceGroup.userData.type = "fence";
      engine.scene.add(fenceGroup);

      editor.addItem({
        uuid,
        productId: "fence_" + currentConfig.presetId,
        name: "Valla",
        price: 100,
        position: [0, 0, 0],
        rotation: [0, 0, 0],
        scale: [1, 1, 1],
        type: "fence",
        points: points2D,
        fenceConfig: JSON.parse(JSON.stringify(currentConfig)),
      });
    }

    this.clearTools();
    editor.setMode("idle");
  }

  // ---------------------------------------------------------------------------
  // EDIT FLOOR (CAD sobre suelos)
  // ---------------------------------------------------------------------------
  public showFloorEditMarkers(
    itemUuid: string,
    points: { x: number; z: number }[]
  ) {
    this.clearFloorEditMarkers();
    this.activeFloorId = itemUuid;

    points.forEach((pt, index) => {
      const marker = new THREE.Mesh(
        new THREE.BoxGeometry(0.4, 0.4, 0.4),
        new THREE.MeshBasicMaterial({
          color: 0x00ff00,
          transparent: true,
          opacity: 0.8,
        })
      );
      marker.position.set(pt.x, 0.0, pt.z);
      marker.userData.isFloorMarker = true;
      marker.userData.pointIndex = index;
      marker.userData.parentUuid = itemUuid;
      this.scene.add(marker);
      this.floorEditMarkers.push(marker);
    });
  }

  public selectVertex(index: number, multiSelect: boolean) {
    if (!multiSelect) {
      this.selectedMarkerIndices = [index];
    } else {
      if (this.selectedMarkerIndices.includes(index)) {
        this.selectedMarkerIndices = this.selectedMarkerIndices.filter(
          (i) => i !== index
        );
      } else {
        this.selectedMarkerIndices.push(index);
        if (this.selectedMarkerIndices.length > 3)
          this.selectedMarkerIndices.shift();
      }
    }

    this.updateMarkerColors();
    this.calculateAndSyncData();
  }

  public swapSelectionOrder() {
    if (this.selectedMarkerIndices.length === 2) {
      this.selectedMarkerIndices.reverse();
      this.updateMarkerColors();
      this.calculateAndSyncData();
    }
  }

  private updateMarkerColors() {
    this.floorEditMarkers.forEach((m) => {
      const idx = m.userData.pointIndex;
      const mat = m.material as THREE.MeshBasicMaterial;
      let color = 0x00ff00; // normal

      const posInArray = this.selectedMarkerIndices.indexOf(idx);
      if (posInArray === 0) color = 0x3b82f6; // primero
      if (posInArray === 1) color = 0xff0000; // segundo
      if (posInArray === 2) color = 0xffff00; // tercero

      mat.color.setHex(color);
    });
  }

  private calculateAndSyncData() {
    let dist: number | null = null;
    let angle: number | null = null;

    if (this.selectedMarkerIndices.length >= 2) {
      const m0 = this.getMarker(this.selectedMarkerIndices[0]);
      const m1 = this.getMarker(this.selectedMarkerIndices[1]);
      if (m0 && m1) dist = m0.position.distanceTo(m1.position);
    }

    if (this.selectedMarkerIndices.length === 3) {
      const pRef = this.getMarker(this.selectedMarkerIndices[0])?.position;
      const pPiv = this.getMarker(this.selectedMarkerIndices[1])?.position;
      const pMov = this.getMarker(this.selectedMarkerIndices[2])?.position;

      if (pRef && pPiv && pMov) {
        const v1 = new THREE.Vector3().subVectors(pRef, pPiv).normalize();
        const v2 = new THREE.Vector3().subVectors(pMov, pPiv).normalize();
        const angleRad = v1.angleTo(v2);
        angle = THREE.MathUtils.radToDeg(angleRad);
      }
    }

    useCADStore
      .getState()
      .setSelectedVertices([...this.selectedMarkerIndices], dist, angle);
  }

  private getMarker(index: number) {
    return this.floorEditMarkers.find(
      (m) => m.userData.pointIndex === index
    );
  }

  public setSegmentLength(
    newLength: number,
    indexToMove: number,
    indexAnchor: number
  ) {
    const markerMove = this.getMarker(indexToMove);
    const markerAnchor = this.getMarker(indexAnchor);
    if (!markerMove || !markerAnchor) return;

    const direction = new THREE.Vector3()
      .subVectors(markerMove.position, markerAnchor.position)
      .normalize();

    const newPos = markerAnchor.position
      .clone()
      .add(direction.multiplyScalar(newLength));

    markerMove.position.copy(newPos);
    this.updateFloorFromMarkers(markerMove);
    this.calculateAndSyncData();
  }

  public setVertexAngle(targetAngleDeg: number) {
    if (this.selectedMarkerIndices.length !== 3) return;

    const idxRef = this.selectedMarkerIndices[0];
    const idxPiv = this.selectedMarkerIndices[1];
    const idxMov = this.selectedMarkerIndices[2];

    const mRef = this.getMarker(idxRef);
    const mPiv = this.getMarker(idxPiv);
    const mMov = this.getMarker(idxMov);
    if (!mRef || !mPiv || !mMov) return;

    const vecRef = new THREE.Vector3().subVectors(
      mRef.position,
      mPiv.position
    );
    const angleRef = Math.atan2(vecRef.z, vecRef.x);
    const distMov = mPiv.position.distanceTo(mMov.position);
    const targetAngleRad = THREE.MathUtils.degToRad(targetAngleDeg);
    const newAngleAbs = angleRef + targetAngleRad;

    const newX = mPiv.position.x + distMov * Math.cos(newAngleAbs);
    const newZ = mPiv.position.z + distMov * Math.sin(newAngleAbs);

    mMov.position.set(newX, 0, newZ);

    this.updateFloorFromMarkers(mMov);
    this.calculateAndSyncData();
  }

  public clearFloorEditMarkers() {
    this.floorEditMarkers.forEach((m) => this.scene.remove(m));
    this.floorEditMarkers = [];
    this.selectedMarkerIndices = [];
    useCADStore.getState().setSelectedVertices([], null, null);
  }

  public updateFloorFromMarkers(marker: THREE.Object3D) {
    const uuid = marker.userData.parentUuid;
    const idx = marker.userData.pointIndex;

    const editor = useEditorStore.getState();
    const items = editor.items;
    const floorItem = items.find((i) => i.uuid === uuid);

    if (floorItem && floorItem.points) {
      const newPoints = floorItem.points.map((p) => ({ ...p }));
      newPoints[idx] = { x: marker.position.x, z: marker.position.z };
      editor.updateFloorPoints(uuid, newPoints);
    }
  }

  // ---------------------------------------------------------------------------
  // MEDICIONES (herramienta de medir)
  // ---------------------------------------------------------------------------
  public handleMeasurementClick(point: THREE.Vector3) {
    const p = point.clone();
    p.y += 0.05;

    this.measurePoints.push(p);
    const marker = new THREE.Mesh(
      new THREE.SphereGeometry(0.1),
      new THREE.MeshBasicMaterial({
        color: 0xffff00,
        depthTest: false,
        transparent: true,
      })
    );
    marker.position.copy(p);
    this.scene.add(marker);
    this.measureMarkers.push(marker);

    const editor = useEditorStore.getState();

    if (this.measurePoints.length === 2) {
      const dist = this.measurePoints[0].distanceTo(this.measurePoints[1]);
      const material = new THREE.LineBasicMaterial({
        color: 0xffff00,
        linewidth: 2,
        depthTest: false,
      });
      const geometry = new THREE.BufferGeometry().setFromPoints(
        this.measurePoints
      );
      this.measureLine = new THREE.Line(geometry, material);
      this.scene.add(this.measureLine);
      editor.setMeasurementResult(dist);
    } else if (this.measurePoints.length > 2) {
      // Reiniciamos si clican una tercera vez
      this.clearTools();
      this.handleMeasurementClick(point);
    }
  }
}
// --- END OF FILE src/features/editor/engine/managers/ToolsManager.ts ---
</file>

<file path="src/features/editor/engine/managers/WalkManager.ts">
// --- START OF FILE src/features/editor/engine/managers/WalkManager.ts ---
import * as THREE from 'three';
import { PointerLockControls } from 'three/examples/jsm/controls/PointerLockControls.js';
import type { A42Engine } from '../A42Engine';

export class WalkManager {
  private engine: A42Engine;
  private controls: PointerLockControls;
  
  // Elemento HTML para las instrucciones
  private instructions: HTMLElement | null = null;
  
  // Estado de teclas
  private moveForward = false;
  private moveBackward = false;
  private moveLeft = false;
  private moveRight = false;
  private moveUp = false;   
  private moveDown = false; 
  private isSlow = false;   

  private velocity = new THREE.Vector3();
  private direction = new THREE.Vector3();
  
  private baseSpeed = 80.0; 
  private slowMultiplier = 0.2; 

  constructor(engine: A42Engine) {
    this.engine = engine;
    
    this.controls = new PointerLockControls(this.engine.activeCamera, this.engine.renderer.domElement);
    this.controls.pointerSpeed = 0.15; 
    
    // Crear el cartel de instrucciones (oculto al inicio)
    this.createInstructions();

    // Eventos de entrar/salir
    this.controls.addEventListener('lock', () => { 
        if (this.instructions) this.instructions.style.display = 'block';
    });
    
    this.controls.addEventListener('unlock', () => { 
        this.resetKeys(); 
        if (this.instructions) this.instructions.style.display = 'none';
    });

    document.addEventListener('keydown', this.onKeyDown);
    document.addEventListener('keyup', this.onKeyUp);
    
    this.engine.scene.add(this.controls.getObject());
  }

  private createInstructions() {
    this.instructions = document.createElement('div');
    this.instructions.innerHTML = `
        <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">MODO PASEO</div>
        <div style="font-size: 12px; opacity: 0.8;">
            <span style="margin-right: 15px;">üñ±Ô∏è Mueve para mirar</span>
            <span style="margin-right: 15px;">‚å®Ô∏è <b>WASD</b> Moverse</span>
            <span style="margin-right: 15px;">üê¢ <b>Espacio</b> Lento</span>
            <span style="margin-right: 15px;">‚ÜïÔ∏è <b>Q / E</b> Altura</span>
            <br/>
            <span style="color: #ff6b6b; font-weight: bold;">üî¥ TECLA 'R' PARA GRABAR</span>
            <span style="margin-left: 15px;">‚ùå <b>ESC</b> Salir</span>
        </div>
    `;
    
    // Estilos del cartel
    Object.assign(this.instructions.style, {
        position: 'absolute',
        bottom: '100px', // Un poco arriba del toolbar
        left: '50%',
        transform: 'translateX(-50%)',
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        color: 'white',
        padding: '15px 25px',
        borderRadius: '30px',
        textAlign: 'center',
        fontFamily: 'sans-serif',
        pointerEvents: 'none', // Para que no bloquee clicks
        display: 'none', // Oculto por defecto
        zIndex: '2000',
        backdropFilter: 'blur(5px)',
        border: '1px solid rgba(255,255,255,0.2)'
    });

    document.body.appendChild(this.instructions);
  }

  public enable() { this.controls.lock(); }
  public disable() { this.controls.unlock(); }
  public get isEnabled() { return this.controls.isLocked; }

  private resetKeys() {
      this.moveForward = false; this.moveBackward = false; 
      this.moveLeft = false; this.moveRight = false;
      this.moveUp = false; this.moveDown = false;
      this.isSlow = false;
  }

  private onKeyDown = (event: KeyboardEvent) => {
    if (document.activeElement?.tagName === 'INPUT') return;

    switch (event.code) {
      case 'ArrowUp':
      case 'KeyW': this.moveForward = true; break;
      case 'ArrowLeft':
      case 'KeyA': this.moveLeft = true; break;
      case 'ArrowDown':
      case 'KeyS': this.moveBackward = true; break;
      case 'ArrowRight':
      case 'KeyD': this.moveRight = true; break;
      case 'KeyE': this.moveUp = true; break;
      case 'KeyQ': this.moveDown = true; break;
      case 'Space': this.isSlow = true; break;
      
      case 'KeyR': 
        if (this.isEnabled) {
            const recorder = this.engine.recorderManager;
            if (recorder.isRecording) recorder.stopRecording();
            else recorder.startRecording();
        }
        break;
    }
  };

  private onKeyUp = (event: KeyboardEvent) => {
    switch (event.code) {
      case 'ArrowUp':
      case 'KeyW': this.moveForward = false; break;
      case 'ArrowLeft':
      case 'KeyA': this.moveLeft = false; break;
      case 'ArrowDown':
      case 'KeyS': this.moveBackward = false; break;
      case 'ArrowRight':
      case 'KeyD': this.moveRight = false; break;
      case 'KeyE': this.moveUp = false; break;
      case 'KeyQ': this.moveDown = false; break;
      case 'Space': this.isSlow = false; break; 
    }
  };

  public update(delta: number) {
    if (!this.controls.isLocked) return;

    this.velocity.x -= this.velocity.x * 10.0 * delta;
    this.velocity.z -= this.velocity.z * 10.0 * delta;
    this.velocity.y -= this.velocity.y * 10.0 * delta;

    this.direction.z = Number(this.moveForward) - Number(this.moveBackward);
    this.direction.x = Number(this.moveRight) - Number(this.moveLeft);
    this.direction.y = Number(this.moveUp) - Number(this.moveDown);
    this.direction.normalize();

    const currentSpeed = this.isSlow ? (this.baseSpeed * this.slowMultiplier) : this.baseSpeed;

    if (this.moveForward || this.moveBackward) this.velocity.z -= this.direction.z * currentSpeed * delta;
    if (this.moveLeft || this.moveRight) this.velocity.x -= this.direction.x * currentSpeed * delta;
    if (this.moveUp || this.moveDown) this.velocity.y += this.direction.y * currentSpeed * delta;

    this.controls.moveRight(-this.velocity.x * delta);
    this.controls.moveForward(-this.velocity.z * delta);
    this.controls.getObject().position.y += this.velocity.y * delta;
  }
}
// --- END OF FILE src/features/editor/engine/managers/WalkManager.ts ---
</file>

<file path="src/features/editor/ui/BudgetPanel.tsx">
// --- START OF FILE src/features/editor/ui/BudgetPanel.tsx ---
import { Trash2, X } from "lucide-react";

import { useUIStore } from "@/stores/ui/useUIStore"; // UI toggles
import { useEditorStore } from "@/stores/editor/useEditorStore"; // items y precios
import { useSelectionStore } from "@/stores/selection/useSelectionStore"; // selecci√≥n

export const BudgetPanel = () => {
  // UI (mostrar u ocultar panel)
  const { budgetVisible, toggleBudget } = useUIStore();

  // Datos de la escena
  const items = useEditorStore((s) => s.items);
  const totalPrice = useEditorStore((s) => s.totalPrice);

  // Acciones de escena
  const removeItem = useEditorStore((s) => s.removeItem);
  const resetScene = useEditorStore((s) => s.resetScene);

  // Selecci√≥n
  const selectItem = useSelectionStore((s) => s.selectItem);

  if (!budgetVisible) return null;

  return (
    <div className="absolute top-20 left-6 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl shadow-2xl w-80 max-h-[70vh] flex flex-col z-30 animate-in fade-in slide-in-from-left-5 duration-200">

      {/* HEADER */}
      <div className="p-4 border-b border-neutral-700 flex justify-between items-center bg-neutral-800/50 rounded-t-xl">
        <h2 className="text-white font-bold text-lg flex items-center gap-2">
          üßæ Presupuesto
        </h2>
        <button onClick={toggleBudget} className="text-neutral-400 hover:text-white">
          <X size={20} />
        </button>
      </div>

      {/* LISTA */}
      <div className="flex-grow overflow-y-auto p-2 custom-scrollbar space-y-2">
        {items.length === 0 ? (
          <div className="text-center py-8 text-neutral-500 italic">
            La escena est√° vac√≠a.
          </div>
        ) : (
          items.map((item) => (
            <div
              key={item.uuid}
              className="flex justify-between items-center p-3 bg-neutral-800 rounded-lg group hover:bg-neutral-700 transition-colors border border-transparent hover:border-blue-500/30 cursor-pointer"
              onClick={() => selectItem(item.uuid)}
            >
              <div className="flex flex-col">
                <span className="text-white font-medium text-sm">
                  {item.name || "Sin Nombre"}
                </span>

                <span className="text-xs text-neutral-500 uppercase font-mono">
                  {item.productId}
                </span>
              </div>

              <div className="flex items-center gap-3">
                <span className="text-sm font-bold text-neutral-400">
                  {item.price.toLocaleString()}‚Ç¨
                </span>

                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    removeItem(item.uuid);
                  }}
                  className="text-neutral-500 hover:text-red-400 p-2 rounded-full hover:bg-red-900/20 transition-all opacity-0 group-hover:opacity-100"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* FOOTER */}
      <div className="p-4 border-t border-neutral-700 bg-neutral-800/50 rounded-b-xl space-y-3">
        <div className="flex justify-between items-end">
          <span className="text-neutral-400 text-sm">Total Estimado</span>
          <span className="text-2xl font-bold text-green-400">
            {totalPrice.toLocaleString()} ‚Ç¨
          </span>
        </div>

        {items.length > 0 && (
          <button
            onClick={() => {
              if (window.confirm("¬øBorrar todo?")) resetScene();
            }}
            className="w-full py-2 bg-red-900/30 hover:bg-red-600 text-red-200 hover:text-white rounded-lg text-sm font-medium transition-all flex justify-center items-center gap-2 border border-red-900/50"
          >
            <Trash2 size={16} />
            Borrar Todo
          </button>
        )}
      </div>
    </div>
  );
};
// --- END OF FILE ---
</file>

<file path="src/features/editor/ui/CadControl.tsx">
// --- START OF FILE src/features/editor/ui/CadControl.tsx ---
import { useEffect, useState } from "react";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import { ArrowLeftRight, Ruler, ScanLine } from "lucide-react";

export const CadControl = () => {
  const selectedVertexIndices = useSelectionStore((s) => s.selectedVertices);
  const measuredDistance = useSelectionStore((s) => s.measuredDistance);
  const measuredAngle = useSelectionStore((s) => s.measuredAngle);

  const [inputValue, setInputValue] = useState<string>("");

  const mode = selectedVertexIndices.length === 3 ? "ANGLE" : "DISTANCE";

  useEffect(() => {
    if (mode === "ANGLE" && measuredAngle !== null) {
      setInputValue(measuredAngle.toFixed(1));
    } else if (mode === "DISTANCE" && measuredDistance !== null) {
      setInputValue(measuredDistance.toFixed(3));
    }
  }, [measuredDistance, measuredAngle, mode]);

  const handleApply = () => {
    const val = parseFloat(inputValue);
    if (isNaN(val) || val <= 0) return;

    // @ts-ignore
    if (window.editorEngine) {
      if (mode === "DISTANCE") {
        window.editorEngine.toolsManager.setSegmentLength(
          val,
          selectedVertexIndices[1],
          selectedVertexIndices[0]
        );
      } else {
        window.editorEngine.toolsManager.setVertexAngle(val);
      }
    }
  };

  const handleSwap = () => {
    // @ts-ignore
    if (window.editorEngine)
      window.editorEngine.toolsManager.swapSelectionOrder();
  };

  if (selectedVertexIndices.length < 2) return null;

  return (
    <div
      className={`p-3 rounded-lg mb-3 border-l-4 shadow-lg ${
        mode === "ANGLE"
          ? "border-yellow-500 bg-neutral-800"
          : "border-blue-500 bg-neutral-800"
      }`}
    >
      {/* ... resto igual ... */}
    </div>
  );
};
// --- END OF FILE ---
</file>

<file path="src/features/editor/ui/Catalog.tsx">
// --- START OF FILE src/features/editor/ui/Catalog.tsx ---
import { useEffect, useState, useMemo } from 'react';
import { Search, X } from 'lucide-react'; // Importamos iconos
import { useEditorStore } from '@/stores/editor/useEditorStore';
import { useCatalogStore } from '@/stores/catalog/useCatalogStore';
import { 
  loadCatalogData, 
  getCatalogDB, 
  getCatalogLoadStatus, 
  getProxiedImageUrl,
  type Product,
  type CatalogDB
} from '../../../services/catalogService';

export const Catalog = () => {
  const { setMode } = useEditorStore();
  const { setSelectedProduct } = useCatalogStore();
  const [catalogDB, setCatalogDB] = useState<CatalogDB | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Navegaci√≥n
  const [currentLine, setCurrentLine] = useState<string | null>(null);
  const [currentCategory, setCurrentCategory] = useState<string | null>(null);
  
  // B√∫squeda
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    const fetchCatalog = async () => {
      setLoading(true);
      setError(null);
      await loadCatalogData();
      const status = getCatalogLoadStatus();
      if (status.error) {
        setError(status.error);
      } else if (status.isLoaded) {
        setCatalogDB(getCatalogDB());
      }
      setLoading(false);
    };
    fetchCatalog();
  }, []);

  // --- L√ìGICA DE B√öSQUEDA ---
  // Aplanamos el cat√°logo para buscar en todos los productos a la vez
  const allProducts = useMemo(() => {
    if (!catalogDB) return [];
    const products: Product[] = [];
    Object.values(catalogDB.lines).forEach(line => {
      Object.values(line.categories).forEach(catProducts => {
        products.push(...catProducts);
      });
    });
    return products;
  }, [catalogDB]);

  // Filtramos seg√∫n lo que escriba el usuario
  const filteredProducts = useMemo(() => {
    if (!searchTerm) return [];
    const lowerTerm = searchTerm.toLowerCase();
    return allProducts.filter(p => 
      p.name.toLowerCase().includes(lowerTerm) || 
      p.id.toLowerCase().includes(lowerTerm) // Buscamos tambi√©n por REF/ID
    );
  }, [searchTerm, allProducts]);

  const handleSelectProduct = (product: Product) => {
    setSelectedProduct(product);
    setMode('placing_item');
  };

  const handleBackToLines = () => {
    setCurrentCategory(null);
    setCurrentLine(null);
    setSearchTerm(''); // Limpiar b√∫squeda al navegar con breadcrumbs
  };
  // *** se supone que no lo uso ya
  //const handleBackToCategories = () => {
    //setCurrentCategory(null);
    //setSearchTerm('');
  //};

  if (loading) {
    return (
      <div className="absolute inset-0 bg-neutral-900 bg-opacity-90 flex items-center justify-center z-50">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-white text-lg">Cargando cat√°logo...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="absolute inset-0 bg-neutral-900 bg-opacity-90 flex flex-col items-center justify-center z-50 p-4">
        <p className="text-red-400 text-lg mb-4">Error al cargar el cat√°logo:</p>
        <p className="text-red-300 text-sm text-center mb-6 max-w-lg">{error}</p>
        <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Reintentar</button>
      </div>
    );
  }

  if (!catalogDB) return null;

  // --- RENDERIZADO DEL CONTENIDO ---

  const renderContent = () => {
    // 0. VISTA DE B√öSQUEDA (Si hay texto en el buscador)
    if (searchTerm) {
      if (filteredProducts.length === 0) {
        return (
          <div className="flex flex-col items-center justify-center h-64 text-neutral-400">
            <Search size={48} className="mb-4 opacity-50" />
            <p className="text-xl">No se encontraron productos para "{searchTerm}"</p>
          </div>
        );
      }
      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
            Resultados de b√∫squeda ({filteredProducts.length})
          </h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 custom-scrollbar pr-2 pb-20" style={{ maxHeight: 'calc(100vh - 200px)', overflowY: 'auto' }}>
            {filteredProducts.map((product) => (
              <div
                key={product.id}
                className="group bg-neutral-800 rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 border border-neutral-700 hover:border-blue-500 cursor-pointer flex flex-col"
                onClick={() => handleSelectProduct(product)}
              >
                <div className="aspect-square bg-white/5 p-4 flex items-center justify-center relative overflow-hidden">
                  {product.img_2d ? (
                    <img src={getProxiedImageUrl(product.img_2d)} alt={product.name} className="w-full h-full object-contain transform group-hover:scale-110 transition-transform duration-300" loading="lazy" />
                  ) : (
                    <span className="text-neutral-500 text-sm">Sin imagen</span>
                  )}
                  {/* Etiqueta peque√±a para saber de qu√© l√≠nea viene al buscar */}
                  <span className="absolute top-2 right-2 bg-black/60 text-xs px-2 py-1 rounded text-white/70 backdrop-blur-sm">
                    {product.category}
                  </span>
                </div>
                <div className="p-4 flex-grow flex flex-col justify-between bg-neutral-800">
                  <h3 className="text-white font-medium text-lg leading-tight mb-2">{product.name}</h3>
                  <div className="flex justify-between items-end">
                    <span className="text-xs text-neutral-500">{product.id}</span>
                    <p className="text-green-400 font-bold">{product.price.toLocaleString()} ‚Ç¨</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </>
      );
    }

    // 1. VISTA DE PRODUCTOS DE CATEGOR√çA
    if (currentLine && currentCategory) {
      const products = catalogDB.lines[currentLine]?.categories[currentCategory];
      
      if (!products || products.length === 0) return <p className="text-neutral-400 mt-10 text-center">No hay productos disponibles aqu√≠.</p>;

      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
            <span className="opacity-50">{currentLine} /</span> {currentCategory}
          </h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 custom-scrollbar pr-2 pb-20" style={{ maxHeight: 'calc(100vh - 200px)', overflowY: 'auto' }}>
            {products.map((product) => (
              <div
                key={product.id}
                className="group bg-neutral-800 rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 border border-neutral-700 hover:border-blue-500 cursor-pointer flex flex-col"
                onClick={() => handleSelectProduct(product)}
              >
                <div className="aspect-square bg-white/5 p-4 flex items-center justify-center relative overflow-hidden">
                  {product.img_2d ? (
                    <img src={getProxiedImageUrl(product.img_2d)} alt={product.name} className="w-full h-full object-contain transform group-hover:scale-110 transition-transform duration-300" loading="lazy" />
                  ) : (
                    <span className="text-neutral-500 text-sm">Sin imagen</span>
                  )}
                </div>
                <div className="p-4 flex-grow flex flex-col justify-between bg-neutral-800">
                  <h3 className="text-white font-medium text-lg leading-tight mb-2">{product.name}</h3>
                  <p className="text-green-400 font-bold">{product.price.toLocaleString()} ‚Ç¨</p>
                </div>
              </div>
            ))}
          </div>
        </>
      );

    // 2. VISTA DE CATEGOR√çAS
    } else if (currentLine) {
      const categories = catalogDB.lines[currentLine]?.categories;
      const categoryNames = Object.keys(categories || {});

      if (categoryNames.length === 0) return <p className="text-neutral-400 mt-10 text-center">No hay categor√≠as en esta l√≠nea.</p>;

      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6">{currentLine}</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {categoryNames.map((catName) => {
              const firstProduct = categories[catName][0];
              const bgImage = firstProduct?.img_2d ? getProxiedImageUrl(firstProduct.img_2d) : null;

              return (
                <div
                  key={catName}
                  onClick={() => setCurrentCategory(catName)}
                  className="relative h-48 rounded-xl overflow-hidden cursor-pointer shadow-lg hover:shadow-blue-500/50 transition-all duration-300 group border border-neutral-700"
                >
                  {bgImage ? (
                    <div className="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110" style={{ backgroundImage: `url(${bgImage})` }} />
                  ) : (
                    <div className="absolute inset-0 bg-neutral-800" />
                  )}
                  <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent opacity-80 group-hover:opacity-90 transition-opacity" />
                  <div className="absolute bottom-0 left-0 p-6 w-full">
                    <h3 className="text-white text-2xl font-bold group-hover:translate-x-2 transition-transform">{catName}</h3>
                    <p className="text-neutral-300 text-sm mt-1 transform translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all">
                      {categories[catName].length} productos
                    </p>
                  </div>
                </div>
              );
            })}
          </div>
        </>
      );

    // 3. VISTA DE L√çNEAS (Home)
    } else {
      const lineNames = Object.keys(catalogDB.lines);
      if (lineNames.length === 0) return <p className="text-neutral-400 mt-10 text-center">El cat√°logo est√° vac√≠o.</p>;

      return (
        <>
          <h2 className="text-2xl font-bold text-white mb-6">Nuestras L√≠neas</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {lineNames.map((lineName) => {
              const lineData = catalogDB.lines[lineName];
              const bgImage = lineData.lineImage ? getProxiedImageUrl(lineData.lineImage) : null;

              return (
                <div
                  key={lineName}
                  onClick={() => setCurrentLine(lineName)}
                  className="relative h-64 rounded-2xl overflow-hidden cursor-pointer shadow-2xl hover:shadow-purple-500/40 transition-all duration-300 group border border-neutral-700"
                >
                  {bgImage ? (
                    <div className="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" style={{ backgroundImage: `url(${bgImage})` }} />
                  ) : (
                    <div className="absolute inset-0 bg-gradient-to-br from-neutral-800 to-neutral-700" />
                  )}
                  <div className="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors" />
                  <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent" />
                  <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10">
                    <h3 className="text-3xl md:text-4xl font-black text-white uppercase tracking-wider drop-shadow-lg transform group-hover:-translate-y-2 transition-transform duration-300">
                      {lineName}
                    </h3>
                    <span className="mt-4 px-4 py-1 border border-white/30 rounded-full text-xs font-semibold text-white/80 uppercase tracking-widest backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-all duration-500 delay-100">
                      Ver Colecci√≥n
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
        </>
      );
    }
  };

  return (
    <div className="absolute inset-0 bg-neutral-950/95 backdrop-blur-md z-40 flex flex-col animate-in fade-in duration-200">
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-center p-6 border-b border-white/10 bg-black/20 gap-4">
        {/* Breadcrumbs (Navegaci√≥n) */}
        <div className="flex items-center space-x-3 overflow-hidden flex-grow min-w-0">
          <button 
            onClick={() => { setCurrentLine(null); setCurrentCategory(null); setSearchTerm(''); }}
            className={`text-2xl font-bold transition-colors ${(!currentLine && !searchTerm) ? 'text-white' : 'text-neutral-400 hover:text-white'}`}
          >
            Cat√°logo
          </button>
          
          {currentLine && !searchTerm && (
            <>
              <span className="text-neutral-600 text-2xl">/</span>
              <button
                onClick={handleBackToLines}
                className={`text-2xl font-bold whitespace-nowrap transition-colors ${!currentCategory ? 'text-white' : 'text-neutral-400 hover:text-white'}`}
              >
                {currentLine}
              </button>
            </>
          )}
          
          {currentCategory && !searchTerm && (
            <>
              <span className="text-neutral-600 text-2xl">/</span>
              <span className="text-2xl font-bold text-white whitespace-nowrap truncate">
                {currentCategory}
              </span>
            </>
          )}
        </div>

        {/* BUSCADOR */}
        <div className="relative w-full md:w-80">
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <Search size={18} className="text-neutral-400" />
          </div>
          <input
            type="text"
            className="block w-full pl-10 pr-10 py-2 border border-neutral-700 rounded-full leading-5 bg-neutral-900/50 text-white placeholder-neutral-500 focus:outline-none focus:bg-neutral-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm transition-all"
            placeholder="Buscar por nombre o ref..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
          {searchTerm && (
            <button 
              onClick={() => setSearchTerm('')}
              className="absolute inset-y-0 right-0 pr-3 flex items-center text-neutral-400 hover:text-white"
            >
              <X size={18} />
            </button>
          )}
        </div>

        {/* BOT√ìN CERRAR */}
        <button
          onClick={() => setMode('idle')}
          className="p-2 hover:bg-white/10 rounded-full text-white/50 hover:text-white transition-all ml-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>

      {/* BODY */}
      <div className="flex-grow p-6 overflow-hidden relative">
        {renderContent()}
      </div>
    </div>
  );
};
// --- END OF FILE src/features/editor/ui/Catalog.tsx ---
</file>

<file path="src/features/editor/ui/Editor.css">
/* Efecto Cristal para los paneles */
.glass-panel {
  background: rgba(30, 30, 30, 0.7);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  padding: 8px;
  display: flex;
  gap: 8px;
  pointer-events: auto; /* Para que se pueda clicar aunque est√© sobre el 3D */
}

/* Botones de la barra */
.tool-btn {
  background: transparent;
  border: none;
  color: #aaa;
  width: 44px;
  height: 44px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.tool-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.tool-btn.active {
  background: #4a90e2; /* Azul A42 */
  color: white;
  box-shadow: 0 0 10px rgba(74, 144, 226, 0.4);
}

.tool-label {
  position: absolute;
  bottom: -25px;
  background: black;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  white-space: nowrap;
}

.tool-btn:hover .tool-label {
  opacity: 1;
}
</file>

<file path="src/features/editor/ui/EnvironmentPanel.tsx">
// --- START OF FILE src/features/editor/ui/EnvironmentPanel.tsx ---
//import React from 'react';
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { X, Sun, MountainSnow } from 'lucide-react';

export const EnvironmentPanel = () => {
  const { 
    envPanelVisible, 
    toggleEnvPanel, 
    sunPosition, 
    setSunPosition, 
    backgroundColor, 
    setBackgroundColor 
  } = useEditorStore();

  if (!envPanelVisible) return null;

  // Definici√≥n de colores
  const colors = [
    { name: 'Cielo', value: '#111111', isSky: true }, // Valor dummy, activar√° el sky
    { name: 'Blanco', value: '#ffffff' },
    { name: 'Azul', value: '#3b82f6' },
    { name: 'Verde', value: '#22c55e' },
    { name: 'Granate', value: '#7f1d1d' },
    { name: 'Negro', value: '#000000' },
  ];

  return (
    <div className="absolute top-20 right-6 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl shadow-2xl w-72 flex flex-col z-30 animate-in fade-in slide-in-from-right-5 duration-200">
      
      {/* Header */}
      <div className="p-4 border-b border-neutral-700 flex justify-between items-center bg-neutral-800/50 rounded-t-xl">
        <h2 className="text-white font-bold text-lg flex items-center gap-2">
          <Sun size={20} className="text-yellow-500" />
          Entorno
        </h2>
        <button onClick={toggleEnvPanel} className="text-neutral-400 hover:text-white">
          <X size={20} />
        </button>
      </div>

      <div className="p-4 space-y-6">
        
        {/* Controles de Sol */}
        <div className="space-y-4">
          <h3 className="text-neutral-400 text-xs uppercase font-bold tracking-wider">Iluminaci√≥n Solar</h3>
          
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-white">Rotaci√≥n</span>
              <span className="text-neutral-400">{sunPosition.azimuth}¬∞</span>
            </div>
            <input 
              type="range" 
              min="0" 
              max="360" 
              value={sunPosition.azimuth} 
              onChange={(e) => setSunPosition(Number(e.target.value), sunPosition.elevation)}
              className="w-full h-2 bg-neutral-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
            />
          </div>

          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-white">Altura</span>
              <span className="text-neutral-400">{sunPosition.elevation}¬∞</span>
            </div>
            <input 
              type="range" 
              min="0" 
              max="90" 
              value={sunPosition.elevation} 
              onChange={(e) => setSunPosition(sunPosition.azimuth, Number(e.target.value))}
              className="w-full h-2 bg-neutral-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
            />
          </div>
        </div>

        {/* Separador */}
        <div className="h-px bg-neutral-700/50" />

        {/* Fondos */}
        <div className="space-y-3">
          <h3 className="text-neutral-400 text-xs uppercase font-bold tracking-wider flex items-center gap-2">
            <MountainSnow size={14} /> Fondo
          </h3>
          
          <div className="grid grid-cols-3 gap-2">
            {colors.map((c) => (
              <button
                key={c.name}
                onClick={() => setBackgroundColor(c.value)}
                className={`
                  relative h-10 rounded-lg border-2 transition-all flex items-center justify-center
                  ${backgroundColor === c.value 
                    ? 'border-blue-500 scale-105 shadow-lg shadow-blue-500/20' 
                    : 'border-transparent hover:border-white/20 hover:scale-105'
                  }
                `}
                style={{ backgroundColor: c.value }}
                title={c.name}
              >
                {c.isSky && <span className="text-[10px] font-bold text-white/50 uppercase">Sky</span>}
              </button>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
};
// --- END OF FILE src/features/editor/ui/EnvironmentPanel.tsx ---
</file>

<file path="src/features/editor/ui/FenceProperties.tsx">
// --- START OF FILE src/features/editor/ui/FenceProperties.tsx ---
import { Fence, Palette } from "lucide-react";
import { FENCE_PRESETS } from "../data/fence_presets";

import { CadControl } from "./CadControl";

// Stores correctos
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";

export const FenceProperties = () => {
  // Suscripci√≥n reactiva correcta
  const items = useEditorStore((s) => s.items);
  const updateItemFenceConfig = useEditorStore((s) => s.updateItemFenceConfig);

  const selectedItemId = useSelectionStore((s) => s.selectedItemId);

  // Buscar el item seleccionado
  const selectedItem = items.find((i) => i.uuid === selectedItemId);
console.log("%c[FENCE-PROPS] Render", "color: #3bf");
console.log(" selectedItemId:", selectedItemId);
console.log(" selectedItem:", selectedItem);
console.log(" type:", selectedItem?.type);
  // Si no hay item o no es valla ‚Üí no renderizar
  if (!selectedItem || selectedItem.type !== "fence") {
    return null;
    
  }

  const currentConfig = selectedItem.fenceConfig!;
  const currentPreset =
    FENCE_PRESETS[currentConfig.presetId] || FENCE_PRESETS["wood"];

  // Cambiar preset
  const handlePresetChange = (key: string) => {
    const preset = FENCE_PRESETS[key];

    const newConfig = {
      presetId: key,
      colors: {
        ...preset.defaultColors,
        ...currentConfig.colors,
      },
    };

    updateItemFenceConfig(selectedItem.uuid, newConfig);
  };

  // Cambiar color
  const handleColorChange = (
    key: "post" | "slatA" | "slatB" | "slatC",
    hex: string
  ) => {
    const colorInt = parseInt(hex.replace("#", "0x"));

    const newColors = {
      ...currentConfig.colors,
      [key]: colorInt,
    };

    updateItemFenceConfig(selectedItem.uuid, {
      presetId: currentConfig.presetId,
      colors: newColors,
    });
  };

  const toHex = (num: number) =>
    "#" + num.toString(16).padStart(6, "0");

  return (
    <div className="absolute top-20 right-4 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl p-4 shadow-xl z-20 w-80 animate-in fade-in slide-in-from-right-2">

      {/* Panel CAD */}
      <CadControl />

      <h3 className="text-white text-sm font-bold mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
        <Fence size={16} /> Editar Valla
      </h3>

      {/* SELECTOR DE MODELO */}
      <div className="mb-4">
        <label className="text-xs text-neutral-400 mb-2 block uppercase font-bold">
          Modelo
        </label>

        <div className="grid grid-cols-2 gap-2">
          {Object.entries(FENCE_PRESETS).map(([key, preset]) => (
            <button
              key={key}
              onClick={() => handlePresetChange(key)}
              className={`text-xs p-2 rounded border text-left transition-all ${
                currentConfig.presetId === key
                  ? "bg-blue-600 border-blue-400 text-white"
                  : "bg-neutral-800 border-neutral-700 text-neutral-300 hover:bg-neutral-700"
              }`}
            >
              {preset.name}
            </button>
          ))}
        </div>
      </div>

      {/* COLORES */}
      <div className="space-y-3">
        <label className="text-xs text-neutral-400 uppercase font-bold flex items-center gap-2">
          <Palette size={12} /> Personalizaci√≥n
        </label>

        {/* Postes */}
        <div className="flex items-center justify-between">
          <span className="text-xs text-neutral-300">Postes / Estructura</span>
          <input
            type="color"
            value={toHex(currentConfig.colors.post)}
            onChange={(e) => handleColorChange("post", e.target.value)}
            className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
          />
        </div>

        {/* Lamas principales */}
        <div className="flex items-center justify-between">
          <span className="text-xs text-neutral-300">
            {currentPreset.isSolidPanel ? "Panel" : "Lamas Principales"}
          </span>
          <input
            type="color"
            value={toHex(currentConfig.colors.slatA)}
            onChange={(e) => handleColorChange("slatA", e.target.value)}
            className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
          />
        </div>

        {/* Multicolor */}
        {currentPreset.multiColor && (
          <>
            <div className="flex items-center justify-between">
              <span className="text-xs text-neutral-300">Lamas Secundarias</span>
              <input
                type="color"
                value={toHex(currentConfig.colors.slatB ?? currentConfig.colors.slatA)}
                onChange={(e) => handleColorChange("slatB", e.target.value)}
                className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
              />
            </div>

            <div className="flex items-center justify-between">
              <span className="text-xs text-neutral-300">Lamas Terciarias</span>
              <input
                type="color"
                value={toHex(currentConfig.colors.slatC ?? currentConfig.colors.slatA)}
                onChange={(e) => handleColorChange("slatC", e.target.value)}
                className="w-8 h-8 rounded cursor-pointer bg-transparent border-none"
              />
            </div>
          </>
        )}
      </div>

      <div className="mt-4 pt-2 border-t border-white/10 text-[10px] text-neutral-500 text-center">
        Clic Izq: Dibujar ‚Ä¢ Clic Dcho: Terminar
      </div>
    </div>
  );
};
// --- END OF FILE ---
</file>

<file path="src/features/editor/ui/FloorProperties.tsx">
// --- FILE: src/features/editor/ui/FloorProperties.tsx ---
import React, { useRef } from "react";
import { Palette, Upload, RotateCw, Move } from "lucide-react";

import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSelectionStore } from "@/stores/selection/useSelectionStore";
import type { FloorMaterialType } from "@/types/editor";
import { CadControl } from "./CadControl";

export const FloorProperties: React.FC = () => {
  // Selecci√≥n (qu√© item est√° seleccionado)
  const selectedItemId = useSelectionStore((s) => s.selectedItemId);

  // --- STORE FIX (cada selector independiente ‚Üí evita bucles infinitos)
  const items = useEditorStore((s) => s.items);
  const updateFloorMaterial = useEditorStore((s) => s.updateFloorMaterial);
  const updateFloorTexture = useEditorStore((s) => s.updateFloorTexture);
  // -------------------------------------------------------------

  const fileInputRef = useRef<HTMLInputElement>(null);

  const selectedItem = items.find((i) => i.uuid === selectedItemId);
  if (!selectedItem || selectedItem.type !== "floor") return null;

  const materials: { id: FloorMaterialType; color: string; name: string }[] = [
    { id: "rubber_red", color: "#A04040", name: "Rojo" },
    { id: "rubber_green", color: "#22c55e", name: "Verde" },
    { id: "rubber_blue", color: "#3b82f6", name: "Azul" },
    { id: "grass", color: "#4ade80", name: "C√©sped" },
    { id: "concrete", color: "#9ca3af", name: "Hormig√≥n" },
  ];

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const url = URL.createObjectURL(file);
    updateFloorTexture(selectedItem.uuid, url, 1, 0);
  };

  const handleUpdateTextureParams = (scale: number, rotation: number) => {
    updateFloorTexture(
      selectedItem.uuid,
      selectedItem.textureUrl,
      scale,
      rotation
    );
  };

  return (
    <div className="absolute top-20 right-4 bg-neutral-900/95 backdrop-blur-md border border-neutral-700 rounded-xl p-4 shadow-xl z-20 w-80 animate-in fade-in slide-in-from-right-2">
      {/* CAD Control arriba */}
      <CadControl />

      <h3 className="text-white text-sm font-bold mb-4 flex items-center gap-2 border-b border-white/10 pb-2">
        <Palette size={16} /> Propiedades del Suelo
      </h3>

      {/* MATERIAL BASE */}
      <div className="mb-4">
        <label className="text-xs text-neutral-400 mb-2 block uppercase font-bold">
          Material Base
        </label>
        <div className="flex gap-2">
          {materials.map((mat) => (
            <button
              key={mat.id}
              onClick={() => {
                // si pongo material base, quito textura custom
                updateFloorTexture(selectedItem.uuid, undefined, 1, 0);
                updateFloorMaterial(selectedItem.uuid, mat.id);
              }}
              className={`w-8 h-8 rounded-full border-2 transition-all ${
                !selectedItem.textureUrl &&
                selectedItem.floorMaterial === mat.id
                  ? "border-white scale-110"
                  : "border-transparent opacity-50 hover:opacity-100"
              }`}
              style={{ backgroundColor: mat.color }}
              title={mat.name}
            />
          ))}
        </div>
      </div>

      {/* TEXTURA PERSONALIZADA */}
      <div className="mb-2">
        <label className="text-xs text-neutral-400 mb-2 block uppercase font-bold">
          Textura Personalizada
        </label>

        <input
          type="file"
          ref={fileInputRef}
          onChange={handleFileChange}
          accept="image/*"
          className="hidden"
        />

        <button
          onClick={() => fileInputRef.current?.click()}
          className="w-full py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-600 rounded flex items-center justify-center gap-2 text-sm text-neutral-300 transition-colors mb-3"
        >
          <Upload size={14} />{" "}
          {selectedItem.textureUrl ? "Cambiar Imagen" : "Subir Imagen (JPG/PNG)"}
        </button>

        {selectedItem.textureUrl && (
          <div className="grid grid-cols-2 gap-3">
            {/* ESCALA */}
            <div className="bg-neutral-800 p-2 rounded">
              <div className="flex justify-between mb-1">
                <span className="text-[10px] text-neutral-400 flex items-center gap-1">
                  <Move size={10} /> ESCALA
                </span>
                <span className="text-[10px] text-white">
                  {(selectedItem.textureScale ?? 1).toFixed(1)}x
                </span>
              </div>
              <input
                type="range"
                min="0.1"
                max="5"
                step="0.1"
                value={selectedItem.textureScale ?? 1}
                onChange={(e) =>
                  handleUpdateTextureParams(
                    parseFloat(e.target.value),
                    selectedItem.textureRotation ?? 0
                  )
                }
                className="w-full h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer accent-blue-500"
              />
            </div>

            {/* ROTACI√ìN */}
            <div className="bg-neutral-800 p-2 rounded">
              <div className="flex justify-between mb-1">
                <span className="text-[10px] text-neutral-400 flex items-center gap-1">
                  <RotateCw size={10} /> ROTACI√ìN
                </span>
                <span className="text-[10px] text-white">
                  {selectedItem.textureRotation ?? 0}¬∞
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="360"
                step="15"
                value={selectedItem.textureRotation ?? 0}
                onChange={(e) =>
                  handleUpdateTextureParams(
                    selectedItem.textureScale ?? 1,
                    parseInt(e.target.value, 10)
                  )
                }
                className="w-full h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer accent-blue-500"
              />
            </div>
          </div>
        )}
      </div>

      <div className="mt-4 pt-2 border-t border-white/10 text-[10px] text-neutral-500 text-center">
        üí° Shift + Clic para seleccionar v√©rtices m√∫ltiples.
      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/ui/InputModal.tsx">
// --- START OF FILE src/features/editor/ui/InputModal.tsx ---
import React, { useState, useEffect, useRef } from 'react';
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { X, Check } from 'lucide-react';

export const InputModal = () => {
  const { inputModal, closeInputModal } = useEditorStore();
  const [value, setValue] = useState('');
  const inputRef = useRef<HTMLInputElement>(null);

  // Sincronizar estado local cuando se abre el modal
  useEffect(() => {
    if (inputModal.isOpen) {
      setValue(inputModal.defaultValue);
      // Enfocar el input autom√°ticamente al abrir
      setTimeout(() => inputRef.current?.focus(), 100);
    }
  }, [inputModal.isOpen, inputModal.defaultValue]);

  if (!inputModal.isOpen) return null;

  const handleSubmit = (e?: React.FormEvent) => {
    e?.preventDefault();
    closeInputModal(value); // Devuelve el texto
  };

  const handleCancel = () => {
    closeInputModal(null); // Devuelve null (como si dieras Cancelar en prompt)
  };

  return (
    <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-neutral-800 border border-neutral-600 rounded-xl shadow-2xl p-6 w-96 transform transition-all scale-100">
        <h3 className="text-white text-lg font-bold mb-4">{inputModal.title}</h3>
        
        <form onSubmit={handleSubmit}>
          <input
            ref={inputRef}
            type="text"
            value={value}
            onChange={(e) => setValue(e.target.value)}
            className="w-full bg-neutral-900 border border-neutral-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-green-500 transition-colors mb-6"
            placeholder="Escribe aqu√≠..."
          />
          
          <div className="flex justify-end gap-3">
            <button
              type="button"
              onClick={handleCancel}
              className="px-4 py-2 rounded-lg text-neutral-400 hover:text-white hover:bg-white/10 transition-colors flex items-center gap-2"
            >
              <X size={18} /> Cancelar
            </button>
            <button
              type="submit"
              className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-medium transition-colors flex items-center gap-2"
            >
              <Check size={18} /> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
// --- END OF FILE src/features/editor/ui/InputModal.tsx ---
</file>

<file path="src/features/editor/ui/QRModal.tsx">
import React from "react";
import { QRCodeSVG } from "qrcode.react";
import { X, Save, LogIn, Smartphone } from "lucide-react";
import { useAuthStore } from "@/stores/auth/useAuthStore";
import { useNavigate } from "react-router-dom";
import { useProjectStore } from "@/stores/project/useProjectStore";

interface QRModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export const QRModal: React.FC<QRModalProps> = ({ isOpen, onClose }) => {
  const navigate = useNavigate();

  // --- auth store ---
  const { user } = useAuthStore();

  // --- editor/project store ---
  const { currentProjectId } = useProjectStore();

  if (!isOpen) return null;

  const shareUrl = currentProjectId
    ? `${window.location.origin}/?project_id=${currentProjectId}`
    : "";

  const isProjectSaved = !!currentProjectId;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-neutral-900 border border-neutral-700 rounded-2xl p-8 shadow-2xl max-w-sm w-full relative flex flex-col items-center gap-6 text-center">
        <button
          onClick={onClose}
          className="absolute top-4 right-4 text-neutral-400 hover:text-white transition-colors"
        >
          <X size={24} />
        </button>

        {/* PROYECTO GUARDADO ‚Üí MOSTRAR QR */}
        {isProjectSaved ? (
          <>
            <div className="space-y-1">
              <div className="flex items-center justify-center gap-2 text-blue-400 mb-2">
                <Smartphone size={20} />
                <span className="text-xs font-bold uppercase tracking-wider">
                  Mobile Ready
                </span>
              </div>
              <h2 className="text-2xl font-bold text-white">Escanear Proyecto</h2>
              <p className="text-sm text-neutral-400">
                Abre la c√°mara de tu m√≥vil para ver el dise√±o.
              </p>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-inner">
              <QRCodeSVG value={shareUrl} size={220} level="M" />
            </div>

            <div className="text-xs text-neutral-500 px-4 break-all">
              ID:
              <span className="font-mono text-neutral-400 ml-1">
                {currentProjectId}
              </span>
            </div>

            {!user && (
              <p className="text-xs text-yellow-500 bg-yellow-900/30 p-2 rounded">
                ‚ö†Ô∏è Enlace en modo <strong>solo lectura</strong>.
              </p>
            )}
          </>
        ) : user ? (
          // PROYECTO SIN GUARDAR ‚Üí PEDIR GUARDAR
          <>
            <div className="w-16 h-16 bg-yellow-500/10 rounded-full flex items-center justify-center text-yellow-500 mb-2">
              <Save size={32} />
            </div>
            <h2 className="text-xl font-bold text-white">Proyecto no guardado</h2>
            <p className="text-sm text-neutral-400">
              Guarda el proyecto para generar un enlace √∫nico.
            </p>

            <button
              onClick={onClose}
              className="w-full py-3 bg-neutral-800 hover:bg-neutral-700 border border-neutral-600 text-white rounded-lg font-bold transition-colors"
            >
              Volver y Guardar
            </button>
          </>
        ) : (
          // NO GUARDADO + NO LOGIN ‚Üí PEDIR LOGIN
          <>
            <div className="w-16 h-16 bg-neutral-800 rounded-full flex items-center justify-center text-neutral-400 mb-2">
              <LogIn size={32} />
            </div>

            <h2 className="text-xl font-bold text-white">Inicia Sesi√≥n</h2>
            <p className="text-sm text-neutral-400">
              Para guardar y compartir tu dise√±o necesitas una cuenta.
            </p>

            <button
              onClick={() => navigate("/login")}
              className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition-colors"
            >
              Ir al Login
            </button>
          </>
        )}
      </div>
    </div>
  );
};
</file>

<file path="src/features/editor/ui/Toolbar.tsx">
import React, { useState, useRef } from 'react';
import { 
  MousePointer2, Grid3X3, Component, Trees, Grid, Undo2, Redo2, Eye, Box, ArrowUp, ArrowRight, GalleryVerticalEnd, Square, Sun, Upload, Ruler, Footprints, Video, Camera, Film, Download, FileText, ShieldAlert, FileDown, Save, LayoutDashboard
} from 'lucide-react';
import { useEditorStore } from "@/stores/editor/useEditorStore";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useProjectStore } from "@/stores/project/useProjectStore";
import { supabase } from '../../../lib/supabase';
import { useNavigate } from 'react-router-dom';
import './Editor.css';

export const Toolbar = () => {
  const navigate = useNavigate();
const {
  mode, setMode, gridVisible, toggleGrid,
  undo, redo, past, future,
  cameraType, setCameraType, triggerView,
  envPanelVisible, toggleEnvPanel,
  setMeasurementResult,
  safetyZonesVisible, toggleSafetyZones,
  requestInput,
} = useEditorStore();

const {
  items, addItem, fenceConfig, totalPrice,
  removeItem, resetScene,
} = useSceneStore();

const {
  user, currentProjectId, currentProjectName,
  isReadOnlyMode, setProjectInfo,
} = useProjectStore();

  const [showViews, setShowViews] = useState(false);
  const [isRecording, setIsRecording] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const tools = [
    { id: 'idle', icon: <MousePointer2 size={20} />, label: 'Seleccionar' },
    { id: 'drawing_floor', icon: <Grid3X3 size={20} />, label: 'Suelo' },
    { id: 'drawing_fence', icon: <Component size={20} />, label: 'Valla' },
    { id: 'catalog', icon: <Trees size={20} />, label: 'Cat√°logo' },
  ];

  // --- L√ìGICA DE GUARDADO ---
  const handleSaveProject = async () => {
    // Doble seguridad: Si es solo lectura, no hacemos nada
    if (isReadOnlyMode) return alert("Modo de Solo Lectura. No puedes sobrescribir este proyecto.");
    if (!user) return alert("Debes iniciar sesi√≥n para guardar.");

    // 1. Captura de pantalla (Miniatura)
    const engine = (window as any).editorEngine;
    
    if (!engine || !engine.renderer) {
        console.error("No se encontr√≥ el motor gr√°fico");
        return;
    }
    
    // Forzamos un render para asegurar que salga todo
    engine.render(); 
    const thumbnailBase64 = engine.renderer.domElement.toDataURL('image/jpeg', 0.5); // Calidad media

    // 2. Preparar datos JSON
    const projectData = {
      items,
      fenceConfig,
      camera: cameraType
    };

    // 3. Determinar Nombre
    let nameToSave = currentProjectName;
    let isOverwrite = false;

    if (currentProjectId) {
      if (confirm(`¬øSobreescribir proyecto "${currentProjectName}"?`)) {
        isOverwrite = true;
      } else {
        const newName = await requestInput("Guardar como nuevo:", currentProjectName + " (Copia)");
        if (!newName) return; 
        nameToSave = newName;
        isOverwrite = false;
      }
    } else {
      const newName = await requestInput("Nombre del Proyecto:", "Mi Parque Nuevo");
      if (!newName) return;
      nameToSave = newName;
      isOverwrite = false;
    }

    setIsSaving(true);
    try {
      if (isOverwrite && currentProjectId) {
        // UPDATE
        const { error } = await supabase.from('projects').update({
          name: nameToSave,
          data: projectData,
          thumbnail_url: thumbnailBase64,
          total_price: totalPrice,
          updated_at: new Date()
        }).eq('id', currentProjectId);
        
        if (error) throw error;
        alert("Proyecto actualizado correctamente.");

      } else {
        // INSERT
        const { data, error } = await supabase.from('projects').insert([{
          user_id: user.id,
          name: nameToSave,
          data: projectData,
          thumbnail_url: thumbnailBase64,
          total_price: totalPrice
        }]).select().single();

        if (error) throw error;
        alert("Proyecto guardado correctamente.");
        
        if (data) setProjectInfo(data.id, data.name);
      }
    } catch (err: any) {
      alert("Error al guardar: " + err.message);
    } finally {
      setIsSaving(false);
    }
  };

  // --- OTRAS FUNCIONES ---
  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]; if (!file) return;
    const url = URL.createObjectURL(file);
    const fileName = file.name.replace('.glb', '').replace('.gltf', '');
    addItem({ uuid: crypto.randomUUID(), productId: 'custom_upload', name: fileName, price: 0, type: 'model', modelUrl: url, position: [0, 0, 0], rotation: [0, 0, 0], scale: [1, 1, 1] });
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  const toggleMeasureMode = () => { 
    if (mode === 'measuring') { setMode('idle'); setMeasurementResult(null); } 
    else { setMode('measuring'); setShowViews(false); } 
  };

  // Funciones auxiliares usando (window as any) para evitar errores TS
  const getEngine = () => (window as any).editorEngine;

  const generatePDF = () => { getEngine()?.pdfManager.generatePDF(); };
  const activateWalkMode = () => { getEngine()?.walkManager.enable(); };
  const takePhoto = () => { getEngine()?.recorderManager.takeScreenshot(); };
  const start360Video = () => { getEngine()?.recorderManager.startOrbitAnimation(); };
  const exportGLB = () => { getEngine()?.exportManager.exportGLB(); };
  const exportDXF = () => { getEngine()?.exportManager.exportDXF(); };
  
  const toggleRecording = () => {
    const manager = getEngine()?.recorderManager;
    if (!manager) return;
    if (isRecording) { manager.stopRecording(); setIsRecording(false); } 
    else { manager.startRecording(); setIsRecording(true); }
  };

  return (
    <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center">
      {/* Vistas Popup */}
      {showViews && (
        <div className="absolute bottom-full mb-4 glass-panel flex-row animate-in slide-in-from-bottom-2 fade-in duration-200">
           <button className={`tool-btn ${cameraType === 'perspective' ? 'active' : ''}`} onClick={() => setCameraType('perspective')} title="3D"><Eye size={18} /></button>
           <button className={`tool-btn ${cameraType === 'orthographic' ? 'active' : ''}`} onClick={() => setCameraType('orthographic')} title="2D"><Square size={18} /></button>
           <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />
           <button className="tool-btn" onClick={() => triggerView('top')} title="Planta"><ArrowUp size={18} /></button>
           <button className="tool-btn" onClick={() => triggerView('front')} title="Alzado"><GalleryVerticalEnd size={18} /></button>
           <button className="tool-btn" onClick={() => triggerView('side')} title="Perfil"><ArrowRight size={18} /></button>
           <button className="tool-btn" onClick={() => triggerView('iso')} title="Iso"><Box size={18} /></button>
        </div>
      )}

      <div className="glass-panel">
        
        {/* Bot√≥n DASHBOARD */}
        {user && (
           <button className="tool-btn text-blue-400 hover:text-blue-300" onClick={() => navigate(user.email?.includes('admin') || user.email?.includes('levipark') ? '/admin/crm' : '/portal?tab=projects')} title="Ir a Mis Proyectos">
             <LayoutDashboard size={20} /> <span className="tool-label">Portal</span>
           </button>
        )}
        
        {user && <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />}

        {/* HERRAMIENTAS PRINCIPALES */}
        {tools.map((tool) => (
          <button key={tool.id} className={`tool-btn ${mode === tool.id ? 'active' : ''}`} onClick={() => { setMode(tool.id as any); setShowViews(false); }}>
            {tool.icon} <span className="tool-label">{tool.label}</span>
          </button>
        ))}

        <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />

        {/* üí° BOT√ìN GUARDAR (BLOQUEADO EN MODO LECTURA) */}
        {user ? (
            <button 
                className={`tool-btn ${isSaving ? 'text-yellow-400' : ''}`} 
                onClick={handleSaveProject} 
                disabled={isSaving || isReadOnlyMode} // <--- BLOQUEO
                title={isReadOnlyMode ? "Modo Lectura (No se puede guardar)" : "Guardar Proyecto en Nube"}
                style={{
                    opacity: isReadOnlyMode ? 0.5 : 1, // <--- OPACIDAD VISUAL
                    cursor: isReadOnlyMode ? 'not-allowed' : 'pointer' // <--- CURSOR PROHIBIDO
                }}
            >
                <Save size={20} className={isSaving ? 'animate-pulse' : ''} /> 
                <span className="tool-label">{isSaving ? '...' : 'Guardar'}</span>
            </button>
        ) : (
            <button className="tool-btn opacity-50 hover:opacity-100" onClick={() => navigate('/login')} title="Inicia sesi√≥n para guardar">
                <Save size={20} /> <span className="tool-label">Login</span>
            </button>
        )}
        
        <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".glb,.gltf" className="hidden" />
        <button className="tool-btn" onClick={() => fileInputRef.current?.click()} title="Importar GLB">
            <Upload size={20} /> <span className="tool-label">Importar</span>
        </button>

        <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />

        <button className={`tool-btn ${showViews ? 'active' : ''}`} onClick={() => setShowViews(!showViews)}>
          <Eye size={20} /> <span className="tool-label">Vistas</span>
        </button>
        <button className={`tool-btn ${envPanelVisible ? 'active' : ''}`} onClick={toggleEnvPanel}>
          <Sun size={20} /> <span className="tool-label">Entorno</span>
        </button>
        <button className={`tool-btn ${mode === 'measuring' ? 'active' : ''}`} onClick={toggleMeasureMode} title="Medir">
            <Ruler size={20} /> <span className="tool-label">Medir</span>
        </button>
        <button className={`tool-btn ${safetyZonesVisible ? 'active text-red-400' : ''}`} onClick={toggleSafetyZones} title="Zonas de Seguridad">
            <ShieldAlert size={20} /> <span className="tool-label">Zonas</span>
        </button>

        <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />
        
        <button className="tool-btn" onClick={takePhoto} title="Hacer Foto">
            <Camera size={20} /> <span className="tool-label">Foto</span>
        </button>
        <button className="tool-btn" onClick={start360Video} title="Video 360 Auto">
            <Film size={20} /> <span className="tool-label">360¬∫</span>
        </button>

        {/* --- SOLO SI EST√Å REGISTRADO: DESCARGAS 3D Y CAD --- */}
        {user && (
          <>
            <button className="tool-btn" onClick={exportGLB} title="Exportar 3D (.glb)">
                <Download size={20} /> <span className="tool-label">3D</span>
            </button>
            <button className="tool-btn" onClick={exportDXF} title="Exportar Plano (.dxf)">
                <FileText size={20} /> <span className="tool-label">CAD</span>
            </button>
          </>
        )}

        <button className="tool-btn" onClick={generatePDF} title="Generar Dossier PDF">
            <FileDown size={20} /> <span className="tool-label">PDF</span>
        </button>

        <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />

        <button className="tool-btn" onClick={activateWalkMode} title="Paseo (WASD)">
            <Footprints size={20} /> <span className="tool-label">Paseo</span>
        </button>
        <button className={`tool-btn ${isRecording ? 'text-red-500 hover:text-red-400' : ''}`} onClick={toggleRecording}>
            <Video size={20} /> <span className="tool-label">{isRecording ? "Stop" : "Rec"}</span>
        </button>
        
        <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />
        <button className={`tool-btn ${gridVisible ? 'active' : ''}`} onClick={toggleGrid}>
          <Grid size={20} /> <span className="tool-label">Grid</span>
        </button>
        <div style={{ width: 1, background: 'rgba(255,255,255,0.1)', margin: '0 4px' }} />
        <button className="tool-btn" onClick={undo} disabled={past.length === 0} style={{ opacity: past.length === 0 ? 0.3 : 1 }}>
          <Undo2 size={20} /> <span className="tool-label">Undo</span>
        </button>
        <button className="tool-btn" onClick={redo} disabled={future.length === 0} style={{ opacity: future.length === 0 ? 0.3 : 1 }}>
          <Redo2 size={20} /> <span className="tool-label">Redo</span>
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/index.css">
/* --- START OF FILE src/index.css --- */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Mantenemos nuestro fondo oscuro y el reset b√°sico */
:root {
  color-scheme: dark;
  background-color: #111;
  color: white;
}

body {
  margin: 0;
  overflow: hidden;
}

#root {
  width: 100vw;
  height: 100vh;
}

/* Custom Scrollbar (para el cat√°logo) */
.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  border: 2px solid rgba(255, 255, 255, 0.05);
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: rgba(255, 255, 255, 0.3);
}
/* --- END OF FILE src/index.css --- */
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_KEY;

if (!SUPABASE_URL || !SUPABASE_KEY) {
    throw new Error("Faltan las variables de entorno de Supabase en .env");
}

export const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
</file>

<file path="src/main.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
</file>

<file path="src/services/catalogService.ts">
// --- START OF FILE src/catalog/catalogService.ts ---

import type { ProductDefinition } from "@/types/catalog";

// Extendemos el tipo para que TypeScript no se queje de la descripci√≥n si no est√° en el store original
export type Product = ProductDefinition & { description?: string };

export interface CatalogDB {
  lines: {
    [lineName: string]: {
      lineImage?: string; 
      categories: {
        [categoryName: string]: Product[];
      };
    };
  };
}

let catalogData: CatalogDB | null = null;
let loadError: string | null = null;
let isLoaded = false;

// URL de tu Google Sheet
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfEbdFX3uyPiy45jEG3YLFsW9xqlbKfmdBigZzBStBjnVm1oWkw1AVesUcK11O0CXytHVeFY3l-gds/pub?output=csv";

// Helper para limpiar comillas extras del CSV
const cleanCell = (text: string) => text ? text.replace(/^"|"$/g, '').trim() : '';

// Helper para buscar √≠ndices ignorando may√∫sculas/min√∫sculas
const getColIndex = (headers: string[], possibleNames: string[]) => {
  const lowerHeaders = headers.map(h => cleanCell(h).toLowerCase());
  return lowerHeaders.findIndex(h => possibleNames.includes(h));
};

export const loadCatalogData = async () => {
  if (isLoaded && catalogData) return; 

  try {
    console.log('[CatalogService] Descargando CSV...');
    const response = await fetch(GOOGLE_SHEET_CSV_URL);
    
    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const csvText = await response.text();
    const rows = csvText.split('\n').map(r => r.trim()).filter(r => r.length > 0);
    if (rows.length < 2) throw new Error("CSV vac√≠o o sin datos.");

    // Procesar cabeceras
    const headers = rows[0].split(','); 
    
    // --- 1. IDENTIFICAR COLUMNAS (Aqu√≠ es donde a√±adimos las nuevas) ---
    const idxRef = getColIndex(headers, ['ref', 'id']);
    const idxNombre = getColIndex(headers, ['nombre', 'name']);
    const idxPrecio = getColIndex(headers, ['precio', 'price']);
    const idxCategoria = getColIndex(headers, ['categoria', 'categor√≠a', 'category']);
    const idxGlb = getColIndex(headers, ['archivo_glb', 'glb', 'modelo']);
    const idxImg = getColIndex(headers, ['img_2d', 'img', 'imagen']);
    const idxLinea = getColIndex(headers, ['linea', 'l√≠nea', 'line']);
    const idxImgLinea = getColIndex(headers, ['img_linea', 'img_line', 'imagen_linea', 'foto_linea']);
    
    // NUEVAS COLUMNAS (Las que faltaban)
    const idxUrlTech = getColIndex(headers, ['url_tech', 'ficha_tecnica', 'ficha t√©cnica']);
    const idxUrlCert = getColIndex(headers, ['url_cert', 'certificado']);
    const idxUrlInst = getColIndex(headers, ['url_inst', 'instrucciones', 'montaje']);
    const idxDesc    = getColIndex(headers, ['descripcion', 'descripci√≥n', 'description']);
    // ------------------------------------------------------------------

    if (idxNombre === -1 || idxGlb === -1) {
      throw new Error("Faltan columnas obligatorias en el CSV (Nombre o GLB).");
    }

    const tempDB: CatalogDB = { lines: {} };

    // Procesar filas
    for (let i = 1; i < rows.length; i++) {
      // Nota: split(',') es b√°sico, si una descripci√≥n tiene comas dentro podr√≠a romperse.
      // Para descripciones complejas se recomienda una librer√≠a parser CSV real, 
      // pero para esto servir√° si no hay comas en los textos.
      const cols = rows[i].split(',').map(cleanCell);
      
      if (cols.length < 3) continue;

      const ref = idxRef > -1 ? cols[idxRef] : `item_${i}`;
      const nombre = cols[idxNombre] || 'Sin Nombre';
      const precio = idxPrecio > -1 ? (parseFloat(cols[idxPrecio]) || 0) : 0;
      const linea = idxLinea > -1 ? (cols[idxLinea] || 'General') : 'General';
      const categoria = idxCategoria > -1 ? (cols[idxCategoria] || 'Varios') : 'Varios';
      const glbUrl = cols[idxGlb];
      const imgUrl = idxImg > -1 ? cols[idxImg] : undefined;
      const lineImgUrl = idxImgLinea > -1 ? cols[idxImgLinea] : undefined;

      // --- 2. EXTRAER DATOS NUEVOS ---
      const urlTech = idxUrlTech > -1 ? cols[idxUrlTech] : undefined;
      const urlCert = idxUrlCert > -1 ? cols[idxUrlCert] : undefined;
      const urlInst = idxUrlInst > -1 ? cols[idxUrlInst] : undefined;
      const desc    = idxDesc > -1    ? cols[idxDesc]    : undefined;
      // -------------------------------

      if (!glbUrl) continue;

      // --- 3. CREAR OBJETO PRODUCTO ---
      const product: Product = {
        id: ref,
        name: nombre,
        price: precio,
        type: 'model' as any, 
        modelUrl: glbUrl,
        img_2d: imgUrl,
        line: linea,
        category: categoria,
        
        // A√ëADIMOS LAS PROPIEDADES AL OBJETO
        url_tech: urlTech,
        url_cert: urlCert,
        url_inst: urlInst,
        description: desc 
      };

      // Organizar en categor√≠as
      if (!tempDB.lines[linea]) {
        tempDB.lines[linea] = { categories: {} };
      }
      
      if (lineImgUrl && !tempDB.lines[linea].lineImage) {
        tempDB.lines[linea].lineImage = lineImgUrl;
      }

      if (!tempDB.lines[linea].categories[categoria]) {
        tempDB.lines[linea].categories[categoria] = [];
      }

      tempDB.lines[linea].categories[categoria].push(product);
    }

    catalogData = tempDB;
    isLoaded = true;
    console.log('[CatalogService] CSV procesado correctamente. Datos cargados:', catalogData);

  } catch (err: any) {
    loadError = `Error CSV: ${err.message || err}`;
    console.error('[CatalogService]', err);
    isLoaded = false;
  }
};

export const getCatalogDB = (): CatalogDB | null => catalogData;
export const getCatalogLoadStatus = () => ({ isLoaded, error: loadError });

export const getProxiedImageUrl = (url: string): string => {
  return url;
};
// --- END OF FILE src/catalog/catalogService.ts ---
</file>

<file path="src/stores/auth/useAuthStore.ts">
import { create } from 'zustand';
import { supabase } from '@/lib/supabase';

interface AuthState {
  user: any | null;
  session: any | null;
  loading: boolean;

  setUser: (user: any) => void;
  setSession: (session: any) => void;
  logout: () => Promise<void>;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  session: null,
  loading: false,

  setUser: (user) => set({ user }),
  setSession: (session) => set({ session }),

  logout: async () => {
    await supabase.auth.signOut();
    set({ user: null, session: null });
  },
}));
</file>

<file path="src/stores/cad/useCADStore.ts">
// --- FILE: src/stores/cad/useCADStore.ts ---
import { create } from "zustand";

interface CADState {
  selectedVertices: number[];
  distance: number | null;
  angle: number | null;

  setSelectedVertices: (
    indices: number[],
    distance: number | null,
    angle: number | null
  ) => void;

  clear: () => void;
}

export const useCADStore = create<CADState>((set) => ({
  selectedVertices: [],
  distance: null,
  angle: null,

  setSelectedVertices: (indices, distance, angle) =>
    set({
      selectedVertices: indices,
      distance,
      angle,
    }),

  clear: () =>
    set({
      selectedVertices: [],
      distance: null,
      angle: null,
    }),
}));
</file>

<file path="src/stores/catalog/useCatalogStore.ts">
// --- START OF FILE useCatalogStore.ts ---
import { create } from "zustand";

interface CatalogState {
  isOpen: boolean;
  selectedProduct: any;

  openCatalog: () => void;
  closeCatalog: () => void;
  toggleCatalog: () => void;

  selectProduct: (product: any) => void;
}

export const useCatalogStore = create<CatalogState>((set) => ({
  isOpen: false,
  selectedProduct: null,

  openCatalog: () => set({ isOpen: true }),
  closeCatalog: () => set({ isOpen: false }),
  toggleCatalog: () => set((s) => ({ isOpen: !s.isOpen })),

  selectProduct: (product) => set({ selectedProduct: product }),
}));
// --- END OF FILE ---
</file>

<file path="src/stores/crm/useCRMStore.ts">
import { create } from 'zustand';

interface Client {
  id: string;
  name: string;
  phone?: string;
  email?: string;
}

interface CRMState {
  clients: Client[];
  selectedClient: Client | null;

  setClients: (clients: Client[]) => void;
  selectClient: (client: Client | null) => void;
}

export const useCRMStore = create<CRMState>((set) => ({
  clients: [],
  selectedClient: null,

  setClients: (clients) => set({ clients }),
  selectClient: (client) => set({ selectedClient: client }),
}));
</file>

<file path="src/stores/editor/useEditorStore.ts">
// --- FILE: src/stores/editor/useEditorStore.ts ---
import { create } from "zustand";
import * as THREE from "three";

// Importamos tipos
import type {
  SceneItem,
  FloorMaterialType,
  FenceConfig,
  EditorMode,
  CameraType,
  CameraView,
} from "@/types/editor";

declare global {
  interface Window {
    editorEngine?: any;
  }
}

import { FENCE_PRESETS } from "@/features/editor/data/fence_presets";

interface InputModalState {
  isOpen: boolean;
  title: string;
  defaultValue: string;
  resolve: ((value: string | null) => void) | null;
}

interface EditorState {
  items: SceneItem[];
  totalPrice: number;

  mode: EditorMode;

  gridVisible: boolean;
  budgetVisible: boolean;
  envPanelVisible: boolean;
  safetyZonesVisible: boolean;

  sunPosition: { azimuth: number; elevation: number };
  backgroundColor: string;

  cameraType: CameraType;
  pendingView: CameraView | null;

  past: SceneItem[][];
  future: SceneItem[][];

  measurementResult: number | null;

  fenceConfig: FenceConfig;

  inputModal: InputModalState;

  // actions
  saveSnapshot: () => void;

  addItem: (item: SceneItem) => void;
  removeItem: (uuid: string) => void;
  duplicateItem: (uuid: string) => void;

  updateItemTransform: (
    uuid: string,
    pos: number[],
    rot: number[],
    scale: number[]
  ) => void;

  updateFloorMaterial: (uuid: string, material: FloorMaterialType) => void;
  updateFloorTexture: (
    uuid: string,
    url: string | undefined,
    scale: number,
    rotation: number
  ) => void;

  updateFloorPoints: (
    uuid: string,
    points: { x: number; z: number }[]
  ) => void;

  setFenceConfig: (config: Partial<FenceConfig>) => void;
  updateItemFenceConfig: (uuid: string, config: Partial<FenceConfig>) => void;

  undo: () => void;
  redo: () => void;
  resetScene: () => void;

  setMode: (mode: EditorMode) => void;

  toggleGrid: () => void;
  toggleBudget: () => void;
  toggleEnvPanel: () => void;
  toggleSafetyZones: () => void;

  setSunPosition: (azimuth: number, elevation: number) => void;
  setBackgroundColor: (color: string) => void;

  setMeasurementResult: (dist: number | null) => void;

  setCameraType: (type: CameraType) => void;
  triggerView: (view: CameraView) => void;
  clearPendingView: () => void;

  requestInput: (title: string, defaultValue?: string) => Promise<string | null>;
  closeInputModal: (value: string | null) => void;
}

export const useEditorStore = create<EditorState>((set, get) => ({
  // --- ESTADO INICIAL ---
  items: [],
  totalPrice: 0,

  mode: "idle",

  gridVisible: false,
  budgetVisible: false,
  envPanelVisible: false,
  safetyZonesVisible: false,

  sunPosition: { azimuth: 180, elevation: 45 },
  backgroundColor: "#111111",

  cameraType: "perspective",
  pendingView: null,

  measurementResult: null,

  past: [],
  future: [],

  fenceConfig: {
    presetId: "wood",
    colors: FENCE_PRESETS["wood"].defaultColors,
  },

  inputModal: {
    isOpen: false,
    title: "",
    defaultValue: "",
    resolve: null,
  },

  // -----------------------------
  // SNAPSHOTS PARA UNDO/REDO
  // -----------------------------
  saveSnapshot: () => {
    const snapshot = structuredClone(get().items);
    set((state) => ({
      past: [...state.past.slice(-19), snapshot],
      future: [],
    }));
  },

  // -----------------------------
  // ADD ITEM
  // -----------------------------
  addItem: (item) => {
    const price = item.price ?? 0;
    get().saveSnapshot();
    set((s) => ({
      items: [...s.items, item],
      totalPrice: s.totalPrice + price,
    }));
  },

  // -----------------------------
  // REMOVE ITEM
  // -----------------------------
  removeItem: (uuid) => {
    get().saveSnapshot();
    set((s) => {
      const newItems = s.items.filter((i) => i.uuid !== uuid);
      return {
        items: newItems,
        totalPrice: newItems.reduce((sum, it) => sum + it.price, 0),
        mode: "idle",
      };
    });
  },

  // -----------------------------
  // DUPLICATE ITEM
  // -----------------------------
  duplicateItem: (uuid) => {
    const s = get();
    const original = s.items.find((i) => i.uuid === uuid);
    if (!original) return;

    s.saveSnapshot();

    const cloned = structuredClone(original);
    cloned.uuid = THREE.MathUtils.generateUUID();
    cloned.position = [
      original.position[0] + 1,
      original.position[1],
      original.position[2] + 1,
    ];

    set({
      items: [...s.items, cloned],
      totalPrice: s.totalPrice + cloned.price,
      mode: "editing",
    });
  },

  // -----------------------------
  // UPDATE TRANSFORM
  // -----------------------------
  updateItemTransform: (uuid, pos, rot, scale) =>
    set((s) => ({
      items: s.items.map((i) =>
        i.uuid === uuid
          ? {
              ...i,
              position: pos as [number, number, number],
              rotation: rot as [number, number, number],
              scale: scale as [number, number, number],
            }
          : i
      ),
    })),

  // -----------------------------
  // FLOOR MATERIAL
  // -----------------------------
  updateFloorMaterial: (uuid, material) =>
    set((s) => ({
      items: s.items.map((i) =>
        i.uuid === uuid
          ? { ...i, floorMaterial: material, textureUrl: undefined }
          : i
      ),
    })),

  // -----------------------------
  // FLOOR TEXTURE
  // -----------------------------
  updateFloorTexture: (uuid, url, scale, rotation) =>
    set((s) => ({
      items: s.items.map((i) =>
        i.uuid === uuid
          ? {
              ...i,
              textureUrl: url,
              textureScale: scale,
              textureRotation: rotation,
              floorMaterial: undefined,
            }
          : i
      ),
    })),

  // -----------------------------
  // FLOOR POINTS
  // -----------------------------
  updateFloorPoints: (uuid, points) => {
    get().saveSnapshot();
    set((s) => ({
      items: s.items.map((i) =>
        i.uuid === uuid ? { ...i, points } : i
      ),
    }));
  },

  // -----------------------------
  // GLOBAL FENCE CONFIG
  // -----------------------------
  setFenceConfig: (config) =>
    set((s) => ({
      fenceConfig: { ...s.fenceConfig, ...config },
    })),

  // -----------------------------
  // ITEM FENCE CONFIG
  // -----------------------------
  updateItemFenceConfig: (uuid, config) => {
    get().saveSnapshot();
    set((s) => ({
      items: s.items.map((i) =>
        i.uuid === uuid && i.fenceConfig
          ? { ...i, fenceConfig: { ...i.fenceConfig, ...config } }
          : i
      ),
    }));
  },

  // -----------------------------
  // UNDO
  // -----------------------------
  undo: () => {
    const { past, items, future } = get();
    if (past.length === 0) return;

    const prev = past[past.length - 1];
    set({
      items: prev,
      past: past.slice(0, -1),
      future: [items, ...future],
      mode: "idle",
      totalPrice: prev.reduce((s, i) => s + i.price, 0),
    });
  },

  // -----------------------------
  // REDO
  // -----------------------------
  redo: () => {
    const { past, items, future } = get();
    if (future.length === 0) return;

    const next = future[0];
    set({
      items: next,
      past: [...past, items],
      future: future.slice(1),
      mode: "idle",
      totalPrice: next.reduce((s, i) => s + i.price, 0),
    });
  },

  // -----------------------------
  // RESET SCENE
  // -----------------------------
  resetScene: () =>
    set({
      items: [],
      totalPrice: 0,
      mode: "idle",
      past: [],
      future: [],
      pendingView: null,
    }),

  // -----------------------------
  // MODE
  // -----------------------------
  setMode: (mode) => {
    window.editorEngine?.clearTools?.();
    set({ mode });
  },

  // -----------------------------
  // UI TOGGLES
  // -----------------------------
  toggleGrid: () => set((s) => ({ gridVisible: !s.gridVisible })),
  toggleBudget: () => set((s) => ({ budgetVisible: !s.budgetVisible })),
  toggleEnvPanel: () => set((s) => ({ envPanelVisible: !s.envPanelVisible })),
  toggleSafetyZones: () =>
    set((s) => ({ safetyZonesVisible: !s.safetyZonesVisible })),

  // -----------------------------
  // ENVIRONMENT
  // -----------------------------
  setSunPosition: (azimuth, elevation) =>
    set({ sunPosition: { azimuth, elevation } }),

  setBackgroundColor: (color) => set({ backgroundColor: color }),

  setMeasurementResult: (dist) => set({ measurementResult: dist }),

  // -----------------------------
  // CAMERA
  // -----------------------------
  setCameraType: (type) => set({ cameraType: type }),
  triggerView: (view) => set({ pendingView: view }),
  clearPendingView: () => set({ pendingView: null }),

  // -----------------------------
  // INPUT MODAL
  // -----------------------------
  requestInput: (title, defaultValue = "") =>
    new Promise((resolve) => {
      set({
        inputModal: {
          isOpen: true,
          title,
          defaultValue,
          resolve,
        },
      });
    }),

  closeInputModal: (value) => {
    const resolver = get().inputModal.resolve;
    resolver?.(value);

    set({
      inputModal: {
        isOpen: false,
        title: "",
        defaultValue: "",
        resolve: null,
      },
    });
  },
}));
</file>

<file path="src/stores/editor/useHistoryStore.ts">
// --- FILE: src/stores/history/useHistoryStore.ts ---
import { create } from "zustand";
import type { SceneItem } from "@/types/editor";

interface HistoryState {
  past: SceneItem[][];
  future: SceneItem[][];
  maxSteps: number;

  saveSnapshot: (items: SceneItem[]) => void;
  undo: (apply: (items: SceneItem[]) => void, currentItems: SceneItem[]) => void;
  redo: (apply: (items: SceneItem[]) => void, currentItems: SceneItem[]) => void;
  clearHistory: () => void;
}

export const useHistoryStore = create<HistoryState>((set, get) => ({
  past: [],
  future: [],
  maxSteps: 30,

  saveSnapshot: (items) => {
    const cloned = JSON.parse(JSON.stringify(items));
    const past = [...get().past, cloned];

    const trimmed =
      past.length > get().maxSteps
        ? past.slice(past.length - get().maxSteps)
        : past;

    set({ past: trimmed, future: [] });
  },

  undo: (apply, currentItems) => {
    const { past, future } = get();
    if (past.length === 0) return;

    const previous = past[past.length - 1];
    const newPast = past.slice(0, -1);

    const clonedCurrent = JSON.parse(JSON.stringify(currentItems));
    const newFuture = [clonedCurrent, ...future];

    apply(previous);

    set({
      past: newPast,
      future: newFuture,
    });
  },

  redo: (apply, currentItems) => {
    const { past, future } = get();
    if (future.length === 0) return;

    const next = future[0];
    const newFuture = future.slice(1);

    const clonedCurrent = JSON.parse(JSON.stringify(currentItems));
    const newPast = [...past, clonedCurrent];

    apply(next);

    set({
      past: newPast,
      future: newFuture,
    });
  },

  clearHistory: () => set({ past: [], future: [] }),
}));
</file>

<file path="src/stores/fence/useFenceStore.ts">
// --- FILE: src/stores/fence/useFenceStore.ts ---
import { create } from "zustand";
import type { FenceConfig } from "@/types/editor";

interface FenceState {
  config: FenceConfig;
  setConfig: (partial: Partial<FenceConfig>) => void;
}

const DEFAULT_FENCE_CONFIG: FenceConfig = {
  presetId: "wood",
  colors: {
    post: 0,
    slatA: 0,
    slatB: 0,
    slatC: 0,
  },
};

export const useFenceStore = create<FenceState>((set) => ({
  config: DEFAULT_FENCE_CONFIG,

  setConfig: (partial) =>
    set((state) => ({
      config: {
        ...state.config,
        ...partial,
        colors: {
          ...state.config.colors,
          ...(partial.colors ?? {}),
        },
      },
    })),
}));
</file>

<file path="src/stores/project/useProjectStore.ts">
import { create } from "zustand";
import { supabase } from "@/lib/supabase";

import type { SceneItem, FenceConfig } from "@/types/editor";
import { useSceneStore } from "@/stores/scene/useSceneStore";
import { useEditorStore } from "@/stores/editor/useEditorStore";

interface ProjectState {
  user: any | null;

  currentProjectId: string | null;
  currentProjectName: string | null;
  isReadOnlyMode: boolean;

  setUser: (user: any | null) => void;

  setProjectInfo: (id: string | null, name: string | null) => void;
  resetProject: () => void;

  loadProjectFromURL: (projectId: string) => Promise<void>;
}

export const useProjectStore = create<ProjectState>((set) => ({
  user: null,

  currentProjectId: null,
  currentProjectName: null,
  isReadOnlyMode: false,

  // -------------------------------------
  // USER
  // -------------------------------------
  setUser: (user) => set({ user }),

  // -------------------------------------
  // SET PROJECT INFO (ID + NAME)
  // -------------------------------------
  setProjectInfo: (id, name) =>
    set({
      currentProjectId: id,
      currentProjectName: name,
      isReadOnlyMode: false,
    }),

  // -------------------------------------
  // RESET PROJECT (NUEVO PROYECTO)
  // -------------------------------------
  resetProject: () => {
    useSceneStore.getState().resetScene(); // limpiamos escena

    set({
      currentProjectId: null,
      currentProjectName: null,
      isReadOnlyMode: false,
    });
  },

  // -------------------------------------
  // LOAD PROJECT
  // -------------------------------------
  loadProjectFromURL: async (projectId: string) => {
    const { data: project, error } = await supabase
      .from("projects")
      .select("id, name, data")
      .eq("id", projectId)
      .single();

    if (error || !project) {
      console.error("‚ùå Error al cargar proyecto:", error?.message);
      return;
    }

    const scene = project.data || {};

    // Items
    const items: SceneItem[] = Array.isArray(scene.items)
      ? scene.items
      : [];

    // Fence config
    const fence: FenceConfig =
      scene.fenceConfig || {
        presetId: "wood",
        colors: { post: 0, slatA: 0 },
      };

    // Price calc
    const totalPrice = items.reduce(
      (sum, i) => sum + (i.price || 0),
      0
    );

    // --- UPDATE SCENE STORE ---
    useSceneStore.setState({
      items,
      fenceConfig: fence,
      totalPrice,
    });

    // --- UPDATE EDITOR STORE ---
    useEditorStore.setState({
      cameraType: scene.camera || "perspective",
    });

    // --- UPDATE PROJECT STORE ---
    set({
      currentProjectId: project.id,
      currentProjectName: project.name,
      isReadOnlyMode: true,
    });
  },
}));
</file>

<file path="src/stores/scene/useSceneStore.ts">
// --- START OF FILE src/stores/scene/useSceneStore.ts ---
import { create } from "zustand";
import type { SceneItem, FenceConfig } from "@/types/editor";

/**
 * Este store contiene SOLO la escena:
 * - items colocados
 * - fenceConfig temporal o global
 * - c√°lculos simples como totalPrice
 */

interface SceneState {
  items: SceneItem[];
  fenceConfig: FenceConfig;

  // --- DERIVADOS ---
  totalPrice: number;

  // --- ACCIONES CRUD ---
  addItem: (item: SceneItem) => void;
  updateItem: (uuid: string, partial: Partial<SceneItem>) => void;
  removeItem: (uuid: string) => void;

  // --- FENCE ---
  setFenceConfig: (cfg: Partial<FenceConfig>) => void;
  updateItemFenceConfig: (uuid: string, cfg: Partial<FenceConfig>) => void;

  // --- RESET ---
  resetScene: () => void;
}

export const useSceneStore = create<SceneState>((set) => ({
  // --- DEFAULT STATE ---
  items: [],

  fenceConfig: {
    presetId: "wood",
    colors: {
      post: 0xffffff,
      slatA: 0xffffff,
      slatB: 0xffffff,
      slatC: 0xffffff,
    },
  },

  totalPrice: 0,

  // -------------------------------------------------------------
  // ADD ITEM
  // -------------------------------------------------------------
  addItem: (item) =>
    set((state) => {
      const items = [...state.items, item];
      const totalPrice = items.reduce((sum, i) => sum + (i.price || 0), 0);
      return { items, totalPrice };
    }),

  // -------------------------------------------------------------
  // UPDATE ITEM
  // -------------------------------------------------------------
  updateItem: (uuid, partial) =>
    set((state) => {
      const items = state.items.map((i) =>
        i.uuid === uuid ? { ...i, ...partial } : i
      );
      const totalPrice = items.reduce((sum, i) => sum + (i.price || 0), 0);
      return { items, totalPrice };
    }),

  // -------------------------------------------------------------
  // REMOVE ITEM
  // -------------------------------------------------------------
  removeItem: (uuid) =>
    set((state) => {
      const items = state.items.filter((i) => i.uuid !== uuid);
      const totalPrice = items.reduce((sum, i) => sum + (i.price || 0), 0);
      return { items, totalPrice };
    }),

  // -------------------------------------------------------------
  // FENCE CONFIG (GLOBAL)
  // -------------------------------------------------------------
  setFenceConfig: (cfg) =>
    set((state) => ({
      fenceConfig: {
        ...state.fenceConfig,
        ...cfg,
        colors: {
          ...state.fenceConfig.colors,
          ...(cfg.colors || {}),
        },
      },
    })),

  // -------------------------------------------------------------
  // UPDATE FENCE CONFIG IN ITEM
  // -------------------------------------------------------------
updateItemFenceConfig: (uuid, cfg) =>
  set((state) => {
    const items = state.items.map((i) => {
      if (i.uuid !== uuid) return i;

      const safeFence: FenceConfig = {
        presetId: i.fenceConfig?.presetId ?? "wood",
        colors: {
          post: i.fenceConfig?.colors.post ?? 0xffffff,
          slatA: i.fenceConfig?.colors.slatA ?? 0xffffff,
          slatB: i.fenceConfig?.colors.slatB ?? 0xffffff,
          slatC: i.fenceConfig?.colors.slatC ?? 0xffffff,
        },
      };

      return {
        ...i,
        fenceConfig: {
          presetId: cfg.presetId ?? safeFence.presetId,
          colors: {
            ...safeFence.colors,
            ...(cfg.colors || {}),
          },
        },
      };
    });

    return { items };
  }),

  // -------------------------------------------------------------
  // RESET SCENE
  // -------------------------------------------------------------
  resetScene: () =>
    set({
      items: [],
      totalPrice: 0,
      fenceConfig: {
        presetId: "wood",
        colors: {
          post: 0xffffff,
          slatA: 0xffffff,
          slatB: 0xffffff,
          slatC: 0xffffff,
        },
      },
    }),
}));
// --- END OF FILE src/stores/scene/useSceneStore.ts ---
</file>

<file path="src/stores/selection/useSelectionStore.ts">
import { create } from "zustand";
import { useEditorStore } from "../editor/useEditorStore";
import { useProjectStore } from "../project/useProjectStore";
import type { SceneItem } from "@/types/editor";

interface SelectionState {
  selectedItemId: string | null;
  selectedVertices: number[];
  measuredDistance: number | null;
  measuredAngle: number | null;

  selectItem: (uuid: string | null) => void;
  clearSelection: () => void;

  setSelectedVertices: (
    indices: number[],
    distance: number | null,
    angle: number | null
  ) => void;

  duplicateSelection: () => void;
  removeSelection: () => void;
}

export const useSelectionStore = create<SelectionState>((set, get) => ({
  selectedItemId: null,
  selectedVertices: [],
  measuredDistance: null,
  measuredAngle: null,

  // -----------------------------
  // SELECT ITEM
  // -----------------------------
  selectItem: (uuid) =>
    set({
      selectedItemId: uuid,
      selectedVertices: [],
      measuredDistance: null,
      measuredAngle: null,
    }),

  // -----------------------------
  // CLEAR SELECTION
  // -----------------------------
  clearSelection: () =>
    set({
      selectedItemId: null,
      selectedVertices: [],
      measuredDistance: null,
      measuredAngle: null,
    }),

  // -----------------------------
  // VERTEX SELECTION (measure tool)
  // -----------------------------
  setSelectedVertices: (indices, distance, angle) =>
    set({
      selectedVertices: indices,
      measuredDistance: distance,
      measuredAngle: angle,
    }),

  // -----------------------------
  // DUPLICATE SELECTED ITEM
  // -----------------------------
  duplicateSelection: () => {
    const { isReadOnlyMode } = useProjectStore.getState();
    if (isReadOnlyMode) {
      console.warn("üö´ No se puede duplicar en modo lectura.");
      return;
    }

    const selectedId = get().selectedItemId;
    if (!selectedId) return;

    const editor = useEditorStore.getState();
    const item = editor.items.find((i: SceneItem) => i.uuid === selectedId);
    if (!item) return;

    const cloned = structuredClone(item);
    cloned.uuid = crypto.randomUUID();
    cloned.position = [
      item.position[0] + 1,
      item.position[1],
      item.position[2] + 1,
    ];

    useEditorStore.setState({
      items: [...editor.items, cloned],
    });

    set({ selectedItemId: cloned.uuid });
  },

  // -----------------------------
  // REMOVE SELECTED ITEM
  // -----------------------------
  removeSelection: () => {
    const { isReadOnlyMode } = useProjectStore.getState();
    if (isReadOnlyMode) {
      console.warn("üö´ No se puede borrar en modo lectura.");
      return;
    }

    const selectedId = get().selectedItemId;
    if (!selectedId) return;

    const editor = useEditorStore.getState();

    useEditorStore.setState({
      items: editor.items.filter((i: SceneItem) => i.uuid !== selectedId),
    });

    set({ selectedItemId: null });
  },
}));
</file>

<file path="src/stores/ui/useUIStore.ts">
import { create } from "zustand";

interface InputModalState {
  isOpen: boolean;
  title: string;
  defaultValue: string;
  resolve: ((value: string | null) => void) | null;
}

interface UIState {
  // --- PANEL STATES ---
  gridVisible: boolean;
  budgetVisible: boolean;
  envPanelVisible: boolean;
  safetyZonesVisible: boolean;

  // --- MODALS ---
  inputModal: InputModalState;
  qrModalOpen: boolean;

  // --- ACTIONS ---
  toggleGrid: () => void;
  toggleBudget: () => void;
  toggleEnvPanel: () => void;
  toggleSafetyZones: () => void;

  openQRModal: () => void;
  closeQRModal: () => void;

  requestInput: (title: string, defaultValue?: string) => Promise<string | null>;
  closeInputModal: (value: string | null) => void;
}

export const useUIStore = create<UIState>((set, get) => ({
  // --- INITIAL UI VALUES ---
  gridVisible: false,
  budgetVisible: false,
  envPanelVisible: false,
  safetyZonesVisible: false,

  qrModalOpen: false,

  inputModal: {
    isOpen: false,
    title: "",
    defaultValue: "",
    resolve: null,
  },

  // --- TOGGLES ---
  toggleGrid: () => set((s) => ({ gridVisible: !s.gridVisible })),
  toggleBudget: () => set((s) => ({ budgetVisible: !s.budgetVisible })),
  toggleEnvPanel: () => set((s) => ({ envPanelVisible: !s.envPanelVisible })),
  toggleSafetyZones: () =>
    set((s) => ({ safetyZonesVisible: !s.safetyZonesVisible })),

  // --- QR MODAL ---
  openQRModal: () => set({ qrModalOpen: true }),
  closeQRModal: () => set({ qrModalOpen: false }),

  // --- INPUT MODAL (PROMISE-BASED) ---
  requestInput: (title, defaultValue = "") => {
    return new Promise((resolve) => {
      set({
        inputModal: {
          isOpen: true,
          title,
          defaultValue,
          resolve,
        },
      });
    });
  },

  closeInputModal: (value) => {
    const { resolve } = get().inputModal;
    if (resolve) resolve(value);

    set({
      inputModal: {
        isOpen: false,
        title: "",
        defaultValue: "",
        resolve: null,
      },
    });
  },
}));
</file>

<file path="src/stores/user/useUserStore.ts">
import { create } from "zustand";

interface UserState {
  user: any | null;
  setUser: (user: any | null) => void;
}

export const useUserStore = create<UserState>((set) => ({
  user: null,
  setUser: (user) => set({ user }),
}));
</file>

<file path="src/types/catalog.ts">
export interface ProductDefinition {
  id: string;
  name: string;
  price: number;
  type: "model" | string;
  modelUrl: string;
  img_2d?: string;
  line?: string;
  category?: string;

  // Estos los a√±adimos pero son opcionales
  url_tech?: string;
  url_cert?: string;
  url_inst?: string;
  description?: string;
}
</file>

<file path="src/types/editor.ts">
// ===============================
//  SHARED EDITOR TYPES
// ===============================

// ---- Scene Item Types ----
export type FloorMaterialType =
  | "rubber_red"
  | "rubber_green"
  | "rubber_blue"
  | "grass"
  | "concrete";

export interface FenceConfig {
  presetId: string;
  colors: { post: number; slatA: number; slatB?: number; slatC?: number };
}

export interface SceneItem {
  uuid: string;
  productId: string;
  name?: string;
  price: number;

  position: [number, number, number];
  rotation: [number, number, number];
  scale: [number, number, number];

  type: "model" | "floor" | "fence";

  modelUrl?: string;
  url_tech?: string;
  url_cert?: string;
  url_inst?: string;
  description?: string;
  
  // floor
  points?: { x: number; z: number }[];
  floorMaterial?: FloorMaterialType;
  textureUrl?: string;
  textureScale?: number;
  textureRotation?: number;

  fenceConfig?: FenceConfig;

  // misc data
  data?: any;
}

// ---- Editor State Types ----

export type EditorMode =
  | "idle"
  | "editing"
  | "placing_item"
  | "drawing_floor"
  | "drawing_fence"
  | "measuring"
  | "catalog";

export type CameraView = "top" | "front" | "side" | "iso";
export type CameraType = "perspective" | "orthographic";
</file>

<file path="src/types/types.ts">
// --- src/types.ts ---

export interface Profile {
  id: string;
  email: string;
  role: 'client' | 'employee' | 'admin';
  company_name?: string;
  full_name?: string;
  shipping_address?: string;
  billing_address?: string;
  billing_email?: string;
  phone?: string;
  cif?: string;
  observations?: string;
  created_at: string;
}

export type OrderStatus = 'borrador' | 'pendiente' | 'presupuestado' | 'pedido' | 'en_proceso' | 'enviado' | 'entregado' | 'rechazado';

export interface Order {
  id: string;
  created_at: string;
  order_ref: string;
  user_id: string;
  project_id?: string;
  status: OrderStatus;
  total_price: number;
  estimated_delivery_date?: string;
  is_archived?: boolean; 
  
  // Relaciones (Supabase join)
  profiles?: Profile;
  // üëá AQU√ç ESTABA EL ERROR: Faltaba a√±adir 'id: string'
  projects?: { 
    id: string; 
    name: string; 
    thumbnail_url?: string 
  };
}
</file>

<file path="src/utils/budgetUtils.ts">
import type { SceneItem } from '@/types/editor';

export interface BudgetLineItem {
  id: string;
  name: string;
  category: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
  image?: string;
}

export const generateBillOfMaterials = (items: SceneItem[]): BudgetLineItem[] => {
  const groupedItems: Record<string, BudgetLineItem> = {};

  items.forEach((item) => {
    if (!item.productId) return;

    const key = item.productId;

    if (!groupedItems[key]) {
      groupedItems[key] = {
        id: item.productId,
        name: item.name || 'Producto sin nombre',
        category: item.type,
        quantity: 0,
        unitPrice: item.price || 0,
        totalPrice: 0,
        image: item.modelUrl
      };
    }

    groupedItems[key].quantity += 1;
    groupedItems[key].totalPrice += item.price || 0;
  });

  return Object.values(groupedItems);
};

export const calculateGrandTotal = (lines: BudgetLineItem[]) => {
  return lines.reduce((acc, line) => acc + line.totalPrice, 0);
};
</file>

<file path="src/utils/pdfGenerator.ts">
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';


// Funci√≥n auxiliar local para formatear dinero
const formatMoney = (amount: number) => {
    return amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
};

export const generateBudgetPDF = async (order: any, items3D: any[], manualItems: any[]) => {
  const doc = new jsPDF();
  const margin = 20;
  const rightMargin = 190; // Alineaci√≥n derecha est√°ndar A4
  
  // --- CABECERA ---
  doc.setFontSize(22);
  doc.setTextColor(40, 40, 40);
  // Alineado a la derecha
  doc.text("PRESUPUESTO", rightMargin, 20, { align: 'right' });

  doc.setFontSize(10);
  doc.setTextColor(100);
  // Alineado a la derecha debajo del t√≠tulo
  doc.text(`Referencia: ${order.order_ref}`, rightMargin, 28, { align: 'right' });
  doc.text(`Fecha: ${new Date().toLocaleDateString()}`, rightMargin, 33, { align: 'right' });
  if(order.custom_name) {
      doc.text(`Proyecto: ${order.custom_name}`, rightMargin, 38, { align: 'right' });
  }

  // Datos de tu empresa
  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.text("Mi Empresa S.L.", margin, 20);
  doc.setFontSize(10);
  doc.setTextColor(100);
  doc.text("Calle Industria 123", margin, 26);
  doc.text("28000 Madrid", margin, 31);
  doc.text("info@miempresa.com", margin, 36);

  // L√≠nea separadora
  doc.setDrawColor(200);
  doc.line(margin, 45, rightMargin, 45);
  
  // Datos del Cliente
  doc.setFontSize(11);
  doc.setTextColor(0);
  doc.text("Cliente:", margin, 55);
  doc.setFontSize(10);
  doc.setTextColor(80);
  const clientName = order.profiles?.company_name || order.profiles?.full_name || 'Particular';
  const clientEmail = order.profiles?.email || '';
  const clientPhone = order.profiles?.phone || '';
  const clientCif = order.profiles?.cif ? `CIF/NIF: ${order.profiles.cif}` : '';
  
  doc.text(clientName, margin, 62);
  doc.text(clientEmail, margin, 67);
  doc.text(clientPhone, margin, 72);
  if (clientCif) doc.text(clientCif, margin, 77);

  // --- IMAGEN DEL PROYECTO (Con m√°s espacio) ---
  // Calculamos d√≥nde empezar√° la tabla din√°micamente
  let tableStartY = 95; // Posici√≥n por defecto si no hay imagen

  if (order.projects?.thumbnail_url) {
    try {
        const img = new Image();
        img.src = order.projects.thumbnail_url;
        img.crossOrigin = "Anonymous";
        await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });
        
        // Imagen alineada a la derecha
        doc.addImage(img, 'JPEG', 120, 50, 70, 45); // x, y, ancho, alto
        tableStartY = 110; // Bajamos la tabla para dejar aire
    } catch (e) {
        console.warn("No se pudo cargar imagen PDF", e);
    }
  }

  // --- TABLA DE ITEMS ---
  const tableRows: any[] = [];

  // 1. Items 3D
  items3D.forEach(item => {
    // L√≥gica para Referencia y Cantidad/Medida
    const ref = item.id ? item.id.substring(0, 8).toUpperCase() : '3D-DESIGN';
    // Si tiene 'info' (dimensiones calculadas), lo usamos. Si no, la cantidad.
    const qtyDisplay = item.info ? item.info : item.quantity.toString();

    tableRows.push([
        item.name,
        ref,
        qtyDisplay,
        formatMoney(item.unitPrice || item.price)
    ]);
  });

  // 2. Items Manuales
  manualItems.forEach(item => {
    const ref = 'EXTRA-MAN';
    const qtyDisplay = item.dimensions ? item.dimensions : item.quantity.toString();

    tableRows.push([
        item.name,
        ref,
        qtyDisplay,
        formatMoney(item.total_price)
    ]);
  });

  // @ts-ignore
  autoTable(doc, {
    startY: tableStartY,
    head: [['Concepto', 'Referencia', 'Cant. / Medida', 'Precio Total']], // Encabezados cambiados
    body: tableRows,
    theme: 'striped',
    headStyles: { 
        fillColor: [41, 128, 185],
        halign: 'left' // Alineaci√≥n general headers
    },
    styles: { fontSize: 10, cellPadding: 3 },
    columnStyles: { 
        0: { cellWidth: 'auto' }, // Concepto
        1: { cellWidth: 30 },     // Referencia
        2: { cellWidth: 30, halign: 'center' }, // Cant/Medida
        3: { cellWidth: 30, halign: 'right' }   // Precio (contenido)
    },
    // Forzar alineaci√≥n derecha espec√≠ficamente al header de la columna 3 (Precio)
    didParseCell: function(data) {
        if (data.section === 'head' && data.column.index === 3) {
            data.cell.styles.halign = 'right';
        }
    }
  });

  // --- C√ÅLCULO DE TOTALES E IVA ---
  // @ts-ignore
  let finalY = doc.lastAutoTable.finalY + 10;
  
  // 1. Recuperar valores
  const finalSavedPrice = order.total_price; // Este es el precio final negociado (Base Imponible)
  const discountRate = order.profiles?.discount_rate || 0;
  
  // 2. C√°lculo inverso para sacar el Subtotal Bruto antes de descuento
  let subtotalBruto = finalSavedPrice;
  if (discountRate > 0 && finalSavedPrice > 0) {
      subtotalBruto = finalSavedPrice / (1 - (discountRate / 100));
  } else if (finalSavedPrice === 0) {
      // Fallback por si es 0
      subtotalBruto = items3D.reduce((a,b) => a + b.totalPrice, 0) + manualItems.reduce((a,b) => a + b.total_price, 0);
  }

  // 3. C√°lculo de IVA
  const baseImponible = finalSavedPrice > 0 ? finalSavedPrice : subtotalBruto; // Lo que queda tras el descuento
  const ivaAmount = baseImponible * 0.21; // 21% IVA
  const totalConIva = baseImponible + ivaAmount;

  // --- PINTAR TOTALES ---
  const textXLabel = 135; // Columna etiquetas
  const textXValue = 190; // Columna valores (alineados derecha)
  
  doc.setFontSize(10);
  doc.setTextColor(0);
  
  // Subtotal
  doc.text(`Subtotal:`, textXLabel, finalY);
  doc.text(formatMoney(subtotalBruto), textXValue, finalY, { align: 'right' });
  
  // Descuento (si hay)
  if (discountRate > 0) {
      finalY += 6;
      doc.setTextColor(230, 126, 34); // Naranja
      doc.text(`Dto. (${discountRate}%):`, textXLabel, finalY);
      const discountAmount = subtotalBruto - baseImponible;
      doc.text(`-${formatMoney(discountAmount)}`, textXValue, finalY, { align: 'right' });
  }

  // Base Imponible
  finalY += 6;
  doc.setTextColor(0); // Negro
  doc.text(`Base Imponible:`, textXLabel, finalY);
  doc.text(formatMoney(baseImponible), textXValue, finalY, { align: 'right' });

  // IVA
  finalY += 6;
  doc.text(`IVA (21%):`, textXLabel, finalY);
  doc.text(formatMoney(ivaAmount), textXValue, finalY, { align: 'right' });

  // TOTAL FINAL
  finalY += 10;
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text(`TOTAL:`, textXLabel, finalY);
  doc.setTextColor(41, 128, 185); // Azul
  doc.text(formatMoney(totalConIva), textXValue, finalY, { align: 'right' });

  // --- PIE ---
  doc.setFontSize(8);
  doc.setTextColor(150);
  doc.setFont('helvetica', 'normal');
  doc.text("Este presupuesto tiene una validez de 15 d√≠as.", margin, 280);
  doc.text("Forma de pago: 50% al aceptar, 50% antes de la entrega.", margin, 284);

  return doc.output('blob');
};
</file>

<file path="src/utils/PriceCalculator.ts">
// --- START OF FILE src/utils/PriceCalculator.ts ---
import type { SceneItem } from '@/types/editor';

// PRECIOS BASE (Configuraci√≥n centralizada)
export const PRICES = {
    FLOOR_M2: 35,   // Precio por m¬≤ suelo
    FENCE_M: 45,    // Precio por metro lineal valla
};

export class PriceCalculator {

    /** Obtiene el precio total de un √≠tem */
    static getItemPrice(item: SceneItem): number {
        // 1. Suelos (√Årea)
        if (item.type === 'floor' && item.points) {
            const area = this.calculateArea(item.points);
            const unitPrice = item.price > 0 ? item.price : PRICES.FLOOR_M2;
            return parseFloat((area * unitPrice).toFixed(2));
        } 
        
        // 2. Vallas (Longitud)
        if (item.type === 'fence' && item.points) {
            const length = this.calculateLength(item.points);
            const unitPrice = item.price > 0 ? item.price : PRICES.FENCE_M;
            return parseFloat((length * unitPrice).toFixed(2));
        }

        // 3. Modelos 3D est√°ndar
        return item.price || 0;
    }

    /** Obtiene el texto de dimensiones para mostrar (ej: "12.50 m¬≤") */
    static getItemDimensions(item: SceneItem): string {
        if (item.type === 'floor' && item.points) {
            const area = this.calculateArea(item.points);
            return `${area.toFixed(2)} m¬≤`;
        }
        if (item.type === 'fence' && item.points) {
            const length = this.calculateLength(item.points);
            return `${length.toFixed(2)} ml`;
        }
        return "1 ud";
    }

    /** Calcula el total de una lista de items */
    static calculateProjectTotal(items: SceneItem[]): number {
        return items.reduce((total, item) => total + this.getItemPrice(item), 0);
    }

    // -------------------------------------------------
    // FUNCIONES INTERNAS
    // -------------------------------------------------
    private static calculateArea(points: { x: number, z: number }[]): number {
        if (!points || points.length < 3) return 0;
        let area = 0;
        for (let i = 0; i < points.length; i++) {
            const j = (i + 1) % points.length;
            area += points[i].x * points[j].z;
            area -= points[j].x * points[i].z;
        }
        return Math.abs(area) / 2;
    }

    private static calculateLength(points: { x: number, z: number }[]): number {
        if (!points || points.length < 2) return 0;
        let length = 0;
        for (let i = 0; i < points.length - 1; i++) {
            const p1 = points[i];
            const p2 = points[i+1];
            const dist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.z - p1.z, 2));
            length += dist;
        }
        return length;
    }
}
// --- END OF FILE src/utils/PriceCalculator.ts ---
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,

    "baseUrl": "./src",
    "paths": {
      "@/*": ["*"],
      "@features/*": ["features/*"],
      "@stores/*": ["stores/*"],
      "@lib/*": ["lib/*"],
      "@utils/*": ["utils/*"],
      "@components/*": ["components/*"]
    }
  },

  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vercel.json">
{
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  
  // 1. TU CONFIGURACI√ìN ACTUAL (Vital para Three.js)
  resolve: {
    alias: {
      // Mantener this para evitar varias copias de Three
      three: path.resolve(__dirname, './node_modules/three'),

      '@': path.resolve(__dirname, './src'),
      '@features': path.resolve(__dirname, './src/features'),
      '@stores': path.resolve(__dirname, './src/stores'),
      '@lib': path.resolve(__dirname, './src/lib'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@components': path.resolve(__dirname, './src/components')
    }
  },

  // 2. CONFIGURACI√ìN DE OPTIMIZACI√ìN (Para quitar el aviso amarillo)
  build: {
    chunkSizeWarningLimit: 1600, // Aumentamos el l√≠mite de aviso a 1.6MB
    rollupOptions: {
      output: {
        manualChunks(id) {
          // Separa las librer√≠as (node_modules) del c√≥digo de tu app
          // Esto crea un archivo 'vendor.js' que el navegador cachea mejor
          if (id.includes('node_modules')) {
            return 'vendor';
          }
        }
      }
    }
  }
})
</file>

</files>
